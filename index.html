<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Image Cards Gallery</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f5f5f5;
    }

    header {
      background: #333;
      color: white;
      padding: 1rem;
      text-align: center;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
    }

    .tags {
      color: #666;
      font-size: 0.85rem;
      margin: 0.5rem 0;
    }

    .related {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }

    .related img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 6px;
    }

    .add-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4caf50;
      color: white;
      border: none;
      padding: 14px 18px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .popup {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 300px;
      max-width: 90vw;
    }

    .popup-content input, .popup-content textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .popup-content button {
      margin-right: 8px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .popup-content button:first-of-type {
      background: #4caf50;
      color: white;
    }

    .popup-content button:last-of-type {
      background: #f44336;
      color: white;
    }

    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>

  <header>
    <h1>Image Cards Gallery</h1>
  </header>

  <main class="gallery" id="gallery"></main>

  <!-- Add Button -->
  <button class="add-btn" onclick="openPopup()">ï¼‹</button>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <h3>Add Image Card</h3>
      <div class="status" id="status"></div>
      <input id="title" placeholder="Title" />
      <input id="tags" placeholder="Tags (comma separated)" />
      <textarea id="relatedLinks" rows="5" placeholder="Image URLs (1 per line)"></textarea>
      <button id="addBtn" type="button">Add</button>
      <button type="button" onclick="closePopup()">Cancel</button>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    let supabase;

    // Show status messages
    function showStatus(message, isError = false) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${isError ? 'error' : 'success'}`;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    window.onload = async function () {
      console.log('Page loaded, initializing...');
      
      const supabaseUrl = 'https://fwzffqwjprjuwidkrckb.supabase.co';
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';

      try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        console.log('Supabase client created');

        // Bind the button after supabase is ready
        document.getElementById('addBtn').addEventListener('click', addCard);
        console.log('Event listener added to Add button');

        // Try to load existing cards
        const { data: cards, error } = await supabase
          .from('cards')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Failed to load cards:', error.message);
          showStatus('Failed to load existing cards: ' + error.message, true);
          return;
        }

        console.log('Loaded cards:', cards);
        if (cards && cards.length > 0) {
          cards.forEach(addCardToPage);
        }
      } catch (err) {
        console.error('Initialization error:', err);
        showStatus('Failed to initialize: ' + err.message, true);
      }
    };

    async function addCard() {
      console.log('Add button clicked');
      
      const title = document.getElementById('title').value.trim();
      const tags = document.getElementById('tags').value.trim();
      const links = document.getElementById('relatedLinks').value.trim().split('\n').map(link => link.trim()).filter(Boolean);

      console.log('Form data:', { title, tags, links });

      if (!title || links.length === 0) {
        showStatus("Please enter a title and at least one image link.", true);
        return;
      }

      if (!supabase) {
        showStatus("Database connection not ready. Please refresh and try again.", true);
        return;
      }

      // Disable button during processing
      const addBtn = document.getElementById('addBtn');
      addBtn.disabled = true;
      addBtn.textContent = 'Adding...';

      try {
        const newCard = {
          title,
          tags,
          main_image_url: links[0],
          related_images: links,
          created_at: new Date().toISOString()
        };

        console.log('Inserting card:', newCard);

        const { data, error } = await supabase.from('cards').insert([newCard]).select();

        if (error) {
          console.error('Supabase error:', error);
          showStatus("Error saving to database: " + error.message, true);
          return;
        }

        console.log('Card inserted successfully:', data);
        
        // Use the returned data or fallback to newCard
        const cardToAdd = data && data.length > 0 ? data[0] : newCard;
        addCardToPage(cardToAdd);
        
        showStatus("Card added successfully!");
        closePopup();

        // Clear fields
        document.getElementById('title').value = '';
        document.getElementById('tags').value = '';
        document.getElementById('relatedLinks').value = '';

      } catch (err) {
        console.error('Unexpected error:', err);
        showStatus("Unexpected error: " + err.message, true);
      } finally {
        // Re-enable button
        addBtn.disabled = false;
        addBtn.textContent = 'Add';
      }
    }

    function addCardToPage(card) {
      console.log('Adding card to page:', card);
      
      const cardElem = document.createElement('div');
      cardElem.className = 'card';
      
      // Handle cases where related_images might be null or empty
      const relatedImages = card.related_images || [card.main_image_url];
      
      cardElem.innerHTML = `
        <img src="${card.main_image_url}" alt="${card.title}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22260%22 height=%22180%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23ddd%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22>Image not found</text></svg>'" />
        <h4>${card.title}</h4>
        <div class="tags">${card.tags || ''}</div>
        <div class="related">
          ${relatedImages.map(link => `<img src="${link}" alt="related" onerror="this.style.display='none'" />`).join('')}
        </div>
      `;
      
      // Add to the beginning of the gallery
      const gallery = document.getElementById('gallery');
      gallery.insertBefore(cardElem, gallery.firstChild);
    }

    function openPopup() {
      console.log('Opening popup');
      document.getElementById('popup').style.display = 'flex';
    }

    function closePopup() {
      console.log('Closing popup');
      document.getElementById('popup').style.display = 'none';
      // Hide status when closing
      document.getElementById('status').style.display = 'none';
    }

    // Close popup when clicking outside
    document.getElementById('popup').addEventListener('click', function(e) {
      if (e.target === this) {
        closePopup();
      }
    });

    // Handle Enter key in form fields
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && document.getElementById('popup').style.display === 'flex') {
        // Don't submit on Enter in textarea
        if (e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          addCard();
        }
      }
    });
  </script>
</body>
</html>
