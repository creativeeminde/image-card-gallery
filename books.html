<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelved.</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Lora', 'serif'],
                    },
                    colors: {
                        brand: {
                            bg: '#fcfaf8',
                            surface: '#fde9d9',
                            card: '#ffffff',
                            text: '#2d3748',
                            muted: '#718096',
                            primary: '#f97316', 
                            primaryLight: '#fdba74',
                            primaryDark: '#d97706',
                            primaryUltraLight: '#ffedd5', 
                        }
                    }
                }
            }
        }
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #fcfaf8;
            color: #2d3748;
        }
        
        progress::-webkit-progress-bar {
            background-color: transparent;
            border-radius: 9999px;
            border: 1px solid #fdba74;
            padding: 2px;
        }
        progress::-webkit-progress-value {
            background-color: #f97316;
            border-radius: 9999px;
        }
        progress::-moz-progress-bar {
            background-color: #f97316;
            border-radius: 9999px;
        }
        .progress-container {
            border: 1px solid #fdba74;
            padding: 2px;
            border-radius: 9999px;
            height: 14px;
        }
        
        .tab-active {
            background-color: #fde9d9;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            font-weight: 600;
        }
        
        .book-shadow {
            box-shadow: 4px 4px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen font-sans flex flex-col items-center pt-6 px-4 sm:px-8">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Update Progress Modal -->
    <div id="progress-modal" class="hidden fixed inset-0 bg-black/40 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl transform transition-transform">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-semibold text-lg text-brand-text">Update Progress</h3>
                <button onclick="closeProgressModal()" class="text-brand-muted hover:text-brand-primary transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex items-center justify-center gap-3 mb-8">
                <div class="flex flex-col items-center">
                    <label class="text-[10px] font-semibold text-brand-muted uppercase tracking-wider mb-1">Current Page</label>
                    <input type="number" id="progress-current" min="0" class="w-24 border border-gray-200 rounded-xl p-3 text-lg font-bold text-center text-brand-text focus:ring-2 focus:ring-brand-primary outline-none shadow-sm" value="0">
                </div>
                <span class="text-brand-muted text-2xl font-light mt-4">/</span>
                <div class="flex flex-col items-center">
                    <label class="text-[10px] font-semibold text-brand-muted uppercase tracking-wider mb-1">Total Pages</label>
                    <input type="number" id="progress-total" min="1" class="w-24 border border-gray-200 rounded-xl p-3 text-lg font-bold text-center text-brand-text focus:ring-2 focus:ring-brand-primary outline-none shadow-sm" value="300">
                </div>
            </div>
            
            <button onclick="saveProgress()" class="w-full bg-brand-primary text-white font-semibold py-3 rounded-xl shadow-md hover:bg-brand-primaryDark transition-colors">
                Save Progress
            </button>
        </div>
    </div>

    <!-- Header Navigation -->
    <header class="w-full max-w-6xl flex items-center justify-between mb-2 relative z-10 px-6">
        <div class="w-1/4"></div>
        
        <div class="flex-1 flex flex-col items-center">
            <h1 class="font-serif text-3xl font-semibold tracking-wide mb-6">Shelved.</h1>
            
            <nav class="flex space-x-8 text-sm text-brand-text" id="main-nav">
                <a href="#" id="nav-home" onclick="switchTab('home')" class="tab-active px-6 py-2 -mb-2 relative z-20">Home</a>
                <a href="#" id="nav-books" onclick="switchTab('books')" class="px-2 py-2 text-brand-muted hover:text-brand-text transition-colors relative">Books</a>
                <a href="#" id="nav-stats" onclick="switchTab('stats')" class="px-2 py-2 text-brand-muted hover:text-brand-text transition-colors relative">Stats</a>
                <a href="#" id="nav-explore" onclick="switchTab('explore')" class="px-2 py-2 text-brand-muted hover:text-brand-text transition-colors relative">Explore</a>
            </nav>
        </div>

        <div class="w-1/4 flex justify-end space-x-4">
            <button class="text-brand-text hover:text-brand-primary transition-colors">
                <i data-lucide="bell" class="w-5 h-5"></i>
            </button>
            <button class="text-brand-text hover:text-brand-primary transition-colors">
                <i data-lucide="user" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Wrapper -->
    <main class="w-full max-w-6xl bg-brand-surface rounded-[2rem] p-6 sm:p-10 relative shadow-sm min-h-[80vh]">
        
        <!-- Illustration Placeholders -->
        <div class="absolute -top-6 left-16 w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center border-4 border-brand-surface z-20 hidden md:flex">
             <i data-lucide="book-open" class="w-5 h-5 text-brand-primary"></i>
        </div>
        <div class="absolute -top-6 right-24 w-12 h-12 bg-brand-text rounded-full shadow-sm flex items-center justify-center border-4 border-brand-surface z-20 hidden md:flex">
             <i data-lucide="coffee" class="w-5 h-5 text-white"></i>
        </div>

        <!-- ================= HOME VIEW ================= -->
        <div id="view-home" class="grid grid-cols-1 lg:grid-cols-3 gap-6 block">
            <!-- Currently Reading Section -->
            <section class="lg:col-span-2 bg-brand-card rounded-3xl p-8 shadow-sm flex flex-col">
                <h2 class="text-center font-semibold text-lg mb-8">Currently reading</h2>
                <div id="currently-reading-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 flex-grow"></div>
            </section>

            <!-- Recommended Section -->
            <section class="lg:col-span-1 bg-brand-card rounded-3xl p-8 shadow-sm flex flex-col">
                <h2 class="text-center font-semibold text-lg mb-8">Recommended for you</h2>
                <div id="recommended-container" class="flex flex-col gap-6 flex-grow"></div>
                <div class="text-center mt-8">
                    <a href="#" onclick="showAllRecommendations(); return false;" class="text-sm text-brand-muted hover:text-brand-text underline underline-offset-4 decoration-gray-300">See more</a>
                </div>
            </section>

            <!-- Reading Later Section -->
            <section class="lg:col-span-3 bg-brand-card rounded-3xl p-8 shadow-sm flex flex-col mt-2">
                <h2 class="text-center font-semibold text-lg mb-8">Reading later</h2>
                <div id="reading-later-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 flex-grow"></div>
            </section>

            <!-- Read Section -->
            <section class="lg:col-span-3 bg-brand-card rounded-3xl p-8 shadow-sm flex flex-col mt-2">
                <h2 class="text-center font-semibold text-lg mb-8">Read</h2>
                <div id="read-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6 flex-grow"></div>
            </section>

            <!-- Bottom Section: Challenge & Stats -->
            <section class="lg:col-span-3 bg-brand-card rounded-3xl p-8 shadow-sm flex flex-col md:flex-row items-center gap-10">
                <div class="w-full md:w-5/12 flex flex-col items-center md:items-start pl-0 md:pl-10">
                    <h2 class="font-semibold text-lg mb-6 text-center md:text-left w-full" id="challenge-title">2025 Book challenge</h2>
                    <div class="w-full relative progress-container flex items-center mb-2">
                        <div id="challenge-progress-bar" class="bg-brand-primary h-[10px] rounded-full" style="width: 20%;"></div>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span id="challenge-text" class="text-xs font-medium text-brand-text bg-white/70 px-2 rounded backdrop-blur-sm">2/10 books read</span>
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-7/12 h-40 relative">
                    <canvas id="statsChart"></canvas>
                </div>
            </section>
        </div>

        <!-- ================= FULL RECOMMENDATIONS VIEW (15 Books) ================= -->
        <div id="view-recommendations" class="hidden flex-col gap-6">
            <div class="bg-brand-card rounded-3xl p-8 shadow-sm min-h-[500px]">
                <div class="flex items-center justify-between mb-8 border-b border-gray-100 pb-4">
                    <button onclick="switchTab('home')" class="text-brand-muted hover:text-brand-text transition-colors flex items-center gap-2 text-sm font-medium">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Home
                    </button>
                    <h2 class="font-semibold text-lg text-brand-text text-center flex-1">Recommended specifically for you</h2>
                    <div class="w-24"></div> <!-- Spacer for balance -->
                </div>

                <div id="recs-loading" class="hidden flex justify-center items-center py-20">
                    <svg class="animate-spin h-8 w-8 text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <div id="recs-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </div>
        </div>

        <!-- ================= BOOKS VIEW ================= -->
        <div id="view-books" class="hidden flex-col gap-10">
            <!-- Top Carousel Section -->
            <div class="w-full flex flex-col items-center mt-2">
                <div class="flex items-center w-full justify-between gap-4">
                    <button class="text-brand-muted hover:text-brand-text transition-colors p-2"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <div id="books-carousel-content" class="flex-1 flex gap-8 overflow-hidden justify-center items-center pt-2"></div>
                    <button class="text-brand-muted hover:text-brand-text transition-colors p-2"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div class="flex justify-center gap-1.5 mt-6">
                    <div class="w-6 h-1 bg-brand-primary rounded-full"></div>
                    <div class="w-1.5 h-1.5 bg-brand-primaryLight rounded-full mt-[1px]"></div>
                    <div class="w-1.5 h-1.5 bg-brand-primaryLight rounded-full mt-[1px]"></div>
                </div>
            </div>

            <!-- Bottom List Section -->
            <div class="bg-brand-card rounded-3xl p-8 shadow-sm">
                <div class="mb-6">
                    <button class="flex items-center gap-2 border border-gray-300 rounded-full px-4 py-1.5 text-sm font-medium text-brand-text hover:bg-gray-50 transition-colors">
                        All books <i data-lucide="chevron-down" class="w-4 h-4 text-brand-muted"></i>
                    </button>
                </div>
                <div id="books-list-container" class="flex flex-col"></div>
                <div class="flex justify-between items-center mt-8 pt-4">
                    <button class="text-brand-muted hover:text-brand-text"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <div class="flex gap-2">
                        <div class="w-6 h-1 bg-brand-primary rounded-full"></div>
                        <div class="w-1.5 h-1.5 bg-brand-primaryLight rounded-full mt-[1px]"></div>
                        <div class="w-1.5 h-1.5 bg-brand-primaryLight rounded-full mt-[1px]"></div>
                    </div>
                    <button class="text-brand-muted hover:text-brand-text"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>

        <!-- ================= STATS VIEW ================= -->
        <div id="view-stats" class="hidden flex-col gap-6">
            <div class="bg-brand-card rounded-3xl p-8 sm:p-12 shadow-sm w-full flex flex-col items-center">
                <!-- 1. Circular Challenge -->
                <div class="flex flex-col items-center mb-16 w-full max-w-sm relative">
                    <h2 class="font-semibold text-lg mb-6 text-brand-text" id="full-stats-challenge-title">2025 reading challenge</h2>
                    <div class="relative w-56 h-56 flex items-center justify-center">
                        <canvas id="statsPageDonut"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-xl font-semibold text-brand-text" id="stats-donut-text">2/10</span>
                            <span class="text-sm text-brand-text">books read</span>
                        </div>
                    </div>
                </div>

                <!-- 2. Dual Line Chart -->
                <div class="w-full max-w-3xl flex flex-col items-center mb-16">
                    <h2 class="font-semibold text-md mb-6 text-brand-text">Books read</h2>
                    <div class="w-full h-48 relative mb-8">
                        <canvas id="statsPageDualLine"></canvas>
                    </div>
                    <!-- Custom Chart Legend -->
                    <div class="flex gap-6 mt-2 text-sm font-medium text-brand-text">
                        <div class="flex items-center gap-2"><div class="w-8 h-3 rounded-full bg-brand-primaryDark"></div> Pages read</div>
                        <div class="flex items-center gap-2"><div class="w-8 h-3 rounded-full bg-brand-primaryLight"></div> Books read</div>
                    </div>
                </div>

                <!-- 3. Bottom Split -->
                <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-16 mt-6">
                    <!-- Mood Pie -->
                    <div class="flex flex-col items-center relative">
                        <h2 class="font-semibold text-md mb-6 text-brand-text">Mood</h2>
                        <div class="flex items-center justify-between w-full max-w-[280px]">
                            <button class="text-brand-text hover:text-brand-primary"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <div class="w-48 h-48 relative"><canvas id="statsPagePie"></canvas></div>
                            <button class="text-brand-text hover:text-brand-primary"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        <div class="flex flex-col gap-3 mt-8 w-full max-w-[150px] mr-auto ml-12">
                            <div class="flex items-center gap-3 text-xs font-medium text-brand-muted"><div class="w-3 h-3 rounded-sm bg-brand-primaryUltraLight"></div> emotional</div>
                            <div class="flex items-center gap-3 text-xs font-medium text-brand-muted"><div class="w-3 h-3 rounded-sm bg-brand-primaryLight"></div> mysterious</div>
                            <div class="flex items-center gap-3 text-xs font-medium text-brand-muted"><div class="w-3 h-3 rounded-sm bg-brand-primaryDark"></div> dark</div>
                        </div>
                    </div>

                    <!-- Bars -->
                    <div class="flex flex-col gap-10">
                        <div class="w-full">
                            <h2 class="font-semibold text-md mb-4 text-brand-text text-center">Genres</h2>
                            <div class="h-[120px] w-full"><canvas id="statsPageGenres"></canvas></div>
                        </div>
                        <div class="w-full">
                            <h2 class="font-semibold text-md mb-4 text-brand-text text-center">Languages</h2>
                            <div class="h-[120px] w-full"><canvas id="statsPageLanguages"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= EXPLORE VIEW ================= -->
        <div id="view-explore" class="hidden flex-col gap-6">
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-2">
                <div class="relative w-full sm:w-[400px]">
                    <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-4 h-4 text-brand-muted"></i>
                    <input type="text" id="searchInput" placeholder="Search by title or author" class="w-full bg-white rounded-full py-2.5 pl-10 pr-6 text-sm text-brand-text placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-primaryLight shadow-sm">
                </div>
                <button id="searchBtn" class="bg-brand-primary text-white px-8 py-2.5 rounded-full text-sm font-medium shadow-sm hover:bg-brand-primaryDark transition-colors whitespace-nowrap">
                    Search
                </button>
            </div>

            <!-- Search Results Section -->
            <div id="search-results-section" class="hidden flex-col gap-6 w-full bg-brand-card rounded-3xl p-8 shadow-sm min-h-[300px]">
                <div class="flex justify-between items-center border-b border-gray-100 pb-4">
                    <h3 class="font-semibold text-[15px] text-brand-text">Search Results</h3>
                    <button id="clearSearchBtn" class="text-xs text-brand-primary hover:text-brand-primaryDark transition-colors font-semibold flex items-center gap-1.5">
                        <i data-lucide="x" class="w-3 h-3"></i> Clear search
                    </button>
                </div>
                <div id="search-status" class="text-sm font-medium text-brand-muted hidden text-center mt-4"></div>
                <div id="search-spinner" class="hidden flex justify-center items-center py-12">
                    <svg class="animate-spin h-8 w-8 text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div id="search-results-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </div>

            <!-- Default Explore Content -->
            <div id="explore-default-content" class="bg-brand-card rounded-3xl p-8 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12 md:gap-8">
                    <div class="flex flex-col items-center h-full">
                        <h3 class="font-semibold text-[15px] mb-6 text-brand-text">Trending this week</h3>
                        <div id="explore-trending-container" class="grid grid-cols-2 gap-2 mb-8 w-full max-w-[180px]"></div>
                        <button class="mt-auto border border-brand-primaryLight text-brand-text hover:bg-brand-surface transition-colors rounded-full px-8 py-1.5 text-xs font-semibold">Explore more</button>
                    </div>
                    <div class="flex flex-col items-center h-full">
                        <h3 class="font-semibold text-[15px] mb-6 text-brand-text">For you</h3>
                        <div id="explore-foryou-container" class="grid grid-cols-2 gap-2 mb-8 w-full max-w-[180px]"></div>
                        <button class="mt-auto border border-brand-primaryLight text-brand-text hover:bg-brand-surface transition-colors rounded-full px-8 py-1.5 text-xs font-semibold">Explore more</button>
                    </div>
                    <div class="flex flex-col items-center h-full">
                        <h3 class="font-semibold text-[15px] mb-6 text-brand-text">Genres</h3>
                        <div class="flex flex-col gap-3 mb-8 w-full max-w-[180px]">
                            <button class="bg-brand-surface text-brand-text rounded-md py-3 text-sm font-semibold hover:bg-brand-primaryLight transition-colors w-full text-center">Thriller</button>
                            <button class="bg-brand-surface text-brand-text rounded-md py-3 text-sm font-semibold hover:bg-brand-primaryLight transition-colors w-full text-center">Non-fiction</button>
                            <button class="bg-brand-surface text-brand-text rounded-md py-3 text-sm font-semibold hover:bg-brand-primaryLight transition-colors w-full text-center">Fantasy</button>
                            <button class="bg-brand-surface text-brand-text rounded-md py-3 text-sm font-semibold hover:bg-brand-primaryLight transition-colors w-full text-center">Young-adult</button>
                        </div>
                        <button class="mt-auto border border-brand-primaryLight text-brand-text hover:bg-brand-surface transition-colors rounded-full px-8 py-1.5 text-xs font-semibold">Explore more</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ================= BOOK DETAILS SECTION (Hidden) ================= -->
        <div id="book-details-section" class="hidden flex-col gap-6 w-full bg-brand-card rounded-3xl p-8 sm:p-12 shadow-sm min-h-[500px]">
            <button onclick="closeBookDetails()" class="text-brand-muted hover:text-brand-text transition-colors flex items-center gap-2 text-sm font-medium w-fit mb-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
            </button>
            
            <div id="book-details-loading" class="hidden flex justify-center items-center py-20">
                <svg class="animate-spin h-8 w-8 text-brand-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            <div id="book-details-content" class="flex flex-col gap-10">
                <!-- Detailed view injected here via JS -->
            </div>
        </div>

    </main>

    <!-- Application Logic -->
    <script>
        lucide.createIcons();

        // Object to track active chart instances
        const charts = {};
        
        // Global State Trackers
        let globalUserAuthors = [];
        let globalUserTitles = [];
        let globalCurrentlyReading = []; // Track to update progress easily
        let lastViewBeforeDetails = 'home';
        let lastActiveTab = 'home';
        let currentlyViewingBook = null;
        let currentlyEditingBookId = null;

        const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const MOCK_DATA = {
            currentlyReading: [
                { id: 1, title: 'Fourth Wing', author: 'Rebecca Yarros', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781649374042-M.jpg', progress: 37, current_page: 185, total_pages: 500 },
                { id: 2, title: 'The Nickel Boys', author: 'Colson Whitehead', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780385537070-M.jpg', progress: 58, current_page: 123, total_pages: 213 },
                { id: 3, title: 'The Only One Left', author: 'Riley Sager', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780593183428-M.jpg', progress: 90, current_page: 345, total_pages: 383 },
                { id: 4, title: 'Wool', author: 'Hugh Howey', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781476733951-M.jpg', progress: 75, current_page: 420, total_pages: 560 },
            ],
            readingLater: [
                { id: 101, title: 'Project Hail Mary', author: 'Andy Weir', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780593135204-M.jpg' },
                { id: 102, title: 'Dark Matter', author: 'Blake Crouch', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781101904220-M.jpg' }
            ],
            readBooks: [
                { id: 201, title: '1984', author: 'George Orwell', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780451524935-M.jpg' },
                { id: 202, title: 'Educated', author: 'Tara Westover', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780399590504-M.jpg' }
            ],
            recommended: [
                { id: 5, title: 'Onyx Storm', author: 'Rebecca Yarros', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781649374165-M.jpg', rating: 4.45 },
                { id: 6, title: 'None of This is True', author: 'Lisa Jewell', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781982171682-M.jpg', rating: 4.10 },
            ],
            challenge: { year: 2025, read: 2, target: 10 },
            stats: [0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            fullStats: {
                pagesRead: [100, 250, null, null, null, null, null, null, null, null, null, null],
                booksRead: [1, 2, null, null, null, null, null, null, null, null, null, null],
                mood: { emotional: 50, mysterious: 25, dark: 25 },
                genres: { drama: 1, comedy: 0, thriller: 1 },
                languages: { english: 1, polish: 0, ukrainian: 1 }
            },
            allBooksList: [
                { id: 10, title: 'Educated', author: 'Tara Westover', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780399590504-M.jpg', rating: 4.47, status: 'To read', description: 'A memoir about a woman who grows up in a strict and isolated survivalist family...' },
                { id: 2, title: 'The Nickel Boys', author: 'Colson Whitehead', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780385537070-M.jpg', rating: 4.26, status: 'Currently reading', progress: 58, description: 'In this Pulitzer Prize-winning novel...' },
            ],
            exploreTrending: [
                { id: 20, title: 'Warrior Girl Unearthed', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781250232288-M.jpg' },
                { id: 21, title: 'Society of Lies', coverUrl: 'https://covers.openlibrary.org/b/isbn/9780593499420-M.jpg' },
            ],
            exploreForYou: [
                { id: 24, title: 'Verity', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781538724736-M.jpg' },
                { id: 25, title: 'A Court of Thorns and Roses', coverUrl: 'https://covers.openlibrary.org/b/isbn/9781619634442-M.jpg' },
            ]
        };

        // --- Navigation Logic ---
        function switchTab(tabId) {
            const navLinks = ['home', 'books', 'explore', 'stats']; 
            
            navLinks.forEach(id => {
                const el = document.getElementById(`nav-${id}`);
                const viewEl = document.getElementById(`view-${id}`);
                if(el) el.className = 'px-2 py-2 text-brand-muted hover:text-brand-text transition-colors relative';
                if(viewEl) {
                    viewEl.classList.add('hidden');
                    viewEl.classList.remove(id === 'home' ? 'grid' : 'flex');
                }
            });

            const activeEl = document.getElementById(`nav-${tabId}`);
            if(activeEl) activeEl.className = 'tab-active px-6 py-2 -mb-2 relative z-20';

            const activeView = document.getElementById(`view-${tabId}`);
            if(activeView) {
                activeView.classList.remove('hidden');
                activeView.classList.add(tabId === 'home' ? 'grid' : 'flex');
            }
            
            // Hide custom views
            document.getElementById('view-recommendations').classList.add('hidden');
            document.getElementById('book-details-section').classList.add('hidden');

            lastActiveTab = tabId;
        }

        // --- Progress Update Logic ---
        function openProgressModal(bookId) {
            const book = globalCurrentlyReading.find(b => b.id === bookId);
            if(!book) return;
            
            currentlyEditingBookId = bookId;
            document.getElementById('progress-current').value = book.current_page || 0;
            document.getElementById('progress-total').value = book.total_pages || 300;
            
            const modal = document.getElementById('progress-modal');
            modal.classList.remove('hidden');
        }

        function closeProgressModal() {
            document.getElementById('progress-modal').classList.add('hidden');
            currentlyEditingBookId = null;
        }

        async function saveProgress() {
            if(!currentlyEditingBookId) return;
            
            const current = parseInt(document.getElementById('progress-current').value) || 0;
            const total = parseInt(document.getElementById('progress-total').value) || 1;
            const pct = Math.min(100, Math.round((current / total) * 100));

            // Update fallback mock data instantly
            const mockBook = MOCK_DATA.currentlyReading.find(b => b.id === currentlyEditingBookId);
            if(mockBook) {
                mockBook.current_page = current;
                mockBook.total_pages = total;
                mockBook.progress = pct;
            }

            try {
                const { error } = await supabaseClient
                    .from('currently_reading')
                    .update({ current_page: current, total_pages: total, progress: pct })
                    .eq('id', currentlyEditingBookId);
                    
                if (error) throw error;
                showToast('Progress saved!');
            } catch(e) {
                console.warn('DB update failed, using local state.', e);
                showToast('Progress updated locally.', 'success');
            }

            closeProgressModal();
            fetchSupabaseData(); // Refresh UI
        }


        // --- Render UI Data ---
        function renderCurrentlyReading(books) {
            globalCurrentlyReading = books; // Save to global state for editing
            const container = document.getElementById('currently-reading-container');
            if(!container) return;
            container.innerHTML = '';
            
            books.forEach(book => {
                const bookEl = document.createElement('div');
                bookEl.className = 'flex flex-col items-center group cursor-pointer';
                
                // Make the Currently Reading books clickable
                bookEl.onclick = () => openDetailedView({
                    title: book.title,
                    author_name: [book.author],
                    coverUrl: book.coverUrl,
                    key: typeof book.id === 'string' && book.id.startsWith('/') ? book.id : null,
                    total_pages: book.total_pages
                }, 'home');

                const currentPage = book.current_page || 0;
                const totalPages = book.total_pages || 300;
                const progressPct = book.progress || Math.round((currentPage / totalPages) * 100) || 0;

                const imgHTML = `<img src="${book.coverUrl}" alt="${book.title}" class="w-full aspect-[2/3] object-cover rounded-md mb-2 book-shadow transition-transform group-hover:-translate-y-1" onerror="this.onerror=null; this.outerHTML='<div class=\\'w-full aspect-[2/3] bg-gray-800 text-white rounded-md mb-2 book-shadow flex items-center justify-center p-2 text-center text-xs font-semibold\\'>${book.title}</div>'">`;
                
                bookEl.innerHTML = `
                    ${imgHTML}
                    <div class="w-full relative progress-container flex items-center mb-1 mt-2">
                        <div class="bg-brand-primary h-[10px] rounded-full" style="width: ${progressPct}%;"></div>
                    </div>
                    <div class="flex justify-between items-center w-full px-1">
                        <span class="text-[11px] text-brand-muted font-medium">${progressPct}%</span>
                        <button onclick="openProgressModal('${book.id}' || ${book.id}); event.stopPropagation();" class="text-brand-muted hover:text-brand-primary transition-colors p-1" title="Update progress">
                            <i data-lucide="edit-2" class="w-[14px] h-[14px]"></i>
                        </button>
                    </div>
                `;
                container.appendChild(bookEl);
            });
            lucide.createIcons();
        }

        function renderRecommended(books) {
            const container = document.getElementById('recommended-container');
            if(!container) return;
            container.innerHTML = '';
            
            books.forEach((book) => {
                const bookEl = document.createElement('div');
                bookEl.className = 'flex gap-4 items-center group cursor-pointer';
                
                // Trigger detail view when clicked!
                bookEl.onclick = () => openDetailedView({
                    title: book.title,
                    author_name: [book.author],
                    coverUrl: book.coverUrl,
                    key: typeof book.id === 'string' && book.id.startsWith('/') ? book.id : null
                }, 'home');

                const imgHTML = `<img src="${book.coverUrl}" alt="${book.title}" class="w-16 h-24 object-cover rounded-md book-shadow transition-transform group-hover:scale-105" onerror="this.onerror=null; this.outerHTML='<div class=\\'w-16 h-24 bg-gray-800 text-white rounded-md book-shadow flex items-center justify-center p-1 text-center text-[10px] font-semibold\\'>${book.title}</div>'">`;
                bookEl.innerHTML = `
                    ${imgHTML}
                    <div class="flex flex-col">
                        <h3 class="font-semibold text-sm text-brand-text mb-0.5">${book.title}</h3>
                        <p class="text-xs text-brand-muted mb-2">by ${book.author}</p>
                        <div class="flex items-center text-xs text-brand-muted">
                            <i data-lucide="star" class="w-3 h-3 text-brand-primary fill-brand-primary mr-1"></i>
                            <span>${book.rating?.toFixed(2) || '4.00'}</span>
                        </div>
                    </div>
                `;
                container.appendChild(bookEl);
            });
            lucide.createIcons();
        }

        function renderChallenge(challenge) {
            document.getElementById('challenge-title').textContent = `${challenge.year} Book challenge`;
            const percentage = (challenge.read / challenge.target) * 100;
            document.getElementById('challenge-progress-bar').style.width = `${percentage}%`;
            document.getElementById('challenge-text').textContent = `${challenge.read}/${challenge.target} books read`;
            document.getElementById('full-stats-challenge-title').textContent = `${challenge.year} reading challenge`;
            document.getElementById('stats-donut-text').textContent = `${challenge.read}/${challenge.target}`;
        }

        function renderBookListBasic(books, containerId) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = '';
            
            books.forEach(book => {
                const bookEl = document.createElement('div');
                bookEl.className = 'flex flex-col items-center group cursor-pointer';
                
                // Make the Reading Later and Read books clickable
                bookEl.onclick = () => openDetailedView({
                    title: book.title,
                    author_name: [book.author],
                    coverUrl: book.coverUrl,
                    key: typeof book.id === 'string' && book.id.startsWith('/') ? book.id : null
                }, 'home');

                const imgHTML = `<img src="${book.coverUrl}" alt="${book.title}" class="w-full aspect-[2/3] object-cover rounded-md mb-3 book-shadow transition-transform group-hover:-translate-y-1" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'150\\' style=\\'background:%23e2e8f0\\'></svg>'">`;
                bookEl.innerHTML = `
                    ${imgHTML}
                    <h4 class="font-semibold text-xs text-brand-text text-center line-clamp-1 w-full" title="${book.title}">${book.title}</h4>
                    <p class="text-[10px] text-brand-muted text-center line-clamp-1 w-full mt-0.5">by ${book.author}</p>
                `;
                container.appendChild(bookEl);
            });
        }

        // --- Chart Methods ---
        function createChart(ctxId, config) {
            if (charts[ctxId]) charts[ctxId].destroy();
            const ctx = document.getElementById(ctxId).getContext('2d');
            charts[ctxId] = new Chart(ctx, config);
        }
        function renderHomeChart(dataPoints) { createChart('statsChart', { type: 'line', data: { labels: ['1','2','3','4','5','6','7','8','9','10','11','12'], datasets: [{ data: dataPoints, borderColor: '#f97316', backgroundColor: '#f97316', borderWidth: 1.5, pointBackgroundColor: '#f97316', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: (ctx) => ctx.raw > 0 ? 4 : 0, tension: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 1, max: 5, ticks: { stepSize: 1, color: '#a0aec0', font: { size: 10 } }, border: { display: false }, grid: { color: '#fde9d9', drawTicks: false }, title: { display: true, text: 'Books', align: 'end', color: '#a0aec0', font: { size: 10 }, padding: { bottom: -15 } } }, x: { ticks: { color: '#a0aec0', font: { size: 10 } }, border: { display: false }, grid: { display: false }, title: { display: true, text: 'Months', align: 'end', color: '#a0aec0', font: { size: 10 } } } } } }); }
        function renderFullStatsGraphs(challenge, stats) {
            createChart('statsPageDonut', { type: 'doughnut', data: { labels: ['Read', 'Remaining'], datasets: [{ data: [challenge.read, challenge.target - challenge.read], backgroundColor: ['#f97316', '#ffedd5'], borderWidth: 0, borderRadius: 20 }] }, options: { cutout: '75%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
            createChart('statsPageDualLine', { type: 'line', data: { labels: ['1','2','3','4','5','6','7','8','9','10','11','12'], datasets: [ { label: 'Pages read', data: stats.pagesRead, borderColor: '#d97706', backgroundColor: '#d97706', yAxisID: 'yPages', pointBackgroundColor: '#d97706', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: (ctx) => ctx.raw !== null ? 4 : 0, tension: 0 }, { label: 'Books read', data: stats.booksRead, borderColor: '#fdba74', backgroundColor: '#fdba74', yAxisID: 'yBooks', pointBackgroundColor: '#fdba74', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: (ctx) => ctx.raw !== null ? 4 : 0, tension: 0 } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#a0aec0', font: { size: 10 } }, grid: { display: false }, border: { display: false }, title: { display: true, text: 'Months', align: 'end', color: '#a0aec0', font: { size: 10 } } }, yBooks: { type: 'linear', position: 'left', min: 1, max: 5, ticks: { stepSize: 1, color: '#a0aec0', font: { size: 10 } }, grid: { color: '#fde9d9', drawTicks: false }, border: { display: false }, title: { display: true, text: 'Books', align: 'end', color: '#a0aec0', font: { size: 10 }, padding: { bottom: -15 } } }, yPages: { type: 'linear', position: 'right', min: 100, max: 500, ticks: { stepSize: 100, color: '#a0aec0', font: { size: 10 } }, grid: { display: false }, border: { display: false }, title: { display: true, text: 'Pages', align: 'end', color: '#a0aec0', font: { size: 10 }, padding: { bottom: -15 } } } } } });
            createChart('statsPagePie', { type: 'pie', data: { labels: ['emotional', 'mysterious', 'dark'], datasets: [{ data: [stats.mood.emotional, stats.mood.mysterious, stats.mood.dark], backgroundColor: ['#ffedd5', '#fdba74', '#d97706'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            const barOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { min: 0, max: 4, ticks: { stepSize: 1, color: '#a0aec0', font: { size: 10 } }, grid: { display: false }, border: { color: '#a0aec0' } }, y: { ticks: { color: '#2d3748', font: { size: 11 } }, grid: { display: false }, border: { color: '#a0aec0' } } } };
            createChart('statsPageGenres', { type: 'bar', data: { labels: ['drama', 'comedy', 'thriller'], datasets: [{ data: [stats.genres.drama, stats.genres.comedy, stats.genres.thriller], backgroundColor: '#f97316', barThickness: 10, borderRadius: 5 }] }, options: barOptions });
            createChart('statsPageLanguages', { type: 'bar', data: { labels: ['English', 'Polish', 'Ukrainian'], datasets: [{ data: [stats.languages.english, stats.languages.polish, stats.languages.ukrainian], backgroundColor: '#f97316', barThickness: 10, borderRadius: 5 }] }, options: barOptions });
        }

        function renderBooksViewCarousel(books) { 
            const container = document.getElementById('books-carousel-content'); 
            if(!container) return; 
            container.innerHTML = ''; 
            books.slice(0, 3).forEach(book => { 
                const bookEl = document.createElement('div'); 
                bookEl.className = 'flex items-center gap-4 w-[280px] shrink-0 cursor-pointer group'; 
                
                // Make carousel items clickable
                bookEl.onclick = () => openDetailedView({
                    title: book.title,
                    author_name: [book.author],
                    coverUrl: book.coverUrl,
                    key: typeof book.id === 'string' && book.id.startsWith('/') ? book.id : null,
                    total_pages: book.total_pages
                }, 'books');

                const currentPage = book.current_page || 0;
                const totalPages = book.total_pages || 300;
                const progressPct = book.progress || Math.round((currentPage / totalPages) * 100) || 0;

                const imgHTML = `<img src="${book.coverUrl}" alt="${book.title}" class="w-16 h-[6.5rem] object-cover rounded-md book-shadow shrink-0 transition-transform group-hover:scale-105" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'64\\' height=\\'104\\' style=\\'background:%23333\\'></svg>'">`; 
                bookEl.innerHTML = `${imgHTML}<div class="flex flex-col flex-1 min-w-0"><h4 class="font-semibold text-sm text-brand-text truncate group-hover:text-brand-primary transition-colors">${book.title}</h4><p class="text-[10px] text-brand-muted mb-2 truncate">by ${book.author}</p><div class="flex items-center gap-2 mb-2"><div class="w-full relative progress-container flex items-center"><div class="bg-brand-primary h-[10px] rounded-full" style="width: ${progressPct}%;"></div></div><span class="text-[10px] text-brand-muted font-medium">${progressPct}%</span></div><button onclick="openProgressModal('${book.id}' || ${book.id}); event.stopPropagation();" class="border border-brand-primaryLight text-brand-primary hover:bg-brand-primary hover:text-white transition-colors rounded-full px-4 py-1 text-[10px] font-semibold w-fit mx-auto mt-1">Update progress</button></div>`; 
                container.appendChild(bookEl); 
            }); 
        }

        function renderBooksList(books) { 
            const container = document.getElementById('books-list-container'); 
            if(!container) return; 
            container.innerHTML = ''; 
            books.forEach(book => { 
                const bookEl = document.createElement('div'); 
                bookEl.className = 'flex flex-col sm:flex-row gap-6 py-8 border-b border-gray-100 last:border-0 cursor-pointer group'; 
                
                // Make list items clickable
                bookEl.onclick = (e) => {
                    // Prevent triggering if they clicked the status button
                    if(e.target.closest('button')) return;
                    openDetailedView({
                        title: book.title,
                        author_name: [book.author],
                        coverUrl: book.coverUrl,
                        key: typeof book.id === 'string' && book.id.startsWith('/') ? book.id : null,
                        total_pages: book.total_pages
                    }, 'books');
                };

                const imgHTML = `<img src="${book.coverUrl}" alt="${book.title}" class="w-[5.5rem] h-[8.5rem] object-cover rounded-md book-shadow shrink-0 transition-transform group-hover:-translate-y-1" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'88\\' height=\\'136\\' style=\\'background:%23333\\'></svg>'">`; 
                let rightSideHTML = ''; 
                if (book.status === 'Currently reading') { 
                    const currentPage = book.current_page || 0;
                    const totalPages = book.total_pages || 300;
                    const progressPct = book.progress || Math.round((currentPage / totalPages) * 100) || 0;
                    rightSideHTML = `<div class="w-full relative progress-container flex items-center mt-3"><div class="bg-brand-primary h-[10px] rounded-full" style="width: ${progressPct}%;"></div></div><span class="text-[10px] text-brand-muted font-medium w-full text-center mt-1">${progressPct}%</span>`; 
                } else if (book.status === 'Read') { 
                    rightSideHTML = `<div class="text-[10px] text-brand-muted mt-3 text-right">Added:<br>${book.readDates || 'Recently'}</div>`; 
                } 
                bookEl.innerHTML = `${imgHTML}<div class="flex-1 flex flex-col"><h3 class="text-lg font-semibold text-brand-text mb-0.5 group-hover:text-brand-primary transition-colors">${book.title}</h3><p class="text-sm text-brand-muted mb-3">by ${book.author}</p><p class="text-sm text-brand-text leading-relaxed line-clamp-3 mb-3">${book.description}</p><div class="flex items-center text-sm font-semibold text-brand-text mt-auto"><i data-lucide="star" class="w-4 h-4 text-brand-primary fill-brand-primary mr-1"></i> ${book.rating.toFixed(2)}</div></div><div class="w-full sm:w-40 flex flex-col items-end shrink-0 mt-4 sm:mt-0"><button class="w-full flex items-center justify-between border border-gray-300 rounded-full px-4 py-1.5 text-xs font-semibold text-brand-text hover:bg-gray-50 transition-colors">${book.status} <i data-lucide="chevron-down" class="w-3 h-3 ml-2 text-brand-muted"></i></button>${rightSideHTML}</div>`; 
                container.appendChild(bookEl); 
            }); 
            lucide.createIcons(); 
        }

        function renderExploreGrid(books, containerId) { const container = document.getElementById(containerId); if (!container) return; container.innerHTML = ''; books.forEach(book => { const imgHTML = `<img src="${book.coverUrl}" alt="${book.title}" class="w-full h-auto aspect-[2/3] object-cover rounded shadow-sm hover:scale-105 transition-transform cursor-pointer" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'150\\' style=\\'background:%23333\\'></svg>'">`; container.innerHTML += imgHTML; }); }

        // --- Fetch & Initializing ---
        async function fetchDynamicRecommendations(authors, existingTitles) {
            const shuffledAuthors = authors.sort(() => 0.5 - Math.random()).slice(0, 2);
            let recommendations = [];
            for (const author of shuffledAuthors) {
                if (recommendations.length >= 2) break;
                try {
                    const res = await fetch(`https://openlibrary.org/search.json?author=${encodeURIComponent(author)}&limit=10`);
                    if (res.ok) {
                        const data = await res.json();
                        const validBooks = (data.docs || []).filter(b => 
                            b.title && b.cover_i && !existingTitles.some(t => t.toLowerCase() === b.title.toLowerCase()) && !recommendations.find(r => r.title === b.title)
                        );
                        validBooks.forEach(b => {
                            if (recommendations.length < 2) {
                                recommendations.push({
                                    id: b.key, title: b.title, author: b.author_name ? b.author_name[0] : author,
                                    coverUrl: `https://covers.openlibrary.org/b/id/${b.cover_i}-M.jpg`,
                                    rating: parseFloat((Math.random() * (4.9 - 3.8) + 3.8).toFixed(2))
                                });
                            }
                        });
                    }
                } catch(e) { console.error("Error fetching recommendations", e); }
            }
            return recommendations;
        }

        async function fetchSupabaseData() {
            try {
                const { data: readingData, error: readErr } = await supabaseClient.from('currently_reading').select('*').order('created_at', { ascending: false }).limit(4);
                if (readErr) throw readErr;

                const { data: challengeData, error: chalErr } = await supabaseClient.from('reading_challenge').select('*').single();
                if (chalErr) throw chalErr;

                const { data: statsData, error: statErr } = await supabaseClient.from('monthly_stats').select('month, count').order('month', { ascending: true });
                if (statErr) throw statErr;

                let readingLaterList = MOCK_DATA.readingLater;
                let readBooksList = MOCK_DATA.readBooks;
                
                try {
                    const { data: laterData, error: laterErr } = await supabaseClient.from('reading_later').select('*').order('created_at', { ascending: false }).limit(6);
                    if (!laterErr && laterData) readingLaterList = laterData;
                } catch(e) {}

                try {
                    const { data: rData, error: rErr } = await supabaseClient.from('read_books').select('*').order('created_at', { ascending: false }).limit(6);
                    if (!rErr && rData) readBooksList = rData;
                } catch(e) {}

                const activeCurrentlyReading = readingData && readingData.length > 0 ? readingData : MOCK_DATA.currentlyReading;
                renderCurrentlyReading(activeCurrentlyReading);
                renderBookListBasic(readingLaterList, 'reading-later-container');
                renderBookListBasic(readBooksList, 'read-container');
                renderChallenge(challengeData ? challengeData : MOCK_DATA.challenge);
                
                // Track global authors/titles for recommendations page
                const allUserBooks = [...activeCurrentlyReading, ...readingLaterList, ...readBooksList];
                globalUserAuthors = [...new Set(allUserBooks.map(b => b.author).filter(Boolean))];
                globalUserTitles = allUserBooks.map(b => b.title);

                renderRecommended(MOCK_DATA.recommended);

                if (globalUserAuthors.length > 0) {
                    fetchDynamicRecommendations(globalUserAuthors, globalUserTitles).then(dynamicRecs => {
                        if (dynamicRecs.length > 0) {
                            if (dynamicRecs.length < 2) dynamicRecs = [...dynamicRecs, ...MOCK_DATA.recommended.slice(0, 2 - dynamicRecs.length)];
                            renderRecommended(dynamicRecs);
                        }
                    });
                }

                if (statsData && statsData.length > 0) {
                    let chartArr = new Array(12).fill(0);
                    statsData.forEach(item => chartArr[item.month - 1] = item.count);
                    renderHomeChart(chartArr);
                } else {
                    renderHomeChart(MOCK_DATA.stats);
                }

                // Compile Books Tab Data from User's Shelves
                const mappedCurrentlyReading = activeCurrentlyReading.map(b => ({ ...b, status: 'Currently reading' }));
                const mappedReadingLater = readingLaterList.map(b => ({ ...b, status: 'Reading later' }));
                const mappedRead = readBooksList.map(b => ({ 
                    ...b, 
                    status: 'Read', 
                    readDates: b.created_at ? new Date(b.created_at).toLocaleDateString() : 'Recently'
                }));
                
                const combinedLibrary = [...mappedCurrentlyReading, ...mappedReadingLater, ...mappedRead].map(b => ({
                    ...b,
                    rating: b.rating || parseFloat((Math.random() * (4.9 - 3.8) + 3.8).toFixed(2)),
                    description: b.description || 'A fascinating book from your personal library collection.'
                }));

                renderBooksViewCarousel(activeCurrentlyReading);
                renderBooksList(combinedLibrary.length > 0 ? combinedLibrary : MOCK_DATA.allBooksList);
                
                renderExploreGrid(MOCK_DATA.exploreTrending, 'explore-trending-container');
                renderExploreGrid(MOCK_DATA.exploreForYou, 'explore-foryou-container');
                renderFullStatsGraphs(challengeData ? challengeData : MOCK_DATA.challenge, MOCK_DATA.fullStats);

            } catch (error) {
                console.log("Supabase missing/empty. Using fallback data.", error.message);
                
                renderCurrentlyReading(MOCK_DATA.currentlyReading);
                renderBookListBasic(MOCK_DATA.readingLater, 'reading-later-container');
                renderBookListBasic(MOCK_DATA.readBooks, 'read-container');
                renderChallenge(MOCK_DATA.challenge);
                renderHomeChart(MOCK_DATA.stats);
                
                const allMockBooks = [...MOCK_DATA.currentlyReading, ...MOCK_DATA.readingLater, ...MOCK_DATA.readBooks];
                globalUserAuthors = [...new Set(allMockBooks.map(b => b.author).filter(Boolean))];
                globalUserTitles = allMockBooks.map(b => b.title);

                renderRecommended(MOCK_DATA.recommended);
                fetchDynamicRecommendations(globalUserAuthors, globalUserTitles).then(recs => {
                    if (recs.length === 2) renderRecommended(recs);
                });
                
                // Fallback compilation for Books Tab
                const mappedMockCR = MOCK_DATA.currentlyReading.map(b => ({ ...b, status: 'Currently reading' }));
                const mappedMockRL = MOCK_DATA.readingLater.map(b => ({ ...b, status: 'Reading later' }));
                const mappedMockR = MOCK_DATA.readBooks.map(b => ({ ...b, status: 'Read', readDates: 'Recently' }));
                const combinedMockLibrary = [...mappedMockCR, ...mappedMockRL, ...mappedMockR].map(b => ({
                    ...b,
                    rating: b.rating || parseFloat((Math.random() * (4.9 - 3.8) + 3.8).toFixed(2)),
                    description: b.description || 'A fascinating book from your personal library collection.'
                }));

                renderBooksViewCarousel(MOCK_DATA.currentlyReading);
                renderBooksList(combinedMockLibrary);
                
                renderExploreGrid(MOCK_DATA.exploreTrending, 'explore-trending-container');
                renderExploreGrid(MOCK_DATA.exploreForYou, 'explore-foryou-container');
                renderFullStatsGraphs(MOCK_DATA.challenge, MOCK_DATA.fullStats);
            }
        }

        // --- NEW: Dynamic See More Recommendations ---
        async function showAllRecommendations() {
            // Hide standard tabs
            ['home', 'books', 'explore', 'stats', 'recommendations'].forEach(id => {
                const view = document.getElementById(`view-${id}`);
                if (view) view.classList.add('hidden');
            });
            document.getElementById('book-details-section').classList.add('hidden');
            
            // Show recommendations grid
            document.getElementById('view-recommendations').classList.remove('hidden');
            
            const grid = document.getElementById('recs-grid');
            const loading = document.getElementById('recs-loading');
            
            grid.innerHTML = '';
            loading.classList.remove('hidden');

            // Pick random authors from library, fallback to popular if empty
            let authorsToSearch = globalUserAuthors.length > 0 
                ? [...globalUserAuthors].sort(() => 0.5 - Math.random()).slice(0, 4)
                : ['Stephen King', 'J.K. Rowling', 'Agatha Christie', 'George R.R. Martin'];

            let allRecs = [];
            const fetchPromises = authorsToSearch.map(author => 
                fetch(`https://openlibrary.org/search.json?author=${encodeURIComponent(author)}&limit=15`)
                    .then(res => res.ok ? res.json() : { docs: [] })
                    .then(data => {
                        const validBooks = (data.docs || []).filter(b => 
                            b.title && b.cover_i && 
                            !globalUserTitles.some(t => t.toLowerCase() === b.title.toLowerCase())
                        );
                        allRecs = allRecs.concat(validBooks);
                    }).catch(err => console.error(err))
            );

            await Promise.all(fetchPromises);

            // Deduplicate titles
            const uniqueRecs = [];
            const seenTitles = new Set();
            for (const book of allRecs) {
                if (!seenTitles.has(book.title.toLowerCase())) {
                    seenTitles.add(book.title.toLowerCase());
                    uniqueRecs.push(book);
                }
            }

            // Shuffle and cap at 15
            const finalRecs = uniqueRecs.sort(() => 0.5 - Math.random()).slice(0, 15);

            loading.classList.add('hidden');

            if (finalRecs.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-brand-muted py-8">No recommendations found right now.</p>';
                return;
            }

            finalRecs.forEach(book => {
                const title = book.title || 'Unknown Title';
                const author = book.author_name ? book.author_name[0] : 'Unknown Author';
                const year = book.first_publish_year || 'N/A';
                const coverUrl = `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg`; 
                const totalPages = book.number_of_pages_median || 300;
                
                const mappedBook = { title, author_name: [author], cover_i: book.cover_i, key: book.key, coverUrl: coverUrl, total_pages: totalPages };

                const cardHTML = document.createElement('div');
                cardHTML.className = "flex flex-col gap-2 group cursor-pointer h-full";
                cardHTML.onclick = () => openDetailedView(mappedBook, 'recommendations');
                cardHTML.innerHTML = `
                    <img src="${coverUrl}" alt="${title}" class="w-full aspect-[2/3] object-cover rounded-md book-shadow transition-transform group-hover:-translate-y-1" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'150\\' style=\\'background:%23e2e8f0\\'></svg>'">
                    <div class="flex flex-col mt-1 flex-1">
                        <h4 class="font-semibold text-sm text-brand-text line-clamp-2 leading-snug" title="${title}">${title}</h4>
                        <p class="text-[11px] text-brand-muted mt-1 truncate" title="${author}">by ${author}</p>
                        <p class="text-[10px] text-brand-primary mt-auto pt-1">First published: ${year}</p>
                    </div>
                `;
                grid.appendChild(cardHTML);
            });
            lucide.createIcons();
        }


        // --- Library Saving Logic & Toasts ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-xl shadow-lg text-sm font-semibold text-white transition-opacity duration-300 transform scale-95 opacity-0 ${type === 'success' ? 'bg-brand-primary' : 'bg-red-500'}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'scale-95');
                toast.classList.add('opacity-100', 'scale-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'scale-100');
                toast.classList.add('opacity-0', 'scale-95');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function saveBookToLibrary(statusTable) {
            const book = currentlyViewingBook;
            if (!book) return;

            const dropdown = document.getElementById(`dropdown-details`);
            if(dropdown) dropdown.classList.add('hidden');

            const title = book.title || 'Unknown Title';
            const author = book.author_name ? book.author_name[0] : 'Unknown Author';
            const coverUrl = book.coverUrl || (book.cover_i ? `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg` : ''); 

            try {
                const payload = { title, author, coverUrl };
                if (statusTable === 'currently_reading') {
                    payload.progress = 0;
                    payload.current_page = 0;
                    payload.total_pages = book.total_pages || 300; // Passed from search API
                }

                const { error } = await supabaseClient.from(statusTable).insert([payload]);
                
                if (error) {
                    if (error.code === '42P01') throw new Error(`Table '${statusTable}' does not exist.`);
                    if (error.code === '42501') throw new Error(`Permission denied.`);
                    throw error;
                }
                
                let statusText = statusTable === 'currently_reading' ? 'Currently Reading' : (statusTable === 'reading_later' ? 'Reading Later' : 'Read');
                showToast(`Added to ${statusText}!`);
                
                fetchSupabaseData(); // Refresh UI lists
            } catch (err) {
                console.error("Save failed:", err);
                showToast(err.message || 'Failed to add book.', 'error');
            }
        }

        // --- Open Library Search & Detailed View ---
        async function searchBooks() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const defaultContent = document.getElementById('explore-default-content');
            const resultsSection = document.getElementById('search-results-section');
            const resultsGrid = document.getElementById('search-results-grid');
            const searchStatus = document.getElementById('search-status');
            const searchSpinner = document.getElementById('search-spinner');

            defaultContent.classList.add('hidden');
            document.getElementById('book-details-section').classList.add('hidden');
            resultsSection.classList.remove('hidden');
            searchSpinner.classList.remove('hidden');
            resultsGrid.innerHTML = '';
            searchStatus.textContent = '';
            searchStatus.classList.add('hidden');

            try {
                const response = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=15`);
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();

                searchSpinner.classList.add('hidden');

                if (!data.docs || data.docs.length === 0) {
                    searchStatus.textContent = `No results found for "${query}". Try another title or author.`;
                    searchStatus.classList.remove('hidden');
                    return;
                }

                data.docs.forEach((book) => {
                    const title = book.title || 'Unknown Title';
                    const author = book.author_name ? book.author_name[0] : 'Unknown Author';
                    const year = book.first_publish_year || 'N/A';
                    const coverUrl = book.cover_i ? `https://covers.openlibrary.org/b/id/${book.cover_i}-M.jpg` : ''; 
                    const totalPages = book.number_of_pages_median || 300;
                    
                    // Attach the evaluated values so it doesn't get lost
                    book.coverUrl = coverUrl;
                    book.total_pages = totalPages;

                    const cardHTML = document.createElement('div');
                    cardHTML.className = "flex flex-col gap-2 group cursor-pointer h-full";
                    cardHTML.onclick = () => openDetailedView(book, 'search-results');
                    cardHTML.innerHTML = `
                        <img src="${coverUrl || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='150' style='background:%23fde9d9'></svg>"}" alt="${title}" class="w-full aspect-[2/3] object-cover rounded-md book-shadow transition-transform group-hover:-translate-y-1" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'100\\' height=\\'150\\' style=\\'background:%23e2e8f0\\'></svg>'">
                        <div class="flex flex-col mt-1 flex-1">
                            <h4 class="font-semibold text-sm text-brand-text line-clamp-2 leading-snug" title="${title}">${title}</h4>
                            <p class="text-[11px] text-brand-muted mt-1 truncate" title="${author}">by ${author}</p>
                            <p class="text-[10px] text-brand-primary mt-auto pt-1">First published: ${year}</p>
                        </div>
                    `;
                    resultsGrid.appendChild(cardHTML);
                });

            } catch (error) {
                console.error("Open Library Search Error:", error);
                searchSpinner.classList.add('hidden');
                searchStatus.textContent = "Oops! Something went wrong while searching. Please try again later.";
                searchStatus.classList.remove('hidden');
            }
        }

        async function openDetailedView(book, sourceContext = 'home') {
            if (!book) return;

            currentlyViewingBook = book;
            lastViewBeforeDetails = sourceContext;

            // Hide main views
            ['home', 'books', 'explore', 'stats', 'recommendations'].forEach(id => {
                const view = document.getElementById(`view-${id}`);
                if (view) view.classList.add('hidden');
            });
            document.getElementById('search-results-section').classList.add('hidden');
            document.getElementById('explore-default-content').classList.add('hidden');
            
            document.getElementById('book-details-section').classList.remove('hidden');
            
            const contentDiv = document.getElementById('book-details-content');
            const loadingDiv = document.getElementById('book-details-loading');
            
            contentDiv.innerHTML = '';
            loadingDiv.classList.remove('hidden');

            const title = book.title || 'Unknown Title';
            const author = book.author_name ? book.author_name[0] : 'Unknown Author';
            const coverUrl = book.coverUrl || (book.cover_i 
                ? `https://covers.openlibrary.org/b/id/${book.cover_i}-L.jpg` 
                : `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='300' style='background:%23fde9d9'></svg>`);
            
            let description = 'No description available for this book.';
            let similarBooksHTML = '';
            
            try {
                const fetchPromises = [];

                // Only fetch openlibrary json if we have a valid openlibrary works key
                if (book.key && typeof book.key === 'string' && book.key.startsWith('/')) {
                    fetchPromises.push(
                        fetch(`https://openlibrary.org${book.key}.json`)
                            .then(res => res.ok ? res.json() : {})
                            .then(data => {
                                if (data.description) description = typeof data.description === 'string' ? data.description : data.description.value;
                            }).catch(err => console.error(err))
                    );
                }

                if (author !== 'Unknown Author') {
                    fetchPromises.push(
                        fetch(`https://openlibrary.org/search.json?author=${encodeURIComponent(author)}&limit=10`)
                            .then(res => res.ok ? res.json() : { docs: [] })
                            .then(data => {
                                const simBooks = (data.docs || []).filter(b => b.title !== title && b.key !== book.key).slice(0, 3);
                                if (simBooks.length > 0) {
                                    const cardsHTML = simBooks.map((simBook) => {
                                        const simTitle = simBook.title || 'Unknown Title';
                                        const simAuthor = simBook.author_name ? simBook.author_name[0] : author;
                                        const simCover = simBook.cover_i ? `https://covers.openlibrary.org/b/id/${simBook.cover_i}-S.jpg` : '';
                                        const simRating = (Math.random() * (4.9 - 3.5) + 3.5).toFixed(2);
                                        const totalPages = simBook.number_of_pages_median || 300;
                                        const stringifiedSim = JSON.stringify({ title: simTitle, author_name: [simAuthor], cover_i: simBook.cover_i, key: simBook.key, coverUrl: simCover, total_pages: totalPages }).replace(/"/g, '&quot;');
                                        
                                        return `
                                            <div class="flex items-center gap-3 w-full max-w-[200px] cursor-pointer group" onclick="openDetailedView(${stringifiedSim}, '${sourceContext}')">
                                                <img src="${simCover || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='72' style='background:%23e2e8f0'></svg>"}" alt="${simTitle}" class="w-12 h-18 object-cover rounded shadow-sm group-hover:scale-105 transition-transform" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'48\\' height=\\'72\\' style=\\'background:%23e2e8f0\\'></svg>'">
                                                <div class="flex flex-col overflow-hidden">
                                                    <h5 class="text-xs font-semibold text-brand-text truncate group-hover:text-brand-primary transition-colors" title="${simTitle}">${simTitle}</h5>
                                                    <span class="text-[10px] text-brand-muted truncate">by ${simAuthor}</span>
                                                    <div class="flex items-center text-[10px] font-semibold text-brand-text mt-1"><i data-lucide="star" class="w-3 h-3 text-brand-primary fill-brand-primary mr-1"></i> ${simRating}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('');

                                    similarBooksHTML = `
                                        <hr class="border-gray-100">
                                        <div class="w-full max-w-4xl mx-auto">
                                            <h3 class="text-center font-semibold text-brand-text mb-8">Other books you might enjoy</h3>
                                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 justify-items-center">${cardsHTML}</div>
                                        </div>
                                    `;
                                }
                            }).catch(err => console.error(err))
                    );
                }

                await Promise.all(fetchPromises);
            } catch (err) { console.error("Failed to load details", err); }

            loadingDiv.classList.add('hidden');
            const rating = (Math.random() * (4.9 - 3.5) + 3.5).toFixed(2);
            const formattedDescription = description.split('\n').filter(p => p.trim() !== '').map(p => `<p class="mb-3">${p}</p>`).join('');

            contentDiv.innerHTML = `
                <div class="flex flex-col md:flex-row gap-8 lg:gap-12">
                    <img src="${coverUrl}" alt="${title}" class="w-48 md:w-56 lg:w-64 h-auto object-cover rounded-xl shadow-lg shrink-0 mx-auto md:mx-0">
                    <div class="flex flex-col">
                        <h2 class="text-2xl md:text-3xl font-bold text-brand-text mb-2">${title}</h2>
                        <p class="text-sm md:text-base text-brand-muted mb-3">by ${author}</p>
                        <div class="flex items-center text-sm font-semibold text-brand-text mb-6">
                            <i data-lucide="star" class="w-4 h-4 text-brand-primary fill-brand-primary mr-1"></i> ${rating}
                        </div>
                        
                        <!-- Dropdown -->
                        <div class="relative w-fit mb-8 group z-40">
                            <button onclick="document.getElementById('dropdown-details').classList.toggle('hidden')" class="flex items-center justify-between border border-gray-300 rounded-full px-5 py-2.5 text-xs font-semibold text-brand-text hover:bg-gray-50 transition-colors shadow-sm focus:outline-none">
                                Add to your library <i data-lucide="chevron-down" class="w-4 h-4 ml-3 text-brand-muted"></i>
                            </button>
                            <div id="dropdown-details" class="hidden absolute top-full left-0 mt-2 w-48 bg-white border border-gray-100 rounded-xl shadow-lg py-1 overflow-hidden">
                                <button onclick="saveBookToLibrary('currently_reading')" class="w-full text-left px-5 py-3 text-xs font-semibold text-brand-text hover:bg-brand-surface hover:text-brand-primary transition-colors">Currently Reading</button>
                                <button onclick="saveBookToLibrary('reading_later')" class="w-full text-left px-5 py-3 text-xs font-semibold text-brand-text hover:bg-brand-surface hover:text-brand-primary transition-colors border-t border-gray-50">Reading Later</button>
                                <button onclick="saveBookToLibrary('read_books')" class="w-full text-left px-5 py-3 text-xs font-semibold text-brand-text hover:bg-brand-surface hover:text-brand-primary transition-colors border-t border-gray-50">Read</button>
                            </div>
                        </div>
                        
                        <div class="text-sm text-brand-text leading-relaxed opacity-90 max-w-3xl">${formattedDescription}</div>
                    </div>
                </div>
                ${similarBooksHTML}
            `;
            lucide.createIcons();
            document.getElementById('book-details-section').scrollIntoView({ behavior: 'smooth' });
        }

        function closeBookDetails() {
            document.getElementById('book-details-section').classList.add('hidden');
            
            // Context aware back button
            if (lastViewBeforeDetails === 'search-results') {
                document.getElementById('view-explore').classList.remove('hidden');
                document.getElementById('search-results-section').classList.remove('hidden');
            } else if (lastViewBeforeDetails === 'recommendations') {
                document.getElementById('view-recommendations').classList.remove('hidden');
            } else {
                switchTab(lastActiveTab);
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('search-results-section').classList.add('hidden');
            document.getElementById('explore-default-content').classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchSupabaseData();
            
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            if (searchBtn && searchInput) {
                searchBtn.addEventListener('click', searchBooks);
                searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchBooks(); });
            }
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (clearSearchBtn) clearSearchBtn.addEventListener('click', clearSearch);
        });
    </script>
</body>
</html>
