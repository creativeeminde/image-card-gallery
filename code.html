<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>TaskMaster</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#101922"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TaskMaster">
    <link rel="apple-touch-icon" href="icons/icon-180x180.png">
    
    <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23137fec'/%3E%3C/svg%3E">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Tailwind Config & Dark Mode Setup
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: { "display": ["Inter"] },
                },
            },
        }

        // Apply theme from localStorage on initial load to prevent flashing
        function applyTheme(theme) {
            const htmlTag = document.documentElement;
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                htmlTag.classList.add('dark');
            } else if (theme === 'light') {
                htmlTag.classList.remove('dark');
            } else { // System default
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    htmlTag.classList.add('dark');
                } else {
                    htmlTag.classList.remove('dark');
                }
            }
        }
        
        // Initial theme application
        const savedTheme = localStorage.getItem('theme') || 'system';
        applyTheme(savedTheme);
    </script>
    
    <style>
        /* Ensures tap feedback on iOS */
        [onclick], [data-view], .load-template-btn, .edit-template-btn, .delete-template-btn {
          cursor: pointer;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 pb-16 md:pb-0">

    <header class="flex items-center justify-between px-6 py-3 border-b border-slate-200 dark:border-slate-800 sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-50 transition-transform duration-300">
        <div class="flex items-center gap-4">
            <div id="online-status" class="size-3 rounded-full bg-green-500" title="Online"></div>
            <div class="text-primary size-7"><svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H42L36 24L42 42H6L12 24L6 6Z"></path></svg></div>
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">TaskMaster</h1>
        </div>
        <nav class="hidden md:flex items-center gap-8">
            <a data-view="#schedule-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Today</a>
            <a data-view="#calendar-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Calendar</a>
            <a data-view="#todo-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">To-Do</a>
            <a data-view="#projects-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Projects</a>
            <a data-view="#pomodoro-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Pomodoro Timer</a>
        </nav>
        <div class="flex items-center gap-4">
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined text-slate-600 dark:text-slate-300">search</span></button>
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined text-slate-600 dark:text-slate-300">notifications</span></button>
            <img alt="User avatar" class="size-10 rounded-full cursor-pointer" id="profile-pic" src="https://i.pravatar.cc/150?u=a042581f4e29026704d"/>
        </div>
    </header>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-background-light dark:bg-background-dark border-t border-slate-200 dark:border-slate-800 z-50 flex justify-around">
        <a data-view="#schedule-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined">today</span>
            <span>Today</span>
        </a>
        <a data-view="#calendar-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined">calendar_month</span>
            <span>Calendar</span>
        </a>
        <a data-view="#todo-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined">checklist</span>
            <span>To-Do</span>
        </a>
        <a data-view="#projects-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined">view_kanban</span>
            <span>Projects</span>
        </a>
        <a data-view="#pomodoro-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined">timer</span>
            <span>Pomodoro</span>
        </a>
    </nav>
    
    <div id="load-template-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-background-light dark:bg-background-dark rounded-lg shadow-xl w-full max-w-md">
            <div class="flex items-center justify-between p-4 border-b dark:border-slate-800">
                <h3 class="text-lg font-bold">Load or Edit Template</h3>
                <button id="close-template-modal-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="template-list" class="p-4 max-h-80 overflow-y-auto space-y-2">
                </div>
        </div>
    </div>
    
    <div id="views-container">
        <div id="schedule-view" class="hidden"><main class="flex-1 px-10 py-8"><div class="mx-auto max-w-5xl"><div class="flex items-center justify-between mb-8"><div><h1 id="schedule-title" class="text-3xl font-bold"></h1><p id="current-date" class="text-slate-500"></p></div>
        <div class="flex items-center gap-2">
            <button id="schedule-tomorrow-btn" class="px-4 py-2 text-sm font-semibold rounded-lg border bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700">Schedule for Tomorrow &rarr;</button>
            <button id="save-template-btn" class="px-4 py-2 text-sm font-semibold rounded-lg border bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700">Save Template</button>
            <button id="load-template-btn" class="px-4 py-2 text-sm font-semibold rounded-lg border bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700">Load Template</button>
        </div>
        </div><div class="relative"><div id="hour-grid" class="grid grid-cols-[auto_1fr] gap-x-4"></div><div id="events-container" class="absolute top-0 left-[60px] right-0 bottom-0"></div></div></div></main><div class="fixed bottom-10 right-10 md:bottom-10"><button id="add-event-btn" class="flex items-center justify-center rounded-full size-14 bg-primary text-white shadow-lg"><span class="material-symbols-outlined">add</span></button></div></div>
        
        <div id="form-view" class="hidden"><main class="w-full max-w-2xl px-4 py-8 mx-auto"><div class="space-y-8"><div><h2 class="text-3xl font-bold">New Event</h2><p class="mt-2 text-slate-500">Create a new event for your schedule.</p></div><form id="event-form" class="space-y-6">
            <div><label class="block text-sm font-medium" for="title">Title</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="title" name="title" type="text" /></div>
            <div>
                <label class="block text-sm font-medium" for="category">Category</label>
                <select required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="category" name="category">
                    <option>Work</option>
                    <option>Personal</option>
                    <option>Spiritual</option>
                    <option>Education</option>
                    <option>Entertainment</option>
                </select>
            </div>
            <div><label class="block text-sm font-medium" for="date">Date</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="date" name="date" type="text" readonly /></div>
            <div class="grid grid-cols-2 gap-6"><div><label class="block text-sm font-medium" for="start-time">Start Time</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="start-time" name="start_time" type="time" /></div><div><label class="block text-sm font-medium" for="end-time">End Time</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="end-time" name="end_time" type="time" /></div></div>
            <div class="flex justify-between items-center pt-4">
                <button id="delete-event-btn" class="px-6 py-3 rounded-lg text-red-500 hover:bg-red-500/10 hidden" type="button">Delete Event</button>
                <div class="flex gap-3">
                    <button id="cancel-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button>
                    <button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Event</button>
                </div>
            </div>
        </form></div></main></div>

        <div id="template-editor-view" class="hidden">
            <main class="flex-1 px-10 py-8">
                <div class="mx-auto max-w-5xl">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 id="template-editor-title" class="text-3xl font-bold">Edit Template</h1>
                            <p id="template-editor-name" class="text-slate-500"></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="close-template-editor-btn" class="px-4 py-2 text-sm font-semibold rounded-lg border bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700">&larr; Back to Schedule</button>
                        </div>
                    </div>
                    <div class="relative">
                        <div id="template-hour-grid" class="grid grid-cols-[auto_1fr] gap-x-4"></div>
                        <div id="template-events-container" class="absolute top-0 left-[60px] right-0 bottom-0"></div>
                    </div>
                </div>
            </main>
            <div class="fixed bottom-10 right-10 md:bottom-10">
                <button id="add-template-event-btn" class="flex items-center justify-center rounded-full size-14 bg-primary text-white shadow-lg">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </div>
        </div>

        <div id="template-form-view" class="hidden">
            <main class="w-full max-w-2xl px-4 py-8 mx-auto">
                <div class="space-y-8">
                    <div>
                        <h2 class="text-3xl font-bold">New Template Event</h2>
                        <p class="mt-2 text-slate-500">Create a new event for your template.</p>
                    </div>
                    <form id="template-event-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium" for="template-title">Title</label>
                            <input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="template-title" name="title" type="text" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium" for="template-category">Category</label>
                            <select required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="template-category" name="category">
                                <option>Work</option>
                                <option>Personal</option>
                                <option>Spiritual</option>
                                <option>Education</option>
                                <option>Entertainment</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium" for="template-start-time">Start Time</label>
                                <input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="template-start-time" name="start_time" type="time" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium" for="template-end-time">End Time</label>
                                <input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="template-end-time" name="end_time" type="time" />
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-4">
                            <button id="delete-template-event-btn" class="px-6 py-3 rounded-lg text-red-500 hover:bg-red-500/10 hidden" type="button">Delete Event</button>
                            <div class="flex gap-3">
                                <button id="cancel-template-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button>
                                <button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Event</button>
                            </div>
                        </div>
                    </form>
                </div>
            </main>
        </div>
        
        <div id="calendar-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="flex flex-col lg:flex-row justify-center gap-8"><div class="w-full lg:max-w-md bg-white dark:bg-slate-900/50 p-4 rounded-lg"><div class="flex items-center justify-between mb-4"><button id="cal1-prev-btn" class="p-2 rounded-full"><span class="material-symbols-outlined">chevron_left</span></button><h2 id="cal1-month-year" class="text-lg font-semibold"></h2><button class="opacity-0 p-2"><span class="material-symbols-outlined">chevron_right</span></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-500 py-2"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div><div id="cal1-body" class="grid grid-cols-7 gap-1 text-center"></div></div><div class="w-full lg:max-w-md bg-white dark:bg-slate-900/50 p-4 rounded-lg"><div class="flex items-center justify-between mb-4"><button class="opacity-0 p-2"><span class="material-symbols-outlined">chevron_left</span></button><h2 id="cal2-month-year" class="text-lg font-semibold"></h2><button id="cal2-next-btn" class="p-2 rounded-full"><span class="material-symbols-outlined">chevron_right</span></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-500 py-2"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div><div id="cal2-body" class="grid grid-cols-7 gap-1 text-center"></div></div></div></main></div>
        
        <div id="todo-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="max-w-4xl mx-auto"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">My To-Do List</h2><button id="new-task-btn" class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-semibold"><span class="material-symbols-outlined">add_circle</span>New Task</button></div><div class="bg-white/50 dark:bg-white/5 rounded-lg p-6 mb-8"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">Today's Progress</h3><span id="progress-text" class="text-sm font-medium"></span></div><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5"><div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width:0%"></div></div><div class="grid grid-cols-3 gap-4 text-center mt-4" id="stats-container"></div></div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2 text-red-500">Overdue</h3>
                    <div id="overdue-tasks" class="space-y-2"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2">Today</h3>
                    <div id="today-tasks" class="space-y-2"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3 border-b pb-2">Upcoming</h3>
                    <div id="upcoming-tasks" class="space-y-2"></div>
                </div>
            </div>
            </div></main></div>
        <div id="new-task-view" class="hidden"><main class="w-full max-w-2xl px-4 py-8 mx-auto"><div class="space-y-8"><div><h2 class="text-3xl font-bold">New Task</h2><p class="mt-2 text-slate-500">Add a new item to your to-do list.</p></div><form id="new-task-form" class="space-y-6"><div><label class="block text-sm font-medium" for="task-title">Task Title</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="task-title" name="title" placeholder="e.g., Pay electricity bill" type="text" /></div><div><label class="block text-sm font-medium" for="task-due-date">Due Date</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="task-due-date" name="due_date" type="text" readonly /></div><div><label class="block text-sm font-medium" for="task-category">Category</label><select class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="task-category" name="category"><option>Personal</option><option>Work</option><option>Shopping</option><option>Other</option></select></div><div class="flex justify-end pt-4 gap-3"><button id="cancel-task-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button><button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Task</button></div></form></div></main></div>
        <div id="settings-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="max-w-2xl mx-auto space-y-10"><div><h2 class="text-4xl font-extrabold mb-8 text-slate-900 dark:text-white">Settings</h2></div><section><h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Notifications</h3><div class="bg-white/50 dark:bg-white/5 rounded-lg p-6 space-y-4"><div class="flex items-center justify-between"><div><p class="font-medium">Event Notifications</p><p class="text-sm text-slate-500 dark:text-slate-400">Enable or disable notifications for upcoming events and reminders.</p></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer" checked /><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div></label></div><div class="flex items-center justify-between"><div><p class="font-medium">Task Notifications</p><p class="text-sm text-slate-500 dark:text-slate-400">Receive notifications for task deadlines and updates.</p></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer" checked /><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div></label></div></div></section><section><h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Theme</h3><div id="theme-selector" class="flex rounded-lg bg-white dark:bg-slate-800 p-1 shadow-sm"><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="light">Light</button><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="dark">Dark</button><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="system">System</button></div></section><section><h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Account</h3><div class="bg-white/50 dark:bg-white/5 rounded-lg divide-y divide-slate-200 dark:divide-slate-800"><a href="#" class="flex items-center justify-between p-4 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-t-lg"><p class="font-medium">Manage Account</p><span class="material-symbols-outlined text-slate-400">chevron_right</span></a><a href="#" class="flex items-center justify-between p-4 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-b-lg text-red-500"><p class="font-medium">Sign Out</p><span class="material-symbols-outlined text-red-500">chevron_right</span></a></div></section></div></main></div>
        
        <div id="projects-view" class="hidden"><main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8"><div class="flex flex-col gap-6"><div class="flex justify-between items-center"><div><h2 class="text-3xl font-bold text-slate-900 dark:text-white">Project Tracker</h2><p class="text-slate-500 dark:text-slate-400 mt-1">Manage your projects and tasks efficiently.</p></div><div class="flex gap-4"><button id="new-project-btn" class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-semibold"><span class="material-symbols-outlined">add</span>New Project</button><button id="new-project-task-btn" class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-semibold"><span class="material-symbols-outlined">add_circle</span>New Task</button></div></div><div id="project-selector-container" class="flex gap-4 items-center"><h3 class="text-xl font-bold text-slate-900 dark:text-white">Project:</h3><select id="project-selector" class="rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 px-4 py-2"></select></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4"><div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-800 dark:text-slate-200">To Do</h4><span id="count-todo" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span></div><div id="kanban-todo" class="space-y-4 kanban-column" data-status="To Do"></div></div><div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4"><div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-800 dark:text-slate-200">In Progress</h4><span id="count-inprogress" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span></div><div id="kanban-inprogress" class="space-y-4 kanban-column" data-status="In Progress"></div></div><div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4"><div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-800 dark:text-slate-200">Done</h4><span id="count-done" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span></div><div id="kanban-done" class="space-y-4 kanban-column" data-status="Done"></div></div></div></div></main></div>
        <div id="new-project-view" class="hidden"><main class="w-full max-w-2xl px-4 py-8 mx-auto"><div class="space-y-8"><div><h2 class="text-3xl font-bold">New Project</h2><p class="mt-2 text-slate-500">Create a new project to organize your tasks.</p></div><form id="new-project-form" class="space-y-6"><div><label class="block text-sm font-medium" for="project-name">Project Name</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="project-name" name="name" placeholder="e.g., Marketing Campaign" type="text" /></div><div class="flex justify-end pt-4 gap-3"><button id="cancel-project-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button><button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Project</button></div></form></div></main></div>
        <div id="new-project-task-view" class="hidden"><main class="w-full max-w-2xl px-4 py-8 mx-auto"><div class="space-y-8"><div><h2 class="text-3xl font-bold">New Project Task</h2><p class="mt-2 text-slate-500">Add a new task to your project.</p></div><form id="new-project-task-form" class="space-y-6"><div><label class="block text-sm font-medium" for="project-task-title">Task Title</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="project-task-title" name="title" placeholder="e.g., Design marketing materials" type="text" /></div><div><label class="block text-sm font-medium" for="project-task-due-date">Due Date</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="project-task-due-date" name="due_date" type="text" readonly /></div><div><label class="block text-sm font-medium" for="project-task-assignee">Assignee</label><input class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="project-task-assignee" name="assignee" placeholder="e.g., John Doe" type="text" /></div><div><label class="block text-sm font-medium" for="project-task-status">Status</label><select class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="project-task-status" name="status"><option>To Do</option><option>In Progress</option><option>Done</option></select></div><div class="flex justify-end pt-4 gap-3"><button id="cancel-project-task-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button><button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Task</button></div></form></div></main></div>
        <div id="pomodoro-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="max-w-2xl mx-auto text-center space-y-10">
            <h2 class="text-4xl font-extrabold text-primary">Pomodoro Timer</h2>
            
            <div class="bg-white/50 dark:bg-white/5 rounded-xl p-8 shadow-lg space-y-8">
                <div class="flex justify-center gap-4">
                    <button id="pomodoro-work-btn" class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors timer-session-btn bg-primary text-white" data-session="work">Work</button>
                    <button id="pomodoro-short-break-btn" class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors timer-session-btn bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600" data-session="shortBreak">Short Break</button>
                    <button id="pomodoro-long-break-btn" class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors timer-session-btn bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600" data-session="longBreak">Long Break</button>
                </div>
                
                <div id="pomodoro-timer-display" class="text-7xl sm:text-8xl md:text-9xl font-mono font-bold text-slate-900 dark:text-white">25:00</div>
                
                <div class="flex justify-center gap-6">
                    <button id="pomodoro-start-pause-btn" class="flex items-center gap-2 bg-primary text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined text-3xl">play_arrow</span>
                        <span id="pomodoro-start-pause-text">Start</span>
                    </button>
                    <button id="pomodoro-reset-btn" class="flex items-center justify-center rounded-full size-14 bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-200 shadow-md hover:bg-slate-400 dark:hover:bg-slate-600 transition-colors">
                        <span class="material-symbols-outlined">restart_alt</span>
                    </button>
                </div>
                
                <div class="text-lg font-medium">
                    <span id="pomodoro-cycle-count">Cycle: 0 / 4</span>
                </div>
            </div>
            <div class="bg-white/50 dark:bg-white/5 rounded-xl p-6 shadow-md text-left space-y-4">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2">Timer Settings</h3>
                <div class="grid grid-cols-3 gap-6">
                    <div>
                        <label for="work-duration" class="block text-sm font-medium">Work (min)</label>
                        <input type="number" id="work-duration" value="25" min="1" class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" />
                    </div>
                    <div>
                        <label for="short-break-duration" class="block text-sm font-medium">Short Break (min)</label>
                        <input type="number" id="short-break-duration" value="5" min="1" class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" />
                    </div>
                    <div>
                        <label for="long-break-duration" class="block text-sm font-medium">Long Break (min)</label>
                        <input type="number" id="long-break-duration" value="15" min="1" class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" />
                    </div>
                </div>
                <button id="apply-pomodoro-settings-btn" class="w-full mt-4 bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary/90">Apply Settings</button>
            </div>
        </div></main></div>
        </div>

    <script>
        // === SUPABASE & STATE SETUP ===
        const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let selectedDate = new Date();
        let calendarDisplayDate = new Date();
        let currentProjectId = null;
        let dragTaskId = null;
        let editingTaskId = null;
        let editingEventId = null;
        let editingTodoId = null;
        
        // === NEW TEMPLATE EDITING STATE ===
        let editingTemplateId = null;
        let editingTemplateEventId = null;
        
        // === POMODORO STATE ===
        let timerInterval = null;
        let pomodoroTimeLeft = 25 * 60; // Default work time in seconds
        let pomodoroIsRunning = false;
        let pomodoroSettings = {
            work: 25,
            shortBreak: 5,
            longBreak: 15,
            longBreakCycle: 4
        };
        let pomodoroCurrentSession = 'work';
        let pomodoroCycleCount = 0; // The number of completed work sessions
        
        // NEW State variables for notifications
        let originalTitle = document.title;
        let originalFavicon = document.getElementById('favicon').href;
        let flashingInterval = null;
        const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        
        // === HELPERS ===
        const toYMD = (date) => date.toISOString().split('T')[0];
        const timeToDecimal = (t) => { const [h, m] = t.split(':'); return parseInt(h, 10) + parseInt(m, 10) / 60; };
        const formatTime = (t) => new Date(`1970-01-01T${t}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const getCategoryClasses = (category) => {
            switch (category) {
                case 'Work':
                    return 'bg-green-300 dark:bg-green-900/50 text-black-800 dark:text-slate-200';
                case 'Personal':
                    return 'bg-orange-300 dark:bg-orange-900/50 text-black-800 dark:text-slate-200';
                case 'Education':
                    return 'bg-purple-300 dark:bg-purple-900/50 text-black-800 dark:text-slate-200';
                case 'Entertainment':
                    return 'bg-blue-300 dark:bg-blue-900/50 text-black-800 dark:text-slate-200';
                case 'spiritual':
                    return 'bg-orange-700 dark:bg-orange-900/50 text-black-800 dark:text-slate-200';
                default:
                    return 'bg-slate-100 dark:bg-slate-900/50 text-slate-700 dark:text-slate-300';
            }
        }
        // === VIEW MANAGEMENT ===
        function showView(viewId) {
            document.querySelectorAll('#views-container > div').forEach(v => v.classList.add('hidden'));
            document.querySelector(viewId).classList.remove('hidden');
            updateActiveLink(viewId);
            
            // Clear editing states when switching views
            if (viewId !== '#form-view') editingEventId = null;
            if (viewId !== '#new-task-view') editingTodoId = null;
            if (viewId !== '#new-project-task-view') editingTaskId = null;
            if (viewId !== '#template-form-view') editingTemplateEventId = null;
            
            if (viewId === '#schedule-view') displayEvents(selectedDate);
            if (viewId === '#calendar-view') initializeCalendarView();
            if (viewId === '#todo-view') displayTodos();
            if (viewId === '#settings-view') initializeSettings();
            if (viewId === '#projects-view') {
                loadProjects();
                displayProjects();
            }
            if (viewId === '#pomodoro-view') {
                if (!timerInterval) resetPomodoroTimer();
            } else {
                pausePomodoroTimer();
            }
        }
        
        function updateActiveLink(activeViewId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                const isActive = link.dataset.view === activeViewId;
                
                // Toggle active classes (text-primary, font-bold)
                link.classList.toggle('text-primary', isActive);
                link.classList.toggle('font-bold', isActive);
                
                // Toggle inactive classes (text-slate-600, dark:text-slate-300)
                link.classList.toggle('text-slate-600', !isActive);
                link.classList.toggle('dark:text-slate-300', !isActive);
                
                // This is for the desktop links that have a medium weight when inactive
                if (link.closest('header nav')) {
                    link.classList.toggle('font-medium', !isActive);
                }
            });
        }
        // === SCHEDULE VIEW LOGIC ===
        function renderHourGrid() {
            const grid = document.getElementById('hour-grid');
            if (!grid) return;
            grid.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const time = new Date(0, 0, 0, i).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                grid.innerHTML += `<div class="text-right text-sm text-slate-500 h-16 pt-2 border-b dark:border-slate-800">${time}</div><div class="border-b dark:border-slate-800"></div>`;
            }
        }
        
        // === NEW: TEMPLATE EDITOR GRID RENDER ===
        function renderTemplateEditorGrid() {
            const grid = document.getElementById('template-hour-grid');
            if (!grid) return;
            grid.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const time = new Date(0, 0, 0, i).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                grid.innerHTML += `<div class="text-right text-sm text-slate-500 h-16 pt-2 border-b dark:border-slate-800">${time}</div><div class="border-b dark:border-slate-800"></div>`;
            }
        }
        
        async function displayEvents(date) {
            const eventsContainer = document.getElementById('events-container');
            const scheduleTitle = document.getElementById('schedule-title');
            const currentDateEl = document.getElementById('current-date');
            if (!eventsContainer || !scheduleTitle || !currentDateEl) return;
            
            const dateString = toYMD(date);
            const isToday = (toYMD(new Date()) === dateString);
            scheduleTitle.textContent = isToday ? "Today" : date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            currentDateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Show a loading/offline state immediately
            eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">Loading events...</p>`;

            const { data: events, error } = await db.from('events').select('*').eq('date', dateString);
            
            eventsContainer.innerHTML = '';
            if (error) { 
                console.error('Error fetching events:', error); 
                eventsContainer.innerHTML = `<p class="text-center text-red-500 pt-4">Could not load events. Check your connection.</p>`;
                return;
            }
            if (!events || events.length === 0) { 
                eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">No events for this day.</p>`; 
                return;
            }
            
            events.forEach(event => {
                const start = timeToDecimal(event.start_time);
                const end = timeToDecimal(event.end_time);
                const eventEl = document.createElement('div');
                
                const colorClasses = getCategoryClasses(event.category);
                
                eventEl.className = `absolute p-2 rounded-lg overflow-hidden cursor-pointer ${colorClasses} hover:opacity-80`;
                eventEl.style.cssText = `top:calc(${start}*4rem);height:calc(${(end-start)}*4rem);left:.5rem;right:.5rem;`;
                eventEl.innerHTML = `<p class="font-bold text-sm truncate">${event.title}</p><p class="text-xs opacity-80">${formatTime(event.start_time)}</p>`;
                
                eventEl.addEventListener('click', () => editEvent(event));
                eventsContainer.appendChild(eventEl);
            });
        }
        
        function editEvent(event) {
            editingEventId = event.id;
            // Populate form
            document.getElementById('title').value = event.title;
            document.getElementById('category').value = event.category;
            document.getElementById('date')._flatpickr.setDate(event.date);
            document.getElementById('start-time').value = event.start_time;
            document.getElementById('end-time').value = event.end_time;
            
            // Update UI for editing
            document.querySelector('#form-view h2').textContent = 'Edit Event';
            document.querySelector('#event-form button[type="submit"]').textContent = 'Update Event';
            document.getElementById('delete-event-btn').classList.remove('hidden');
            
            showView('#form-view');
        }
        async function deleteEvent() {
            if (!editingEventId || !confirm('Are you sure you want to delete this event?')) {
                return;
            }
            // Lightweight offline handling: just alert the user if offline.
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to delete the event.");
                return;
            }
            const { error } = await db.from('events').delete().eq('id', editingEventId);
            if (error) {
                alert('Error deleting event: ' + error.message);
            } else {
                showView('#schedule-view');
            }
        }
        // === FORM SUBMISSION LOGIC ===
        async function handleEventFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save changes.");
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const eventData = Object.fromEntries(formData.entries());
            if (eventData.start_time.length === 5) eventData.start_time += ':00';
            if (eventData.end_time.length === 5) eventData.end_time += ':00';
            
            let response;
            if (editingEventId) {
                response = await db.from('events').update(eventData).eq('id', editingEventId);
            } else {
                response = await db.from('events').insert([eventData]);
            }
            if (response.error) {
                alert('Error: ' + response.error.message);
            } else {
                showView('#schedule-view');
            }
        }
        async function handleTaskFormSubmit(e) {
            e.preventDefault();
             if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save changes.");
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const taskData = Object.fromEntries(formData.entries());
            let response;
            if (editingTodoId) {
                response = await db.from('todos').update(taskData).eq('id', editingTodoId);
            } else {
                taskData.status = 'Pending';
                response = await db.from('todos').insert([taskData]);
            }
            
            if (response.error) {
                alert('Error creating task: ' + response.error.message);
            } else {
                showView('#todo-view');
            }
        }
        
        // === CALENDAR VIEW LOGIC ===
        async function initializeCalendarView() {
            const date1 = new Date(calendarDisplayDate), date2 = new Date(date1);
            date2.setMonth(date2.getMonth() + 1);
            const { data, error } = await db.from('events').select('date').gte('date', toYMD(new Date(date1.getFullYear(), date1.getMonth(), 1))).lte('date', toYMD(new Date(date2.getFullYear(), date2.getMonth() + 1, 0)));
            const eventDates = error ? new Set() : new Set(data.map(e => e.date));
            renderMonth(date1.getFullYear(), date1.getMonth(), document.getElementById('cal1-body'), document.getElementById('cal1-month-year'), eventDates);
            renderMonth(date2.getFullYear(), date2.getMonth(), document.getElementById('cal2-body'), document.getElementById('cal2-month-year'), eventDates);
        }
        function renderMonth(year, month, bodyEl, titleEl, eventDates) {
            bodyEl.innerHTML = '';
            titleEl.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) bodyEl.insertAdjacentHTML('beforeend', '<div></div>');
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day), dateString = toYMD(date);
                const button = document.createElement('button');
                button.className = 'relative h-10 w-10 flex items-center justify-center rounded-full ' + (toYMD(selectedDate) === dateString ? 'bg-primary text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-800');
                button.innerHTML = day + (eventDates.has(dateString) ? '<span class="absolute bottom-1 h-1 w-1 bg-primary rounded-full"></span>' : '');
                button.onclick = () => { selectedDate = date; showView('#schedule-view'); };
                bodyEl.appendChild(button);
            }
        }
        // === TO-DO VIEW LOGIC (UPDATED) ===
        async function displayTodos() {
            const { data: todos, error } = await db.from('todos').select('*').order('due_date');
            if (error) { console.error("Error fetching todos:", error); return; }
            const todayYMD = toYMD(new Date());
            
            const overdueTasks = todos.filter(t => t.due_date < todayYMD && t.status !== 'Completed');
            const todayTasks = todos.filter(t => t.due_date === todayYMD);
            const upcomingTasks = todos.filter(t => t.due_date > todayYMD);
            
            renderTasks(overdueTasks, document.getElementById('overdue-tasks'));
            renderTasks(todayTasks, document.getElementById('today-tasks'));
            renderTasks(upcomingTasks, document.getElementById('upcoming-tasks'));
            updateTodoStats(todos, todayTasks);
        }
        function renderTasks(tasks, container) { 
            container.innerHTML = tasks.length ? tasks.map(renderTask).join('') : '<p class="text-slate-500">No tasks.</p>'; 
        }
        function renderTask(task) {
            const isCompleted = task.status === 'Completed';
            const statusColors = { 'Pending': 'bg-red-500/20 text-red-500', 'In Progress': 'bg-yellow-500/20 text-yellow-500', 'Completed': 'bg-green-500/20 text-green-500' };
            const dueDateText = getDueDateText(task.due_date);
            const todayYMD = toYMD(new Date());
            const isOverdue = task.due_date < todayYMD && !isCompleted;
            return `<div class="flex items-center gap-4 p-4 rounded-lg bg-white/50 dark:bg-white/5 ${isCompleted ? 'opacity-60' : ''} ${isOverdue ? 'border border-red-500/50' : ''}">
                        <input type="checkbox" data-id="${task.id}" class="form-checkbox h-5 w-5 rounded border-slate-300 dark:border-slate-600 bg-transparent text-primary focus:ring-primary/50" ${isCompleted ? 'checked' : ''}>
                        <div class="flex-grow">
                            <p class="font-medium ${isCompleted ? 'line-through' : ''}">${task.title}</p>
                            <p class="text-sm text-slate-500 ${isCompleted ? 'line-through' : ''}">${dueDateText} • ${task.category}</p>
                        </div>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[task.status] || ''}">${task.status}</span>
                        <button class="todo-options-btn p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" data-task='${JSON.stringify(task)}'>
                            <span class="material-symbols-outlined text-slate-400">more_vert</span>
                        </button>
                    </div>`;
        }
        
        function getDueDateText(dueDateStr) {
            const today = new Date(toYMD(new Date()));
            const dueDate = new Date(dueDateStr + 'T00:00:00');
            const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 'Due Today';
            if (diffDays === 1) return 'Due Tomorrow';
            if (diffDays > 1) return `Due in ${diffDays} days`;
            if (diffDays < 0) {
                const daysOver = Math.abs(diffDays);
                return `Overdue by ${daysOver} day${daysOver > 1 ? 's' : ''}`;
            }
            return `Due ${dueDate.toLocaleDateString()}`;
        }
        function updateTodoStats(allTasks, todayTasks) {
            const completedToday = todayTasks.filter(t => t.status === 'Completed').length;
            const totalPending = allTasks.filter(t => t.status !== 'Completed').length;
            const progress = todayTasks.length > 0 ? Math.round((completedToday / todayTasks.length) * 100) : 0;
            
            document.getElementById('progress-text').textContent = `${progress}% Complete`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('stats-container').innerHTML = `<div><p class="text-2xl font-bold">${todayTasks.length}</p><p class="text-sm text-slate-500">Today's Tasks</p></div><div><p class="text-2xl font-bold">${completedToday}</p><p class="text-sm text-slate-500">Completed</p></div><div><p class="text-2xl font-bold">${totalPending}</p><p class="text-sm text-slate-500">Pending</p></div>`;
        }
        function showTodoOptionsMenu(task, button) {
            document.querySelectorAll('.todo-options-menu').forEach(menu => menu.remove());
            const menu = document.createElement('div');
            menu.className = 'absolute z-10 right-0 mt-2 w-32 bg-white dark:bg-slate-800 rounded-lg shadow-lg border dark:border-slate-700 todo-options-menu';
            menu.innerHTML = `<button class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-t-lg edit-todo-btn">Edit</button><button class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-500/10 dark:hover:bg-red-500/20 rounded-b-lg delete-todo-btn">Delete</button>`;
            button.parentElement.style.position = 'relative';
            button.parentElement.appendChild(menu);
            menu.querySelector('.edit-todo-btn').onclick = () => { menu.remove(); editTodo(task); };
            menu.querySelector('.delete-todo-btn').onclick = () => { menu.remove(); deleteTodo(task.id); };
            setTimeout(() => {
                document.addEventListener('click', () => menu.remove(), { once: true });
            }, 0);
        }
        function editTodo(task) {
            editingTodoId = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-due-date')._flatpickr.setDate(task.due_date);
            document.getElementById('task-category').value = task.category;
            document.querySelector('#new-task-view h2').textContent = 'Edit Task';
            document.querySelector('#new-task-form button[type="submit"]').textContent = 'Update Task';
            showView('#new-task-view');
        }
        async function deleteTodo(taskId) {
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to delete tasks.");
                return;
            }
            if (!confirm('Are you sure you want to delete this task?')) return;
            const { error } = await db.from('todos').delete().eq('id', taskId);
            if (error) {
                alert('Error deleting task: ' + error.message);
            } else {
                displayTodos();
            }
        }
        // === SETTINGS VIEW LOGIC ===
        function initializeSettings() {
            const themeSelector = document.getElementById('theme-selector');
            const savedTheme = localStorage.getItem('theme') || 'system';
            themeSelector.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white', 'text-slate-700', 'dark:text-slate-300');
                if (btn.dataset.theme === savedTheme) {
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('text-slate-700', 'dark:text-slate-300');
                }
                btn.addEventListener('click', () => {
                    themeSelector.querySelectorAll('button').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('text-slate-700', 'dark:text-slate-300');
                    });
                    btn.classList.add('bg-primary', 'text-white');
                    applyTheme(btn.dataset.theme);
                });
            });
        }
        // === PROJECTS VIEW LOGIC ===
        async function loadProjects() {
            const { data: projects, error } = await db.from('projects').select('*').order('created_at');
            if (error) { console.error("Error fetching projects:", error); return; }
            
            const projectSelector = document.getElementById('project-selector');
            projectSelector.innerHTML = '';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelector.appendChild(option);
            });
            if (projects.length > 0 && !currentProjectId) {
                currentProjectId = projects[0].id;
                projectSelector.value = currentProjectId;
            }
            
            projectSelector.addEventListener('change', () => {
                currentProjectId = projectSelector.value;
                displayProjects();
            });
        }
        
        async function displayProjects() {
            if (!currentProjectId) return;
            const { data: tasks, error } = await db
                .from('project_tasks')
                .select('*')
                .eq('project_id', currentProjectId)
                .order('due_date');
            if (error) { console.error("Error fetching project tasks:", error); return; }
            
            document.getElementById('kanban-todo').innerHTML = '';
            document.getElementById('kanban-inprogress').innerHTML = '';
            document.getElementById('kanban-done').innerHTML = '';
            
            const todoCount = tasks.filter(t => t.status === 'To Do').length;
            const inProgressCount = tasks.filter(t => t.status === 'In Progress').length;
            const doneCount = tasks.filter(t => t.status === 'Done').length;
            
            document.getElementById('count-todo').textContent = todoCount;
            document.getElementById('count-inprogress').textContent = inProgressCount;
            document.getElementById('count-done').textContent = doneCount;
            
            tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                const targetColumn = document.getElementById(`kanban-${task.status.toLowerCase().replace(' ', '')}`);
                if (targetColumn) {
                    targetColumn.appendChild(taskElement);
                }
            });
        }
        
        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            taskEl.className = 'bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm cursor-move';
            taskEl.draggable = true;
            taskEl.dataset.id = task.id;
            
            const dueDateText = getDueDateText(task.due_date);
            taskEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex flex-col gap-2">
                        <h5 class="font-semibold text-slate-900 dark:text-white">${task.title}</h5>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${dueDateText}</p>
                        ${task.assignee ? `<p class="text-sm text-slate-600 dark:text-slate-300">Assignee: ${task.assignee}</p>` : ''}
                    </div>
                    <div class="flex-shrink-0 flex gap-1">
                        <button class="p-1 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 edit-project-task-btn">
                            <span class="material-symbols-outlined text-sm">edit</span>
                        </button>
                        <button class="p-1 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 delete-project-task-btn">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </div>
                </div>
            `;
            taskEl.addEventListener('dragstart', (e) => {
                dragTaskId = task.id;
                e.dataTransfer.setData('text/plain', task.id);
                setTimeout(() => taskEl.classList.add('opacity-50'), 0);
            });
            taskEl.addEventListener('dragend', () => {
                taskEl.classList.remove('opacity-50');
                dragTaskId = null;
            });
            taskEl.querySelector('.edit-project-task-btn').addEventListener('click', () => {
                editProjectTask(task);
            });
            taskEl.querySelector('.delete-project-task-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteProjectTask(task.id);
            });
            return taskEl;
        }
        async function deleteProjectTask(taskId) {
             if (!navigator.onLine) {
                alert("You are offline. Please reconnect to delete tasks.");
                return;
            }
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }
            const { error } = await db.from('project_tasks').delete().eq('id', taskId);
            if (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task.');
            } else {
                displayProjects();
            }
        }
        function editProjectTask(task) {
            editingTaskId = task.id;
            document.getElementById('project-task-title').value = task.title;
            document.getElementById('project-task-due-date')._flatpickr.setDate(task.due_date);
            document.getElementById('project-task-assignee').value = task.assignee || '';
            document.getElementById('project-task-status').value = task.status;
            document.querySelector('#new-project-task-view h2').textContent = 'Edit Project Task';
            document.querySelector('#new-project-task-form button[type="submit"]').textContent = 'Update Task';
            showView('#new-project-task-view');
        }
        
        async function handleProjectFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to create projects.");
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const newProject = Object.fromEntries(formData.entries());
            const { error } = await db.from('projects').insert([newProject]).select();
            if (error) {
                alert('Error creating project: ' + error.message);
            } else {
                form.reset();
                showView('#projects-view');
                loadProjects();
            }
        }
        
        async function handleProjectTaskFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save tasks.");
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const taskData = Object.fromEntries(formData.entries());
            let response;
            if (editingTaskId) {
                response = await db.from('project_tasks').update(taskData).eq('id', editingTaskId);
            } else {
                if (!currentProjectId) {
                    alert('Please select a project first');
                    return;
                }
                taskData.project_id = currentProjectId;
                response = await db.from('project_tasks').insert([taskData]);
            }
            if (response.error) {
                alert('Error saving task: ' + response.error.message);
            } else {
                form.reset();
                editingTaskId = null;
                document.querySelector('#new-project-task-view h2').textContent = 'New Project Task';
                document.querySelector('#new-project-task-form button[type="submit"]').textContent = 'Create Task';
                showView('#projects-view');
                displayProjects();
            }
        }
        
        // === DRAG AND DROP LOGIC ===
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    column.classList.add('bg-slate-200/50', 'dark:bg-slate-800/50');
                });
                
                column.addEventListener('dragleave', () => {
                    column.classList.remove('bg-slate-200/50', 'dark:bg-slate-800/50');
                });
                
                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('bg-slate-200/50', 'dark:bg-slate-800/50');
                    if (!dragTaskId) return;
                    
                    if (!navigator.onLine) {
                        alert("You are offline. Please reconnect to update task status.");
                        // Re-render to snap the card back to its original column
                        displayProjects();
                        return;
                    }
                    
                    const newStatus = column.dataset.status;
                    
                    const { error } = await db
                        .from('project_tasks')
                        .update({ status: newStatus })
                        .eq('id', dragTaskId);
                        
                    if (error) {
                        console.error('Error updating task status:', error);
                    } else {
                        displayProjects();
                    }
                });
            });
        }
        // === TEMPLATE FUNCTIONS (MODIFIED) ===
        function scheduleForTomorrow() {
            selectedDate.setDate(selectedDate.getDate() + 1);
            displayEvents(selectedDate);
        }
        async function saveCurrentDayAsTemplate() {
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save templates.");
                return;
            }
            const templateName = prompt("Please enter a name for this template:");
            if (!templateName) return;
            const dateString = toYMD(selectedDate);
            const { data: events, error: fetchError } = await db.from('events')
                .select('title, start_time, end_time, category')
                .eq('date', dateString);
            
            if (fetchError) {
                alert('Error fetching events to save: ' + fetchError.message);
                return;
            }
            if (!events || events.length === 0) {
                alert('There are no events on this day to save as a template.');
                return;
            }
            const { data: template, error: templateError } = await db.from('schedule_templates')
                .insert({ name: templateName })
                .select()
                .single();
            if (templateError) {
                alert('Error creating template: ' + templateError.message);
                return;
            }
            const templateEvents = events.map(event => ({
                template_id: template.id,
                title: event.title,
                start_time: event.start_time,
                end_time: event.end_time,
                category: event.category,
            }));
            const { error: eventsError } = await db.from('template_events').insert(templateEvents);
            if (eventsError) {
                alert('Error saving template events: ' + eventsError.message);
            } else {
                alert(`Template "${templateName}" saved successfully!`);
            }
        }
        
        // MODIFIED: Renders buttons for Load, Edit, Delete
        async function showLoadTemplateModal() {
            const { data: templates, error } = await db.from('schedule_templates').select('*');
            if (error) {
                alert('Error fetching templates: ' + error.message);
                return;
            }
            
            const templateList = document.getElementById('template-list');
            templateList.innerHTML = '';
            if (templates.length === 0) {
                templateList.innerHTML = '<p class="text-slate-500">No saved templates found.</p>';
            } else {
                templates.forEach(template => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700';
                    el.innerHTML = `
                        <span class="font-medium load-template-btn" data-load-id="${template.id}">${template.name}</span>
                        <div class="flex gap-2">
                            <button class="edit-template-btn p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600" data-edit-id="${template.id}" title="Edit Template">
                                <span class="material-symbols-outlined text-sm">edit</span>
                            </button>
                            <button class="delete-template-btn p-2 rounded-full hover:bg-red-500/20 text-red-500" data-delete-id="${template.id}" title="Delete Template">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    `;
                    templateList.appendChild(el);
                });
            }
            document.getElementById('load-template-modal').classList.remove('hidden');
            document.getElementById('load-template-modal').classList.add('flex');
        }
        
        // This function remains the same
        async function loadTemplate(templateId) {
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to load templates.");
                return;
            }
            if (!confirm('This will add the template events to the current day. Are you sure?')) {
                return;
            }
            
            const { data: templateEvents, error } = await db.from('template_events')
                .select('*')
                .eq('template_id', templateId);
            if (error) {
                alert('Error fetching template events: ' + error.message);
                return;
            }
            
            const dateString = toYMD(selectedDate);
            const newEvents = templateEvents.map(event => ({
                date: dateString,
                title: event.title,
                start_time: event.start_time,
                end_time: event.end_time,
                category: event.category,
            }));
            const { error: insertError } = await db.from('events').insert(newEvents);
            
            if (insertError) {
                alert('Error loading template: ' + insertError.message);
            } else {
                document.getElementById('load-template-modal').classList.add('hidden');
                document.getElementById('load-template-modal').classList.remove('flex');
                displayEvents(selectedDate);
            }
        }
        
        // === NEW TEMPLATE EDITOR FUNCTIONS ===
        async function deleteTemplate(templateId) {
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to delete templates.");
                return;
            }
            if (!confirm('Are you sure you want to delete this template and all its events? This cannot be undone.')) {
                return;
            }
            
            // Delete child events first
            const { error: eventsError } = await db.from('template_events').delete().eq('template_id', templateId);
            if (eventsError) {
                alert('Error deleting template events: ' + eventsError.message);
                return;
            }
            
            // Delete parent template
            const { error: templateError } = await db.from('schedule_templates').delete().eq('id', templateId);
            if (templateError) {
                alert('Error deleting template: ' + templateError.message);
                return;
            }
            
            // Refresh the modal
            showLoadTemplateModal();
        }
        
        async function showTemplateEditor(templateId) {
            editingTemplateId = templateId;
            const { data: template, error } = await db.from('schedule_templates').select('name').eq('id', templateId).single();
            if (error) {
                alert('Error fetching template details: ' + error.message);
                return;
            }
            
            document.getElementById('template-editor-name').textContent = template.name;
            document.getElementById('load-template-modal').classList.add('hidden');
            document.getElementById('load-template-modal').classList.remove('flex');
            showView('#template-editor-view');
            displayTemplateEvents(templateId);
        }
        
        async function displayTemplateEvents(templateId) {
            const eventsContainer = document.getElementById('template-events-container');
            eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">Loading template events...</p>`;
            
            const { data: events, error } = await db.from('template_events').select('*').eq('template_id', templateId);
            
            eventsContainer.innerHTML = '';
            if (error) {
                console.error('Error fetching template events:', error);
                eventsContainer.innerHTML = `<p class="text-center text-red-500 pt-4">Could not load events.</p>`;
                return;
            }
            if (!events || events.length === 0) {
                eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">No events in this template.</p>`;
                return;
            }
            
            events.forEach(event => {
                const start = timeToDecimal(event.start_time);
                const end = timeToDecimal(event.end_time);
                const eventEl = document.createElement('div');
                const colorClasses = getCategoryClasses(event.category);
                
                eventEl.className = `absolute p-2 rounded-lg overflow-hidden cursor-pointer ${colorClasses} hover:opacity-80`;
                eventEl.style.cssText = `top:calc(${start}*4rem);height:calc(${(end-start)}*4rem);left:.5rem;right:.5rem;`;
                eventEl.innerHTML = `<p class="font-bold text-sm truncate">${event.title}</p><p class="text-xs opacity-80">${formatTime(event.start_time)}</p>`;
                
                eventEl.addEventListener('click', () => editTemplateEvent(event));
                eventsContainer.appendChild(eventEl);
            });
        }
        
        function editTemplateEvent(event) {
            editingTemplateEventId = event.id;
            // Populate template form
            document.getElementById('template-title').value = event.title;
            document.getElementById('template-category').value = event.category;
            document.getElementById('template-start-time').value = event.start_time;
            document.getElementById('template-end-time').value = event.end_time;
            
            // Update UI for editing
            document.querySelector('#template-form-view h2').textContent = 'Edit Template Event';
            document.querySelector('#template-event-form button[type="submit"]').textContent = 'Update Event';
            document.getElementById('delete-template-event-btn').classList.remove('hidden');
            
            showView('#template-form-view');
        }
        
        async function handleTemplateEventFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save changes.");
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const eventData = Object.fromEntries(formData.entries());
            if (eventData.start_time.length === 5) eventData.start_time += ':00';
            if (eventData.end_time.length === 5) eventData.end_time += ':00';
            
            let response;
            if (editingTemplateEventId) {
                response = await db.from('template_events').update(eventData).eq('id', editingTemplateEventId);
            } else {
                eventData.template_id = editingTemplateId;
                response = await db.from('template_events').insert([eventData]);
            }
            if (response.error) {
                alert('Error: ' + response.error.message);
            } else {
                showTemplateEditor(editingTemplateId);
            }
        }
        
        async function deleteTemplateEvent() {
            if (!editingTemplateEventId || !confirm('Are you sure you want to delete this event from the template?')) {
                return;
            }
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to delete the event.");
                return;
            }
            const { error } = await db.from('template_events').delete().eq('id', editingTemplateEventId);
            if (error) {
                alert('Error deleting event: ' + error.message);
            } else {
                showTemplateEditor(editingTemplateId);
            }
        }

        // === POMODORO TIMER LOGIC (UPDATED) ===
        function stopAlerts() {
            if (flashingInterval) {
                clearInterval(flashingInterval);
                flashingInterval = null;
            }
            // Restore original title and favicon
            document.title = originalTitle;
            const faviconEl = document.getElementById('favicon');
            if (faviconEl) {
                faviconEl.href = originalFavicon;
            }
        }
        function updatePomodoroTimerDisplay() {
            const minutes = Math.floor(pomodoroTimeLeft / 60);
            const seconds = pomodoroTimeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('pomodoro-timer-display').textContent = display;
            
            const sessionName = pomodoroCurrentSession.replace(/([A-Z])/g, ' $1');
            const capitalizedSessionName = sessionName.charAt(0).toUpperCase() + sessionName.slice(1);
            
            // Only update the title if the timer is running (not in a "Time's Up" state)
            if (!flashingInterval) {
                 const newTitle = `${display} | ${capitalizedSessionName} - TaskMaster`;
                 document.title = newTitle;
                 originalTitle = newTitle; // Keep track of the last "normal" title
            }
            document.getElementById('pomodoro-cycle-count').textContent = `Cycle: ${pomodoroCycleCount} / ${pomodoroSettings.longBreakCycle}`;
        }
        function updatePomodoroButton(isRunning) {
            const startPauseBtn = document.getElementById('pomodoro-start-pause-btn');
            const startPauseText = document.getElementById('pomodoro-start-pause-text');
            const playIcon = startPauseBtn.querySelector('.material-symbols-outlined');
            if (isRunning) {
                startPauseText.textContent = 'Pause';
                playIcon.textContent = 'pause';
                startPauseBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                startPauseBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
            } else {
                startPauseText.textContent = 'Start';
                playIcon.textContent = 'play_arrow';
                startPauseBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                startPauseBtn.classList.add('bg-primary', 'hover:bg-primary/90');
            }
        }
        function setPomodoroSession(session) {
            pausePomodoroTimer();
            stopAlerts();
            pomodoroCurrentSession = session;
            let durationMinutes = pomodoroSettings[session];
            pomodoroTimeLeft = durationMinutes * 60;
            
            document.querySelectorAll('.timer-session-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300', 'hover:bg-slate-300', 'dark:hover:bg-slate-600');
            });
            document.getElementById(`pomodoro-${session.replace(/([A-Z])/g, '-$1').toLowerCase()}-btn`).classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300', 'hover:bg-slate-300', 'dark:hover:bg-slate-600');
            document.getElementById(`pomodoro-${session.replace(/([A-Z])/g, '-$1').toLowerCase()}-btn`).classList.add('bg-primary', 'text-white');
            
            updatePomodoroTimerDisplay();
        }
        
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }
        function startPomodoroTimer() {
            if (pomodoroIsRunning) return;
            
            requestNotificationPermission();
            stopAlerts();
            pomodoroIsRunning = true;
            updatePomodoroButton(true);
            timerInterval = setInterval(() => {
                pomodoroTimeLeft--;
                if (pomodoroTimeLeft < 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    handleSessionEnd();
                } else {
                    updatePomodoroTimerDisplay();
                }
            }, 1000);
        }
        function pausePomodoroTimer() {
            if (!pomodoroIsRunning) return;
            pomodoroIsRunning = false;
            updatePomodoroButton(false);
            clearInterval(timerInterval);
            timerInterval = null;
        }
        function resetPomodoroTimer() {
            pausePomodoroTimer();
            stopAlerts();
            pomodoroCurrentSession = 'work';
            pomodoroTimeLeft = pomodoroSettings.work * 60;
            pomodoroCycleCount = 0;
            setPomodoroSession('work'); // This will also call stopAlerts again but it's fine
            updatePomodoroButton(false);
            updatePomodoroTimerDisplay();
        }
        function handleSessionEnd() {
            pomodoroIsRunning = false;
            updatePomodoroButton(false);
            // 1. Sound Alert
            alarmSound.play();
            
            // 2. Dynamic Favicon Change
            const faviconEl = document.getElementById('favicon');
            const bellFavicon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ef4444'%3E%3Cpath d='M12 22C13.1 22 14 21.1 14 20H10C10 21.1 10.9 22 12 22ZM18 16V11C18 7.93 16.36 5.36 13.5 4.68V4C13.5 3.17 12.83 2.5 12 2.5C11.17 2.5 10.5 3.17 10.5 4V4.68C7.63 5.36 6 7.93 6 11V16L4 18V19H20V18L18 16Z'/%3E%3C/svg%3E";
            if (faviconEl) {
                faviconEl.href = bellFavicon;
            }
            // 3. Desktop Notification
            const sessionEndText = pomodoroCurrentSession === 'work' ? 'Work session complete! Time for a break.' : 'Break complete! Time to get back to work.';
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('TaskMaster Pomodoro', {
                    body: sessionEndText,
                    icon: bellFavicon
                });
            }
            
            // 4. Flashing Tab Title
            let isTitleToggled = false;
            flashingInterval = setInterval(() => {
                document.title = isTitleToggled ? "⏰ Time's up!" : sessionEndText;
                isTitleToggled = !isTitleToggled;
            }, 1000);
            // Set up the next session but don't start it
            if (pomodoroCurrentSession === 'work') {
                pomodoroCycleCount++;
                if (pomodoroCycleCount > 0 && pomodoroCycleCount % pomodoroSettings.longBreakCycle === 0) {
                    setPomodoroSession('longBreak');
                } else {
                    setPomodoroSession('shortBreak');
                }
            } else { // Break session end
                setPomodoroSession('work');
            }
            pausePomodoroTimer(); // Ensure timer is paused
        }
        function applyPomodoroSettings() {
            const workDuration = parseInt(document.getElementById('work-duration').value);
            const shortBreakDuration = parseInt(document.getElementById('short-break-duration').value);
            const longBreakDuration = parseInt(document.getElementById('long-break-duration').value);
            if (workDuration > 0 && shortBreakDuration > 0 && longBreakDuration > 0) {
                pomodoroSettings.work = workDuration;
                pomodoroSettings.shortBreak = shortBreakDuration;
                pomodoroSettings.longBreak = longBreakDuration;
                localStorage.setItem('pomodoroSettings', JSON.stringify(pomodoroSettings));
                resetPomodoroTimer();
                // A simple feedback without using alert()
                const applyBtn = document.getElementById('apply-pomodoro-settings-btn');
                const originalText = applyBtn.textContent;
                applyBtn.textContent = 'Settings Applied!';
                setTimeout(() => { applyBtn.textContent = originalText; }, 2000);
            } else {
                // Let's provide feedback without an alert
                 const applyBtn = document.getElementById('apply-pomodoro-settings-btn');
                 applyBtn.textContent = 'Please use positive numbers.';
                 applyBtn.classList.add('bg-red-500');
                 setTimeout(() => { 
                    applyBtn.textContent = 'Apply Settings';
                    applyBtn.classList.remove('bg-red-500');
                 }, 3000);
            }
        }
        
        function loadPomodoroSettings() {
            const savedSettings = localStorage.getItem('pomodoroSettings');
            if (savedSettings) {
                pomodoroSettings = JSON.parse(savedSettings);
                document.getElementById('work-duration').value = pomodoroSettings.work;
                document.getElementById('short-break-duration').value = pomodoroSettings.shortBreak;
                document.getElementById('long-break-duration').value = pomodoroSettings.longBreak;
            }
            pomodoroTimeLeft = pomodoroSettings.work * 60;
        }

        // === ONLINE/OFFLINE STATUS HANDLING ===
        function updateOnlineStatus() {
            const onlineStatusIndicator = document.getElementById('online-status');
            if (navigator.onLine) {
                onlineStatusIndicator.classList.add('bg-green-500');
                onlineStatusIndicator.classList.remove('bg-red-500');
                onlineStatusIndicator.title = 'Online';
            } else {
                onlineStatusIndicator.classList.add('bg-red-500');
                onlineStatusIndicator.classList.remove('bg-green-500');
                onlineStatusIndicator.title = 'Offline - Some features may be unavailable';
            }
        }
        
        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            originalTitle = document.title;
            originalFavicon = document.getElementById('favicon').href;
            loadPomodoroSettings();
            
            flatpickr('#date', { defaultDate: 'today', dateFormat: 'Y-m-d' });
            flatpickr('#task-due-date', { defaultDate: 'today', dateFormat: 'Y-m-d' });
            flatpickr('#project-task-due-date', { defaultDate: 'today', dateFormat: 'Y-m-d' });
            
            renderHourGrid();
            renderTemplateEditorGrid(); // NEW: Render the grid for the new editor
            
            // --- NEW NAVIGATION LOGIC ---
            // This handles both desktop and the new mobile navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = link.dataset.view;
                    if (viewId) showView(viewId);
                });
            });
            
            // The profile pic is not a standard nav link, so it gets its own listener
            document.getElementById('profile-pic').addEventListener('click', () => showView('#settings-view'));
            // Pomodoro event listeners
            document.getElementById('pomodoro-start-pause-btn').addEventListener('click', () => pomodoroIsRunning ? pausePomodoroTimer() : startPomodoroTimer());
            document.getElementById('pomodoro-reset-btn').addEventListener('click', resetPomodoroTimer);
            document.getElementById('pomodoro-work-btn').addEventListener('click', () => setPomodoroSession('work'));
            document.getElementById('pomodoro-short-break-btn').addEventListener('click', () => setPomodoroSession('shortBreak'));
            document.getElementById('pomodoro-long-break-btn').addEventListener('click', () => setPomodoroSession('longBreak'));
            document.getElementById('apply-pomodoro-settings-btn').addEventListener('click', applyPomodoroSettings);
            // Form submissions
            document.getElementById('event-form').addEventListener('submit', handleEventFormSubmit);
            document.getElementById('new-task-form').addEventListener('submit', handleTaskFormSubmit);
            document.getElementById('new-project-form').addEventListener('submit', handleProjectFormSubmit);
            document.getElementById('new-project-task-form').addEventListener('submit', handleProjectTaskFormSubmit);
            document.getElementById('template-event-form').addEventListener('submit', handleTemplateEventFormSubmit); // NEW
            
            // Button clicks
            document.getElementById('delete-event-btn').addEventListener('click', deleteEvent);
            document.getElementById('add-event-btn').addEventListener('click', () => showView('#form-view'));
            document.getElementById('cancel-btn').addEventListener('click', () => {
                editingEventId = null;
                document.getElementById('event-form').reset();
                document.querySelector('#form-view h2').textContent = 'New Event';
                document.querySelector('#event-form button[type="submit"]').textContent = 'Create Event';
                document.getElementById('delete-event-btn').classList.add('hidden');
                showView('#schedule-view');
            });
            document.getElementById('new-task-btn').addEventListener('click', () => showView('#new-task-view'));
            document.getElementById('cancel-task-btn').addEventListener('click', () => {
                editingTodoId = null;
                document.getElementById('new-task-form').reset();
                document.querySelector('#new-task-view h2').textContent = 'New Task';
                document.querySelector('#new-task-form button[type="submit"]').textContent = 'Create Task';
                showView('#todo-view');
            });
            document.getElementById('new-project-btn').addEventListener('click', () => showView('#new-project-view'));
            document.getElementById('cancel-project-btn').addEventListener('click', () => showView('#projects-view'));
            document.getElementById('new-project-task-btn').addEventListener('click', () => showView('#new-project-task-view'));
            document.getElementById('cancel-project-task-btn').addEventListener('click', () => {
                editingTaskId = null;
                document.getElementById('new-project-task-form').reset();
                document.querySelector('#new-project-task-view h2').textContent = 'New Project Task';
                document.querySelector('#new-project-task-form button[type="submit"]').textContent = 'Create Task';
                showView('#projects-view');
            });
            
            // Calendar controls
            document.getElementById('cal1-prev-btn').addEventListener('click', () => { calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() - 1); initializeCalendarView(); });
            document.getElementById('cal2-next-btn').addEventListener('click', () => { calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() + 1); initializeCalendarView(); });
            
            // Template controls
            document.getElementById('schedule-tomorrow-btn').addEventListener('click', scheduleForTomorrow);
            document.getElementById('save-template-btn').addEventListener('click', saveCurrentDayAsTemplate);
            document.getElementById('load-template-btn').addEventListener('click', showLoadTemplateModal);
            document.getElementById('close-template-modal-btn').addEventListener('click', () => {
                document.getElementById('load-template-modal').classList.add('hidden');
                document.getElementById('load-template-modal').classList.remove('flex');
            });
            
            // === NEW: TEMPLATE EDITOR/FORM LISTENERS ===
            document.getElementById('close-template-editor-btn').addEventListener('click', () => showView('#schedule-view'));
            document.getElementById('add-template-event-btn').addEventListener('click', () => {
                editingTemplateEventId = null; // Ensure we are creating new
                document.getElementById('template-event-form').reset();
                document.querySelector('#template-form-view h2').textContent = 'New Template Event';
                document.querySelector('#template-event-form button[type="submit"]').textContent = 'Create Event';
                document.getElementById('delete-template-event-btn').classList.add('hidden');
                showView('#template-form-view');
            });
            document.getElementById('delete-template-event-btn').addEventListener('click', deleteTemplateEvent);
            document.getElementById('cancel-template-btn').addEventListener('click', () => {
                // Go back to the template editor
                showTemplateEditor(editingTemplateId);
            });
            
            // === NEW: Event delegation for template modal ===
            document.getElementById('template-list').addEventListener('click', (e) => {
                const loadBtn = e.target.closest('.load-template-btn');
                const editBtn = e.target.closest('.edit-template-btn');
                const deleteBtn = e.target.closest('.delete-template-btn');
                
                if (loadBtn) {
                    loadTemplate(loadBtn.dataset.loadId);
                } else if (editBtn) {
                    showTemplateEditor(editBtn.dataset.editId);
                } else if (deleteBtn) {
                    deleteTemplate(deleteBtn.dataset.deleteId);
                }
            });

            // Global event listeners for dynamic content
            document.addEventListener('change', async (e) => {
                if (e.target.matches('#today-tasks input[type="checkbox"], #upcoming-tasks input[type="checkbox"], #overdue-tasks input[type="checkbox"]')) {
                    if (!navigator.onLine) {
                        alert("You are offline. Please reconnect to update tasks.");
                        e.target.checked = !e.target.checked; // Revert the checkbox change
                        return;
                    }
                    const taskId = e.target.dataset.id;
                    const newStatus = e.target.checked ? 'Completed' : 'Pending';
                
                    const { error } = await db.from('todos').update({ status: newStatus }).eq('id', taskId);
                    if (error) {
                        console.error('Error updating task:', error);
                    } else {
                        displayTodos();
                    }
                }
            });
            document.addEventListener('click', (e) => {
                const optionsBtn = e.target.closest('.todo-options-btn');
                if (optionsBtn) {
                    e.stopPropagation();
                    const task = JSON.parse(optionsBtn.dataset.task);
                    showTodoOptionsMenu(task, optionsBtn);
                }
            });
            setupDragAndDrop();

            // Setup Online/Offline listeners
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus(); // Initial check

            // === NEW: HEADER SCROLL LOGIC ===
            let lastScrollTop = 0;
            const header = document.querySelector('header');
            window.addEventListener("scroll", function() {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop && scrollTop > 50) {
                    // Downscroll
                    header.classList.add('-translate-y-full');
                } else if (scrollTop === 0) {
                    // At the very top
                    header.classList.remove('-translate-y-full');
                }
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; // For Mobile or negative scrolling
            }, false);
            
            // Initial view
            showView('#schedule-view');
        });
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
</body>
</html>
