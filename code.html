<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>DayWise Application</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Tailwind Config & Dark Mode Setup
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: { "display": ["Inter"] },
                },
            },
        }

        // Apply theme from localStorage on initial load to prevent flashing
        function applyTheme(theme) {
            const htmlTag = document.documentElement;
            localStorage.setItem('theme', theme);
            if (theme === 'dark') htmlTag.classList.add('dark');
            else if (theme === 'light') htmlTag.classList.remove('dark');
            else { // System default
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) htmlTag.classList.add('dark');
                else htmlTag.classList.remove('dark');
            }
        }
        
        const savedTheme = localStorage.getItem('theme') || 'system';
        applyTheme(savedTheme);
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

    <header class="flex items-center justify-between px-6 py-3 border-b border-slate-200 dark:border-slate-800 sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-50">
        <div class="flex items-center gap-4">
            <div class="text-primary size-7"><svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H42L36 24L42 42H6L12 24L6 6Z"></path></svg></div>
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">TaskMaster</h1>
        </div>
        <nav class="hidden md:flex items-center gap-8">
            <a id="today-link" class="text-sm font-medium cursor-pointer">Today</a>
            <a id="calendar-link" class="text-sm font-medium cursor-pointer">Calendar</a>
            <a id="todo-link" class="text-sm font-medium cursor-pointer">To-Do</a>
            <a id="projects-link" class="text-sm font-medium cursor-pointer">Projects</a>
        </nav>
        <div class="flex items-center gap-4">
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined">search</span></button>
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined">notifications</span></button>
            <img alt="User avatar" class="size-10 rounded-full cursor-pointer" id="profile-pic" src="https://i.pravatar.cc/150?u=a042581f4e29026704d"/>
        </div>
    </header>

    <div id="views-container">
        <div id="schedule-view" class="hidden"><main class="flex-1 px-10 py-8"><div class="mx-auto max-w-5xl"><div class="flex items-center justify-between mb-8"><div><h1 id="schedule-title" class="text-3xl font-bold"></h1><p id="current-date" class="text-slate-500"></p></div></div><div class="relative"><div id="hour-grid" class="grid grid-cols-[auto_1fr] gap-x-4"></div><div id="events-container" class="absolute top-0 left-[60px] right-0 bottom-0"></div></div></div></main><div class="fixed bottom-10 right-10"><button id="add-event-btn" class="flex items-center justify-center rounded-full size-14 bg-primary text-white shadow-lg"><span class="material-symbols-outlined">add</span></button></div></div>
        
        <div id="form-view" class="hidden"><main class="w-full max-w-2xl px-4 py-8 mx-auto"><div class="space-y-8"><div><h2 class="text-3xl font-bold">New Event</h2><p class="mt-2 text-slate-500">Create a new event for your schedule.</p></div><form id="event-form" class="space-y-6"><div><label class="block text-sm font-medium" for="title">Title</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="title" name="title" type="text" /></div><div><label class="block text-sm font-medium" for="date">Date</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="date" name="date" type="text" readonly /></div><div class="grid grid-cols-2 gap-6"><div><label class="block text-sm font-medium" for="start-time">Start Time</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="start-time" name="start_time" type="time" /></div><div><label class="block text-sm font-medium" for="end-time">End Time</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="end-time" name="end_time" type="time" /></div></div><div class="flex justify-end pt-4 gap-3"><button id="cancel-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button><button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Event</button></div></form></div></main></div>

        <div id="calendar-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="flex flex-col lg:flex-row justify-center gap-8"><div class="w-full lg:max-w-md bg-white dark:bg-slate-900/50 p-4 rounded-lg"><div class="flex items-center justify-between mb-4"><button id="cal1-prev-btn" class="p-2 rounded-full"><span class="material-symbols-outlined">chevron_left</span></button><h2 id="cal1-month-year" class="text-lg font-semibold"></h2><button class="opacity-0 p-2"><span class="material-symbols-outlined">chevron_right</span></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-500 py-2"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div><div id="cal1-body" class="grid grid-cols-7 gap-1 text-center"></div></div><div class="w-full lg:max-w-md bg-white dark:bg-slate-900/50 p-4 rounded-lg"><div class="flex items-center justify-between mb-4"><button class="opacity-0 p-2"><span class="material-symbols-outlined">chevron_left</span></button><h2 id="cal2-month-year" class="text-lg font-semibold"></h2><button id="cal2-next-btn" class="p-2 rounded-full"><span class="material-symbols-outlined">chevron_right</span></button></div><div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-500 py-2"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div><div id="cal2-body" class="grid grid-cols-7 gap-1 text-center"></div></div></div></main></div>
        
        <div id="todo-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="max-w-4xl mx-auto"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold">My To-Do List</h2><button id="new-task-btn" class="flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg font-semibold"><span class="material-symbols-outlined">add_circle</span>New Task</button></div><div class="bg-white/50 dark:bg-white/5 rounded-lg p-6 mb-8"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">Today's Progress</h3><span id="progress-text" class="text-sm font-medium"></span></div><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5"><div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width:0%"></div></div><div class="grid grid-cols-3 gap-4 text-center mt-4" id="stats-container"></div></div><div class="space-y-6"><div><h3 class="text-lg font-semibold mb-3 border-b pb-2">Today</h3><div id="today-tasks" class="space-y-2"></div></div><div><h3 class="text-lg font-semibold mb-3 border-b pb-2">Upcoming</h3><div id="upcoming-tasks" class="space-y-2"></div></div></div></div></main></div>

        <div id="new-task-view" class="hidden"><main class="w-full max-w-2xl px-4 py-8 mx-auto"><div class="space-y-8"><div><h2 class="text-3xl font-bold">New Task</h2><p class="mt-2 text-slate-500">Add a new item to your to-do list.</p></div><form id="new-task-form" class="space-y-6"><div><label class="block text-sm font-medium" for="task-title">Task Title</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="task-title" name="title" placeholder="e.g., Pay electricity bill" type="text" /></div><div><label class="block text-sm font-medium" for="task-due-date">Due Date</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="task-due-date" name="due_date" type="text" readonly /></div><div><label class="block text-sm font-medium" for="task-category">Category</label><select class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="task-category" name="category"><option>Personal</option><option>Work</option><option>Shopping</option><option>Other</option></select></div><div class="flex justify-end pt-4 gap-3"><button id="cancel-task-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button><button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Task</button></div></form></div></main></div>

        <div id="settings-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="max-w-2xl mx-auto space-y-10"><div><h2 class="text-4xl font-extrabold mb-8 text-slate-900 dark:text-white">Settings</h2></div><section><h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Theme</h3><div id="theme-selector" class="flex rounded-lg bg-white dark:bg-slate-800 p-1 shadow-sm"><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="light">Light</button><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="dark">Dark</button><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="system">System</button></div></section></div></main></div>
        
        <div id="projects-view" class="hidden"><main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8"><div class="flex flex-col gap-6"><div><h2 class="text-3xl font-bold text-slate-900 dark:text-white">Project Tracker</h2><p class="text-slate-500 dark:text-slate-400 mt-1">Manage your projects and tasks efficiently.</p></div><div><h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Project: Marketing Campaign</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4"><div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-800 dark:text-slate-200">To Do</h4><span id="count-todo" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span></div><div id="kanban-todo" class="space-y-4"></div></div><div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4"><div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-800 dark:text-slate-200">In Progress</h4><span id="count-inprogress" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span></div><div id="kanban-inprogress" class="space-y-4"></div></div><div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4"><div class="flex items-center justify-between mb-4"><h4 class="font-bold text-slate-800 dark:text-slate-200">Done</h4><span id="count-done" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span></div><div id="kanban-done" class="space-y-4"></div></div></div></div></div></main></div>
    </div>
    
    <div id="edit-event-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-background-light dark:bg-background-dark rounded-lg shadow-xl w-full max-w-md">
            <form id="edit-event-form" class="p-6 space-y-4">
                <div class="flex justify-between items-center"><h3 class="text-xl font-bold">Edit Event</h3><button type="button" class="close-modal-btn p-1 rounded-full text-2xl leading-none hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button></div>
                <input type="hidden" name="id" id="edit-event-id">
                <div><label for="edit-event-title" class="text-sm font-medium">Title</label><input type="text" name="title" id="edit-event-title" class="mt-1 w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" required></div>
                <div><label for="edit-event-date" class="text-sm font-medium">Date</label><input type="text" name="date" id="edit-event-date" class="mt-1 w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" readonly required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="edit-event-start" class="text-sm font-medium">Start Time</label><input type="time" name="start_time" id="edit-event-start" class="mt-1 w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 [color-scheme:dark]" required></div>
                    <div><label for="edit-event-end" class="text-sm font-medium">End Time</label><input type="time" name="end_time" id="edit-event-end" class="mt-1 w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 [color-scheme:dark]" required></div>
                </div>
                <div class="flex justify-between items-center pt-4">
                    <button id="delete-event-btn" type="button" class="px-4 py-2 text-sm font-medium text-red-600 rounded-md hover:bg-red-500/10">Delete Event</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-todo-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-background-light dark:bg-background-dark rounded-lg shadow-xl w-full max-w-md">
            <form id="edit-todo-form" class="p-6 space-y-4">
                <div class="flex justify-between items-center"><h3 class="text-xl font-bold">Edit Task</h3><button type="button" class="close-modal-btn p-1 rounded-full text-2xl leading-none hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button></div>
                <input type="hidden" name="id" id="edit-todo-id">
                <div><label for="edit-todo-title" class="text-sm font-medium">Title</label><input type="text" name="title" id="edit-todo-title" class="mt-1 w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" required></div>
                <div><label for="edit-todo-date" class="text-sm font-medium">Due Date</label><input type="text" name="due_date" id="edit-todo-date" class="mt-1 w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800" readonly required></div>
                <div><label for="edit-todo-category" class="text-sm font-medium">Category</label><select name="category" id="edit-todo-category" class="mt-1 w-full rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800"><option>Personal</option><option>Work</option><option>Shopping</option><option>Other</option></select></div>
                <div class="flex justify-between items-center pt-4">
                    <button id="delete-todo-btn" type="button" class="px-4 py-2 text-sm font-medium text-red-600 rounded-md hover:bg-red-500/10">Delete Task</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // === SUPABASE & STATE SETUP ===
        const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let selectedDate = new Date();
        let calendarDisplayDate = new Date();

        // === HELPERS ===
        const toYMD = (date) => date.toISOString().split('T')[0];
        const timeToDecimal = (t) => { const [h, m] = t.split(':'); return parseInt(h, 10) + parseInt(m, 10) / 60; };
        const formatTime = (t) => new Date(`1970-01-01T${t}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

        // === VIEW & MODAL MANAGEMENT ===
        function showView(viewId) {
            document.querySelectorAll('#views-container > div').forEach(v => v.classList.add('hidden'));
            document.querySelector(viewId).classList.remove('hidden');
            updateActiveLink(viewId);

            if (viewId === '#schedule-view') displayEvents(selectedDate);
            if (viewId === '#calendar-view') initializeCalendarView();
            if (viewId === '#todo-view') displayTodos();
            if (viewId === '#settings-view') initializeSettings();
            if (viewId === '#projects-view') displayProjects();
        }
        
        function updateActiveLink(activeViewId) {
            const linkMap = { '#schedule-view': '#today-link', '#calendar-view': '#calendar-link', '#todo-view': '#todo-link', '#projects-view': '#projects-link' };
            document.querySelectorAll('header nav a').forEach(link => {
                link.classList.remove('text-primary', 'font-bold');
                link.classList.add('text-slate-600', 'dark:text-slate-300', 'font-medium');
            });
            if (linkMap[activeViewId]) {
                const activeLink = document.querySelector(linkMap[activeViewId]);
                activeLink.classList.add('text-primary', 'font-bold');
                activeLink.classList.remove('text-slate-600', 'dark:text-slate-300', 'font-medium');
            }
        }

        function closeModal(modal) {
            if (modal) modal.classList.add('hidden');
        }
        function openModal(modal) {
            if (modal) modal.classList.remove('hidden');
            if (modal) modal.classList.add('flex');
        }

        // === SCHEDULE VIEW LOGIC & EDITING ===
        function renderHourGrid() {
            const grid = document.getElementById('hour-grid');
            grid.innerHTML = Array.from({length: 24}, (_, i) => `<div class="text-right text-sm text-slate-500 h-16 pt-2 border-b dark:border-slate-800">${new Date(0,0,0,i).toLocaleTimeString('en-US',{hour:'numeric',hour12:true})}</div><div class="border-b dark:border-slate-800"></div>`).join('');
        }
        async function displayEvents(date) {
            const eventsContainer = document.getElementById('events-container');
            const scheduleTitle = document.getElementById('schedule-title');
            const currentDateEl = document.getElementById('current-date');
            const dateString = toYMD(date);
            const isToday = (toYMD(new Date()) === dateString);
            scheduleTitle.textContent = isToday ? "Today" : date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            currentDateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const { data: events, error } = await db.from('events').select('*').eq('date', dateString);
            eventsContainer.innerHTML = '';
            if (error) { console.error('Error fetching events:', error); return; }
            if (!events || events.length === 0) { eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">No events for this day.</p>`; return; }
            
            events.forEach(event => {
                const start = timeToDecimal(event.start_time);
                const end = timeToDecimal(event.end_time);
                const eventEl = document.createElement('div');
                eventEl.className = 'absolute bg-primary/20 dark:bg-primary/30 p-2 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary';
                eventEl.style.cssText = `top:calc(${start}*4rem);height:calc(${(end-start)}*4rem);left:.5rem;right:.5rem;`;
                eventEl.dataset.id = event.id;
                eventEl.innerHTML = `<p class="font-medium text-sm text-primary truncate">${event.title}</p><p class="text-xs text-primary/80">${formatTime(event.start_time)}</p>`;
                eventsContainer.appendChild(eventEl);
            });
        }
        async function handleEventClick(e) {
            const eventEl = e.target.closest('[data-id]');
            if (!eventEl) return;
            const eventId = eventEl.dataset.id;
            const { data: event, error } = await db.from('events').select('*').eq('id', eventId).single();
            if (error) { alert("Could not fetch event details."); return; }
            const form = document.getElementById('edit-event-form');
            form.querySelector('#edit-event-id').value = event.id;
            form.querySelector('#edit-event-title').value = event.title;
            form.querySelector('#edit-event-date')._flatpickr.setDate(event.date);
            form.querySelector('#edit-event-start').value = event.start_time.substring(0, 5);
            form.querySelector('#edit-event-end').value = event.end_time.substring(0, 5);
            openModal(document.getElementById('edit-event-modal'));
        }
        async function handleEditEventSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const eventId = formData.get('id');
            const updatedEvent = {
                title: formData.get('title'),
                date: formData.get('date'),
                start_time: formData.get('start_time') + ':00',
                end_time: formData.get('end_time') + ':00'
            };
            const { error } = await db.from('events').update(updatedEvent).eq('id', eventId);
            if (error) alert('Error updating event: ' + error.message);
            else { closeModal(document.getElementById('edit-event-modal')); displayEvents(selectedDate); }
        }
        async function handleDeleteEvent() {
            const eventId = document.getElementById('edit-event-id').value;
            if (confirm('Are you sure you want to delete this event?')) {
                const { error } = await db.from('events').delete().eq('id', eventId);
                if (error) alert('Error deleting event: ' + error.message);
                else { closeModal(document.getElementById('edit-event-modal')); displayEvents(selectedDate); }
            }
        }

        // === FORM SUBMISSION LOGIC ===
        async function handleEventFormSubmit(e) { e.preventDefault(); const form=e.target,formData=new FormData(form),newEvent=Object.fromEntries(formData.entries()); newEvent.start_time+=':00'; newEvent.end_time+=':00'; const {error}=await db.from('events').insert([newEvent]); if(error)alert('Error: '+error.message); else{form.reset();showView('#schedule-view');} }
        async function handleTaskFormSubmit(e) { e.preventDefault(); const form=e.target,formData=new FormData(form),newTask=Object.fromEntries(formData.entries()); newTask.status='Pending'; const {error}=await db.from('todos').insert([newTask]); if(error)alert('Error: '+error.message); else{form.reset();showView('#todo-view');} }
        
        // === CALENDAR VIEW LOGIC ===
        async function initializeCalendarView() { const d1=new Date(calendarDisplayDate),d2=new Date(d1); d2.setMonth(d2.getMonth()+1); const {data,error}=await db.from('events').select('date').gte('date',toYMD(new Date(d1.getFullYear(),d1.getMonth(),1))).lte('date',toYMD(new Date(d2.getFullYear(),d2.getMonth()+1,0))); const eventDates=error?new Set():new Set(data.map(e=>e.date)); renderMonth(d1.getFullYear(),d1.getMonth(),document.getElementById('cal1-body'),document.getElementById('cal1-month-year'),eventDates); renderMonth(d2.getFullYear(),d2.getMonth(),document.getElementById('cal2-body'),document.getElementById('cal2-month-year'),eventDates); }
        function renderMonth(y,m,body,title,dates) { body.innerHTML=''; title.textContent=new Date(y,m).toLocaleString('default',{month:'long',year:'numeric'}); const first=new Date(y,m,1).getDay(),days=new Date(y,m+1,0).getDate(); for(let i=0;i<first;i++)body.insertAdjacentHTML('beforeend','<div></div>'); for(let d=1;d<=days;d++){const date=new Date(y,m,d),dateStr=toYMD(date);const btn=document.createElement('button');btn.className='relative h-10 w-10 flex items-center justify-center rounded-full '+(toYMD(selectedDate)===dateStr?'bg-primary text-white':'hover:bg-slate-200 dark:hover:bg-slate-800');btn.innerHTML=d+(dates.has(dateStr)?'<span class="absolute bottom-1 h-1 w-1 bg-primary rounded-full"></span>':'');btn.onclick=()=>{selectedDate=date;showView('#schedule-view');};body.appendChild(btn);} }

        // === TO-DO VIEW LOGIC & EDITING ===
        async function displayTodos() { const { data, error } = await db.from('todos').select('*').order('due_date'); if (error) { console.error("Error fetching todos:", error); return; } const today=toYMD(new Date()), todayTasks=data.filter(t=>t.due_date===today), upcomingTasks=data.filter(t=>t.due_date>today); renderTasks(todayTasks,document.getElementById('today-tasks')); renderTasks(upcomingTasks,document.getElementById('upcoming-tasks')); updateTodoStats(data,todayTasks); }
        function renderTasks(tasks, container) { container.innerHTML = tasks.length ? tasks.map(renderTask).join('') : '<p class="text-slate-500 p-4">No tasks.</p>'; }
        function renderTask(task) { const isCompleted=task.status==='Completed', statusColors={'Pending':'bg-red-500/20 text-red-500','In Progress':'bg-yellow-500/20 text-yellow-500','Completed':'bg-green-500/20 text-green-500'}, dueDateText=getDueDateText(task.due_date); return `<div class="relative flex items-center gap-4 p-4 rounded-lg bg-white/50 dark:bg-white/5 ${isCompleted?'opacity-60':''}" data-id="${task.id}"><input type="checkbox" data-id="${task.id}" class="form-checkbox h-5 w-5 rounded" ${isCompleted?'checked':''}><div class="flex-grow"><p class="font-medium ${isCompleted?'line-through':''}">${task.title}</p><p class="text-sm text-slate-500 ${isCompleted?'line-through':''}">${dueDateText} • ${task.category}</p></div><span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[task.status]||''}">${task.status}</span><button data-action="toggle-menu" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"><span class="material-symbols-outlined text-slate-400 pointer-events-none">more_vert</span></button><div data-menu class="absolute top-12 right-4 bg-white dark:bg-slate-800 rounded-md shadow-lg border dark:border-slate-700 hidden text-sm w-28 z-10"><button data-action="edit" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-t-md">Edit</button><button data-action="delete" class="w-full text-left px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 text-red-500 rounded-b-md">Delete</button></div></div>`; }
        async function handleTodoActions(e) {
            const action = e.target.dataset.action;
            if (!action) { if (!e.target.closest('[data-menu]')) document.querySelectorAll('[data-menu]').forEach(m => m.classList.add('hidden')); return; }
            const taskEl = e.target.closest('[data-id]'), taskId = taskEl.dataset.id;
            if (action === 'toggle-menu') { const menu=taskEl.querySelector('[data-menu]'),isHidden=menu.classList.contains('hidden'); document.querySelectorAll('[data-menu]').forEach(m=>m.classList.add('hidden')); if(isHidden)menu.classList.remove('hidden'); }
            else if (action === 'edit') { const {data,error}=await db.from('todos').select('*').eq('id',taskId).single(); if(error)return; const form=document.getElementById('edit-todo-form'); form.querySelector('#edit-todo-id').value=data.id; form.querySelector('#edit-todo-title').value=data.title; form.querySelector('#edit-todo-date')._flatpickr.setDate(data.due_date); form.querySelector('#edit-todo-category').value=data.category; openModal(document.getElementById('edit-todo-modal')); }
            else if (action === 'delete') { if (confirm('Delete this task?')) { const {error}=await db.from('todos').delete().eq('id',taskId); if(error)alert(error.message); else displayTodos(); } }
        }
        async function handleEditTodoSubmit(e) { e.preventDefault(); const form=e.target,formData=new FormData(form),todoId=formData.get('id'),updatedTodo={title:formData.get('title'),due_date:formData.get('due_date'),category:formData.get('category')}; const {error}=await db.from('todos').update(updatedTodo).eq('id',todoId); if(error)alert(error.message); else{closeModal(document.getElementById('edit-todo-modal'));displayTodos();} }
        function handleDeleteTodo() { const todoId=document.getElementById('edit-todo-id').value; if(confirm('Delete this task?')) { db.from('todos').delete().eq('id',todoId).then(({error})=>{if(error)alert(error.message); else{closeModal(document.getElementById('edit-todo-modal'));displayTodos();}}); } }
        function getDueDateText(d) { const today=new Date(toYMD(new Date())),due=new Date(d+'T00:00:00'),diff=Math.ceil((due-today)/(864e5)); if(diff===0)return'Due Today';if(diff===1)return'Due Tomorrow';if(diff>1)return`Due in ${diff} days`;return`Due ${due.toLocaleDateString()}`; }
        function updateTodoStats(all,today) { const completed=today.filter(t=>t.status==='Completed').length,pending=today.length-completed,totalPending=all.filter(t=>t.status!=='Completed').length,progress=today.length?completed/today.length*100:0; document.getElementById('progress-bar').style.width=`${progress}%`; document.getElementById('progress-text').textContent=`${Math.round(progress)}% Complete`; document.getElementById('stats-container').innerHTML=`<div><p class="text-2xl font-bold">${completed}</p><p class="text-sm">Completed Today</p></div><div><p class="text-2xl font-bold">${pending}</p><p class="text-sm">Pending Today</p></div><div><p class="text-2xl font-bold">${totalPending}</p><p class="text-sm">Total Pending</p></div>`; }
        async function handleTodoToggle(e) { if(e.target.matches('#todo-view input[type="checkbox"]')) { const id=e.target.dataset.id,status=e.target.checked?'Completed':'Pending'; await db.from('todos').update({status}).eq('id',id); displayTodos();} }
        
        // === SETTINGS VIEW LOGIC ===
        function initializeSettings() {
            const savedTheme=localStorage.getItem('theme')||'system'; updateThemeButtons(savedTheme);
            document.querySelectorAll('#theme-selector button').forEach(b=>b.onclick=()=>applyTheme(b.dataset.theme));
        }
        function updateThemeButtons(activeTheme) { document.querySelectorAll('#theme-selector button').forEach(btn => { btn.classList.toggle('bg-primary', btn.dataset.theme === activeTheme); btn.classList.toggle('text-white', btn.dataset.theme === activeTheme); btn.classList.toggle('bg-white', btn.dataset.theme !== activeTheme); btn.classList.toggle('dark:bg-slate-800', btn.dataset.theme !== activeTheme); }); }
        
        // === PROJECT TRACKER VIEW LOGIC ===
        async function displayProjects() { const{data,error}=await db.from('project_tasks').select('*').eq('project_name','Marketing Campaign').order('due_date');if(error)return;const cols={'To Do':document.getElementById('kanban-todo'),'In Progress':document.getElementById('kanban-inprogress'),'Done':document.getElementById('kanban-done')};Object.values(cols).forEach(c=>c.innerHTML='');data.forEach(t=>{if(cols[t.status])cols[t.status].innerHTML+=`<div class="bg-background-light dark:bg-background-dark p-4 rounded-lg border dark:border-slate-800 shadow-sm"><p class="font-medium">${t.title}</p><div class="flex items-center justify-between mt-2 text-sm text-slate-500"><span>Due: ${t.due_date}</span><span>${t.assignee}</span></div></div>`;});document.getElementById('count-todo').textContent=data.filter(t=>t.status==='To Do').length;document.getElementById('count-inprogress').textContent=data.filter(t=>t.status==='In Progress').length;document.getElementById('count-done').textContent=data.filter(t=>t.status==='Done').length; }
        
        // === INITIALIZATION & EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', () => {
            flatpickr("#date", { altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", defaultDate: "today" });
            flatpickr("#task-due-date", { altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", defaultDate: "today" });
            flatpickr("#edit-event-date", { altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d" });
            flatpickr("#edit-todo-date", { altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d" });
            
            renderHourGrid();
            showView('#schedule-view');

            document.getElementById('today-link').addEventListener('click', () => showView('#schedule-view'));
            document.getElementById('calendar-link').addEventListener('click', () => showView('#calendar-view'));
            document.getElementById('todo-link').addEventListener('click', () => showView('#todo-view'));
            document.getElementById('projects-link').addEventListener('click', () => showView('#projects-view'));
            document.getElementById('profile-pic').addEventListener('click', () => showView('#settings-view'));
            document.getElementById('add-event-btn').addEventListener('click', () => showView('#form-view'));
            document.getElementById('cancel-btn').addEventListener('click', () => showView('#schedule-view'));
            document.getElementById('event-form').addEventListener('submit', handleEventFormSubmit);
            document.getElementById('new-task-btn').addEventListener('click', () => showView('#new-task-view'));
            document.getElementById('cancel-task-btn').addEventListener('click', () => showView('#todo-view'));
            document.getElementById('new-task-form').addEventListener('submit', handleTaskFormSubmit);
            document.getElementById('edit-event-form').addEventListener('submit', handleEditEventSubmit);
            document.getElementById('delete-event-btn').addEventListener('click', handleDeleteEvent);
            document.getElementById('edit-todo-form').addEventListener('submit', handleEditTodoSubmit);
            document.getElementById('delete-todo-btn').addEventListener('click', handleDeleteTodo);
            document.getElementById('events-container').addEventListener('click', handleEventClick);
            document.getElementById('todo-view').addEventListener('click', handleTodoActions);
            document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', e => closeModal(e.target.closest('.fixed'))));
            document.querySelectorAll('#edit-event-modal, #edit-todo-modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m); }));
            document.getElementById('cal1-prev-btn').addEventListener('click', () => { calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() - 1); initializeCalendarView(); });
            document.getElementById('cal2-next-btn').addEventListener('click', () => { calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() + 1); initializeCalendarView(); });
            document.getElementById('views-container').addEventListener('change', handleTodoToggle);
        });
    </script>
</body>
</html>
