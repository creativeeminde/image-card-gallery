<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>TaskMaster</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#101922"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TaskMaster">
    <link rel="apple-touch-icon" href="icons/icon-180x180.png">
    
    <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23137fec'/%3E%3C/svg%3E">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Tailwind Config & Dark Mode Setup
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f3f4f6", 
                        "background-dark": "#101922",
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] },
                    animation: {
                        "fade-in": "fadeIn 0.3s ease-out forwards",
                    },
                    keyframes: {
                        fadeIn: {
                            "0%": { opacity: "0", transform: "translateY(10px)" },
                            "100%": { opacity: "1", transform: "translateY(0)" },
                        },
                    },
                },
            },
        }

        // Apply theme from localStorage on initial load to prevent flashing
        function applyTheme(theme) {
            const htmlTag = document.documentElement;
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                htmlTag.classList.add('dark');
            } else if (theme === 'light') {
                htmlTag.classList.remove('dark');
            } else { // System default
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    htmlTag.classList.add('dark');
                } else {
                    htmlTag.classList.remove('dark');
                }
            }
        }
        
        // Initial theme application
        const savedTheme = localStorage.getItem('theme') || 'system';
        applyTheme(savedTheme);
    </script>
    
    <style>
        /* Ensures tap feedback on iOS */
        [onclick], [data-view], .load-template-btn, .edit-template-btn, .delete-template-btn, .event-card {
          cursor: pointer;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 20px;
        }
        /* Hide scrollbar for goal filter tabs but keep functionality */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* NEW: Kanban connector arrows */
        .kanban-item {
            position: relative;
        }
        .kanban-item:not(:last-child)::after {
            content: 'expand_more';
            font-family: 'Material Symbols Outlined';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            color: #cbd5e1;
            z-index: 0;
            pointer-events: none;
        }
        .dark .kanban-item:not(:last-child)::after {
            color: #334155;
        }
        
        /* NEW: Calendar Hatched Pattern */
        .bg-hatched {
            background-image: repeating-linear-gradient(45deg, transparent, transparent 6px, rgba(0,0,0,0.03) 6px, rgba(0,0,0,0.03) 8px);
        }
        .dark .bg-hatched {
            background-image: repeating-linear-gradient(45deg, transparent, transparent 6px, rgba(255,255,255,0.03) 6px, rgba(255,255,255,0.03) 8px);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 pb-20 md:pb-0">

    <header class="flex items-center justify-between px-6 py-3 border-b border-slate-200 dark:border-slate-800 sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-50 transition-transform duration-300">
        <div class="flex items-center gap-4">
            <div id="online-status" class="size-3 rounded-full bg-green-500" title="Online"></div>
            <div class="text-primary size-7"><svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H42L36 24L42 42H6L12 24L6 6Z"></path></svg></div>
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">TaskMaster</h1>
        </div>
        <nav class="hidden md:flex items-center gap-8">
            <a data-view="#schedule-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Today</a>
            <a data-view="#calendar-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Calendar</a>
            <a data-view="#todo-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">To-Do</a>
            <a data-view="#projects-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Projects</a>
            <a data-view="#goals-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Goals</a>
            <a data-view="#pomodoro-view" class="nav-link text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">Timer</a>
        </nav>
        <div class="flex items-center gap-4">
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined text-slate-600 dark:text-slate-300">search</span></button>
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined text-slate-600 dark:text-slate-300">notifications</span></button>
            <img alt="User avatar" class="size-10 rounded-full cursor-pointer" id="profile-pic" src="https://i.pravatar.cc/150?u=a042581f4e29026704d"/>
        </div>
    </header>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-background-dark border-t border-slate-200 dark:border-slate-800 z-50 flex justify-around shadow-[0_-4px_10px_rgba(0,0,0,0.02)]">
        <a data-view="#schedule-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined text-[20px]">today</span>
            <span class="text-[10px]">Today</span>
        </a>
        <a data-view="#calendar-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined text-[20px]">calendar_month</span>
            <span class="text-[10px]">Calendar</span>
        </a>
        <a data-view="#todo-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined text-[20px]">checklist</span>
            <span class="text-[10px]">To-Do</span>
        </a>
        <a data-view="#goals-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined text-[20px]">flag</span>
            <span class="text-[10px]">Goals</span>
        </a>
        <a data-view="#projects-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined text-[20px]">view_kanban</span>
            <span class="text-[10px]">Projects</span>
        </a>
        <a data-view="#pomodoro-view" class="nav-link flex flex-col items-center text-center p-2 text-xs font-medium text-slate-600 dark:text-slate-300 hover:text-primary dark:hover:text-primary cursor-pointer">
            <span class="material-symbols-outlined text-[20px]">timer</span>
            <span class="text-[10px]">Timer</span>
        </a>
    </nav>
    
    <div id="load-template-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-background-light dark:bg-background-dark rounded-lg shadow-xl w-full max-w-md">
            <div class="flex items-center justify-between p-4 border-b dark:border-slate-800">
                <h3 class="text-lg font-bold">Load or Edit Template</h3>
                <button id="close-template-modal-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="template-list" class="p-4 max-h-80 overflow-y-auto space-y-2">
                <!-- Template items will be injected here -->
            </div>
        </div>
    </div>
    
    <div id="views-container">
        <!-- MINIMALIST SCHEDULE VIEW -->
        <div id="schedule-view" class="hidden min-h-screen">
            <main class="w-full max-w-md mx-auto px-5 py-8 flex flex-col gap-6">
                
                <!-- Top Widgets -->
                <div class="grid grid-cols-2 gap-5 h-[160px]">
                    <!-- Date Card -->
                    <div class="bg-white dark:bg-slate-800 rounded-[28px] p-6 shadow-[0_4px_20px_rgba(0,0,0,0.03)] flex flex-col items-center justify-center relative overflow-hidden">
                        <span id="widget-month-day" class="text-[17px] text-slate-500 dark:text-slate-400 font-medium mb-1 tracking-tight"></span>
                        <span id="widget-date-num" class="text-[64px] font-semibold text-slate-900 dark:text-white leading-none tracking-tight"></span>
                    </div>
                    
                    <!-- Progress Card -->
                    <div class="bg-white dark:bg-slate-800 rounded-[28px] p-5 shadow-[0_4px_20px_rgba(0,0,0,0.03)] flex flex-col justify-between">
                        <div class="flex justify-between items-center w-full px-1">
                            <span class="font-semibold text-[17px] text-slate-900 dark:text-white">Day</span>
                            <span id="widget-day-percent" class="text-[16px] text-slate-500 dark:text-slate-400 font-medium"></span>
                        </div>
                        <div id="widget-dot-grid" class="grid grid-cols-7 gap-y-2.5 gap-x-1.5 mt-auto mb-2 px-1">
                            <!-- Dots injected via JS -->
                        </div>
                    </div>
                </div>

                <!-- Main Schedule Card -->
                <div class="bg-white dark:bg-slate-800 rounded-[36px] p-6 sm:p-8 shadow-[0_4px_20px_rgba(0,0,0,0.03)] relative flex-grow min-h-[450px]">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-8">
                        <div class="flex flex-col">
                            <h2 id="schedule-title" class="text-[28px] font-bold text-slate-900 dark:text-white leading-none tracking-tight">Today</h2>
                            <span id="event-count" class="text-[14px] font-medium text-slate-400 mt-1 block"></span>
                        </div>
                        
                        <!-- Template Actions -->
                        <div class="flex bg-slate-100 dark:bg-slate-700/50 p-1.5 rounded-full border border-slate-200 dark:border-slate-700/50">
                            <button id="save-template-btn" class="px-3 py-1 text-[12px] font-bold text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white flex items-center gap-1 transition-colors" title="Save Day as Template">
                                <span class="material-symbols-outlined text-[14px]">save</span> <span class="hidden sm:inline">Save</span>
                            </button>
                            <div class="w-[1px] bg-slate-200 dark:bg-slate-600 my-1 mx-0.5"></div>
                            <button id="load-template-btn" class="px-3 py-1 text-[12px] font-bold text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white flex items-center gap-1 transition-colors" title="Load Template">
                                <span class="material-symbols-outlined text-[14px]">download</span> <span class="hidden sm:inline">Load</span>
                            </button>
                        </div>
                    </div>

                    <!-- Events List -->
                    <div id="timeline-container" class="space-y-6 pb-20">
                        <!-- Events injected via JS -->
                    </div>

                    <!-- Floating Add Button Inside Card -->
                    <button id="add-event-btn" class="absolute bottom-6 right-6 size-14 bg-black dark:bg-white text-white dark:text-black rounded-full flex items-center justify-center shadow-lg hover:scale-105 hover:shadow-xl transition-all z-10 focus:outline-none">
                        <span class="material-symbols-outlined text-[28px] font-bold">arrow_forward</span>
                    </button>
                </div>
                
                <!-- Hidden UI Elements (Preserved functionality) -->
                <div class="hidden">
                    <p id="current-date"></p>
                    <button id="schedule-tomorrow-btn">Schedule for Tomorrow</button>
                    <button id="bulk-mode-btn">Plan Entire Day</button>
                </div>
            </main>
        </div>
        
        <!-- SINGLE EVENT FORM -->
        <div id="form-view" class="hidden"><main class="w-full max-w-2xl px-4 py-8 mx-auto"><div class="space-y-8"><div><h2 class="text-3xl font-bold">New Event</h2><p class="mt-2 text-slate-500">Create a new event for your schedule.</p></div><form id="event-form" class="space-y-6">
            <div><label class="block text-sm font-medium" for="title">Title</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="title" name="title" type="text" /></div>
            <div>
                <label class="block text-sm font-medium" for="category">Category</label>
                <select required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="category" name="category">
                    <option>Work</option>
                    <option>Personal</option>
                    <option>Spiritual</option>
                    <option>Education</option>
                    <option>Entertainment</option>
                </select>
            </div>
            <div><label class="block text-sm font-medium" for="date">Date</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="date" name="date" type="text" readonly /></div>
            <div class="grid grid-cols-2 gap-6"><div><label class="block text-sm font-medium" for="start-time">Start Time</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="start-time" name="start_time" type="time" /></div><div><label class="block text-sm font-medium" for="end-time">End Time</label><input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="end-time" name="end_time" type="time" /></div></div>
            <div class="flex justify-between items-center pt-4">
                <button id="delete-event-btn" class="px-6 py-3 rounded-lg text-red-500 hover:bg-red-500/10 hidden" type="button">Delete Event</button>
                <div class="flex gap-3">
                    <button id="cancel-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button>
                    <button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Event</button>
                </div>
            </div>
        </form></div></main></div>

        <!-- NEW: BULK SCHEDULE VIEW (Day Planner) -->
        <div id="bulk-schedule-view" class="hidden">
            <main class="w-full max-w-4xl px-4 py-8 mx-auto">
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-bold">Day Planner</h2>
                            <p class="mt-2 text-slate-500">Rapidly schedule your entire day.</p>
                        </div>
                        <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-4 py-2 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
                            <span class="material-symbols-outlined text-primary">calendar_today</span>
                            <input id="bulk-date" type="text" class="bg-transparent font-bold border-none focus:ring-0 p-0 text-slate-700 dark:text-slate-200 w-32 cursor-pointer" readonly>
                        </div>
                    </div>

                    <form id="bulk-form" class="space-y-6">
                        <div id="bulk-rows-container" class="space-y-4">
                            <!-- Rows injected via JS -->
                        </div>
                        
                        <div class="flex justify-center pt-4 pb-8 border-b dark:border-slate-800">
                            <button type="button" id="add-bulk-row-btn" class="flex items-center gap-2 text-primary font-medium hover:bg-primary/10 px-6 py-3 rounded-full transition-colors border border-dashed border-primary/50">
                                <span class="material-symbols-outlined">add</span> Add Another Event
                            </button>
                        </div>

                        <div class="flex justify-end items-center gap-4">
                            <button id="cancel-bulk-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800 font-medium hover:bg-slate-50 dark:hover:bg-slate-700" type="button">Cancel</button>
                            <button class="px-8 py-3 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 shadow-md font-bold flex items-center gap-2" type="submit">
                                <span class="material-symbols-outlined">save</span> Save All Events
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        </div>

        <div id="template-editor-view" class="hidden">
            <main class="flex-1 px-10 py-8">
                <div class="mx-auto max-w-5xl">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 id="template-editor-title" class="text-3xl font-bold">Edit Template</h1>
                            <p id="template-editor-name" class="text-slate-500"></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="close-template-editor-btn" class="px-4 py-2 text-sm font-semibold rounded-lg border bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700">&larr; Back to Schedule</button>
                        </div>
                    </div>
                    <div class="relative">
                        <div id="template-hour-grid" class="grid grid-cols-[auto_1fr] gap-x-4"></div>
                        <div id="template-events-container" class="absolute top-0 left-[60px] right-0 bottom-0"></div>
                    </div>
                </div>
            </main>
            <div class="fixed bottom-24 right-4 md:bottom-10 md:right-10">
                <button id="add-template-event-btn" class="flex items-center justify-center rounded-full size-14 bg-primary text-white shadow-lg">
                    <span class="material-symbols-outlined">add</span>
                </button>
            </div>
        </div>

        <div id="template-form-view" class="hidden">
            <main class="w-full max-w-2xl px-4 py-8 mx-auto">
                <div class="space-y-8">
                    <div>
                        <h2 class="text-3xl font-bold">New Template Event</h2>
                        <p class="mt-2 text-slate-500">Create a new event for your template.</p>
                    </div>
                    <form id="template-event-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium" for="template-title">Title</label>
                            <input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="template-title" name="title" type="text" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium" for="template-category">Category</label>
                            <select required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" id="template-category" name="category">
                                <option>Work</option>
                                <option>Personal</option>
                                <option>Spiritual</option>
                                <option>Education</option>
                                <option>Entertainment</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium" for="template-start-time">Start Time</label>
                                <input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="template-start-time" name="start_time" type="time" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium" for="template-end-time">End Time</label>
                                <input required class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 [color-scheme:dark]" id="template-end-time" name="end_time" type="time" />
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-4">
                            <button id="delete-template-event-btn" class="px-6 py-3 rounded-lg text-red-500 hover:bg-red-500/10 hidden" type="button">Delete Event</button>
                            <div class="flex gap-3">
                                <button id="cancel-template-btn" class="px-6 py-3 rounded-lg border bg-white dark:bg-slate-800" type="button">Cancel</button>
                                <button class="px-6 py-3 rounded-lg text-white bg-primary" type="submit">Create Event</button>
                            </div>
                        </div>
                    </form>
                </div>
            </main>
        </div>
        
        <!-- NEW THEMED CALENDAR VIEW -->
        <div id="calendar-view" class="hidden">
            <main class="container mx-auto px-4 py-8 max-w-6xl">
                <div class="bg-[#fffbf2] dark:bg-slate-900 rounded-[40px] p-6 md:p-10 shadow-[0_8px_30px_rgba(0,0,0,0.02)] border border-amber-900/5 dark:border-slate-800">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-8 px-2 relative">
                        <button id="cal-prev-btn" class="size-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors"><span class="material-symbols-outlined">chevron_left</span></button>
                        
                        <div class="flex flex-col items-center">
                            <h2 id="cal-month-year" class="text-[26px] font-bold text-slate-800 dark:text-white tracking-tight leading-none mb-1"></h2>
                            <button onclick="showLoadTemplateModal()" class="text-[12px] font-semibold text-primary hover:underline flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">dynamic_feed</span> Manage Templates</button>
                        </div>
                        
                        <button id="cal-next-btn" class="size-10 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors"><span class="material-symbols-outlined">chevron_right</span></button>
                    </div>

                    <!-- Days of week -->
                    <div class="grid grid-cols-7 gap-3 md:gap-5 mb-4 text-center">
                        <div class="text-[13px] font-semibold text-slate-400">Mon</div>
                        <div class="text-[13px] font-semibold text-slate-400">Tue</div>
                        <div class="text-[13px] font-semibold text-slate-400">Wed</div>
                        <div class="text-[13px] font-semibold text-slate-400">Thu</div>
                        <div class="text-[13px] font-semibold text-slate-400">Fri</div>
                        <div class="text-[13px] font-semibold text-red-400">Sat</div>
                        <div class="text-[13px] font-semibold text-red-400">Sun</div>
                    </div>

                    <!-- Grid -->
                    <div id="cal-body" class="grid grid-cols-7 gap-3 md:gap-5">
                        <!-- JS Injected Calendar Cells -->
                    </div>
                </div>
            </main>
        </div>
        
        <!-- NEW TODO VIEW -->
        <div id="todo-view" class="hidden min-h-screen">
            <main class="w-full max-w-md mx-auto px-6 py-8">
                <div id="weekly-accordion" class="flex flex-col">
                    <!-- Dynamic Content Injected via displayTodos() -->
                </div>
            </main>
        </div>

        <div id="settings-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="max-w-2xl mx-auto space-y-10"><div><h2 class="text-4xl font-extrabold mb-8 text-slate-900 dark:text-white">Settings</h2></div><section><h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Notifications</h3><div class="bg-white/50 dark:bg-white/5 rounded-lg p-6 space-y-4"><div class="flex items-center justify-between"><div><p class="font-medium">Event Notifications</p><p class="text-sm text-slate-500 dark:text-slate-400">Enable or disable notifications for upcoming events and reminders.</p></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer" checked /><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div></label></div><div class="flex items-center justify-between"><div><p class="font-medium">Task Notifications</p><p class="text-sm text-slate-500 dark:text-slate-400">Receive notifications for task deadlines and updates.</p></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer" checked /><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div></label></div></div></section><section><h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Theme</h3><div id="theme-selector" class="flex rounded-lg bg-white dark:bg-slate-800 p-1 shadow-sm"><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="light">Light</button><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="dark">Dark</button><button class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors" data-theme="system">System</button></div></section><section><h3 class="text-xl font-semibold mb-4 text-slate-900 dark:text-white">Account</h3><div class="bg-white/50 dark:bg-white/5 rounded-lg divide-y divide-slate-200 dark:divide-slate-800"><a href="#" class="flex items-center justify-between p-4 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-t-lg"><p class="font-medium">Manage Account</p><span class="material-symbols-outlined text-slate-400">chevron_right</span></a><a href="#" class="flex items-center justify-between p-4 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-b-lg text-red-500"><p class="font-medium">Sign Out</p><span class="material-symbols-outlined text-red-500">chevron_right</span></a></div></section></div></main></div>
        
        <!-- NEW MODIFIED PROJECTS VIEW -->
        <div id="projects-view" class="hidden">
            <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-7xl">
                <div class="flex flex-col gap-6">
                    
                    <!-- Top Navigation Area -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-4">
                        <div class="flex flex-col gap-4">
                            <h2 class="text-3xl md:text-4xl font-bold tracking-tight text-slate-900 dark:text-white">Projects Overview</h2>
                            <!-- Project Selector dynamically loaded here -->
                            <div class="flex items-center gap-2 bg-white dark:bg-slate-800 rounded-full p-1.5 border border-slate-200 dark:border-slate-700 shadow-sm inline-flex w-max">
                                 <span class="pl-4 pr-2 text-sm font-medium text-slate-500">Project</span>
                                 <select id="project-selector" class="bg-slate-100 dark:bg-slate-700 border-none rounded-full py-1.5 pl-4 pr-10 text-sm font-semibold text-slate-800 dark:text-slate-200 focus:ring-0 cursor-pointer"></select>
                                 <button id="delete-project-btn" class="size-8 flex items-center justify-center rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors mr-1" title="Delete Project">
                                     <span class="material-symbols-outlined text-[18px]">delete</span>
                                 </button>
                            </div>
                        </div>
                        
                        <!-- Top Tabs Style Filter -->
                        <div class="flex items-center bg-slate-100/80 dark:bg-slate-800/80 p-1.5 rounded-full border border-slate-200/60 dark:border-slate-700/60 self-start md:self-end">
                            <button class="px-6 py-2.5 rounded-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-medium shadow-md transition-transform hover:scale-105">Board</button>
                            <button id="new-project-btn" class="px-5 py-2.5 rounded-full text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 text-sm font-medium transition-colors">New Project</button>
                            <button id="new-project-task-btn" class="px-5 py-2.5 rounded-full text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 text-sm font-medium transition-colors flex items-center gap-1"><span class="material-symbols-outlined text-[18px]">add</span> Task</button>
                        </div>
                    </div>

                    <!-- Columns Container -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12 mt-6">
                        
                        <!-- To Do Column -->
                        <div class="flex flex-col">
                            <div class="flex items-center justify-center py-3 border border-slate-200 dark:border-slate-700 rounded-full mb-8 relative bg-white/50 dark:bg-slate-800/30 shadow-sm">
                                <h4 class="font-medium text-[13px] text-slate-600 dark:text-slate-300">New Tasks</h4>
                                <span id="count-todo" class="absolute right-3.5 text-[11px] font-bold text-slate-500 bg-slate-100 dark:bg-slate-700 size-6 flex items-center justify-center rounded-full">0</span>
                            </div>
                            <div id="kanban-todo" class="space-y-10 kanban-column min-h-[200px] pb-10" data-status="To Do"></div>
                        </div>

                        <!-- In Progress Column -->
                        <div class="flex flex-col">
                            <div class="flex items-center justify-center py-3 border border-slate-200 dark:border-slate-700 rounded-full mb-8 relative bg-white/50 dark:bg-slate-800/30 shadow-sm">
                                <h4 class="font-medium text-[13px] text-slate-600 dark:text-slate-300">In Progress</h4>
                                <span id="count-inprogress" class="absolute right-3.5 text-[11px] font-bold text-slate-500 bg-slate-100 dark:bg-slate-700 size-6 flex items-center justify-center rounded-full">0</span>
                            </div>
                            <div id="kanban-inprogress" class="space-y-10 kanban-column min-h-[200px] pb-10" data-status="In Progress"></div>
                        </div>

                        <!-- Done Column -->
                        <div class="flex flex-col">
                            <div class="flex items-center justify-center py-3 border border-slate-200 dark:border-slate-700 rounded-full mb-8 relative bg-white/50 dark:bg-slate-800/30 shadow-sm">
                                <h4 class="font-medium text-[13px] text-slate-600 dark:text-slate-300">Completed</h4>
                                <span id="count-done" class="absolute right-3.5 text-[11px] font-bold text-slate-500 bg-slate-100 dark:bg-slate-700 size-6 flex items-center justify-center rounded-full">0</span>
                            </div>
                            <div id="kanban-done" class="space-y-10 kanban-column min-h-[200px] pb-10" data-status="Done"></div>
                        </div>

                    </div>
                </div>
            </main>
        </div>

        <!-- NEW MODERN PROJECT FORM -->
        <div id="new-project-view" class="hidden">
            <main class="w-full h-full min-h-[80vh] flex items-center justify-center px-4 py-8">
                <div class="bg-white dark:bg-slate-900 rounded-[32px] shadow-xl border border-slate-200 dark:border-slate-800 w-full max-w-md overflow-hidden">
                    <div class="p-6 pb-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800">
                        <h2 class="text-2xl font-medium tracking-tight">New Project</h2>
                        <button id="cancel-project-btn" type="button" class="size-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors text-slate-500">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="p-6 pt-5">
                        <form id="new-project-form" class="space-y-5">
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1" for="project-name">Project Name</label>
                                <div class="relative">
                                    <input required class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-slate-900 dark:focus:ring-white p-4 pl-12 font-medium transition-shadow" id="project-name" name="name" placeholder="e.g., Marketing Campaign" type="text" />
                                    <span class="absolute left-4 top-[17px] material-symbols-outlined text-slate-400 text-[20px] pointer-events-none">folder</span>
                                </div>
                            </div>
                            <div class="pt-4">
                                <button class="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-bold text-lg hover:scale-[1.02] transition-transform shadow-md" type="submit">Create Project</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>

        <!-- NEW MODERN PROJECT TASK FORM -->
        <div id="new-project-task-view" class="hidden">
            <main class="w-full h-full min-h-[80vh] flex items-center justify-center px-4 py-8">
                <div class="bg-white dark:bg-slate-900 rounded-[32px] shadow-xl border border-slate-200 dark:border-slate-800 w-full max-w-lg overflow-hidden">
                    <div class="p-6 pb-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800">
                        <h2 class="text-2xl font-medium tracking-tight">New Project Task</h2>
                        <button id="cancel-project-task-btn" type="button" class="size-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors text-slate-500">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="p-6 pt-5">
                        <form id="new-project-task-form" class="space-y-5">
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1" for="project-task-title">Task Title</label>
                                <input required class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-slate-900 dark:focus:ring-white p-4 font-medium transition-shadow" id="project-task-title" name="title" placeholder="e.g., Design marketing materials" type="text" />
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1" for="project-task-due-date">Due Date</label>
                                    <div class="relative">
                                        <input required class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-slate-900 dark:focus:ring-white p-4 pl-11 font-medium transition-shadow" id="project-task-due-date" name="due_date" type="text" readonly />
                                        <span class="absolute left-4 top-[17px] material-symbols-outlined text-slate-400 text-[20px] pointer-events-none">calendar_today</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1" for="project-task-status">Status</label>
                                    <select class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-slate-900 dark:focus:ring-white p-4 font-medium transition-shadow" id="project-task-status" name="status">
                                        <option>To Do</option>
                                        <option>In Progress</option>
                                        <option>Done</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1" for="project-task-assignee">Assignee</label>
                                <div class="relative">
                                    <input class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-slate-900 dark:focus:ring-white p-4 pl-11 font-medium transition-shadow" id="project-task-assignee" name="assignee" placeholder="e.g., John Doe" type="text" />
                                    <span class="absolute left-4 top-[17px] material-symbols-outlined text-slate-400 text-[20px] pointer-events-none">person</span>
                                </div>
                            </div>
                            
                            <div class="pt-4">
                                <button class="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl font-bold text-lg hover:scale-[1.02] transition-transform shadow-md" type="submit">Create Task</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>

        <div id="pomodoro-view" class="hidden"><main class="container mx-auto px-4 py-8"><div class="max-w-2xl mx-auto text-center space-y-10">
            <h2 class="text-4xl font-extrabold text-primary">Pomodoro Timer</h2>
            
            <div class="bg-white/50 dark:bg-white/5 rounded-xl p-8 shadow-lg space-y-8">
                <div class="flex justify-center gap-4">
                    <button id="pomodoro-work-btn" class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors timer-session-btn bg-primary text-white" data-session="work">Work</button>
                    <button id="pomodoro-short-break-btn" class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors timer-session-btn bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600" data-session="shortBreak">Short Break</button>
                    <button id="pomodoro-long-break-btn" class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors timer-session-btn bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600" data-session="longBreak">Long Break</button>
                </div>
                
                <div id="pomodoro-timer-display" class="text-7xl sm:text-8xl md:text-9xl font-mono font-bold text-slate-900 dark:text-white">25:00</div>
                
                <div class="flex justify-center gap-6">
                    <button id="pomodoro-start-pause-btn" class="flex items-center gap-2 bg-primary text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined text-3xl">play_arrow</span>
                        <span id="pomodoro-start-pause-text">Start</span>
                    </button>
                    <button id="pomodoro-reset-btn" class="flex items-center justify-center rounded-full size-14 bg-slate-300 dark:bg-slate-700 text-slate-800 dark:text-slate-200 shadow-md hover:bg-slate-400 dark:hover:bg-slate-600 transition-colors">
                        <span class="material-symbols-outlined">restart_alt</span>
                    </button>
                </div>
                
                <div class="text-lg font-medium">
                    <span id="pomodoro-cycle-count">Cycle: 0 / 4</span>
                </div>
            </div>
            <div class="bg-white/50 dark:bg-white/5 rounded-xl p-6 shadow-md text-left space-y-4">
                <h3 class="text-xl font-semibold mb-4 border-b pb-2">Timer Settings</h3>
                <div class="grid grid-cols-3 gap-6">
                    <div>
                        <label for="work-duration" class="block text-sm font-medium">Work (min)</label>
                        <input type="number" id="work-duration" value="25" min="1" class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" />
                    </div>
                    <div>
                        <label for="short-break-duration" class="block text-sm font-medium">Short Break (min)</label>
                        <input type="number" id="short-break-duration" value="5" min="1" class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" />
                    </div>
                    <div>
                        <label for="long-break-duration" class="block text-sm font-medium">Long Break (min)</label>
                        <input type="number" id="long-break-duration" value="15" min="1" class="mt-1 block w-full rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600" />
                    </div>
                </div>
                <button id="apply-pomodoro-settings-btn" class="w-full mt-4 bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary/90">Apply Settings</button>
            </div>
        </div></main></div>
        
        <!-- MODIFIED GOALS VIEW WITH NEW THEME -->
        <div id="goals-view" class="hidden">
            <main class="container mx-auto px-4 py-8 max-w-6xl">
                <!-- GOALS LIST VIEW (Container handles both header and grid) -->
                <div id="goals-list-container">
                    
                    <!-- New Stylized Header Area -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12" id="goals-list-header">
                        <div class="flex items-center gap-4">
                            <h2 class="text-3xl md:text-4xl font-light tracking-tight text-slate-900 dark:text-white uppercase flex items-center">
                                GOAL<span class="font-bold mr-2">SPACE</span>
                                <span class="size-4 rounded-full bg-[#bdf553] inline-block -ml-8 mix-blend-multiply dark:mix-blend-screen opacity-80"></span>
                            </h2>
                            <button id="add-goal-btn" class="flex items-center gap-2 bg-black dark:bg-white text-white dark:text-black px-4 py-2 rounded-full text-sm font-medium hover:scale-105 transition-transform shadow-md">
                                <span class="material-symbols-outlined text-[18px]">add</span> New Goal
                            </button>
                        </div>
                        <div class="flex gap-8 text-slate-900 dark:text-white">
                            <div class="flex items-baseline gap-1">
                                <span class="text-4xl font-light tracking-tight" id="stat-total">0</span>
                                <span class="text-[11px] text-slate-500 uppercase font-bold tracking-wider">Goals</span>
                            </div>
                            <div class="flex items-baseline gap-1">
                                <span class="text-4xl font-light tracking-tight" id="stat-completed">0</span>
                                <span class="text-[11px] text-slate-500 uppercase font-bold tracking-wider">Won</span>
                                <span class="text-[10px] text-red-500 font-bold ml-1 flex items-center"><span class="material-symbols-outlined text-[10px]">arrow_downward</span>2</span>
                            </div>
                            <div class="flex items-baseline gap-1">
                                <span class="text-4xl font-light tracking-tight" id="stat-active">0</span>
                                <span class="text-[11px] text-slate-500 uppercase font-bold tracking-wider">Active</span>
                                <span class="text-[10px] text-green-500 font-bold ml-1 flex items-center"><span class="material-symbols-outlined text-[10px]">arrow_upward</span>3</span>
                            </div>
                        </div>
                    </div>

                    <!-- New Horizontal Pills Filter -->
                    <div class="flex flex-nowrap items-center gap-3 mb-8 w-full overflow-x-auto pb-4 hide-scroll">
                        <h3 class="text-xl font-normal whitespace-nowrap mr-2">Your Goals</h3>
                        <span class="text-sm border-b-2 border-black dark:border-white pb-0.5 mr-4 font-bold whitespace-nowrap" id="goals-count-text">0 Goals</span>

                        <button class="size-10 flex-shrink-0 rounded-full border border-slate-200 dark:border-slate-700 flex items-center justify-center hover:bg-white dark:hover:bg-slate-800 transition-colors bg-transparent"><span class="material-symbols-outlined text-sm">search</span></button>
                        <button class="size-10 flex-shrink-0 rounded-full border border-slate-200 dark:border-slate-700 flex items-center justify-center hover:bg-white dark:hover:bg-slate-800 transition-colors bg-transparent"><span class="material-symbols-outlined text-[16px]">tune</span></button>

                        <button class="goal-filter-btn px-5 py-2.5 rounded-full border text-sm flex-shrink-0 transition-colors flex items-center gap-1.5 bg-white dark:bg-slate-800 shadow-sm border-slate-100 dark:border-slate-700 text-slate-900 dark:text-white font-semibold" data-filter="All">All</button>
                        <button class="goal-filter-btn px-5 py-2.5 rounded-full border text-sm flex-shrink-0 transition-colors flex items-center gap-1.5 bg-transparent border-slate-200 dark:border-slate-700 text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 font-medium" data-filter=" Hot Goal"><span class="text-orange-500 text-base leading-none"></span> Hot Goal</button>
                        <button class="goal-filter-btn px-5 py-2.5 rounded-full border text-sm flex-shrink-0 transition-colors flex items-center gap-1.5 bg-transparent border-slate-200 dark:border-slate-700 text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 font-medium" data-filter="Great Interest">Great interest</button>
                        <button class="goal-filter-btn px-5 py-2.5 rounded-full border text-sm flex-shrink-0 transition-colors flex items-center gap-1.5 bg-transparent border-slate-200 dark:border-slate-700 text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 font-medium" data-filter="Medium Interest">Medium interest</button>
                        <button class="goal-filter-btn px-5 py-2.5 rounded-full border text-sm flex-shrink-0 transition-colors flex items-center gap-1.5 bg-transparent border-slate-200 dark:border-slate-700 text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 font-medium" data-filter="Low Interest">Low interest</button>
                    </div>

                    <!-- Grid for Sleek Cards -->
                    <div id="goals-list-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Goal Cards Injected Here via JS -->
                    </div>
                </div>

                <!-- GOAL DETAILS VIEW (Updated to match theme) -->
                <div id="goal-details-view" class="hidden space-y-6">
                    <div class="flex items-center gap-4 mb-6">
                        <button id="back-to-goals-btn" class="size-12 flex items-center justify-center rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:scale-105 transition-transform shadow-sm">
                            <span class="material-symbols-outlined text-sm">arrow_back</span>
                        </button>
                        <h2 id="goal-details-title" class="text-3xl md:text-4xl font-medium tracking-tight"></h2>
                        <div class="flex-grow"></div>
                        <button id="edit-goal-btn" class="h-12 px-6 flex items-center justify-center gap-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors font-semibold shadow-sm">
                            <span class="material-symbols-outlined text-sm">edit</span> <span class="hidden sm:inline">Edit</span>
                        </button>
                        <button id="delete-goal-btn" class="h-12 px-6 flex items-center justify-center gap-2 rounded-full bg-red-50 dark:bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-colors font-semibold shadow-sm">
                            <span class="material-symbols-outlined text-sm">delete</span> <span class="hidden sm:inline">Delete Goal</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                         <!-- Details Progress Card -->
                         <div class="col-span-1 bg-white dark:bg-slate-900 rounded-[32px] p-8 shadow-sm border border-slate-200/60 dark:border-slate-800 flex flex-col justify-between min-h-[340px]">
                             <div>
                                 <div class="flex justify-between items-center mb-10">
                                     <div class="size-14 rounded-full bg-black dark:bg-white text-white dark:text-black flex items-center justify-center shadow-lg">
                                         <span class="material-symbols-outlined">flag</span>
                                     </div>
                                     <span id="goal-percentage" class="text-5xl md:text-6xl font-light tracking-tighter">0%</span>
                                 </div>
                                 <p class="text-xs font-bold uppercase tracking-widest text-slate-400 mb-3">Overall Progress</p>
                                 <div class="w-full h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                     <div id="goal-progress-bar" class="h-full bg-[#bdf553] rounded-full transition-all duration-1000" style="width:0%"></div>
                                 </div>
                             </div>
                             <div class="grid grid-cols-3 gap-4 mt-8 pt-6 border-t border-slate-100 dark:border-slate-800">
                                <div><p class="text-3xl font-light text-slate-900 dark:text-white" id="goal-stat-completed">0</p><p class="text-[10px] uppercase font-bold text-slate-400 mt-1">Done</p></div>
                                <div><p class="text-3xl font-light text-slate-400" id="goal-stat-target">0</p><p class="text-[10px] uppercase font-bold text-slate-400 mt-1">Target</p></div>
                                <div><p class="text-3xl font-light text-slate-400" id="goal-stat-remaining">0</p><p class="text-[10px] uppercase font-bold text-slate-400 mt-1">Left</p></div>
                             </div>
                         </div>

                         <!-- Details Logs & History -->
                         <div class="col-span-1 lg:col-span-2 flex flex-col gap-6">
                             <!-- Input Section -->
                             <div class="bg-white dark:bg-slate-900 rounded-[32px] p-6 md:p-8 shadow-sm border border-slate-200/60 dark:border-slate-800 flex flex-col sm:flex-row sm:items-center gap-6">
                                 <div class="flex-grow">
                                     <h4 class="text-xl font-medium mb-1">Update Progress</h4>
                                     <p class="text-sm text-slate-500">Log your recent activity to keep this goal on track.</p>
                                 </div>
                                 <form id="goal-log-form" class="flex items-center gap-3">
                                     <input type="text" id="goal-log-date" name="date" class="hidden" required>
                                     <input type="number" name="count" class="w-24 h-12 rounded-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-center font-medium focus:ring-2 focus:ring-black dark:focus:ring-white outline-none" placeholder="+0" required min="1">
                                     <button type="submit" class="h-12 px-6 rounded-full bg-black dark:bg-white text-white dark:text-black font-medium flex items-center justify-center hover:scale-[1.03] transition-transform shadow-md"><span class="material-symbols-outlined text-sm mr-1">add</span> Log</button>
                                 </form>
                             </div>

                             <!-- History List -->
                             <div class="bg-white dark:bg-slate-900 rounded-[32px] p-6 md:p-8 shadow-sm border border-slate-200/60 dark:border-slate-800 flex-grow flex flex-col min-h-[200px]">
                                 <h4 class="text-xl font-medium mb-6">Activity History</h4>
                                 <div id="goal-history-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                                     <!-- Items Injected -->
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </main>

            <!-- THEMED GOAL MODAL -->
            <div id="goal-modal" class="fixed inset-0 bg-black/20 dark:bg-black/60 z-[60] hidden items-center justify-center p-4 backdrop-blur-md">
                <div class="bg-white dark:bg-slate-900 rounded-[32px] shadow-2xl w-full max-w-md transform transition-all scale-100 p-2 border border-slate-200 dark:border-slate-800">
                    <div class="p-6 pb-4 flex justify-between items-center">
                        <h3 class="text-2xl font-medium tracking-tight">Set New Goal</h3>
                        <button id="close-goal-modal" class="size-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors text-slate-500">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="p-6 pt-0">
                        <form id="create-goal-form" class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1">Goal Title</label>
                                <input type="text" id="goal-title-input" name="title" placeholder="e.g. Expand reach to 5k" class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-black dark:focus:ring-white p-4 font-medium" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1">Target Number</label>
                                <div class="relative">
                                    <input type="number" id="goal-target-input" name="target_number" placeholder="e.g. 5000" class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-black dark:focus:ring-white p-4 pl-12 font-medium" required min="1">
                                     <span class="absolute left-4 top-3.5 material-symbols-outlined text-slate-400 text-[20px]">flag</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1">Interest Level</label>
                                    <select name="interest" id="goal-interest-input" class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-black dark:focus:ring-white p-4 font-medium" required>
                                        <option value=" Hot Goal"> Hot Goal</option>
                                        <option value="Great Interest">Great Interest</option>
                                        <option value="Medium Interest" selected>Medium Interest</option>
                                        <option value="Low Interest">Low Interest</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300 ml-1">Source</label>
                                    <select name="source" id="goal-source-input" class="w-full rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-black dark:focus:ring-white p-4 font-medium" required>
                                        <option value="Work">Work</option>
                                        <option value="Education">Education</option>
                                        <option value="Entertainment">Entertainment</option>
                                        <option value="Personal" selected>Personal</option>
                                        <option value="Spiritual">Spiritual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="pt-4">
                                <button type="submit" id="submit-goal-btn" class="w-full py-4 bg-[#bdf553] text-black rounded-2xl font-bold text-lg hover:scale-[1.02] transition-transform shadow-lg">Start Tracking</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === SUPABASE & STATE SETUP ===
        const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let selectedDate = new Date();
        let calendarDisplayDate = new Date();
        let currentProjectId = null;
        let dragTaskId = null;
        let editingTaskId = null;
        let editingEventId = null;
        let editingTodoId = null;
        
        // === NEW: Time Indicator State ===
        let progressInterval = null;
        
        // === NEW TEMPLATE EDITING STATE ===
        let editingTemplateId = null;
        let editingTemplateEventId = null;
        
        // === POMODORO STATE ===
        let timerInterval = null;
        let pomodoroTimeLeft = 25 * 60; // Default work time in seconds
        let pomodoroIsRunning = false;
        let pomodoroSettings = {
            work: 25,
            shortBreak: 5,
            longBreak: 15,
            longBreakCycle: 4
        };
        let pomodoroCurrentSession = 'work';
        let pomodoroCycleCount = 0; // The number of completed work sessions
        
        // NEW State variables for notifications
        let originalTitle = document.title;
        let originalFavicon = document.getElementById('favicon').href;
        let flashingInterval = null;
        const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');

        // === GOALS STATE ===
        let activeGoal = null;
        let editingGoalId = null;
        let currentGoalFilter = 'All'; // Global filter state
        let expandedTodoDate = toYMD(new Date()); // Default to today for the new To-Do list
        
        // === HELPERS ===
        function toYMD(date) { 
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        const timeToDecimal = (t) => { const [h, m] = t.split(':'); return parseInt(h, 10) + parseInt(m, 10) / 60; };
        const formatTime = (t) => new Date(`1970-01-01T${t}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

        // MODIFICATION: This helper is no longer used by displayEvents, but is
        // still used by the template editor. We'll keep it.
        const getCategoryClasses = (category) => {
            switch (category) {
                case 'Work':
                    return 'bg-green-300 dark:bg-green-900/50 text-black-800 dark:text-slate-200';
                case 'Personal':
                    return 'bg-orange-300 dark:bg-orange-900/50 text-black-800 dark:text-slate-200';
                case 'Education':
                    return 'bg-purple-300 dark:bg-purple-900/50 text-black-800 dark:text-slate-200';
                case 'Entertainment':
                    return 'bg-blue-300 dark:bg-blue-900/50 text-black-800 dark:text-slate-200';
                case 'spiritual': // Note: 'Spiritual' in form, 'spiritual' here. Should standardize.
                    return 'bg-orange-700 dark:bg-orange-900/50 text-black-800 dark:text-slate-200';
                default:
                    return 'bg-slate-100 dark:bg-slate-900/50 text-slate-700 dark:text-slate-300';
            }
        }

        // NEW HELPER: Gets icon and color for the new timeline
        function getCategoryStyle(category) {
            switch (category) {
                case 'Work':
                    return { icon: 'work', color: 'bg-green-500 text-white' };
                case 'Personal':
                    return { icon: 'person', color: 'bg-orange-500 text-white' };
                case 'Spiritual':
                    return { icon: 'self_improvement', color: 'bg-amber-600 text-white' };
                case 'Education':
                    return { icon: 'school', color: 'bg-purple-500 text-white' };
                case 'Entertainment':
                    return { icon: 'celebration', color: 'bg-blue-500 text-white' };
                default:
                    return { icon: 'task_alt', color: 'bg-slate-500 text-white' };
            }
        }
        
        // NEW HELPER: Calculates duration for the event card
        function calculateDuration(startTime, endTime) {
            try {
                const start = new Date(`1970-01-01T${startTime}`);
                const end = new Date(`1970-01-01T${endTime}`);
                let diff = (end.getTime() - start.getTime()) / 1000 / 60; // difference in minutes
                
                if (diff < 0) diff += 24 * 60; // Handle overnight
                if (diff === 0) return null;

                const hours = Math.floor(diff / 60);
                const minutes = diff % 60;

                let durationStr = '';
                if (hours > 0) durationStr += `${hours} hr `;
                if (minutes > 0) durationStr += `${minutes} min`;
                
                return durationStr.trim() || null;
            } catch(e) {
                console.error("Error calculating duration:", e, startTime, endTime);
                return null;
            }
        }

        // Calculates time range like "3:00 PM - 4:00 PM"
        const formatTimeRange = (startStr, endStr) => {
            const format12 = (t) => {
                let [h, m] = t.split(':');
                h = parseInt(h);
                const ampm = h >= 12 ? 'PM' : 'AM';
                h = h % 12 || 12;
                return `${h}:${m} ${ampm}`;
            };
            return `${format12(startStr)} - ${format12(endStr)}`;
        };

        // Renders the dot grid for Day progress
        function updateDayProgressWidget() {
            const now = new Date();
            const minutesPassed = now.getHours() * 60 + now.getMinutes();
            const totalMinutes = 24 * 60;
            const percent = Math.round((minutesPassed / totalMinutes) * 100);
            
            const percentEl = document.getElementById('widget-day-percent');
            if(percentEl) percentEl.textContent = `${percent}%`;

            const gridEl = document.getElementById('widget-dot-grid');
            if (!gridEl) return;
            
            const totalDots = 28; // 7 cols x 4 rows
            const activeDots = Math.round((percent / 100) * totalDots);
            
            let dotsHtml = '';
            for(let i=0; i<totalDots; i++) {
                if (i < activeDots) {
                    dotsHtml += `<div class="size-[7px] rounded-full bg-slate-900 dark:bg-white mx-auto"></div>`;
                } else {
                    dotsHtml += `<div class="size-[7px] rounded-full bg-slate-200 dark:bg-slate-600 mx-auto"></div>`;
                }
            }
            gridEl.innerHTML = dotsHtml;
        }

        // === VIEW MANAGEMENT ===
        function showView(viewId) {
            // NEW: Clear interval when leaving schedule view
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }

            document.querySelectorAll('#views-container > div').forEach(v => v.classList.add('hidden'));
            document.querySelector(viewId).classList.remove('hidden');
            updateActiveLink(viewId);
            
            // Clear editing states when switching views
            if (viewId !== '#form-view') editingEventId = null;
            if (viewId !== '#new-task-view') editingTodoId = null;
            if (viewId !== '#new-project-task-view') editingTaskId = null;
            if (viewId !== '#template-form-view') editingTemplateEventId = null;
            
            if (viewId === '#schedule-view') displayEvents(selectedDate); // This will now handle starting the interval
            if (viewId === '#calendar-view') initializeCalendarView();
            if (viewId === '#todo-view') displayTodos();
            if (viewId === '#settings-view') initializeSettings();
            if (viewId === '#projects-view') {
                loadProjects();
                displayProjects();
            }
            if (viewId === '#goals-view') displayGoals();
            if (viewId === '#pomodoro-view') {
                if (!timerInterval) resetPomodoroTimer();
            } else {
                pausePomodoroTimer();
            }
        }
        
        function updateActiveLink(activeViewId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                const isActive = link.dataset.view === activeViewId;
                
                // Toggle active classes (text-primary, font-bold)
                link.classList.toggle('text-primary', isActive);
                link.classList.toggle('font-bold', isActive);
                
                // Toggle inactive classes (text-slate-600, dark:text-slate-300)
                link.classList.toggle('text-slate-600', !isActive);
                link.classList.toggle('dark:text-slate-300', !isActive);
                
                // This is for the desktop links that have a medium weight when inactive
                if (link.closest('header nav')) {
                    link.classList.toggle('font-medium', !isActive);
                }
            });
        }
        
        // === SCHEDULE VIEW LOGIC (HEAVILY MODIFIED) ===
        
        // REMOVED: renderHourGrid() is no longer needed.
        
        // === NEW: TEMPLATE EDITOR GRID RENDER (Unchanged) ===
        // This is still used by the template editor view
        function renderTemplateEditorGrid() {
            const grid = document.getElementById('template-hour-grid');
            if (!grid) return;
            grid.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const time = new Date(0, 0, 0, i).toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                grid.innerHTML += `<div class="text-right text-sm text-slate-500 h-16 pt-2 border-b dark:border-slate-800">${time}</div><div class="border-b dark:border-slate-800"></div>`;
            }
        }
        
        // MODIFIED: displayEvents now renders the new timeline
        // FIX: Removed corrupted comments from previous diff
        async function displayEvents(date) {
            // Target the new container
            const eventsContainer = document.getElementById('timeline-container'); 
            const scheduleTitle = document.getElementById('schedule-title');
            const currentDateEl = document.getElementById('current-date');
            if (!eventsContainer || !scheduleTitle || !currentDateEl) return;
            
            const dateString = toYMD(date);
            const isToday = (toYMD(new Date()) === dateString);
            
            // Update Top Widgets
            const dayNameStr = date.toLocaleDateString('en-US', { weekday: 'short' });
            const monthStr = date.toLocaleDateString('en-US', { month: 'short' });
            const monthDayEl = document.getElementById('widget-month-day');
            const dateNumEl = document.getElementById('widget-date-num');
            
            if (monthDayEl) monthDayEl.textContent = `${dayNameStr} ${monthStr}`;
            if (dateNumEl) dateNumEl.textContent = date.getDate();
            
            updateDayProgressWidget();
            
            // Set title text
            scheduleTitle.textContent = isToday ? "Today" : date.toLocaleDateString('en-US', { weekday: 'long' });
            currentDateEl.textContent = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Show a loading/offline state immediately
            eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">Loading events...</p>`;

            // MODIFICATION: Added .order('start_time') to sort events chronologically
            const { data: events, error } = await db
                .from('events')
                .select('*')
                .eq('date', dateString)
                .order('start_time'); 
            
            if (error) { 
                console.error('Error fetching events:', error); 
                eventsContainer.innerHTML = `<p class="text-center text-red-500 pt-4">Could not load events. Check your connection.</p>`;
                document.getElementById('event-count').textContent = `0 Events`;
                return;
            }

            document.getElementById('event-count').textContent = `${events.length} Events`;

            if (!events || events.length === 0) { 
                eventsContainer.innerHTML = `<p class="text-slate-500 text-[15px] pt-2">No events scheduled.</p>`; 
                
                // NEW: Still update the day progress interval if it's today
                if (isToday) {
                    if (progressInterval) clearInterval(progressInterval);
                    progressInterval = setInterval(updateDayProgressWidget, 60000);
                }
                return;
            }
            
            // NEW: Map events to the new timeline HTML structure
            eventsContainer.innerHTML = events.map((event, index) => {
                const style = getCategoryStyle(event.category);
                
                // The card itself is clickable to edit, using data-event-id
                return `
                <div class="flex gap-4 items-start event-card group" data-event-id="${event.id}">
                    <div class="w-[3px] bg-slate-900 dark:bg-white rounded-full h-[40px] mt-1.5 flex-shrink-0"></div>
                    <div class="flex flex-col flex-grow min-w-0 pt-0.5">
                        <span class="font-[800] text-slate-900 dark:text-white text-[16px] leading-tight mb-0.5 truncate tracking-tight">${event.title}</span>
                        <span class="text-[12px] text-slate-500 dark:text-slate-400 font-medium tracking-tight">${formatTimeRange(event.start_time, event.end_time)}</span>
                    </div>
                </div>
                `;
            }).join('');

            // NEW: Add event listeners to the new cards
            // This replaces the old method of adding listeners inside the loop
            eventsContainer.querySelectorAll('.event-card').forEach(card => {
                card.addEventListener('click', () => {
                    const eventId = card.dataset.eventId;
                    // Find the event data from the array we already fetched
                    const eventData = events.find(e => e.id.toString() === eventId);
                    if (eventData) {
                        editEvent(eventData);
                    }
                });
            });

            // NEW: Clear any existing interval and start a new one
            if (progressInterval) clearInterval(progressInterval);
            
            if (isToday) {
                progressInterval = setInterval(() => {
                    updateDayProgressWidget();
                }, 60000); // Update every minute
            }
        }
        
        function editEvent(event) {
            editingEventId = event.id;
            // Populate form
            document.getElementById('title').value = event.title;
            document.getElementById('category').value = event.category;
            document.getElementById('date')._flatpickr.setDate(event.date);
            document.getElementById('start-time').value = event.start_time;
            document.getElementById('end-time').value = event.end_time;
            
            // Update UI for editing
            document.querySelector('#form-view h2').textContent = 'Edit Event';
            document.querySelector('#event-form button[type="submit"]').textContent = 'Update Event';
            document.getElementById('delete-event-btn').classList.remove('hidden');
            
            showView('#form-view');
        }
        async function deleteEvent() {
            if (!editingEventId || !confirm('Are you sure you want to delete this event?')) {
                return;
            }
            // Lightweight offline handling: just alert the user if offline.
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to delete the event.");
                return;
            }
            const { error } = await db.from('events').delete().eq('id', editingEventId);
            if (error) {
                alert('Error deleting event: ' + error.message);
            } else {
                showView('#schedule-view');
            }
        }
        // === FORM SUBMISSION LOGIC ===
        async function handleEventFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save changes.");
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const eventData = Object.fromEntries(formData.entries());
            if (eventData.start_time.length === 5) eventData.start_time += ':00';
            if (eventData.end_time.length === 5) eventData.end_time += ':00';
            
            let response;
            if (editingEventId) {
                response = await db.from('events').update(eventData).eq('id', editingEventId);
            } else {
                response = await db.from('events').insert([eventData]);
            }
            if (response.error) {
                alert('Error: ' + response.error.message);
            } else {
                // === FIX 2 ===
                // Update selectedDate to match the event that was just
                // created or edited. This ensures we show the correct day.
                // Parse the date string to avoid timezone issues.
                const [year, month, day] = eventData.date.split('-').map(Number);
                selectedDate = new Date(year, month - 1, day); 
            
                showView('#schedule-view');
            }
        }
        async function handleTaskFormSubmit(e) {
            e.preventDefault();
             if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save changes.");
                return;
            }
            const form = e.target;
            const formData = new FormData(form);
            const taskData = Object.fromEntries(formData.entries());
            let response;
            if (editingTodoId) {
                response = await db.from('todos').update(taskData).eq('id', editingTodoId);
            } else {
                taskData.status = 'Pending';
                response = await db.from('todos').insert([taskData]);
            }
            
            if (response.error) {
                alert('Error creating task: ' + response.error.message);
            } else {
                showView('#todo-view');
            }
        }
        
        // === NEW: BULK SCHEDULE LOGIC ===
        function addBulkRow(startTime = '') {
            const container = document.getElementById('bulk-rows-container');
            const rowId = 'row-' + Date.now();
            
            // Calculate a smart default start time if not provided
            if (!startTime) {
                const lastRowEnd = document.querySelector('.bulk-row:last-child input[name="end_time"]')?.value;
                if (lastRowEnd) {
                    startTime = lastRowEnd;
                } else {
                    startTime = '09:00'; // Default start
                }
            }
            
            // Calculate default end time (1 hour later)
            let endTime = '';
            if (startTime) {
                const [h, m] = startTime.split(':').map(Number);
                const nextH = (h + 1) % 24;
                endTime = `${nextH.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            }

            const rowHTML = `
            <div class="bulk-row grid grid-cols-1 md:grid-cols-12 gap-3 items-start bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm animate-fade-in relative group" id="${rowId}">
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-slate-500 mb-1 md:hidden">Start</label>
                    <input type="time" name="start_time" value="${startTime}" class="w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm [color-scheme:dark]" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-slate-500 mb-1 md:hidden">End</label>
                    <input type="time" name="end_time" value="${endTime}" class="w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm [color-scheme:dark]" required>
                </div>
                <div class="md:col-span-4">
                    <label class="block text-xs font-medium text-slate-500 mb-1 md:hidden">Title</label>
                    <input type="text" name="title" placeholder="Event Title" class="w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm" required>
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-medium text-slate-500 mb-1 md:hidden">Category</label>
                    <select name="category" class="w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-sm">
                        <option>Work</option>
                        <option>Personal</option>
                        <option>Spiritual</option>
                        <option>Education</option>
                        <option>Entertainment</option>
                    </select>
                </div>
                <div class="md:col-span-1 flex justify-end md:justify-center mt-2 md:mt-0">
                    <button type="button" class="remove-bulk-row-btn text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>`;
            
            container.insertAdjacentHTML('beforeend', rowHTML);
            
            // Add focus to the title input of the new row for better UX
            setTimeout(() => {
                const newRow = document.getElementById(rowId);
                newRow.querySelector('input[name="title"]').focus();
            }, 50);
        }

        async function handleBulkFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) {
                alert("You are offline. Please reconnect to save.");
                return;
            }
            
            const dateStr = document.getElementById('bulk-date').value;
            const rows = document.querySelectorAll('.bulk-row');
            const eventsToInsert = [];
            
            rows.forEach(row => {
                const startTime = row.querySelector('input[name="start_time"]').value;
                const endTime = row.querySelector('input[name="end_time"]').value;
                const title = row.querySelector('input[name="title"]').value;
                const category = row.querySelector('select[name="category"]').value;
                
                if (title && startTime && endTime) {
                    eventsToInsert.push({
                        date: dateStr,
                        start_time: startTime + ':00', // ensure format matches DB
                        end_time: endTime + ':00',
                        title: title,
                        category: category
                    });
                }
            });
            
            if (eventsToInsert.length === 0) {
                alert("Please add at least one valid event.");
                return;
            }
            
            const { error } = await db.from('events').insert(eventsToInsert);
            
            if (error) {
                alert('Error saving events: ' + error.message);
            } else {
                // Update selected date to match what we just planned
                const [year, month, day] = dateStr.split('-').map(Number);
                selectedDate = new Date(year, month - 1, day);
                showView('#schedule-view');
            }
        }

        // === CALENDAR VIEW LOGIC (UPDATED WITH NEW THEME) ===
        window.selectDateFromCalendar = function(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            selectedDate = new Date(y, m - 1, d);
            showView('#schedule-view'); // Jumping to schedule when day is clicked
        }

        async function initializeCalendarView() {
            const date = new Date(calendarDisplayDate);
            const year = date.getFullYear();
            const month = date.getMonth();

            const firstDay = toYMD(new Date(year, month, 1));
            const lastDay = toYMD(new Date(year, month + 1, 0));

            // Fetch events to display inside the calendar cells
            const { data: events, error } = await db.from('events')
                .select('*')
                .gte('date', firstDay)
                .lte('date', lastDay);

            renderNewMonth(year, month, events || []);
        }

        function renderNewMonth(year, month, events) {
            const bodyEl = document.getElementById('cal-body');
            const titleEl = document.getElementById('cal-month-year');
            bodyEl.innerHTML = '';
            titleEl.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDayDate = new Date(year, month, 1);
            let firstDay = firstDayDate.getDay() - 1; // 0=Sun -> -1, 1=Mon -> 0
            if (firstDay === -1) firstDay = 6; // Sunday becomes last column

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            let html = '';

            // Previous Month (Hatched)
            for (let i = 0; i < firstDay; i++) {
                const dayNum = daysInPrevMonth - firstDay + i + 1;
                html += `<div class="bg-hatched rounded-[20px] md:rounded-[24px] border border-slate-200/60 dark:border-slate-700/30 min-h-[90px] md:min-h-[110px] p-2 md:p-3 text-slate-400/60 font-medium text-sm"><span>${dayNum}</span></div>`;
            }

            // Current Month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = toYMD(date);
                const isSelected = toYMD(selectedDate) === dateString;
                const dayEvents = events.filter(e => e.date === dateString);

                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                let cellClass = 'rounded-[20px] md:rounded-[24px] min-h-[90px] md:min-h-[110px] p-2 md:p-3 transition-all cursor-pointer relative overflow-hidden flex flex-col ';
                if (isSelected) {
                    cellClass += 'bg-[#ffde6a] text-black shadow-lg transform hover:scale-[1.03] z-10';
                } else {
                    cellClass += 'bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300';
                }

                let textClass = 'text-[15px] font-medium block ';
                if (!isSelected && isWeekend) textClass += 'text-red-400 dark:text-red-400';

                // Render events inside cell
                let eventsHtml = '';
                if (dayEvents.length > 0) {
                    eventsHtml = `<div class="space-y-1.5 mt-auto pt-2 relative z-10 w-full">` + dayEvents.slice(0, 3).map(e => {
                        const style = getCategoryStyle(e.category);
                        if (isSelected) {
                             return `<div class="text-[11px] md:text-[12px] leading-tight font-bold opacity-80 truncate">${e.title}</div>`;
                        } else {
                             return `
                                <div class="bg-white/90 dark:bg-slate-900/90 rounded-full px-2.5 py-1 text-[10px] md:text-[11px] font-semibold flex items-center gap-1.5 shadow-sm truncate border border-slate-200/50 dark:border-slate-700/50">
                                    <div class="size-1.5 rounded-full ${style.color.split(' ')[0]} flex-shrink-0"></div>
                                    <span class="truncate">${e.title}</span>
                                </div>`;
                        }
                    }).join('') + `</div>`;
                }

                // Render quick action buttons inside yellow block
                let topIconHtml = '';
                if (isSelected) {
                    topIconHtml = `
                        <div class="absolute top-2.5 right-2.5 flex items-center gap-1.5 z-20">
                            <button class="size-7 bg-white/60 hover:bg-white rounded-full flex items-center justify-center shadow-sm transition-colors text-black" onclick="event.stopPropagation(); saveCurrentDayAsTemplate();" title="Save Day as Template">
                                <span class="material-symbols-outlined text-[14px]">save</span>
                            </button>
                            <button class="size-7 bg-white/60 hover:bg-white rounded-full flex items-center justify-center shadow-sm transition-colors text-black" onclick="event.stopPropagation(); showLoadTemplateModal();" title="Load Template">
                                <span class="material-symbols-outlined text-[14px]">download</span>
                            </button>
                        </div>
                    `;
                }

                html += `
                    <div class="${cellClass}" onclick="selectDateFromCalendar('${dateString}')">
                        ${topIconHtml}
                        <span class="${textClass}">${day}</span>
                        ${eventsHtml}
                    </div>
                `;
            }

            // Fill remaining grid to complete the row
            const totalCellsRendered = firstDay + daysInMonth;
            const remainingCells = (7 - (totalCellsRendered % 7)) % 7;
            
            for (let i = 1; i <= remainingCells; i++) {
                 html += `<div class="bg-hatched rounded-[20px] md:rounded-[24px] border border-slate-200/60 dark:border-slate-700/30 min-h-[90px] md:min-h-[110px] p-2 md:p-3 text-slate-400/60 font-medium text-sm"><span>${i}</span></div>`;
            }
            
            bodyEl.innerHTML = html;
        }

        // === NEW MINIMALIST TO-DO VIEW ===
        function toggleTodoDay(dateStr) {
            expandedTodoDate = dateStr;
            displayTodos(); // Re-render to expand and format active date
        }

        async function handleInlineTaskAdd(e, dateStr) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const title = e.target.value.trim();
                if (!title) return;
                
                if (!navigator.onLine) {
                    alert("You are offline.");
                    return;
                }

                e.target.disabled = true; // prevent double submission

                const taskData = {
                    title: title,
                    due_date: dateStr,
                    category: 'Personal',
                    status: 'Pending'
                };

                const { error } = await db.from('todos').insert([taskData]);
                if (error) {
                    console.error('Error creating task:', error);
                    e.target.disabled = false;
                } else {
                    displayTodos();
                }
            }
        }

        async function deleteTodoInline(taskId) {
            if (!navigator.onLine) {
                alert("You are offline.");
                return;
            }
            const { error } = await db.from('todos').delete().eq('id', taskId);
            if (error) {
                console.error('Error deleting task:', error);
            } else {
                displayTodos();
            }
        }

        async function displayTodos() {
            const { data: todos, error } = await db.from('todos').select('*');
            if (error) { console.error("Error fetching todos:", error); return; }

            const today = new Date();
            // Get Monday of current week
            const dayOfWeek = today.getDay() || 7; 
            const monday = new Date(today);
            monday.setDate(today.getDate() - dayOfWeek + 1);

            const days = [];
            for (let i = 0; i < 7; i++) { // Render Monday to Sunday
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                days.push(d);
            }

            const container = document.getElementById('weekly-accordion');
            container.innerHTML = days.map(date => {
                const dateStr = toYMD(date);
                const isExpanded = expandedTodoDate === dateStr;
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
                
                // Format: April, 14 2025 - 9:41am
                const month = date.toLocaleDateString('en-US', { month: 'long' });
                const dayNum = date.getDate();
                const year = date.getFullYear();
                
                const now = new Date();
                let hours = now.getHours();
                const ampm = hours >= 12 ? 'pm' : 'am';
                hours = hours % 12;
                hours = hours ? hours : 12; 
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const dateDisplay = `${month}, ${dayNum} ${year} - ${hours}:${minutes}${ampm}`;
                
                const dayTasks = todos.filter(t => t.due_date === dateStr);
                
                return `
                    <div class="border-b border-slate-300 dark:border-slate-700 last:border-0 accordion-item" data-date="${dateStr}">
                        <button class="w-full text-left py-6 accordion-header" onclick="toggleTodoDay('${dateStr}')">
                            <h2 class="text-4xl md:text-[40px] leading-none font-black tracking-tight text-slate-900 dark:text-white transition-opacity ${!isExpanded && 'hover:opacity-70'}">${dayName}</h2>
                        </button>
                        <div class="accordion-content ${isExpanded ? 'block' : 'hidden'} pb-8 transition-all animate-fade-in">
                            <p class="text-[13px] text-slate-500 dark:text-slate-400 mb-6 font-medium">${dateDisplay}</p>
                            
                            <div class="space-y-3 mb-6" id="tasks-${dateStr}">
                                ${dayTasks.map(task => {
                                    const isCompleted = task.status === 'Completed';
                                    return `
                                    <div class="flex items-center gap-3 group">
                                        <input type="checkbox" data-id="${task.id}" class="todo-cb form-checkbox h-[18px] w-[18px] rounded-[4px] border-2 border-slate-400 dark:border-slate-500 text-[#eb5e28] focus:ring-0 cursor-pointer bg-transparent transition-colors" ${isCompleted ? 'checked' : ''}>
                                        <span class="text-[15px] font-medium transition-colors duration-200 ${isCompleted ? 'text-slate-400 dark:text-slate-500 line-through' : 'text-slate-800 dark:text-slate-200'}">${task.title}</span>
                                        <button class="ml-auto opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity delete-inline-btn" onclick="deleteTodoInline(${task.id})">
                                            <span class="material-symbols-outlined text-sm">close</span>
                                        </button>
                                    </div>`;
                                }).join('')}
                            </div>
                            
                            <input type="text" placeholder="Add a new task..." 
                                   class="inline-task-input w-full bg-transparent border-none p-0 text-[15px] text-slate-700 dark:text-slate-300 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-0 font-medium"
                                   data-date="${dateStr}" onkeypress="handleInlineTaskAdd(event, '${dateStr}')">
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === SETTINGS VIEW LOGIC ===
        function initializeSettings() {
            const themeSelector = document.getElementById('theme-selector');
            const savedTheme = localStorage.getItem('theme') || 'system';
            themeSelector.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white', 'text-slate-700', 'dark:text-slate-300');
                if (btn.dataset.theme === savedTheme) {
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('text-slate-700', 'dark:text-slate-300');
                }
                btn.addEventListener('click', () => {
                    themeSelector.querySelectorAll('button').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('text-slate-700', 'dark:text-slate-300');
                    });
                    btn.classList.add('bg-primary', 'text-white');
                    applyTheme(btn.dataset.theme);
                });
            });
        }
        
        // === PROJECTS VIEW LOGIC ===
        async function loadProjects() {
            const { data: projects, error } = await db.from('projects').select('*').order('created_at');
            if (error) { console.error("Error fetching projects:", error); return; }
            
            const projectSelector = document.getElementById('project-selector');
            projectSelector.innerHTML = '';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelector.appendChild(option);
            });

            if (projects.length > 0 && !currentProjectId) {
                currentProjectId = projects[0].id;
                projectSelector.value = currentProjectId;
            } else if (projects.length === 0) {
                currentProjectId = null;
                document.getElementById('kanban-todo').innerHTML = '';
                document.getElementById('kanban-inprogress').innerHTML = '';
                document.getElementById('kanban-done').innerHTML = '';
                document.getElementById('count-todo').textContent = '0';
                document.getElementById('count-inprogress').textContent = '0';
                document.getElementById('count-done').textContent = '0';
            }
            
            projectSelector.addEventListener('change', () => {
                currentProjectId = projectSelector.value;
                displayProjects();
            });
        }

        async function deleteProject() {
            if (!currentProjectId) {
                alert('No project selected to delete.');
                return;
            }
            if (!navigator.onLine) { alert("You are offline. Please reconnect to delete the project."); return; }
            if (!confirm("Are you sure you want to delete this ENTIRE project and ALL of its tasks? This action cannot be undone.")) return;

            // Delete associated tasks first to prevent database orphaned rows
            const { error: tasksError } = await db.from('project_tasks').delete().eq('project_id', currentProjectId);
            if (tasksError) { 
                console.error('Error deleting project tasks:', tasksError); 
                alert('Error deleting tasks.'); 
                return; 
            }

            // Delete the main project
            const { error: projectError } = await db.from('projects').delete().eq('id', currentProjectId);
            if (projectError) { 
                console.error('Error deleting project:', projectError); 
                alert('Error deleting project.'); 
                return; 
            }

            // Reset selected ID and reload the view
            currentProjectId = null;
            loadProjects();
            displayProjects();
        }
        
        async function displayProjects() {
            if (!currentProjectId) return;
            const { data: tasks, error } = await db.from('project_tasks').select('*').eq('project_id', currentProjectId).order('due_date');
            if (error) { console.error("Error fetching project tasks:", error); return; }
            
            document.getElementById('kanban-todo').innerHTML = '';
            document.getElementById('kanban-inprogress').innerHTML = '';
            document.getElementById('kanban-done').innerHTML = '';
            
            const todoCount = tasks.filter(t => t.status === 'To Do').length;
            const inProgressCount = tasks.filter(t => t.status === 'In Progress').length;
            const doneCount = tasks.filter(t => t.status === 'Done').length;
            
            document.getElementById('count-todo').textContent = todoCount;
            document.getElementById('count-inprogress').textContent = inProgressCount;
            document.getElementById('count-done').textContent = doneCount;
            
            tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                const targetColumn = document.getElementById(`kanban-${task.status.toLowerCase().replace(' ', '')}`);
                if (targetColumn) targetColumn.appendChild(taskElement);
            });
        }
        
        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            taskEl.className = 'kanban-item bg-white dark:bg-slate-800 rounded-full p-2 pr-4 shadow-sm border border-slate-100 dark:border-slate-700/60 cursor-move relative flex items-center gap-3 w-full group transition-all hover:shadow-md hover:border-slate-300 dark:hover:border-slate-600';
            taskEl.draggable = true;
            taskEl.dataset.id = task.id;
            
            const dueDateText = new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            taskEl.innerHTML = `
                <div class="size-[42px] rounded-full bg-slate-50 dark:bg-slate-700/50 flex flex-shrink-0 items-center justify-center shadow-sm border border-slate-200 dark:border-slate-600 text-slate-400 dark:text-slate-300">
                    <span class="material-symbols-outlined text-[20px]">task</span>
                </div>
                <div class="flex-grow min-w-0 flex flex-col justify-center pt-0.5 pl-1">
                    <h5 class="font-semibold text-[14px] text-slate-900 dark:text-white truncate leading-tight mb-[3px]">${task.title}</h5>
                    <p class="text-[11px] text-slate-500 dark:text-slate-400 truncate leading-tight font-medium">Due: ${dueDateText}${task.assignee ? `  ${task.assignee}` : ''}</p>
                </div>
                <div class="flex-shrink-0 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 bg-white dark:bg-slate-800 pl-2 rounded-full py-1">
                    <button class="size-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 edit-project-task-btn text-slate-400 hover:text-primary transition-colors"><span class="material-symbols-outlined text-[16px]">edit</span></button>
                    <button class="size-8 flex items-center justify-center rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-slate-400 hover:text-red-500 delete-project-task-btn transition-colors"><span class="material-symbols-outlined text-[16px]">delete</span></button>
                </div>
                <div class="flex-shrink-0 group-hover:opacity-0 transition-opacity text-slate-300 dark:text-slate-500 pr-1">
                    <span class="material-symbols-outlined text-[20px]">more_horiz</span>
                </div>
            `;
            taskEl.addEventListener('dragstart', (e) => { dragTaskId = task.id; e.dataTransfer.setData('text/plain', task.id); setTimeout(() => taskEl.classList.add('opacity-50'), 0); });
            taskEl.addEventListener('dragend', () => { taskEl.classList.remove('opacity-50'); dragTaskId = null; });
            taskEl.querySelector('.edit-project-task-btn').addEventListener('click', () => editProjectTask(task));
            taskEl.querySelector('.delete-project-task-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteProjectTask(task.id); });
            return taskEl;
        }
        
        async function deleteProjectTask(taskId) {
            if (!navigator.onLine) { alert("You are offline. Please reconnect to delete tasks."); return; }
            if (!confirm('Are you sure you want to delete this task?')) return;
            const { error } = await db.from('project_tasks').delete().eq('id', taskId);
            if (error) { console.error('Error deleting task:', error); alert('Error deleting task.'); } else { displayProjects(); }
        }
        
        function editProjectTask(task) {
            editingTaskId = task.id;
            document.getElementById('project-task-title').value = task.title;
            document.getElementById('project-task-due-date')._flatpickr.setDate(task.due_date);
            document.getElementById('project-task-assignee').value = task.assignee || '';
            document.getElementById('project-task-status').value = task.status;
            document.querySelector('#new-project-task-view h2').textContent = 'Edit Project Task';
            document.querySelector('#new-project-task-form button[type="submit"]').textContent = 'Update Task';
            showView('#new-project-task-view');
        }
        
        async function handleProjectFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) { alert("You are offline. Please reconnect to create projects."); return; }
            const formData = new FormData(e.target);
            const newProject = Object.fromEntries(formData.entries());
            const { error } = await db.from('projects').insert([newProject]).select();
            if (error) { alert('Error creating project: ' + error.message); } else { e.target.reset(); showView('#projects-view'); loadProjects(); }
        }
        
        async function handleProjectTaskFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) { alert("You are offline. Please reconnect to save tasks."); return; }
            const formData = new FormData(e.target);
            const taskData = Object.fromEntries(formData.entries());
            let response;
            if (editingTaskId) {
                response = await db.from('project_tasks').update(taskData).eq('id', editingTaskId);
            } else {
                if (!currentProjectId) { alert('Please select a project first'); return; }
                taskData.project_id = currentProjectId;
                response = await db.from('project_tasks').insert([taskData]);
            }
            if (response.error) {
                alert('Error saving task: ' + response.error.message);
            } else {
                e.target.reset(); editingTaskId = null;
                document.querySelector('#new-project-task-view h2').textContent = 'New Project Task';
                document.querySelector('#new-project-task-form button[type="submit"]').textContent = 'Create Task';
                showView('#projects-view'); displayProjects();
            }
        }
        
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => { e.preventDefault(); column.classList.add('bg-slate-200/50', 'dark:bg-slate-800/50'); });
                column.addEventListener('dragleave', () => { column.classList.remove('bg-slate-200/50', 'dark:bg-slate-800/50'); });
                column.addEventListener('drop', async (e) => {
                    e.preventDefault(); column.classList.remove('bg-slate-200/50', 'dark:bg-slate-800/50');
                    if (!dragTaskId) return;
                    if (!navigator.onLine) { alert("You are offline."); displayProjects(); return; }
                    const newStatus = column.dataset.status;
                    const { error } = await db.from('project_tasks').update({ status: newStatus }).eq('id', dragTaskId);
                    if (error) console.error('Error updating task status:', error); else displayProjects();
                });
            });
        }

        // === TEMPLATE FUNCTIONS ===
        function scheduleForTomorrow() {
            selectedDate.setDate(selectedDate.getDate() + 1); displayEvents(selectedDate);
        }
        
        async function saveCurrentDayAsTemplate() {
            if (!navigator.onLine) { alert("You are offline."); return; }
            const templateName = prompt("Please enter a name for this template:");
            if (!templateName) return;
            const dateString = toYMD(selectedDate);
            const { data: events, error: fetchError } = await db.from('events').select('title, start_time, end_time, category').eq('date', dateString);
            if (fetchError) { alert('Error fetching events to save: ' + fetchError.message); return; }
            if (!events || events.length === 0) { alert('There are no events on this day to save.'); return; }
            
            const { data: template, error: templateError } = await db.from('schedule_templates').insert({ name: templateName }).select().single();
            if (templateError) { alert('Error creating template: ' + templateError.message); return; }
            
            const templateEvents = events.map(event => ({ template_id: template.id, title: event.title, start_time: event.start_time, end_time: event.end_time, category: event.category }));
            const { error: eventsError } = await db.from('template_events').insert(templateEvents);
            if (eventsError) alert('Error saving template events: ' + eventsError.message); else alert(`Template "${templateName}" saved successfully!`);
        }
        
        async function showLoadTemplateModal() {
            const { data: templates, error } = await db.from('schedule_templates').select('*');
            if (error) { alert('Error fetching templates: ' + error.message); return; }
            const templateList = document.getElementById('template-list'); templateList.innerHTML = '';
            if (templates.length === 0) {
                templateList.innerHTML = '<p class="text-slate-500">No saved templates found.</p>';
            } else {
                templates.forEach(template => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700';
                    el.innerHTML = `
                        <span class="font-medium load-template-btn" data-load-id="${template.id}">${template.name}</span>
                        <div class="flex gap-2">
                            <button class="edit-template-btn p-2 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600" data-edit-id="${template.id}" title="Edit Template"><span class="material-symbols-outlined text-sm">edit</span></button>
                            <button class="delete-template-btn p-2 rounded-full hover:bg-red-500/20 text-red-500" data-delete-id="${template.id}" title="Delete Template"><span class="material-symbols-outlined text-sm">delete</span></button>
                        </div>
                    `;
                    templateList.appendChild(el);
                });
            }
            document.getElementById('load-template-modal').classList.remove('hidden'); document.getElementById('load-template-modal').classList.add('flex');
        }
        
        async function loadTemplate(templateId) {
            if (!navigator.onLine) { alert("You are offline."); return; }
            if (!confirm('This will add the template events to the current day. Are you sure?')) return;
            const { data: templateEvents, error } = await db.from('template_events').select('*').eq('template_id', templateId);
            if (error) { alert('Error fetching template events: ' + error.message); return; }
            
            const dateString = toYMD(selectedDate);
            const newEvents = templateEvents.map(event => ({ date: dateString, title: event.title, start_time: event.start_time, end_time: event.end_time, category: event.category }));
            const { error: insertError } = await db.from('events').insert(newEvents);
            if (insertError) {
                alert('Error loading template: ' + insertError.message);
            } else {
                document.getElementById('load-template-modal').classList.add('hidden'); document.getElementById('load-template-modal').classList.remove('flex');
                displayEvents(selectedDate);
            }
        }
        
        async function deleteTemplate(templateId) {
            if (!navigator.onLine) { alert("You are offline."); return; }
            if (!confirm('Are you sure you want to delete this template?')) return;
            await db.from('template_events').delete().eq('template_id', templateId);
            await db.from('schedule_templates').delete().eq('id', templateId);
            showLoadTemplateModal();
        }
        
        async function showTemplateEditor(templateId) {
            editingTemplateId = templateId;
            const { data: template, error } = await db.from('schedule_templates').select('name').eq('id', templateId).single();
            if (error) { alert('Error fetching template details: ' + error.message); return; }
            document.getElementById('template-editor-name').textContent = template.name;
            document.getElementById('load-template-modal').classList.add('hidden'); document.getElementById('load-template-modal').classList.remove('flex');
            showView('#template-editor-view'); displayTemplateEvents(templateId);
        }
        
        async function displayTemplateEvents(templateId) {
            const eventsContainer = document.getElementById('template-events-container');
            eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">Loading template events...</p>`;
            const { data: events, error } = await db.from('template_events').select('*').eq('template_id', templateId);
            eventsContainer.innerHTML = '';
            if (error || !events || events.length === 0) { eventsContainer.innerHTML = `<p class="text-center text-slate-500 pt-4">No events.</p>`; return; }
            events.forEach(event => {
                const start = timeToDecimal(event.start_time), end = timeToDecimal(event.end_time);
                const eventEl = document.createElement('div');
                eventEl.className = `absolute p-2 rounded-lg overflow-hidden cursor-pointer ${getCategoryClasses(event.category)} hover:opacity-80`;
                eventEl.style.cssText = `top:calc(${start}*4rem);height:calc(${(end-start)}*4rem);left:.5rem;right:.5rem;`;
                eventEl.innerHTML = `<p class="font-bold text-sm truncate">${event.title}</p><p class="text-xs opacity-80">${formatTime(event.start_time)}</p>`;
                eventEl.addEventListener('click', () => editTemplateEvent(event));
                eventsContainer.appendChild(eventEl);
            });
        }
        
        function editTemplateEvent(event) {
            editingTemplateEventId = event.id;
            document.getElementById('template-title').value = event.title;
            document.getElementById('template-category').value = event.category;
            document.getElementById('template-start-time').value = event.start_time;
            document.getElementById('template-end-time').value = event.end_time;
            document.querySelector('#template-form-view h2').textContent = 'Edit Template Event';
            document.querySelector('#template-event-form button[type="submit"]').textContent = 'Update Event';
            document.getElementById('delete-template-event-btn').classList.remove('hidden');
            showView('#template-form-view');
        }
        
        async function handleTemplateEventFormSubmit(e) {
            e.preventDefault();
            if (!navigator.onLine) { alert("You are offline."); return; }
            const formData = new FormData(e.target);
            const eventData = Object.fromEntries(formData.entries());
            if (eventData.start_time.length === 5) eventData.start_time += ':00'; if (eventData.end_time.length === 5) eventData.end_time += ':00';
            
            let response;
            if (editingTemplateEventId) { response = await db.from('template_events').update(eventData).eq('id', editingTemplateEventId); }
            else { eventData.template_id = editingTemplateId; response = await db.from('template_events').insert([eventData]); }
            if (response.error) alert('Error: ' + response.error.message); else showTemplateEditor(editingTemplateId);
        }
        
        async function deleteTemplateEvent() {
            if (!editingTemplateEventId || !confirm('Delete event?')) return;
            if (!navigator.onLine) { alert("You are offline."); return; }
            await db.from('template_events').delete().eq('id', editingTemplateEventId);
            showTemplateEditor(editingTemplateId);
        }

        // === POMODORO TIMER ===
        function stopAlerts() {
            if (flashingInterval) { clearInterval(flashingInterval); flashingInterval = null; }
            document.title = originalTitle;
            if (document.getElementById('favicon')) document.getElementById('favicon').href = originalFavicon;
        }
        
        function updatePomodoroTimerDisplay() {
            const minutes = Math.floor(pomodoroTimeLeft / 60), seconds = pomodoroTimeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('pomodoro-timer-display').textContent = display;
            
            const sessionName = pomodoroCurrentSession.replace(/([A-Z])/g, ' $1');
            const capitalizedSessionName = sessionName.charAt(0).toUpperCase() + sessionName.slice(1);
            if (!flashingInterval) {
                 const newTitle = `${display} | ${capitalizedSessionName} - TaskMaster`;
                 document.title = newTitle; originalTitle = newTitle;
            }
            document.getElementById('pomodoro-cycle-count').textContent = `Cycle: ${pomodoroCycleCount} / ${pomodoroSettings.longBreakCycle}`;
        }
        
        function updatePomodoroButton(isRunning) {
            const startPauseBtn = document.getElementById('pomodoro-start-pause-btn'), startPauseText = document.getElementById('pomodoro-start-pause-text'), playIcon = startPauseBtn.querySelector('.material-symbols-outlined');
            if (isRunning) {
                startPauseText.textContent = 'Pause'; playIcon.textContent = 'pause';
                startPauseBtn.classList.add('bg-orange-500', 'hover:bg-orange-600'); startPauseBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
            } else {
                startPauseText.textContent = 'Start'; playIcon.textContent = 'play_arrow';
                startPauseBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600'); startPauseBtn.classList.add('bg-primary', 'hover:bg-primary/90');
            }
        }
        
        function setPomodoroSession(session) {
            pausePomodoroTimer(); stopAlerts();
            pomodoroCurrentSession = session;
            pomodoroTimeLeft = pomodoroSettings[session] * 60;
            document.querySelectorAll('.timer-session-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300', 'hover:bg-slate-300', 'dark:hover:bg-slate-600');
            });
            const btn = document.getElementById(`pomodoro-${session.replace(/([A-Z])/g, '-$1').toLowerCase()}-btn`);
            btn.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300', 'hover:bg-slate-300', 'dark:hover:bg-slate-600');
            btn.classList.add('bg-primary', 'text-white');
            updatePomodoroTimerDisplay();
        }
        
        function startPomodoroTimer() {
            if (pomodoroIsRunning) return;
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') Notification.requestPermission();
            stopAlerts(); pomodoroIsRunning = true; updatePomodoroButton(true);
            timerInterval = setInterval(() => {
                pomodoroTimeLeft--;
                if (pomodoroTimeLeft < 0) { clearInterval(timerInterval); timerInterval = null; handleSessionEnd(); } 
                else { updatePomodoroTimerDisplay(); }
            }, 1000);
        }
        
        function pausePomodoroTimer() {
            if (!pomodoroIsRunning) return;
            pomodoroIsRunning = false; updatePomodoroButton(false);
            clearInterval(timerInterval); timerInterval = null;
        }
        
        function resetPomodoroTimer() {
            pausePomodoroTimer(); stopAlerts();
            pomodoroCurrentSession = 'work'; pomodoroTimeLeft = pomodoroSettings.work * 60; pomodoroCycleCount = 0;
            setPomodoroSession('work'); updatePomodoroButton(false); updatePomodoroTimerDisplay();
        }
        
        function handleSessionEnd() {
            pomodoroIsRunning = false; updatePomodoroButton(false);
            alarmSound.play();
            const bellFavicon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ef4444'%3E%3Cpath d='M12 22C13.1 22 14 21.1 14 20H10C10 21.1 10.9 22 12 22ZM18 16V11C18 7.93 16.36 5.36 13.5 4.68V4C13.5 3.17 12.83 2.5 12 2.5C11.17 2.5 10.5 3.17 10.5 4V4.68C7.63 5.36 6 7.93 6 11V16L4 18V19H20V18L18 16Z'/%3E%3C/svg%3E";
            if (document.getElementById('favicon')) document.getElementById('favicon').href = bellFavicon;
            
            const sessionEndText = pomodoroCurrentSession === 'work' ? 'Work session complete! Time for a break.' : 'Break complete! Time to get back to work.';
            if ('Notification' in window && Notification.permission === 'granted') new Notification('TaskMaster Pomodoro', { body: sessionEndText, icon: bellFavicon });
            
            let isTitleToggled = false;
            flashingInterval = setInterval(() => {
                document.title = isTitleToggled ? " Time's up!" : sessionEndText;
                isTitleToggled = !isTitleToggled;
            }, 1000);
            
            if (pomodoroCurrentSession === 'work') {
                pomodoroCycleCount++;
                if (pomodoroCycleCount > 0 && pomodoroCycleCount % pomodoroSettings.longBreakCycle === 0) setPomodoroSession('longBreak');
                else setPomodoroSession('shortBreak');
            } else { setPomodoroSession('work'); }
            pausePomodoroTimer();
        }
        
        function applyPomodoroSettings() {
            const work = parseInt(document.getElementById('work-duration').value), shortBreak = parseInt(document.getElementById('short-break-duration').value), longBreak = parseInt(document.getElementById('long-break-duration').value);
            if (work > 0 && shortBreak > 0 && longBreak > 0) {
                pomodoroSettings.work = work; pomodoroSettings.shortBreak = shortBreak; pomodoroSettings.longBreak = longBreak;
                localStorage.setItem('pomodoroSettings', JSON.stringify(pomodoroSettings));
                resetPomodoroTimer();
                const applyBtn = document.getElementById('apply-pomodoro-settings-btn');
                const originalText = applyBtn.textContent; applyBtn.textContent = 'Settings Applied!';
                setTimeout(() => { applyBtn.textContent = originalText; }, 2000);
            }
        }
        
        function loadPomodoroSettings() {
            const saved = localStorage.getItem('pomodoroSettings');
            if (saved) {
                pomodoroSettings = JSON.parse(saved);
                document.getElementById('work-duration').value = pomodoroSettings.work;
                document.getElementById('short-break-duration').value = pomodoroSettings.shortBreak;
                document.getElementById('long-break-duration').value = pomodoroSettings.longBreak;
            }
            pomodoroTimeLeft = pomodoroSettings.work * 60;
        }

        // === GOALS FUNCTIONS ===
        function generateDotsHTML(interest, isLime) {
            let activeDots = 3; // Default Medium
            if (interest.includes('Low')) activeDots = 1;
            else if (interest.includes('Medium')) activeDots = 3;
            else if (interest.includes('Great') || interest.includes('High')) activeDots = 4;
            else if (interest.includes('Hot')) activeDots = 5;

            let dots = '';
            for(let i=0; i<5; i++) {
                let colorClass = isLime 
                    ? (i < activeDots ? 'bg-black' : 'bg-black/20') 
                    : (i < activeDots ? 'bg-orange-500' : 'bg-slate-200 dark:bg-slate-700');
                dots += `<div class="size-2 rounded-full ${colorClass}"></div>`;
            }
            return `<div class="flex gap-1.5">${dots}</div>`;
        }

        async function displayGoals() {
            document.getElementById('goals-list-view').classList.remove('hidden'); document.getElementById('goals-list-header').classList.remove('hidden'); document.getElementById('goal-details-view').classList.add('hidden');
            const listContainer = document.getElementById('goals-list-view');
            listContainer.innerHTML = '<p class="col-span-full text-center text-slate-500 py-10">Loading goals...</p>';
            
            const { data: goals, error } = await db.from('goals').select('*').order('created_at', { ascending: false });
            
            if (error) {
                listContainer.innerHTML = '<p class="col-span-full text-center text-red-500">Error loading goals.</p>'; return;
            }

            // Update filter UI Buttons
            document.querySelectorAll('.goal-filter-btn').forEach(btn => {
                const isSelected = btn.dataset.filter === currentGoalFilter;
                let baseClasses = "goal-filter-btn px-5 py-2.5 rounded-full border text-sm flex-shrink-0 transition-colors flex items-center gap-1.5 ";
                if (isSelected) {
                    btn.className = baseClasses + "bg-white dark:bg-slate-800 shadow-sm border-slate-100 dark:border-slate-700 text-slate-900 dark:text-white font-semibold";
                } else {
                    btn.className = baseClasses + "bg-transparent border-slate-200 dark:border-slate-700 text-slate-500 hover:bg-white/50 dark:hover:bg-slate-800/50 font-medium";
                }
            });

            if (!goals || goals.length === 0) {
                listContainer.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-16 text-center bg-white/50 dark:bg-slate-800/50 rounded-[32px] border border-dashed border-slate-300 dark:border-slate-700">
                        <div class="w-16 h-16 bg-[#bdf553] rounded-full flex items-center justify-center text-black mb-4"><span class="material-symbols-outlined text-3xl">flag</span></div>
                        <h3 class="text-xl font-bold mb-2">No Goals Yet</h3>
                        <p class="text-slate-500 max-w-sm mx-auto mb-6">Set your first goal to start tracking your progress.</p>
                        <button onclick="document.getElementById('add-goal-btn').click()" class="text-black dark:text-white font-semibold underline decoration-2 underline-offset-4 hover:opacity-80 transition-opacity">Create a Goal</button>
                    </div>`;
                document.getElementById('stat-total').textContent = '0';
                document.getElementById('stat-completed').textContent = '0';
                document.getElementById('stat-active').textContent = '0';
                document.getElementById('goals-count-text').textContent = '0 Goals';
                return;
            }
            
            let filteredGoals = goals;
            if (currentGoalFilter !== 'All') {
                filteredGoals = goals.filter(g => g.interest === currentGoalFilter);
            }

            const { data: logs } = await db.from('goal_logs').select('goal_id, count');
            
            let totalGoals = goals.length;
            let completedGoalsCount = 0;

            // Calculate overall stats
            goals.forEach(g => {
                const gLogs = logs ? logs.filter(l => l.goal_id === g.id) : [];
                const comp = gLogs.reduce((sum, l) => sum + l.count, 0);
                if (comp >= g.target_number) completedGoalsCount++;
            });

            document.getElementById('stat-total').textContent = totalGoals;
            document.getElementById('stat-completed').textContent = completedGoalsCount;
            document.getElementById('stat-active').textContent = totalGoals - completedGoalsCount;
            document.getElementById('goals-count-text').textContent = `${totalGoals} Goals`;

            if (filteredGoals.length === 0) {
                listContainer.innerHTML = '<p class="col-span-full text-center text-slate-500 py-10 font-medium">No goals match your current filter.</p>';
                return;
            }

            listContainer.innerHTML = filteredGoals.map((goal, index) => {
                const goalLogs = logs ? logs.filter(l => l.goal_id === goal.id) : [];
                const completed = goalLogs.reduce((sum, l) => sum + l.count, 0);
                const percent = Math.min(100, Math.round((completed / goal.target_number) * 100));

                // First card acts as the 'Hot Client / Highlighted' card like in the image
                const isLimeCard = index === 0;

                const interestText = goal.interest || 'Medium Interest';
                const sourceText = goal.source || 'Personal';
                const categoryStyle = getCategoryStyle(sourceText);
                const cardIcon = isLimeCard ? 'rocket_launch' : categoryStyle.icon;

                let cardStyle = isLimeCard
                    ? 'bg-[#bdf553] text-black border-transparent'
                    : 'bg-white dark:bg-slate-900 text-slate-900 dark:text-white border-slate-200/60 dark:border-slate-800';

                let buttonStyle = isLimeCard
                    ? 'border-black/10 text-black/60 hover:text-black hover:bg-black/5'
                    : 'border-slate-200 dark:border-slate-700 text-slate-400 hover:text-black dark:hover:text-white hover:bg-slate-50 dark:hover:bg-slate-800';

                let bottomSection = isLimeCard ? `
                    <div class="flex items-center justify-between w-full gap-4">
                        <div class="flex flex-col flex-shrink-0">
                            <p class="text-[11px] font-bold uppercase tracking-widest text-black/50 mb-1">Status</p>
                            <div class="flex items-center gap-1 text-[13px] font-semibold">Goal Active</div>
                        </div>
                        <div class="flex flex-col w-full max-w-[130px]">
                            <div class="flex justify-between items-end mb-1.5">
                                <p class="text-[10px] font-bold uppercase tracking-widest text-black/50">Overall Progress</p>
                                <span class="text-[12px] font-bold text-black leading-none">${percent}%</span>
                            </div>
                            <div class="w-full h-1.5 bg-black/10 rounded-full overflow-hidden">
                                <div class="h-full bg-black rounded-full" style="width:${percent}%"></div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="flex items-end justify-between w-full">
                         <div class="flex flex-col">
                             <p class="text-[11px] font-medium text-slate-400 mb-1">Source</p>
                             <div class="flex gap-1.5 mt-1"><span class="px-3 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-[10px] font-medium text-slate-500">${sourceText}</span></div>
                         </div>
                         <div class="flex flex-col items-end">
                             <p class="text-[11px] font-medium ${interestText.includes('Hot') ? 'text-orange-500' : 'text-slate-400'} mb-1.5">${percent>=100 ? ' Completed' : interestText}</p>
                             ${generateDotsHTML(interestText, false)}
                         </div>
                    </div>
                `;

                return `
                    <div class="goal-card relative p-6 md:p-8 shadow-sm hover:shadow-xl transition-all cursor-pointer rounded-[32px] min-h-[260px] flex flex-col justify-between ${cardStyle}" data-id="${goal.id}">
                        <button class="absolute top-6 right-6 size-8 rounded-full border flex items-center justify-center transition-colors ${buttonStyle}">
                            <span class="material-symbols-outlined text-sm transform -rotate-45">arrow_upward</span>
                        </button>
                        <div class="mb-4">
                            <div class="size-12 rounded-full border-2 flex items-center justify-center ${isLimeCard ? 'border-black/10 bg-black/5 text-black' : 'border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400'} shadow-sm">
                                <span class="material-symbols-outlined text-[22px]">${cardIcon}</span>
                            </div>
                        </div>
                        <div class="mb-6 pr-8">
                            <h3 class="font-medium text-2xl leading-tight mb-1 line-clamp-2">${goal.title}</h3>
                            <p class="text-[13px] ${isLimeCard ? 'text-black/60 font-medium' : 'text-slate-500 dark:text-slate-400'}">Target: ${goal.target_number}</p>
                        </div>
                        <div class="flex items-end justify-between mt-auto pt-4 border-t ${isLimeCard ? 'border-black/5' : 'border-slate-100 dark:border-slate-800'}">
                            ${bottomSection}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.goal-card').forEach(card => {
                card.addEventListener('click', () => {
                    const goal = goals.find(g => g.id == card.dataset.id);
                    if(goal) showGoalDetails(goal);
                });
            });
        }

        async function showGoalDetails(goal) {
            activeGoal = goal;
            document.getElementById('goals-list-container').classList.add('hidden');
            document.getElementById('goal-details-view').classList.remove('hidden');
            document.getElementById('goal-details-title').textContent = goal.title;
            updateGoalStats();
        }

        async function updateGoalStats() {
            if (!activeGoal) return;
            const { data: logs, error } = await db.from('goal_logs').select('*').eq('goal_id', activeGoal.id).order('date', { ascending: false });
            if (error) return;

            const totalCompleted = logs.reduce((sum, log) => sum + log.count, 0);
            const target = activeGoal.target_number;
            const remaining = Math.max(0, target - totalCompleted);
            const percentage = Math.min(100, Math.round((totalCompleted / target) * 100));

            document.getElementById('goal-percentage').textContent = `${percentage}%`;
            document.getElementById('goal-progress-bar').style.width = `${percentage}%`;
            document.getElementById('goal-stat-completed').textContent = totalCompleted;
            document.getElementById('goal-stat-target').textContent = target;
            document.getElementById('goal-stat-remaining').textContent = remaining;

            const historyContainer = document.getElementById('goal-history-list');
            if (logs.length === 0) {
                historyContainer.innerHTML = '<p class="text-sm text-slate-500 py-4">No entries logged yet.</p>';
            } else {
                historyContainer.innerHTML = logs.map(log => `
                    <div class="flex items-center justify-between p-4 rounded-[20px] bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors border border-transparent dark:border-slate-700/50">
                        <div class="flex items-center gap-4">
                            <div class="size-10 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center shadow-sm">
                                <span class="material-symbols-outlined text-sm text-slate-400">task_alt</span>
                            </div>
                            <div>
                                <p class="font-medium text-slate-900 dark:text-white">+${log.count} logged</p>
                                <p class="text-[11px] font-semibold uppercase tracking-wider text-slate-500 mt-0.5">${new Date(log.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <button class="size-8 flex items-center justify-center rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors delete-log-btn" data-id="${log.id}">
                            <span class="material-symbols-outlined text-sm">close</span>
                        </button>
                    </div>
                `).join('');
                document.querySelectorAll('.delete-log-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteGoalLog(btn.dataset.id));
                });
            }
        }

        async function handleGoalSetup(e) {
            e.preventDefault();
            if (!navigator.onLine) { alert("You are offline. Please reconnect."); return; }
            const formData = new FormData(e.target);
            const title = formData.get('title');
            const targetNumber = parseInt(formData.get('target_number'));
            const interest = formData.get('interest');
            const source = formData.get('source');

            if (!title || !targetNumber) return;
            
            const goalData = { title, target_number: targetNumber, interest, source };

            let response;
            if (editingGoalId) {
                response = await db.from('goals').update(goalData).eq('id', editingGoalId);
            } else {
                response = await db.from('goals').insert([goalData]);
            }

            if (response.error) {
                alert('Error: ' + response.error.message);
            } else { 
                e.target.reset(); 
                document.getElementById('goal-modal').classList.add('hidden'); 
                document.getElementById('goal-modal').classList.remove('flex'); 
                
                if (editingGoalId && activeGoal) {
                    activeGoal = { ...activeGoal, ...goalData };
                    document.getElementById('goal-details-title').textContent = activeGoal.title;
                    updateGoalStats();
                } else {
                    displayGoals(); 
                }
                editingGoalId = null;
            }
        }

        async function handleGoalLog(e) {
            e.preventDefault();
            if (!activeGoal) return;
            const formData = new FormData(e.target);
            const { error } = await db.from('goal_logs').insert([{ goal_id: activeGoal.id, date: formData.get('date'), count: parseInt(formData.get('count')) }]);
            if (error) alert('Error: ' + error.message);
            else { e.target.reset(); document.getElementById('goal-log-date')._flatpickr.setDate(new Date()); updateGoalStats(); }
        }

        async function deleteGoalLog(logId) {
            if (!confirm("Remove this entry?")) return;
            const { error } = await db.from('goal_logs').delete().eq('id', logId);
            if (error) alert('Error: ' + error.message); else updateGoalStats();
        }

        async function deleteGoal() {
            if (!activeGoal || !confirm("Delete this goal and all history?")) return;
            await db.from('goal_logs').delete().eq('goal_id', activeGoal.id);
            const { error } = await db.from('goals').delete().eq('id', activeGoal.id);
            if (error) alert('Error: ' + error.message); else { activeGoal = null; displayGoals(); }
        }

        function updateOnlineStatus() {
            const ind = document.getElementById('online-status');
            if (navigator.onLine) { ind.classList.add('bg-green-500'); ind.classList.remove('bg-red-500'); ind.title = 'Online'; } 
            else { ind.classList.add('bg-red-500'); ind.classList.remove('bg-green-500'); ind.title = 'Offline'; }
        }
        
        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            originalTitle = document.title;
            originalFavicon = document.getElementById('favicon').href;
            
            flatpickr('#date', { defaultDate: 'today', dateFormat: 'Y-m-d' });
            flatpickr('#project-task-due-date', { defaultDate: 'today', dateFormat: 'Y-m-d' });
            flatpickr('#bulk-date', { defaultDate: 'today', dateFormat: 'Y-m-d' });
            flatpickr('#goal-log-date', { defaultDate: 'today', dateFormat: 'Y-m-d' });
            
            renderTemplateEditorGrid(); 
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (link.dataset.view) showView(link.dataset.view);
                });
            });
            
            document.getElementById('profile-pic').addEventListener('click', () => showView('#settings-view'));
            
            document.getElementById('pomodoro-start-pause-btn').addEventListener('click', () => pomodoroIsRunning ? pausePomodoroTimer() : startPomodoroTimer());
            document.getElementById('pomodoro-reset-btn').addEventListener('click', resetPomodoroTimer);
            document.getElementById('pomodoro-work-btn').addEventListener('click', () => setPomodoroSession('work'));
            document.getElementById('pomodoro-short-break-btn').addEventListener('click', () => setPomodoroSession('shortBreak'));
            document.getElementById('pomodoro-long-break-btn').addEventListener('click', () => setPomodoroSession('longBreak'));
            document.getElementById('apply-pomodoro-settings-btn').addEventListener('click', applyPomodoroSettings);
            
            document.getElementById('event-form').addEventListener('submit', handleEventFormSubmit);
            document.getElementById('new-project-form').addEventListener('submit', handleProjectFormSubmit);
            document.getElementById('new-project-task-form').addEventListener('submit', handleProjectTaskFormSubmit);
            document.getElementById('template-event-form').addEventListener('submit', handleTemplateEventFormSubmit); 
            document.getElementById('bulk-form').addEventListener('submit', handleBulkFormSubmit);
            
            // Goal Listeners
            document.querySelectorAll('.goal-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentGoalFilter = e.currentTarget.dataset.filter;
                    displayGoals();
                });
            });

            document.getElementById('add-goal-btn').addEventListener('click', () => { 
                editingGoalId = null;
                document.getElementById('create-goal-form').reset();
                document.querySelector('#goal-modal h3').textContent = 'Set New Goal';
                document.getElementById('submit-goal-btn').textContent = 'Start Tracking';
                document.getElementById('goal-modal').classList.remove('hidden'); 
                document.getElementById('goal-modal').classList.add('flex'); 
            });
            document.getElementById('edit-goal-btn').addEventListener('click', () => {
                if (!activeGoal) return;
                editingGoalId = activeGoal.id;
                document.getElementById('goal-title-input').value = activeGoal.title;
                document.getElementById('goal-target-input').value = activeGoal.target_number;
                document.getElementById('goal-interest-input').value = activeGoal.interest || 'Medium Interest';
                document.getElementById('goal-source-input').value = activeGoal.source || 'Personal';
                
                document.querySelector('#goal-modal h3').textContent = 'Edit Goal';
                document.getElementById('submit-goal-btn').textContent = 'Save Changes';
                
                document.getElementById('goal-modal').classList.remove('hidden'); 
                document.getElementById('goal-modal').classList.add('flex'); 
            });
            document.getElementById('close-goal-modal').addEventListener('click', () => { document.getElementById('goal-modal').classList.add('hidden'); document.getElementById('goal-modal').classList.remove('flex'); });
            document.getElementById('create-goal-form').addEventListener('submit', handleGoalSetup);
            document.getElementById('goal-log-form').addEventListener('submit', handleGoalLog);
            document.getElementById('delete-goal-btn').addEventListener('click', deleteGoal);
            document.getElementById('back-to-goals-btn').addEventListener('click', () => { activeGoal = null; displayGoals(); });

            document.getElementById('delete-event-btn').addEventListener('click', deleteEvent);
            document.getElementById('add-event-btn').addEventListener('click', () => {
                const datePicker = document.getElementById('date')._flatpickr;
                datePicker.setDate(selectedDate);
                editingEventId = null;
                document.getElementById('event-form').reset();
                datePicker.setDate(selectedDate); 
                document.querySelector('#form-view h2').textContent = 'New Event';
                document.querySelector('#event-form button[type="submit"]').textContent = 'Create Event';
                document.getElementById('delete-event-btn').classList.add('hidden');
                showView('#form-view');
            });

            document.getElementById('bulk-mode-btn').addEventListener('click', () => {
                document.getElementById('bulk-date')._flatpickr.setDate(selectedDate);
                document.getElementById('bulk-rows-container').innerHTML = '';
                addBulkRow('09:00'); addBulkRow(); addBulkRow(); 
                showView('#bulk-schedule-view');
            });
            
            document.getElementById('add-bulk-row-btn').addEventListener('click', () => addBulkRow());
            document.getElementById('cancel-bulk-btn').addEventListener('click', () => showView('#schedule-view'));
            document.getElementById('bulk-rows-container').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-bulk-row-btn');
                if (removeBtn) {
                    const row = removeBtn.closest('.bulk-row');
                    if (document.querySelectorAll('.bulk-row').length > 1) row.remove();
                    else row.querySelectorAll('input').forEach(i => i.value = '');
                }
            });
            
            document.getElementById('cancel-btn').addEventListener('click', () => {
                editingEventId = null; document.getElementById('event-form').reset();
                showView('#schedule-view');
            });
            
            document.getElementById('new-project-btn').addEventListener('click', () => showView('#new-project-view'));
            document.getElementById('cancel-project-btn').addEventListener('click', () => showView('#projects-view'));
            document.getElementById('new-project-task-btn').addEventListener('click', () => showView('#new-project-task-view'));
            document.getElementById('cancel-project-task-btn').addEventListener('click', () => {
                editingTaskId = null;
                document.getElementById('new-project-task-form').reset();
                document.querySelector('#new-project-task-view h2').textContent = 'New Project Task';
                document.querySelector('#new-project-task-form button[type="submit"]').textContent = 'Create Task';
                showView('#projects-view');
            });
            
            document.getElementById('delete-project-btn').addEventListener('click', deleteProject);

            document.getElementById('cal-prev-btn').addEventListener('click', () => { calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() - 1); initializeCalendarView(); });
            document.getElementById('cal-next-btn').addEventListener('click', () => { calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() + 1); initializeCalendarView(); });
            
            document.getElementById('schedule-tomorrow-btn').addEventListener('click', scheduleForTomorrow);
            document.getElementById('save-template-btn').addEventListener('click', saveCurrentDayAsTemplate);
            document.getElementById('load-template-btn').addEventListener('click', showLoadTemplateModal);
            document.getElementById('close-template-modal-btn').addEventListener('click', () => { document.getElementById('load-template-modal').classList.add('hidden'); document.getElementById('load-template-modal').classList.remove('flex'); });
            
            document.getElementById('close-template-editor-btn').addEventListener('click', () => showView('#schedule-view'));
            document.getElementById('add-template-event-btn').addEventListener('click', () => {
                editingTemplateEventId = null; document.getElementById('template-event-form').reset();
                document.querySelector('#template-form-view h2').textContent = 'New Template Event';
                document.querySelector('#template-event-form button[type="submit"]').textContent = 'Create Event';
                document.getElementById('delete-template-event-btn').classList.add('hidden');
                showView('#template-form-view');
            });
            document.getElementById('delete-template-event-btn').addEventListener('click', deleteTemplateEvent);
            document.getElementById('cancel-template-btn').addEventListener('click', () => showTemplateEditor(editingTemplateId));
            
            document.getElementById('template-list').addEventListener('click', (e) => {
                const loadBtn = e.target.closest('.load-template-btn');
                const editBtn = e.target.closest('.edit-template-btn');
                const deleteBtn = e.target.closest('.delete-template-btn');
                
                if (loadBtn) {
                    loadTemplate(loadBtn.dataset.loadId);
                } else if (editBtn) {
                    showTemplateEditor(editBtn.dataset.editId);
                } else if (deleteBtn) {
                    deleteTemplate(deleteBtn.dataset.deleteId);
                }
            });

            // To-Do Inline Checkbox Toggle
            document.addEventListener('change', async (e) => {
                if (e.target.matches('.todo-cb')) {
                    if (!navigator.onLine) {
                        alert("You are offline. Please reconnect to update tasks.");
                        e.target.checked = !e.target.checked; 
                        return;
                    }
                    const taskId = e.target.dataset.id;
                    const newStatus = e.target.checked ? 'Completed' : 'Pending';
                
                    const { error } = await db.from('todos').update({ status: newStatus }).eq('id', taskId);
                    if (error) { console.error('Error updating task:', error); } else { displayTodos(); }
                }
            });

            setupDragAndDrop();

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus(); // Initial check

            // === NEW: HEADER SCROLL LOGIC ===
            let lastScrollTop = 0;
            const header = document.querySelector('header');
            window.addEventListener("scroll", function() {
                let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                if (scrollTop > lastScrollTop && scrollTop > 50) {
                    // Downscroll
                    header.classList.add('-translate-y-full');
                } else if (scrollTop < lastScrollTop || scrollTop === 0) {
                    // Upscroll or at the top
                    header.classList.remove('-translate-y-full');
                }
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; // For Mobile or negative scrolling
            }, false);
            
            // Initial view
            showView('#schedule-view');
        });
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
</body>
</html>
