<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>DayWise Application</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        // Tailwind Config & Dark Mode Setup
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: { "display": ["Inter"] },
                },
            },
        }

        // Apply theme from localStorage on initial load to prevent flashing
        function applyTheme(theme) {
            const htmlTag = document.documentElement;
            localStorage.setItem('theme', theme);
            if (theme === 'dark') htmlTag.classList.add('dark');
            else if (theme === 'light') htmlTag.classList.remove('dark');
            else { // System default
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) htmlTag.classList.add('dark');
                else htmlTag.classList.remove('dark');
            }
        }
        
        const savedTheme = localStorage.getItem('theme') || 'system';
        applyTheme(savedTheme);
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200">

    <header class="flex items-center justify-between px-6 py-3 border-b border-slate-200 dark:border-slate-800 sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-50">
        <div class="flex items-center gap-4">
            <div class="text-primary size-7"><svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H42L36 24L42 42H6L12 24L6 6Z"></path></svg></div>
            <h1 class="text-xl font-bold text-slate-900 dark:text-white">TaskMaster</h1>
        </div>
        <nav class="hidden md:flex items-center gap-8">
            <a id="today-link" class="text-sm font-medium cursor-pointer">Today</a>
            <a id="calendar-link" class="text-sm font-medium cursor-pointer">Calendar</a>
            <a id="todo-link" class="text-sm font-medium cursor-pointer">To-Do</a>
            <a id="projects-link" class="text-sm font-medium cursor-pointer">Projects</a>
        </nav>
        <div class="flex items-center gap-4">
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined">search</span></button>
            <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"><span class="material-symbols-outlined">notifications</span></button>
            <img alt="User avatar" class="size-10 rounded-full cursor-pointer" id="profile-pic" src="https://i.pravatar.cc/150?u=a042581f4e29026704d"/>
        </div>
    </header>

    <div id="views-container">
        <div id="schedule-view" class="hidden"></div>
        <div id="form-view" class="hidden"></div>
        <div id="calendar-view" class="hidden"></div>
        <div id="todo-view" class="hidden"></div>
        <div id="new-task-view" class="hidden"></div>
        <div id="settings-view" class="hidden"></div>

        <div id="projects-view" class="hidden">
            <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex flex-col gap-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-900 dark:text-white">Project Tracker</h2>
                            <p class="text-slate-500 dark:text-slate-400 mt-1">Manage your projects and tasks efficiently.</p>
                        </div>
                        <button id="new-project-btn" class="bg-primary text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                            <span class="material-symbols-outlined">add_circle</span> New Project
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <label for="project-selector" class="font-medium">Current Project:</label>
                        <select id="project-selector" class="form-select rounded-lg bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-700"></select>
                    </div>

                    <div id="kanban-container" class="hidden">
                         <div class="flex justify-between items-center mb-4">
                            <h3 id="project-title" class="text-xl font-bold text-slate-900 dark:text-white"></h3>
                            <button id="new-project-task-btn" class="bg-primary/20 text-primary dark:bg-primary/30 px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-2">
                                <span class="material-symbols-outlined">add</span> New Task
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-slate-800 dark:text-slate-200">To Do</h4>
                                    <span id="count-todo" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span>
                                </div>
                                <div id="kanban-todo" class="space-y-4 min-h-[100px]" data-status="To Do"></div>
                            </div>
                            <div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-slate-800 dark:text-slate-200">In Progress</h4>
                                    <span id="count-inprogress" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span>
                                </div>
                                <div id="kanban-inprogress" class="space-y-4 min-h-[100px]" data-status="In Progress"></div>
                            </div>
                            <div class="bg-slate-100/50 dark:bg-slate-900/50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-slate-800 dark:text-slate-200">Done</h4>
                                    <span id="count-done" class="text-sm font-medium text-slate-500 bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full">0</span>
                                </div>
                                <div id="kanban-done" class="space-y-4 min-h-[100px]" data-status="Done"></div>
                            </div>
                        </div>
                    </div>
                     <div id="no-projects-message" class="text-center py-12 text-slate-500 hidden">
                        <p>No projects found. Create a new project to get started.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="edit-event-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm"></div>
    <div id="edit-todo-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm"></div>

    <div id="new-project-task-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-background-light dark:bg-background-dark rounded-lg shadow-xl w-full max-w-md">
            <form id="new-project-task-form" class="p-6 space-y-4">
                <div class="flex justify-between items-center"><h3 class="text-xl font-bold">New Project Task</h3><button type="button" class="close-modal-btn p-1">&times;</button></div>
                <input type="hidden" id="new-task-project-id" name="project_id">
                <div><label for="new-task-title">Title</label><input type="text" id="new-task-title" name="title" class="mt-1 w-full rounded-lg" required></div>
                <div><label for="new-task-due-date">Due Date</label><input type="text" id="new-task-due-date" name="due_date" class="mt-1 w-full rounded-lg" readonly></div>
                <div><label for="new-task-assignee">Assignee</label><input type="text" id="new-task-assignee" name="assignee" class="mt-1 w-full rounded-lg"></div>
                <div class="flex justify-end pt-4"><button type="submit" class="px-4 py-2 text-white bg-primary rounded-lg">Create Task</button></div>
            </form>
        </div>
    </div>


    <script>
        // === SUPABASE & STATE SETUP ===
      const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        let selectedDate = new Date();
        let calendarDisplayDate = new Date();

        // === HELPERS & MANAGEMENT ===
        const toYMD = (date) => date.toISOString().split('T')[0];
        function showView(viewId) {
            document.querySelectorAll('#views-container > div').forEach(v => v.classList.add('hidden'));
            document.querySelector(viewId).classList.remove('hidden');
            updateActiveLink(viewId);

            if (viewId === '#schedule-view') displayEvents(selectedDate);
            if (viewId === '#calendar-view') initializeCalendarView();
            if (viewId === '#todo-view') displayTodos();
            if (viewId === '#settings-view') initializeSettings();
            if (viewId === '#projects-view') initializeProjectsView();
        }
        function updateActiveLink(activeViewId) { /* Unchanged */ }
        function closeModal(modal) { if (modal) modal.classList.add('hidden'); }
        function openModal(modal) { if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); } }
        
        // === PROJECT TRACKER VIEW LOGIC (Updated) ===
        async function initializeProjectsView() {
            const { data: projects, error } = await db.from('projects').select('*').order('created_at');
            if (error) { console.error('Error fetching projects:', error); return; }

            const selector = document.getElementById('project-selector');
            selector.innerHTML = ''; // Clear previous options

            if (projects && projects.length > 0) {
                document.getElementById('kanban-container').classList.remove('hidden');
                document.getElementById('no-projects-message').classList.add('hidden');

                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    selector.appendChild(option);
                });
                
                // If there's no current project selected, or the old one was deleted, select the first one
                if (!currentProjectId || !projects.some(p => p.id == currentProjectId)) {
                    currentProjectId = projects[0].id;
                }
                
                selector.value = currentProjectId;
                await displayProjectTasks(currentProjectId);

            } else {
                // No projects exist
                document.getElementById('kanban-container').classList.add('hidden');
                document.getElementById('no-projects-message').classList.remove('hidden');
                currentProjectId = null;
            }
        }

        async function displayProjectTasks(projectId) {
            currentProjectId = projectId;
            const { data: project, error: projectError } = await db.from('projects').select('name').eq('id', projectId).single();
            if(projectError) { console.error('Error fetching project name'); return; }

            document.getElementById('project-title').textContent = `Project: ${project.name}`;
            
            const { data: tasks, error } = await db.from('project_tasks').select('*').eq('project_id', projectId).order('due_date');
            if (error) { console.error("Error fetching project tasks:", error); return; }

            const columns = { 'To Do': document.getElementById('kanban-todo'), 'In Progress': document.getElementById('kanban-inprogress'), 'Done': document.getElementById('kanban-done') };
            Object.values(columns).forEach(col => col.innerHTML = '');

            tasks.forEach(task => {
                if (columns[task.status]) {
                    columns[task.status].innerHTML += `<div class="bg-background-light dark:bg-background-dark p-4 rounded-lg border dark:border-slate-800 shadow-sm cursor-grab active:cursor-grabbing" data-id="${task.id}">
                        <p class="font-medium">${task.title}</p>
                        <div class="flex items-center justify-between mt-2 text-sm text-slate-500"><span>Due: ${task.due_date||'N/A'}</span><span>${task.assignee||'Unassigned'}</span></div>
                    </div>`;
                }
            });
            
            document.getElementById('count-todo').textContent = tasks.filter(t => t.status === 'To Do').length;
            document.getElementById('count-inprogress').textContent = tasks.filter(t => t.status === 'In Progress').length;
            document.getElementById('count-done').textContent = tasks.filter(t => t.status === 'Done').length;
        }

        function initializeKanban() {
            const columns = ['kanban-todo', 'kanban-inprogress', 'kanban-done'];
            columns.forEach(colId => {
                const el = document.getElementById(colId);
                new Sortable(el, {
                    group: 'kanban',
                    animation: 150,
                    onEnd: async function (evt) {
                        const taskId = evt.item.dataset.id;
                        const newStatus = evt.to.dataset.status;
                        
                        // Update Supabase
                        const { error } = await db.from('project_tasks').update({ status: newStatus }).eq('id', taskId);
                        if (error) {
                            alert("Could not update task status.");
                            // Revert the move visually if there's an error
                             evt.from.appendChild(evt.item);
                        } else {
                            // Refresh counts after a successful update
                            await displayProjectTasks(currentProjectId);
                        }
                    },
                });
            });
        }

        async function handleNewProject() {
            const projectName = prompt("Enter the new project name:");
            if (projectName) {
                const { data, error } = await db.from('projects').insert([{ name: projectName }]).select();
                if (error) alert("Error creating project.");
                else {
                    currentProjectId = data[0].id; // Select the new project
                    await initializeProjectsView();
                }
            }
        }

        async function handleNewProjectTaskSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const newTask = Object.fromEntries(formData.entries());
            newTask.status = 'To Do'; // New tasks always start in 'To Do'

            const { error } = await db.from('project_tasks').insert([newTask]);
            if (error) alert("Error creating task: " + error.message);
            else {
                closeModal(document.getElementById('new-project-task-modal'));
                await displayProjectTasks(currentProjectId);
                form.reset();
            }
        }
        
        // --- Other view functions are here but unchanged ---
        function renderHourGrid() { /* Unchanged */ }
        async function displayEvents(date) { /* Unchanged */ }
        async function handleEventFormSubmit(e) { /* Unchanged */ }
        async function handleTaskFormSubmit(e) { /* Unchanged */ }
        async function initializeCalendarView() { /* Unchanged */ }
        function renderMonth(y,m,body,title,dates) { /* Unchanged */ }
        async function displayTodos() { /* Unchanged */ }
        function renderTask(task) { /* Unchanged */ }
        async function handleTodoActions(e) { /* Unchanged */ }
        async function handleEditTodoSubmit(e) { /* Unchanged */ }
        function handleDeleteTodo() { /* Unchanged */ }
        async function handleTodoToggle(e) { /* Unchanged */ }
        function initializeSettings() { /* Unchanged */ }
        function updateThemeButtons(active) { /* Unchanged */ }
        async function handleEventClick(e) { /* Unchanged */ }
        async function handleEditEventSubmit(e) { /* Unchanged */ }
        async function handleDeleteEvent() { /* Unchanged */ }

        // === INITIALIZATION & EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', () => {
            // Your other initializations (flatpickr, etc.)
            initializeKanban();

            // Navigation
            document.getElementById('today-link').addEventListener('click', () => showView('#schedule-view'));
            document.getElementById('calendar-link').addEventListener('click', () => showView('#calendar-view'));
            document.getElementById('todo-link').addEventListener('click', () => showView('#todo-view'));
            document.getElementById('projects-link').addEventListener('click', () => showView('#projects-view'));
            document.getElementById('profile-pic').addEventListener('click', () => showView('#settings-view'));
            
            // Project View Listeners
            document.getElementById('new-project-btn').addEventListener('click', handleNewProject);
            document.getElementById('project-selector').addEventListener('change', (e) => displayProjectTasks(e.target.value));
            document.getElementById('new-project-task-btn').addEventListener('click', () => {
                document.getElementById('new-task-project-id').value = currentProjectId;
                openModal(document.getElementById('new-project-task-modal'));
            });
            document.getElementById('new-project-task-form').addEventListener('submit', handleNewProjectTaskSubmit);

            // Other event listeners (forms, modals, etc.)
            document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', e => closeModal(e.target.closest('.fixed'))));
            document.querySelectorAll('#edit-event-modal, #edit-todo-modal, #new-project-task-modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m); }));

            showView('#schedule-view'); // Start on the schedule view
        });
    </script>
</body>
</html>
