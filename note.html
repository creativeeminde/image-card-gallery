<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Interactive Notes</title>
    <!-- Custom SVG Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='25' y='15' width='60' height='75' rx='12' fill='%23cbf5d3' /><rect x='15' y='25' width='60' height='75' rx='12' fill='%231d1d1f' /><circle cx='35' cy='45' r='5' fill='%23ffffff' /><line x1='35' y1='60' x2='60' y2='60' stroke='%23ffffff' stroke-width='6' stroke-linecap='round'/><line x1='35' y1='75' x2='50' y2='75' stroke='%23ffffff' stroke-width='6' stroke-linecap='round'/></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-color: #eef0f2;
            --card-bg: #ffffff;
            --text-main: #1d1d1f;
            --text-muted: #86868b;
            --shadow-soft: 0 8px 24px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.02);
            --shadow-hover: 0 16px 40px rgba(0,0,0,0.08);
            --shadow-drag: 0 30px 60px -15px rgba(0,0,0,0.15);
            --radius-lg: 20px;
            --radius-sm: 12px;
            --sticky-pink: #ffd6e4;
            --sticky-green: #cbf5d3;
            --sticky-yellow: #fdf2b3;
            --transition-smooth: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --transition-fast: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main);
            overflow-x: hidden; -webkit-font-smoothing: antialiased; user-select: none;
        }

        /* Nav & Controls */
        .top-nav {
            position: fixed; top: 24px; left: 24px; background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 100px;
            display: flex; align-items: center; padding: 8px 12px; gap: 16px; box-shadow: var(--shadow-soft);
            z-index: 100; border: 1px solid rgba(255,255,255,0.4);
        }
        .nav-icon { cursor: pointer; color: var(--text-muted); transition: var(--transition-smooth); display: flex; align-items: center; }
        .nav-icon:hover { color: var(--text-main); transform: scale(1.1); }

        .bottom-controls { position: fixed; bottom: 32px; right: 32px; display: flex; align-items: center; gap: 16px; z-index: 550; }
        .control-btn {
            width: 56px; height: 56px; border-radius: 50%; background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--shadow-soft); border: 1px solid rgba(255,255,255,0.4);
            color: var(--text-main); transition: var(--transition-smooth);
        }
        .control-btn:hover { transform: translateY(-4px) scale(1.05); box-shadow: var(--shadow-hover); }

        /* Masonry Grid */
        .grid-container {
            padding: 100px 40px 120px; max-width: 1600px; margin: 0 auto;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            grid-auto-rows: 20px; gap: 0 24px; opacity: 0; animation: fadeIn 0.8s ease-out forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Drag Placeholders */
        .card-wrapper {
            position: relative; cursor: grab; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; z-index: 1;
        }
        .card-wrapper:active { cursor: grabbing; }
        .card-wrapper:hover { transform: translateY(-6px); z-index: 10; }
        .card-wrapper:hover .card { box-shadow: var(--shadow-hover); }

        .drag-placeholder {
            background: rgba(0,0,0,0.03); border: 2px dashed rgba(0,0,0,0.08);
            border-radius: var(--radius-lg); margin-bottom: 24px;
            transition: transform 0.2s; pointer-events: none;
        }

        .card {
            background: transparent; border-radius: var(--radius-lg); box-shadow: var(--shadow-soft);
            display: flex; flex-direction: column; width: 100%; margin-bottom: 24px;
            transition: var(--transition-smooth); pointer-events: none; border: none; position: relative;
        }
        
        .card-inner {
            background: var(--card-bg); border-radius: var(--radius-lg); overflow: hidden; 
            height: 100%; display: flex; flex-direction: column; position: relative; z-index: 1;
        }

        /* Card Actions (Delete & Pin) */
        .card-actions {
            position: absolute; top: 12px; right: 12px;
            display: flex; gap: 8px; z-index: 20;
        }
        .action-btn {
            background: rgba(255,255,255,0.95); border-radius: 50%;
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: var(--transition-fast); border: none; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); pointer-events: auto;
        }
        .card-wrapper:hover .action-btn { opacity: 1; }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.delete-btn { color: #ff3b30; }
        .action-btn.pin-btn { color: var(--text-muted); }
        .action-btn.pin-btn.is-pinned {
            opacity: 1; background: var(--text-main); color: white;
        }

        /* Card Types & Mini Document Preview */
        .card-text .card-inner { 
            padding: 32px 28px; 
            min-height: 240px; 
            max-height: 480px;
        }
        
        .card-breadcrumb {
            display: flex; align-items: center; gap: 6px;
            font-size: 11px; font-weight: 600; color: var(--text-muted);
            margin-bottom: 16px; 
        }

        .preview-title { 
            font-size: 18px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.02em; color: var(--text-main);
            line-height: 1.2;
        }
        
        .preview-content { font-size: 11px; line-height: 1.6; color: #555; overflow: hidden; }
        .preview-content h1 { font-size: 14px; font-weight: 600; margin: 12px 0 6px; color: var(--text-main); letter-spacing: -0.02em; }
        .preview-content h2 { font-size: 12px; font-weight: 600; margin: 10px 0 4px; color: var(--text-main); }
        .preview-content h3 { font-size: 11px; font-weight: 600; margin: 8px 0 4px; color: var(--text-main); }
        .preview-content p { margin-bottom: 8px; }
        .preview-content ul, .preview-content ol { margin-bottom: 8px; padding-left: 16px; }
        .preview-content li { margin-bottom: 4px; }
        .preview-content input[type="checkbox"] { width: 10px; height: 10px; margin-top: 2px; margin-right: 6px; accent-color: var(--text-muted); pointer-events: none; vertical-align: middle; }
        .preview-content img { max-width: 100%; border-radius: 6px; margin: 8px 0; opacity: 0.8; }
        .preview-content hr { border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 12px 0; }
        .preview-content blockquote { border-left: 2px solid #ccc; padding-left: 8px; margin: 8px 0; font-style: italic; }
        
        .card-image .card-inner img { width: 100%; height: auto; display: block; border-radius: var(--radius-lg); pointer-events: none; }
        
        .card-sticky .card-inner { padding: 24px; max-width: 85%; }
        .card-sticky .card-inner p { font-size: 13px; font-weight: 500; line-height: 1.5; color: rgba(0,0,0,0.85); }

        /* Project Card Stacked Design */
        .card.card-project { 
            padding: 0; background: transparent; cursor: pointer; pointer-events: auto;
            border: none; box-shadow: none; overflow: visible; min-height: 380px; position: relative;
            width: calc(100% - 24px); 
        }

        .project-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: var(--radius-lg); transition: var(--transition-smooth); pointer-events: none;
        }
        .layer-back { background: #ffffff; z-index: 1; transform: translate(24px, 0) scaleY(0.82); box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.04); }
        .layer-mid { background: var(--sticky-green); z-index: 2; transform: translate(12px, 0) scaleY(0.91); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        .project-front {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; border-radius: var(--radius-lg); z-index: 3;
            padding: 24px 24px 32px 24px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 8px 30px rgba(0,0,0,0.06); border: 1px solid rgba(255,255,255,0.7);
            transition: var(--transition-smooth);
        }

        .tag-open { 
            align-self: flex-start; display: inline-flex; align-items: center; gap: 6px; 
            background: rgba(0,0,0,0.04); padding: 8px 14px; border-radius: 100px; 
            font-size: 11px; font-weight: 600; letter-spacing: 0.05em; color: var(--text-muted); 
        }

        .project-text { margin-top: auto; }
        .project-text h2 { font-size: 22px; font-weight: 600; letter-spacing: -0.02em; color: var(--text-main); margin-bottom: 8px; }
        .project-text h3 { font-size: 12px; color: var(--text-muted); font-weight: 500; }

        /* Hover Effects */
        .card-wrapper:hover .card-project .layer-back { transform: translate(32px, 0) scaleY(0.85); }
        .card-wrapper:hover .card-project .layer-mid { transform: translate(16px, 0) scaleY(0.94); }
        .card-wrapper:hover .card-project .project-front { transform: translateY(-4px); box-shadow: var(--shadow-hover); }

        /* Drag & Drop Visuals */
        .card-wrapper.is-dragging { opacity: 0; pointer-events: none; }
        
        .drag-clone {
            position: fixed; pointer-events: none !important; z-index: 9999; margin: 0 !important; left: 0; top: 0;
        }
        .drag-clone .card { box-shadow: var(--shadow-drag); }
        .drag-clone .action-btn { display: none; }

        /* Drop Targets */
        .card-project.drop-target .project-front { transform: scale(1.04); box-shadow: 0 0 0 4px rgba(100, 150, 255, 0.3), var(--shadow-hover); background: #eef2f7; }
        .card-project.drop-target .layer-mid { transform: translate(24px, 0) scaleY(0.91); }
        .card-project.drop-target .layer-back { transform: translate(40px, 0) scaleY(0.82); }

        .card-wrapper.drop-target .card-inner {
            box-shadow: 0 0 0 4px rgba(100, 150, 255, 0.3), var(--shadow-hover);
            transform: scale(1.02); transition: var(--transition-smooth);
        }
        
        /* Universal Attached Stickies */
        .attached-sticky {
            position: absolute;
            padding: 12px 16px; border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.02);
            width: 130px; min-height: 130px;
            font-size: 13px; font-weight: 500; color: rgba(0,0,0,0.85);
            cursor: grab; pointer-events: auto; z-index: 5;
            transition: box-shadow 0.2s, transform 0.2s;
            display: flex; flex-direction: column;
        }
        .attached-sticky:active { cursor: grabbing; }
        .attached-sticky:hover { box-shadow: 0 16px 40px rgba(0,0,0,0.15); z-index: 20; transform: translate(-50%, -50%) scale(1.05) !important; }
        
        .attached-sticky-content { outline: none; min-height: 20px; flex-grow: 1; cursor: text; line-height: 1.5; }
        .attached-sticky .action-btn.delete-btn { display: none; top: -10px; right: -10px; position: absolute; }
        .attached-sticky:hover .action-btn.delete-btn { display: flex; opacity: 1; }

        /* Project View Fullscreen */
        .project-view-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color);
            z-index: 500; opacity: 0; pointer-events: none; transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: scale(0.95); display: flex; flex-direction: column; overflow-y: auto;
        }
        .project-view-overlay.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        
        .project-header {
            padding: 40px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; background: rgba(238, 240, 242, 0.85); backdrop-filter: blur(20px); z-index: 10;
        }
        .project-header-left { display: flex; align-items: center; gap: 24px; }
        
        .btn-back, .btn-action {
            display: flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 100px;
            font-family: 'Inter'; font-weight: 600; font-size: 14px; cursor: pointer; border: none;
            box-shadow: var(--shadow-soft); transition: var(--transition-smooth);
        }
        .btn-back { background: white; color: var(--text-main); }
        .btn-action { background: #1d1d1f; color: white; }
        .btn-back:hover { transform: translateX(-4px); box-shadow: var(--shadow-hover); }
        .btn-action:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        
        .project-title-display { font-size: 32px; font-weight: 700; letter-spacing: -0.03em; }
        
        .drop-out-zone {
            padding: 16px 32px; background: rgba(255, 59, 48, 0.05); border: 2px dashed rgba(255, 59, 48, 0.3);
            border-radius: 100px; color: #ff3b30; font-size: 14px; font-weight: 600; transition: var(--transition-smooth);
            opacity: 0; pointer-events: none;
        }
        .drop-out-zone.visible { opacity: 1; pointer-events: auto; }
        .drop-out-zone.active-target { background: rgba(255, 59, 48, 0.15); border-color: #ff3b30; transform: scale(1.05); }

        /* Rich Text Editor Fullscreen View */
        .note-view-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(242, 243, 245, 0.95); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 600; opacity: 0; pointer-events: none; 
            transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: scale(0.97); display: flex; flex-direction: column;
        }
        .note-view-overlay.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        
        .note-view-header {
            padding: 24px 40px; position: sticky; top: 0; z-index: 30;
            display: flex; align-items: center; justify-content: space-between;
        }

        .save-status {
            font-size: 12px; font-weight: 600; color: var(--text-muted); opacity: 0; transition: opacity 0.3s ease;
            background: rgba(0,0,0,0.05); padding: 4px 12px; border-radius: 100px;
        }

        /* Floating Toolbar */
        .editor-toolbar {
            position: sticky; top: 20px; z-index: 20; display: flex; gap: 4px; padding: 8px; margin: 0 auto 20px;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-radius: 16px; box-shadow: var(--shadow-soft); 
            border: 1px solid rgba(255,255,255,0.4); max-width: fit-content; flex-wrap: wrap; justify-content: center;
            opacity: 0; transform: translateY(-10px); transition: var(--transition-smooth); pointer-events: none;
        }
        .editor-toolbar.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .toolbar-group { display: flex; align-items: center; gap: 2px; }
        .toolbar-divider { width: 1px; height: 20px; background: rgba(0,0,0,0.1); margin: 0 6px; }
        
        .toolbar-btn {
            background: transparent; border: none; padding: 8px; border-radius: 8px; cursor: pointer; color: var(--text-main); 
            display: flex; align-items: center; justify-content: center; transition: var(--transition-fast); position: relative;
        }
        .toolbar-btn:hover { background: rgba(0,0,0,0.06); }
        .toolbar-btn:active { transform: scale(0.95); }

        .color-picker-wrapper { position: relative; display: flex; align-items: center; }
        .color-picker-input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* Editor Content Area */
        .note-view-content { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 0 40px 80px; width: 100%; overflow-y: auto; }
        .editor-container { max-width: 760px; width: 100%; margin: 0 auto; background: transparent; border: none; box-shadow: none; cursor: text; }
        
        .editor-title {
            font-size: 40px; font-weight: 700; margin-bottom: 24px; letter-spacing: -0.03em;
            outline: none; border: none; color: var(--text-main); border-bottom: 1px solid transparent; transition: border-color 0.2s;
        }
        .editor-title:empty:before { content: 'Note Title'; color: var(--text-muted); pointer-events: none; }
        
        .editor-body { font-size: 16px; line-height: 1.8; color: #333336; outline: none; min-height: 50vh; padding-bottom: 100px; }
        .editor-body:empty:before { content: 'Start typing here...'; color: var(--text-muted); pointer-events: none; }

        .editor-body h1 { font-size: 32px; font-weight: 700; margin: 32px 0 16px; letter-spacing: -0.02em; }
        .editor-body h2 { font-size: 24px; font-weight: 600; margin: 24px 0 12px; }
        .editor-body h3 { font-size: 20px; font-weight: 600; margin: 20px 0 10px; }
        .editor-body p { margin-bottom: 16px; }
        .editor-body ul, .editor-body ol { margin-bottom: 16px; padding-left: 24px; }
        .editor-body li { margin-bottom: 8px; }
        .editor-body blockquote { border-left: 4px solid var(--text-muted); padding-left: 16px; margin: 16px 0; font-style: italic; color: #555; background: rgba(0,0,0,0.02); padding: 12px 16px; border-radius: 0 8px 8px 0; }
        .editor-body pre { background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 12px; overflow-x: auto; margin-bottom: 16px; font-family: monospace; }
        .editor-body img { max-width: 100%; border-radius: 12px; margin: 16px 0; box-shadow: var(--shadow-soft); }
        .editor-body a { color: #0066cc; text-decoration: underline; text-underline-offset: 2px; }
        .editor-body hr { border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 32px 0; }
        .editor-body input[type="checkbox"] { width: 16px; height: 16px; margin-right: 8px; accent-color: var(--text-main); cursor: pointer; }

        .non-text-wrapper { background: white; padding: 40px; border-radius: 24px; box-shadow: var(--shadow-hover); max-width: 600px; width: 100%; margin: 40px auto; }
        .non-text-wrapper.sticky-wrapper { max-width: 500px; padding: 60px; font-size: 20px; font-weight: 500; line-height: 1.6; border: none; }

        /* Rename Overlay */
        .rename-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 3000; display: none; background: transparent; }
        .rename-input-container {
            position: absolute; background: #1c1c1e; border-radius: 100px; box-shadow: 0 16px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
            padding: 14px 24px; display: flex; align-items: center; transform: scale(0.9) translateY(10px); opacity: 0; transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1); width: 280px;
        }
        .rename-input-container.active { transform: scale(1) translateY(0); opacity: 1; }
        .rename-input { background: transparent; border: none; outline: none; color: #ffffff; font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 500; width: 100%; letter-spacing: -0.01em; }
        .rename-input::placeholder { color: rgba(255,255,255,0.4); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(242, 243, 245, 0.8); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 40px; border-radius: 30px; width: 100%; max-width: 480px; box-shadow: 0 40px 80px rgba(0,0,0,0.1); transform: scale(0.95) translateY(20px); transition: var(--transition-smooth); }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 22px; font-weight: 600; }
        .close-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-control { width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid #e0e0e0; font-family: 'Inter', sans-serif; font-size: 15px; outline: none; transition: border-color 0.2s; background: #fafafa; }
        .form-control:focus { border-color: #a0a0a0; background: white; }
        textarea.form-control { resize: vertical; min-height: 100px; }
        .btn-submit { width: 100%; padding: 16px; background: #1d1d1f; color: white; border: none; border-radius: 14px; font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.2s, background 0.2s; margin-top: 10px; }
        .btn-submit:hover { background: #333336; transform: translateY(-2px); }
        .dynamic-field { display: none; }
        .dynamic-field.active { display: block; }
        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #1d1d1f; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1500; display: none; }
        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="nav-icon"><i data-lucide="menu" size="20"></i></div>
        <div class="nav-icon"><i data-lucide="hash" size="18"></i></div>
        <div class="nav-icon"><i data-lucide="check" size="20"></i></div>
    </nav>

    <div class="loader" id="loader"></div>

    <!-- Main Grid -->
    <main class="grid-container" id="mainGrid"></main>

    <!-- Project View Overlay -->
    <div class="project-view-overlay" id="projectView">
        <div class="project-header">
            <div class="project-header-left">
                <button class="btn-back" id="btnBackToMain"><i data-lucide="arrow-left" size="18"></i> Back</button>
                <h2 class="project-title-display" id="projectTitleDisplay">Project Name</h2>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="drop-out-zone" id="dropOutZone"><i data-lucide="log-out" size="14"></i> Drag to remove</div>
                <button class="btn-action" id="btnProjectAddNote"><i data-lucide="plus" size="16"></i> Add Note</button>
            </div>
        </div>
        <div class="grid-container" id="projectGrid"></div>
    </div>

    <!-- Note View Overlay (Rich Text Editor) -->
    <div class="note-view-overlay" id="noteView">
        <div class="note-view-header">
            <button class="btn-back" id="btnBackFromNote"><i data-lucide="arrow-left" size="18"></i> Back</button>
            <div class="save-status" id="saveStatus">Saved</div>
        </div>

        <div class="editor-toolbar" id="editorToolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" title="Bold" onmousedown="event.preventDefault(); formatDoc('bold')"><i data-lucide="bold" size="16"></i></button>
                <button class="toolbar-btn" title="Italic" onmousedown="event.preventDefault(); formatDoc('italic')"><i data-lucide="italic" size="16"></i></button>
                <button class="toolbar-btn" title="Underline" onmousedown="event.preventDefault(); formatDoc('underline')"><i data-lucide="underline" size="16"></i></button>
                <button class="toolbar-btn" title="Strikethrough" onmousedown="event.preventDefault(); formatDoc('strikeThrough')"><i data-lucide="strikethrough" size="16"></i></button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
                <div class="color-picker-wrapper" title="Highlight Color">
                    <button class="toolbar-btn"><i data-lucide="highlighter" size="16"></i></button>
                    <input type="color" class="color-picker-input" onchange="formatDoc('hiliteColor', this.value)" value="#fef08a">
                </div>
                <div class="color-picker-wrapper" title="Text Color">
                    <button class="toolbar-btn"><i data-lucide="palette" size="16"></i></button>
                    <input type="color" class="color-picker-input" onchange="formatDoc('foreColor', this.value)" value="#ef4444">
                </div>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
                <button class="toolbar-btn" title="Heading 1" onmousedown="event.preventDefault(); formatDoc('formatBlock', 'H1')"><i data-lucide="heading-1" size="16"></i></button>
                <button class="toolbar-btn" title="Heading 2" onmousedown="event.preventDefault(); formatDoc('formatBlock', 'H2')"><i data-lucide="heading-2" size="16"></i></button>
                <button class="toolbar-btn" title="Quote" onmousedown="event.preventDefault(); formatDoc('formatBlock', 'BLOCKQUOTE')"><i data-lucide="quote" size="16"></i></button>
                <button class="toolbar-btn" title="Code Block" onmousedown="event.preventDefault(); formatDoc('formatBlock', 'PRE')"><i data-lucide="code" size="16"></i></button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
                <button class="toolbar-btn" title="Bullet List" onmousedown="event.preventDefault(); formatDoc('insertUnorderedList')"><i data-lucide="list" size="16"></i></button>
                <button class="toolbar-btn" title="Numbered List" onmousedown="event.preventDefault(); formatDoc('insertOrderedList')"><i data-lucide="list-ordered" size="16"></i></button>
                <button class="toolbar-btn" title="Checklist" onmousedown="event.preventDefault(); insertChecklist()"><i data-lucide="list-todo" size="16"></i></button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
                <button class="toolbar-btn" title="Align Left" onmousedown="event.preventDefault(); formatDoc('justifyLeft')"><i data-lucide="align-left" size="16"></i></button>
                <button class="toolbar-btn" title="Align Center" onmousedown="event.preventDefault(); formatDoc('justifyCenter')"><i data-lucide="align-center" size="16"></i></button>
                <button class="toolbar-btn" title="Align Right" onmousedown="event.preventDefault(); formatDoc('justifyRight')"><i data-lucide="align-right" size="16"></i></button>
            </div>
            <div class="toolbar-divider"></div>
            <div class="toolbar-group">
                <button class="toolbar-btn" title="Link" onmousedown="event.preventDefault(); insertLink()"><i data-lucide="link" size="16"></i></button>
                <button class="toolbar-btn" title="Image" onmousedown="event.preventDefault(); insertImagePrompt()"><i data-lucide="image" size="16"></i></button>
                <button class="toolbar-btn" title="Divider" onmousedown="event.preventDefault(); formatDoc('insertHorizontalRule')"><i data-lucide="minus" size="16"></i></button>
            </div>
        </div>

        <div class="note-view-content" id="noteViewContent"></div>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-controls">
        <div class="control-btn" id="btnSettings"><i data-lucide="home" size="24"></i></div>
        <div class="control-btn" id="btnAddNote" style="background: #1d1d1f; color: white;"><i data-lucide="plus" size="26"></i></div>
    </div>

    <!-- Right Click Rename Overlay -->
    <div id="renameOverlay" class="rename-overlay">
        <div id="renameContainer" class="rename-input-container">
            <input type="text" id="renameInput" class="rename-input" placeholder="Untitled" autocomplete="off">
        </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Note</h2>
                <button class="close-btn" id="btnCloseModal"><i data-lucide="x" size="24"></i></button>
            </div>
            <form id="noteForm">
                <div class="form-group">
                    <label>Card Type</label>
                    <select class="form-control" id="noteType">
                        <option value="text">Text Note</option>
                        <option value="image">Image Note</option>
                        <option value="sticky">Sticky Note</option>
                        <option value="project">Project Card</option>
                    </select>
                </div>
                <div class="form-group dynamic-field active" id="fieldTitle">
                    <label>Title</label>
                    <input type="text" class="form-control" id="inputTitle" placeholder="e.g. Design Philosophy">
                </div>
                <div class="form-group dynamic-field active" id="fieldContent">
                    <label>Content</label>
                    <textarea class="form-control" id="inputContent" placeholder="Write your thoughts..."></textarea>
                </div>
                <div class="form-group dynamic-field" id="fieldSubtitle">
                    <label>Client Name (Subtitle)</label>
                    <input type="text" class="form-control" id="inputSubtitle" placeholder="e.g. Client 004">
                </div>
                <div class="form-group dynamic-field" id="fieldImage">
                    <label>Image URL</label>
                    <input type="url" class="form-control" id="inputImage" placeholder="https://...">
                </div>
                <div class="form-group dynamic-field" id="fieldColor">
                    <label>Sticky Color</label>
                    <select class="form-control" id="inputColor">
                        <option value="var(--sticky-pink)">Pink</option>
                        <option value="var(--sticky-green)">Green</option>
                        <option value="var(--sticky-yellow)">Yellow</option>
                    </select>
                </div>
                <button type="submit" class="btn-submit">Save Note</button>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Supabase Init
        const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allNotes = [];
        let currentOpenProjectId = null;

        const mainGrid = document.getElementById('mainGrid');
        const projectView = document.getElementById('projectView');
        const projectGrid = document.getElementById('projectGrid');
        const noteView = document.getElementById('noteView');
        const noteViewContent = document.getElementById('noteViewContent');
        const loader = document.getElementById('loader');
        const addModal = document.getElementById('addModal');
        const dropOutZone = document.getElementById('dropOutZone');
        
        const renameOverlay = document.getElementById('renameOverlay');
        const renameContainer = document.getElementById('renameContainer');
        const renameInput = document.getElementById('renameInput');

        const noteType = document.getElementById('noteType');
        const fields = {
            title: document.getElementById('fieldTitle'),
            content: document.getElementById('fieldContent'),
            subtitle: document.getElementById('fieldSubtitle'),
            image: document.getElementById('fieldImage'),
            color: document.getElementById('fieldColor')
        };

        noteType.addEventListener('change', (e) => {
            Object.values(fields).forEach(f => f.classList.remove('active'));
            const t = e.target.value;
            if(t === 'text') { fields.title.classList.add('active'); fields.content.classList.add('active'); }
            else if(t === 'image') { fields.image.classList.add('active'); }
            else if(t === 'sticky') { fields.content.classList.add('active'); fields.color.classList.add('active'); }
            else if(t === 'project') { fields.title.classList.add('active'); fields.subtitle.classList.add('active'); }
        });

        document.getElementById('btnAddNote').addEventListener('click', () => addModal.classList.add('active'));
        document.getElementById('btnProjectAddNote').addEventListener('click', () => addModal.classList.add('active'));
        document.getElementById('btnCloseModal').addEventListener('click', () => { addModal.classList.remove('active'); document.getElementById('noteForm').reset(); noteType.dispatchEvent(new Event('change')); });

        function resizeGridItem(item, gridEl) {
            if (item.classList.contains('drag-placeholder')) return; // Ignore height measurement for placeholders
            const rowHeight = parseInt(window.getComputedStyle(gridEl).getPropertyValue('grid-auto-rows'));
            const rowGap = parseInt(window.getComputedStyle(gridEl).getPropertyValue('grid-row-gap'));
            const card = item.querySelector('.card');
            if(!card) return;
            
            const img = card.querySelector('img');
            if (img && !img.complete) { img.onload = () => resizeGridItem(item, gridEl); return; }

            const rowSpan = Math.ceil((card.getBoundingClientRect().height + rowGap) / (rowHeight + rowGap));
            item.style.gridRowEnd = "span " + rowSpan;
        }

        function resizeAllGridItems() {
            const grids = [mainGrid, projectGrid];
            grids.forEach(grid => {
                const items = grid.getElementsByClassName("card-wrapper");
                for(let i=0; i<items.length; i++) resizeGridItem(items[i], grid);
            });
        }
        window.addEventListener("resize", resizeAllGridItems);

        async function fetchNotes() {
            loader.style.display = 'block';
            try {
                // Fetch including the is_pinned attribute
                const { data, error } = await supabaseClient
                    .from('interactive_notes')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                allNotes = data;
                renderViews();
            } catch (error) { console.error('Error:', error); } 
            finally { loader.style.display = 'none'; }
        }

        function renderViews() {
            // Main Grid Filtering and Sorting (Pinned items first)
            const mainNotes = allNotes.filter(n => !n.project_id);
            mainNotes.sort((a, b) => {
                if (a.is_pinned && !b.is_pinned) return -1;
                if (!a.is_pinned && b.is_pinned) return 1;
                return (a.sort_order || 0) - (b.sort_order || 0);
            });
            renderGrid(mainNotes, mainGrid);

            // Project Grid Filtering and Sorting (Pinned items first)
            if(currentOpenProjectId) {
                const projNotes = allNotes.filter(n => n.project_id === currentOpenProjectId);
                projNotes.sort((a, b) => {
                    if (a.is_pinned && !b.is_pinned) return -1;
                    if (!a.is_pinned && b.is_pinned) return 1;
                    return (a.sort_order || 0) - (b.sort_order || 0);
                });
                renderGrid(projNotes, projectGrid);
            }
        }

        function renderGrid(notes, container) {
            container.innerHTML = '';
            notes.forEach(note => {
                const wrapper = document.createElement('div');
                wrapper.className = 'card-wrapper';
                wrapper.dataset.id = note.id;
                wrapper.dataset.type = note.type;
                wrapper.dataset.projectId = note.project_id || '';
                
                let cardHTML = ''; let extraStyles = '';
                
                let displayContent = note.content || '';
                if (displayContent && !displayContent.includes('<') && !displayContent.includes('>')) {
                    displayContent = displayContent.replace(/\n/g, '<br>');
                }

                // Gather stickies attached specifically to this card
                const attachedStickies = allNotes.filter(n => n.project_id === note.id && n.type === 'sticky');
                let stickiesHTML = '';
                attachedStickies.forEach(st => {
                    const [pctX, pctY] = (st.subtitle || '50,50').split(',');
                    const x = parseFloat(pctX) || 50;
                    const y = parseFloat(pctY) || 50;
                    stickiesHTML += `
                        <div class="attached-sticky" data-id="${st.id}" data-type="attached-sticky" 
                             style="background-color: ${st.color || 'var(--sticky-yellow)'}; left: ${x}%; top: ${y}%; transform: translate(-50%, -50%);">
                            <div class="attached-sticky-content" contenteditable="true" onblur="updateStickyContent('${st.id}', this.innerHTML)" onpointerdown="event.stopPropagation()">${(st.content || '').replace(/\n/g, '<br>')}</div>
                            <button class="action-btn delete-btn" title="Detach sticky" onclick="detachSticky('${st.id}', event)"><i data-lucide="x" size="12"></i></button>
                        </div>
                    `;
                });

                switch(note.type) {
                    case 'text': 
                        let breadcrumb = 'Untitled';
                        if (note.project_id) {
                            const parentProj = allNotes.find(n => n.id === note.project_id);
                            if (parentProj && parentProj.title) breadcrumb = parentProj.title;
                        }
                        cardHTML = `
                            <div class="card card-text">
                                <div class="card-inner">
                                    <div class="card-breadcrumb"><i data-lucide="arrow-right" size="12"></i> ${breadcrumb}</div>
                                    ${note.title ? `<h3 class="preview-title">${note.title}</h3>` : ''}
                                    ${displayContent ? `<div class="preview-content">${displayContent}</div>` : ''}
                                </div>
                                ${stickiesHTML}
                            </div>`; 
                        break;
                    case 'image': 
                        cardHTML = `
                            <div class="card card-image">
                                <div class="card-inner">
                                    ${note.title ? `<div style="padding: 20px 24px 8px;"><h3 style="font-size: 16px; font-weight: 600; letter-spacing: -0.01em;">${note.title}</h3></div>` : ''}
                                    <img src="${note.image_url}" onerror="this.src='https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=500&q=80'">
                                </div>
                                ${stickiesHTML}
                            </div>`; 
                        break;
                    case 'sticky': 
                        extraStyles = `background-color: ${note.color || 'var(--sticky-yellow)'}; border: none;`; 
                        cardHTML = `
                            <div class="card card-sticky" style="${extraStyles}">
                                <div class="card-inner" style="background: transparent;">
                                    ${note.title ? `<h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; opacity: 0.8; letter-spacing: -0.01em;">${note.title}</h3>` : ''}
                                    <p>${displayContent}</p>
                                </div>
                            </div>`; 
                        break;
                    case 'project': 
                        const subtitleText = note.subtitle || (note.created_at ? `Created on ${new Date(note.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}` : 'Created recently');
                        cardHTML = `
                            <div class="card card-project">
                                <div class="project-layer layer-back"></div>
                                <div class="project-layer layer-mid"></div>
                                <div class="project-front">
                                    <div class="tag-open"><i data-lucide="arrow-up-right" size="12"></i> OPEN</div>
                                    <div class="project-text">
                                        <h2>${note.title || 'Untitled'}</h2>
                                        <h3>${subtitleText}</h3>
                                    </div>
                                </div>
                            </div>`; 
                        break;
                }

                wrapper.innerHTML = `
                    <div class="card-actions">
                        <button class="action-btn pin-btn ${note.is_pinned ? 'is-pinned' : ''}" onclick="togglePin('${note.id}', event)" title="${note.is_pinned ? 'Unpin' : 'Pin to top'}">
                            <i data-lucide="pin" size="14"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteNote('${note.id}', event)" title="Delete Note">
                            <i data-lucide="trash-2" size="14"></i>
                        </button>
                    </div>
                    ${cardHTML}
                `;
                
                wrapper.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    openRenameInput(note.id, note.title, e.clientX, e.clientY);
                });

                // Attach drag to all cards (including projects)
                wrapper.addEventListener('pointerdown', handleDragStart);
                
                container.appendChild(wrapper);

                // Add drag listener to stickies attached to this card
                if (note.type === 'image' || note.type === 'text') {
                    wrapper.querySelectorAll('.attached-sticky').forEach(st => {
                        st.addEventListener('pointerdown', handleDragStart);
                    });
                }
            });
            lucide.createIcons();
            setTimeout(resizeAllGridItems, 50);
        }

        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = noteType.value;
            const noteData = { type, project_id: currentOpenProjectId };
            
            if(type === 'text') { noteData.title = document.getElementById('inputTitle').value; noteData.content = document.getElementById('inputContent').value; }
            else if(type === 'image') { noteData.image_url = document.getElementById('inputImage').value; }
            else if(type === 'sticky') { noteData.content = document.getElementById('inputContent').value; noteData.color = document.getElementById('inputColor').value; }
            else if(type === 'project') { noteData.title = document.getElementById('inputTitle').value; noteData.subtitle = document.getElementById('inputSubtitle').value; noteData.project_id = null; }

            document.getElementById('btnCloseModal').click();
            loader.style.display = 'block';
            try {
                await supabaseClient.from('interactive_notes').insert([noteData]);
                fetchNotes();
            } catch (err) { console.error(err); }
        });

        window.togglePin = async (id, event) => {
            event.stopPropagation();
            const note = allNotes.find(n => n.id === id);
            if (!note) return;

            note.is_pinned = !note.is_pinned;
            renderViews(); // Optimistic UI update
            
            try {
                await supabaseClient.from('interactive_notes').update({ is_pinned: note.is_pinned }).eq('id', id);
            } catch (err) {
                console.error("Failed to update pin state:", err);
                note.is_pinned = !note.is_pinned; // Revert on fail
                renderViews();
            }
        };

        window.deleteNote = async (id, event) => {
            event.stopPropagation();
            if(!confirm('Delete this note?')) return;
            const card = event.target.closest('.card-wrapper');
            if (card) {
                card.style.opacity = '0'; card.style.transform = 'scale(0.8)';
                setTimeout(() => card.remove(), 300);
            }
            try {
                await supabaseClient.from('interactive_notes').delete().eq('id', id);
                setTimeout(resizeAllGridItems, 350);
            } catch (err) { fetchNotes(); }
        };

        window.detachSticky = async (id, event) => {
            event.stopPropagation();
            const stickyEl = event.target.closest('.attached-sticky');
            if (stickyEl) {
                stickyEl.style.transition = 'all 0.2s ease-out';
                stickyEl.style.transform = 'translate(-50%, -50%) scale(0.5)';
                stickyEl.style.opacity = '0';
            }
            setTimeout(() => {
                updateNoteProject(id, currentOpenProjectId, { subtitle: null });
            }, 200);
        };

        let renamingNoteId = null;

        function openRenameInput(noteId, currentTitle, x, y) {
            renamingNoteId = noteId;
            renameInput.value = currentTitle || '';
            renameOverlay.style.display = 'block';

            let leftPos = x; let topPos = y - 25;
            if (leftPos + 300 > window.innerWidth) leftPos = window.innerWidth - 300;
            if (topPos < 10) topPos = 10;

            renameContainer.style.left = `${leftPos}px`;
            renameContainer.style.top = `${topPos}px`;

            setTimeout(() => {
                renameContainer.classList.add('active');
                renameInput.focus();
                renameInput.select();
            }, 10);
        }

        function closeRename(save = true) {
            if (!renamingNoteId) return;
            renameContainer.classList.remove('active');
            
            setTimeout(async () => {
                renameOverlay.style.display = 'none';
                if (save) {
                    const newTitle = renameInput.value.trim();
                    const note = allNotes.find(n => n.id === renamingNoteId);
                    
                    if (note && note.title !== newTitle) {
                        note.title = newTitle;
                        renderViews(); 
                        try {
                            await supabaseClient.from('interactive_notes').update({ title: newTitle }).eq('id', renamingNoteId);
                        } catch (err) { fetchNotes(); }
                    }
                }
                renamingNoteId = null;
            }, 200);
        }

        renameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') closeRename(true);
            if (e.key === 'Escape') closeRename(false);
        });
        renameOverlay.addEventListener('mousedown', (e) => { if (e.target === renameOverlay) closeRename(true); });

        // --- Master Flawless Reordering System ---
        let dragInfo = {
            isActive: false, el: null, clone: null, placeholder: null, id: null, 
            startX: 0, startY: 0, offsetX: 0, offsetY: 0, targetProject: null, isOutZone: false, isReordered: false
        };

        function handleDragStart(e) {
            if(e.button !== 0 || e.target.closest('button') || e.target.closest('input')) return; 
            if(e.target.closest('[contenteditable="true"]')) return; 
            
            const wrapper = e.currentTarget;
            dragInfo.id = wrapper.dataset.id;
            dragInfo.el = wrapper;
            dragInfo.startX = e.clientX;
            dragInfo.startY = e.clientY;
            dragInfo.isReordered = false;
            
            const rect = wrapper.getBoundingClientRect();
            dragInfo.offsetX = e.clientX - rect.left;
            dragInfo.offsetY = e.clientY - rect.top;

            // Prepare ghost placeholder exactly matching the element's height in masonry
            dragInfo.placeholder = document.createElement('div');
            dragInfo.placeholder.className = 'card-wrapper drag-placeholder';
            dragInfo.placeholder.style.width = rect.width + 'px';
            dragInfo.placeholder.style.height = rect.height + 'px';
            dragInfo.placeholder.style.gridRowEnd = wrapper.style.gridRowEnd;

            document.addEventListener('pointermove', handleDragMove);
            document.addEventListener('pointerup', handleDragEnd);
        }

        function handleDragMove(e) {
            const dx = Math.abs(e.clientX - dragInfo.startX);
            const dy = Math.abs(e.clientY - dragInfo.startY);

            if (!dragInfo.isActive && (dx > 5 || dy > 5)) {
                dragInfo.isActive = true;
                
                // Swap original element with placeholder
                dragInfo.el.parentNode.insertBefore(dragInfo.placeholder, dragInfo.el);
                dragInfo.el.style.display = 'none';

                // Create free-floating visual clone
                const rect = dragInfo.placeholder.getBoundingClientRect();
                dragInfo.clone = dragInfo.el.cloneNode(true);
                dragInfo.clone.className = 'card-wrapper drag-clone';
                dragInfo.clone.style.width = rect.width + 'px';
                dragInfo.clone.style.height = rect.height + 'px';
                dragInfo.clone.style.display = '';
                
                const innerCard = dragInfo.clone.querySelector('.card');
                if (innerCard) {
                    innerCard.style.transformOrigin = `${dragInfo.offsetX}px ${dragInfo.offsetY}px`;
                    innerCard.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.3s ease';
                }

                document.body.appendChild(dragInfo.clone);
                dragInfo.clone.offsetHeight; // Reflow
                if (innerCard) innerCard.style.transform = 'scale(1.04) rotate(1deg)';
                if(currentOpenProjectId) dropOutZone.classList.add('visible');
            }

            if (dragInfo.isActive) {
                const left = e.clientX - dragInfo.offsetX;
                const top = e.clientY - dragInfo.offsetY;
                dragInfo.clone.style.transform = `translate(${left}px, ${top}px)`;

                const els = document.elementsFromPoint(e.clientX, e.clientY);
                
                const hoveredProject = els.find(el => el.classList && el.classList.contains('card-wrapper') && el.dataset.type === 'project' && el !== dragInfo.el && el !== dragInfo.clone);
                
                const isSticky = dragInfo.el.dataset.type === 'sticky' || dragInfo.el.dataset.type === 'attached-sticky';
                const hoveredCardForSticky = isSticky ? els.find(el => el.classList && el.classList.contains('card-wrapper') && el.dataset.type !== 'project' && el.dataset.type !== 'sticky' && el.dataset.type !== 'attached-sticky' && el !== dragInfo.el && el !== dragInfo.clone) : null;

                let targetDrop = hoveredProject || hoveredCardForSticky;

                if (dragInfo.targetProject && dragInfo.targetProject !== targetDrop) {
                    dragInfo.targetProject.classList.remove('drop-target');
                }
                if (targetDrop && targetDrop.dataset.id !== dragInfo.id) {
                    dragInfo.targetProject = targetDrop;
                    dragInfo.targetProject.classList.add('drop-target');
                } else {
                    dragInfo.targetProject = null;
                }

                if (currentOpenProjectId) {
                    const overZone = els.find(el => el.id === 'dropOutZone');
                    if(overZone) {
                        dropOutZone.classList.add('active-target');
                        dragInfo.isOutZone = true;
                    } else {
                        dropOutZone.classList.remove('active-target');
                        dragInfo.isOutZone = false;
                    }
                }

                // Grid Reordering Swap
                const hoveredSibling = els.find(el => 
                    el.classList && el.classList.contains('card-wrapper') && 
                    el !== dragInfo.el && el !== dragInfo.clone && el !== dragInfo.placeholder &&
                    el.dataset.type !== 'attached-sticky' &&
                    dragInfo.placeholder.parentNode &&
                    el.parentNode === dragInfo.placeholder.parentNode
                );

                if (hoveredSibling && !dragInfo.targetProject && !dragInfo.isOutZone && dragInfo.el.dataset.type !== 'attached-sticky') {
                    const rect = hoveredSibling.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    if (Math.abs(e.clientX - centerX) < rect.width / 4 && Math.abs(e.clientY - centerY) < rect.height / 4) {
                        const parent = dragInfo.placeholder.parentNode;
                        const siblings = Array.from(parent.querySelectorAll('.card-wrapper:not(.drag-clone):not([style*="display: none"])'));
                        
                        const myIndex = siblings.indexOf(dragInfo.placeholder);
                        const hoverIndex = siblings.indexOf(hoveredSibling);

                        if (myIndex > -1 && hoverIndex > -1) {
                            if (myIndex < hoverIndex) {
                                parent.insertBefore(dragInfo.placeholder, hoveredSibling.nextSibling);
                            } else {
                                parent.insertBefore(dragInfo.placeholder, hoveredSibling);
                            }
                            resizeAllGridItems(); 
                            dragInfo.isReordered = true;
                        }
                    }
                }
            }
        }

        async function handleDragEnd(e) {
            document.removeEventListener('pointermove', handleDragMove);
            document.removeEventListener('pointerup', handleDragEnd);

            if (dragInfo.isActive) {
                const clone = dragInfo.clone;
                const originalEl = dragInfo.el;
                const innerCard = clone.querySelector('.card') || clone;
                
                // Cleanup DOM Placeholder structure immediately
                if (dragInfo.placeholder && dragInfo.placeholder.parentNode) {
                    dragInfo.placeholder.parentNode.insertBefore(originalEl, dragInfo.placeholder);
                    dragInfo.placeholder.remove();
                }
                originalEl.style.display = '';

                if (dragInfo.targetProject) {
                    const targetId = dragInfo.targetProject.dataset.id;
                    const targetType = dragInfo.targetProject.dataset.type;
                    
                    if (targetType !== 'project') {
                        // Attach sticky to a text or image card
                        const innerCardRect = dragInfo.targetProject.querySelector('.card-inner') || dragInfo.targetProject.querySelector('.card');
                        const targetRect = innerCardRect.getBoundingClientRect();
                        const pctX = ((e.clientX - targetRect.left) / targetRect.width) * 100;
                        const pctY = ((e.clientY - targetRect.top) / targetRect.height) * 100;
                        
                        clone.style.transition = 'all 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
                        clone.style.transform = `translate(${e.clientX - dragInfo.offsetX}px, ${e.clientY - dragInfo.offsetY}px) scale(0.8)`;
                        clone.style.opacity = '0';
                        dragInfo.targetProject.classList.remove('drop-target');
                        
                        // Keep sticky visible in current view by adopting parent's project_id if it exists
                        const parentNote = allNotes.find(n => n.id === targetId);
                        const newProjectId = parentNote ? parentNote.project_id : null;

                        updateNoteProject(dragInfo.id, targetId, { subtitle: `${pctX.toFixed(2)},${pctY.toFixed(2)}` });
                    } else {
                        // Drop inside a project folder
                        const targetRect = dragInfo.targetProject.getBoundingClientRect();
                        clone.style.transition = 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)';
                        clone.style.transform = `translate(${targetRect.left + 20}px, ${targetRect.top + 20}px) scale(0.2)`;
                        clone.style.opacity = '0';
                        dragInfo.targetProject.classList.remove('drop-target');
                        
                        updateNoteProject(dragInfo.id, targetId);
                    }
                } else if (dragInfo.isOutZone) {
                    clone.style.transition = 'all 0.4s ease-out';
                    clone.style.transform = `translate(${e.clientX}px, -100px) scale(0.5)`;
                    clone.style.opacity = '0';
                    dropOutZone.classList.remove('active-target');
                    
                    updateNoteProject(dragInfo.id, null, { subtitle: null });
                    
                } else if (dragInfo.el.dataset.type === 'attached-sticky') {
                    // Detach sticky to grid
                    clone.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
                    clone.style.transform = `translate(${e.clientX - dragInfo.offsetX}px, ${e.clientY - dragInfo.offsetY}px)`;
                    updateNoteProject(dragInfo.id, currentOpenProjectId, { subtitle: null });
                } else {
                    // Smoothly snap back into place
                    const origRect = originalEl.getBoundingClientRect();
                    clone.style.transition = 'transform 0.3s cubic-bezier(0.16, 1, 0.3, 1)';
                    clone.style.transform = `translate(${origRect.left}px, ${origRect.top}px)`;
                    if(innerCard && innerCard !== clone) innerCard.style.transform = 'scale(1) rotate(0deg)';
                    setTimeout(() => originalEl.classList.remove('is-dragging'), 250);
                    
                    // Save new order to database
                    if (dragInfo.isReordered) saveGridOrder(originalEl.parentNode);
                }

                setTimeout(() => { if(clone && clone.parentNode) clone.remove(); }, 400);
            } else {
                // Was just a click! Open view
                if (dragInfo.el && !e.target.closest('.action-btn')) {
                    if (dragInfo.el.dataset.type === 'project') {
                        const note = allNotes.find(n => n.id === dragInfo.id);
                        openProjectView(note);
                    } else if (dragInfo.el.dataset.type !== 'attached-sticky') {
                        openNoteView(dragInfo.id);
                    }
                }
            }

            dragInfo.isActive = false; dragInfo.el = null; dragInfo.placeholder = null;
            if(dropOutZone) dropOutZone.classList.remove('visible');
        }

        async function updateNoteProject(noteId, projectId, extraUpdates = {}) {
            const noteIndex = allNotes.findIndex(n => n.id === noteId);
            if(noteIndex > -1) Object.assign(allNotes[noteIndex], { project_id: projectId, ...extraUpdates });
            renderViews(); 

            try {
                await supabaseClient.from('interactive_notes').update({ project_id: projectId, ...extraUpdates }).eq('id', noteId);
            } catch (err) { fetchNotes(); }
        }

        async function saveGridOrder(container) {
            const wrappers = Array.from(container.querySelectorAll('.card-wrapper:not(.drag-clone):not(.drag-placeholder)'));
            
            const updates = wrappers.map((el, index) => {
                const id = el.dataset.id;
                const note = allNotes.find(n => n.id === id);
                if (note) note.sort_order = index;
                return { id, sort_order: index };
            });

            try {
                await Promise.all(updates.map(u => 
                    supabaseClient.from('interactive_notes').update({ sort_order: u.sort_order }).eq('id', u.id)
                ));
            } catch (err) { console.error("Failed to save reordered layout", err); }
        }

        window.updateStickyContent = async (id, html) => {
            const note = allNotes.find(n => n.id === id);
            if (note && note.content !== html) {
                note.content = html;
                try {
                    await supabaseClient.from('interactive_notes').update({ content: html }).eq('id', id);
                } catch (err) { console.error(err); }
            }
        };

        function openProjectView(projectNode) {
            currentOpenProjectId = projectNode.id;
            document.getElementById('projectTitleDisplay').innerText = projectNode.title || 'Project View';
            
            const projNotes = allNotes.filter(n => n.project_id === currentOpenProjectId);
            projNotes.sort((a, b) => {
                if (a.is_pinned && !b.is_pinned) return -1;
                if (!a.is_pinned && b.is_pinned) return 1;
                return (a.sort_order || 0) - (b.sort_order || 0);
            });
            renderGrid(projNotes, projectGrid);
            
            projectView.classList.add('active');
        }

        document.getElementById('btnBackToMain').addEventListener('click', () => {
            projectView.classList.remove('active');
            setTimeout(() => { currentOpenProjectId = null; projectGrid.innerHTML = ''; }, 400);
        });

        // --- Note View & Rich Text Editor Handling ---
        let activeEditNoteId = null;
        let autoSaveTimer = null;
        const editorToolbar = document.getElementById('editorToolbar');

        function formatDoc(cmd, value=null) { document.execCommand(cmd, false, value); }
        function insertLink() { const url = prompt('Enter link URL:'); if (url) formatDoc('createLink', url); }
        function insertImagePrompt() { const url = prompt('Enter image URL:'); if (url) formatDoc('insertImage', url); }
        function insertChecklist() { const html = `<ul><li style="list-style-type: none; margin-left: -20px;"><input type="checkbox"> List item</li></ul>`; formatDoc('insertHTML', html); }

        function handleAutoSave() {
            clearTimeout(autoSaveTimer);
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.style.opacity = '1'; saveStatus.innerText = 'Saving...';
            
            autoSaveTimer = setTimeout(async () => {
                const titleEl = document.getElementById('editorTitle');
                const bodyEl = document.getElementById('editorBody');
                if (!titleEl && !bodyEl) return;

                const updates = {};
                if (titleEl) updates.title = titleEl.innerText;
                if (bodyEl) updates.content = bodyEl.innerHTML;

                try {
                    await supabaseClient.from('interactive_notes').update(updates).eq('id', activeEditNoteId);
                    const note = allNotes.find(n => n.id === activeEditNoteId);
                    if(note) Object.assign(note, updates);
                    renderViews();

                    saveStatus.innerText = 'Saved';
                    setTimeout(() => saveStatus.style.opacity = '0', 2000);
                } catch (err) {
                    saveStatus.innerText = 'Error saving';
                }
            }, 1000);
        }

        function openNoteView(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;
            activeEditNoteId = note.id;
            editorToolbar.classList.remove('active');

            if (note.type === 'text') {
                editorToolbar.classList.add('active');
                noteViewContent.innerHTML = `
                    <div class="editor-container">
                        <h1 class="editor-title" id="editorTitle" contenteditable="true">${note.title || ''}</h1>
                        <div class="editor-body" id="editorBody" contenteditable="true">${note.content || ''}</div>
                    </div>`;
                document.getElementById('editorTitle').addEventListener('input', handleAutoSave);
                document.getElementById('editorBody').addEventListener('input', handleAutoSave);
                setTimeout(() => document.getElementById('editorBody').focus(), 100);

            } else if (note.type === 'sticky') {
                noteViewContent.innerHTML = `
                    <div class="non-text-wrapper sticky-wrapper" style="background-color: ${note.color || 'var(--sticky-yellow)'}">
                        <div class="editor-body" id="editorBody" contenteditable="true">${note.content || ''}</div>
                    </div>`;
                document.getElementById('editorBody').addEventListener('input', handleAutoSave);
                
            } else if (note.type === 'image') {
                noteViewContent.innerHTML = `<div class="non-text-wrapper"><img src="${note.image_url}" style="width: 100%; border-radius: 12px;"></div>`;
            }

            lucide.createIcons();
            noteView.classList.add('active');
        }

        document.getElementById('btnBackFromNote').addEventListener('click', () => {
            noteView.classList.remove('active');
            editorToolbar.classList.remove('active');
            setTimeout(() => { noteViewContent.innerHTML = ''; activeEditNoteId = null; }, 400);
        });

        fetchNotes();

    </script>
</body>
</html>
