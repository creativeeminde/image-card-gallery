<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Habit Tracker ‚Äî Supabase</title>

    <!-- PWA and iOS specific meta tags -->
    <link rel="manifest" href="manifest-habit.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Habit Tracker">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/ef4444/ffffff?text=H">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .date-scroller::-webkit-scrollbar { display: none; }
        .date-scroller { -ms-overflow-style: none; scrollbar-width: none; }
        .view { transition: all 0.3s ease-in-out; }
        .toast-notification, .modal-container { transition: opacity 0.3s ease-in-out; }
        .view.hidden { display: none; }
        .day-btn.active, .time-range-btn.active { background-color: #EF4444; color: #FFFFFF; font-weight: 600; }
        .theme-btn.active { background-color: white; color: #111827; }
        .dark .theme-btn.active { background-color: #4B5563; color: white; }
        .achievement-unlocked { box-shadow: 0 0 15px rgba(250,204,21,0.6); animation: glow 1.5s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(250,204,21,0.4);} to { box-shadow: 0 0 20px rgba(250,204,21,0.8);} }
        .habit-swipe-container, .hidden-habit-swipe-container { position: relative; overflow: hidden; border-radius: 0.75rem; user-select: none; }
        .habit-content, .hidden-habit-tile { transition: transform 0.3s ease-out, background 0.5s ease-out, opacity 0.5s ease-out; position: relative; z-index: 10; cursor: grab; }
        .habit-actions { position: absolute; top: 0; right: 0; height: 100%; display:flex; align-items:center; z-index:1; }
        .habit-action-btn { width:70px; height: 100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-size:0.75rem; font-weight:600; cursor:pointer; }
    </style>
</head>
<body class="antialiased bg-gray-100 dark:bg-black text-gray-900 dark:text-gray-200">

<div id="app-container">
    <!-- Main View -->
    <div id="main-view" class="view p-5 pb-24 min-h-screen">
        <header class="flex justify-between items-center mb-6">
            <button class="flex items-center gap-1.5 bg-white dark:bg-[#1E1E1E] px-3 py-1.5 rounded-full text-sm font-semibold">
                <span>All</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            </button>
            <h1 id="header-title" class="text-xl font-bold">Today</h1>
            <button class="w-8 h-8 rounded-full bg-yellow-400 text-black flex items-center justify-center text-lg"><span>üòä</span></button>
        </header>

        <div id="date-scroller-container" class="date-scroller flex space-x-3 overflow-x-auto pb-4 mb-6"></div>
        <div id="habits-container" class="space-y-3"></div>

        <div id="hidden-habits-section" class="fixed bottom-20 left-0 right-0 z-20 px-5 hidden">
            <div id="hidden-habits-header" class="bg-gray-300 dark:bg-gray-800 text-gray-800 dark:text-white font-semibold py-2 px-4 rounded-t-lg cursor-pointer flex justify-between items-center">
                <span>Hidden Habits</span>
                <svg id="hidden-habits-arrow" class="w-5 h-5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>
            </div>
            <div id="hidden-habits-list" class="bg-gray-200 dark:bg-gray-900/80 backdrop-blur-sm max-h-0 overflow-y-auto transition-all duration-300 ease-in-out p-0 space-y-2"></div>
        </div>
    </div>

    <!-- Stats View -->
    <div id="stats-view" class="view hidden p-5 pb-24 min-h-screen">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold">Statistics</h1>
        </header>
        <div id="stats-container" class="space-y-6"></div>
    </div>

    <!-- Achievements View -->
    <div id="achievements-view" class="view hidden p-5 pb-24 min-h-screen">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span class="text-2xl">üèÜ</span>
                Achievements
            </h1>
        </header>
        <div id="achievements-container" class="space-y-6"></div>
        <p class="text-center text-gray-500 dark:text-gray-400 mt-8 font-semibold">Keep going to unlock more rewards!</p>
    </div>

    <!-- Settings View -->
    <div id="settings-view" class="view hidden p-5 pb-24 min-h-screen">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold">Settings</h1>
        </header>
        <div class="space-y-4">
            <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl">
                <h2 class="font-bold text-lg mb-3">Appearance</h2>
                <div id="theme-selector" class="flex rounded-lg bg-gray-200 dark:bg-black p-1">
                     <button data-theme="light" class="theme-btn flex-1 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600 dark:text-gray-400">Light</button>
                     <button data-theme="dark" class="theme-btn flex-1 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600 dark:text-gray-400">Dark</button>
                </div>
            </div>
            <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl">
                <h2 class="font-bold text-lg mb-2">Data Management</h2>
                <button id="reset-data-btn" class="w-full text-left p-3 bg-red-100 dark:bg-red-900/50 hover:bg-red-200 dark:hover:bg-red-900/80 rounded-lg text-red-700 dark:text-red-300 font-semibold">Reset All Data</button>
                <p class="text-xs text-gray-500 mt-2">This will permanently delete all your habits and progress from Supabase and local cache.</p>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Habit View -->
<div id="add-habit-view" class="fixed inset-0 bg-gray-100 dark:bg-black transform translate-x-full z-50 p-5 overflow-y-auto">
    <header class="flex items-center mb-8">
        <button id="back-btn" class="p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
        <h2 id="form-title" class="text-xl font-bold mx-auto">Custom Habit</h2>
        <div class="w-6"></div>
    </header>
    <div class="space-y-4 pb-5">
        <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl">
            <div class="flex items-center gap-4">
                <button id="icon-preview-btn" class="w-14 h-14 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center text-3xl flex-shrink-0">‚ûï</button>
                <div class="flex-grow space-y-2">
                    <input id="habit-name-input" type="text" placeholder="Habit name" class="w-full bg-transparent text-lg font-semibold placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none">
                    <input id="habit-category-input" type="text" placeholder="Category (e.g., Health)" class="w-full bg-transparent text-sm text-gray-500 dark:placeholder-gray-400 focus:outline-none">
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl flex justify-between items-center">
             <label class="font-semibold">Times Per Day</label>
             <input id="habit-times-per-day-input" type="number" value="1" min="1" class="w-20 bg-gray-200 dark:bg-gray-700 text-center font-semibold rounded-lg py-1 focus:outline-none focus:ring-2 focus:ring-red-500">
        </div>
         <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl">
            <label class="font-semibold">Target Days</label>
            <div id="form-target-days" class="flex justify-between items-center mt-3"></div>
        </div>
        <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl">
            <label class="font-semibold">Time Range</label>
            <div id="form-time-range" class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3"></div>
        </div>
        <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl">
            <label class="font-semibold">Color</label>
            <div id="form-color-grid" class="grid grid-cols-8 gap-3 py-4 place-items-center"></div>
        </div>
         <button id="save-habit-btn" class="w-full bg-red-500 text-white font-bold py-4 rounded-xl mt-6">Create Habit</button>
    </div>
</div>

<!-- Icon Picker Modal -->
<div id="icon-picker-modal" class="modal-container fixed inset-0 bg-black/70 z-[60] hidden items-center justify-center p-5">
    <div class="bg-white dark:bg-[#1E1E1E] p-4 rounded-xl w-full max-w-sm">
        <h3 class="text-lg font-bold text-center mb-4">Choose an Icon</h3>
        <div id="icon-grid" class="grid grid-cols-6 gap-2 max-h-60 overflow-y-auto"></div>
        <button id="close-icon-modal" class="mt-4 w-full py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Close</button>
    </div>
</div>

<!-- Footer Navigation -->
<footer class="fixed bottom-0 left-0 right-0 bg-white dark:bg-black border-t border-gray-200 dark:border-gray-800 p-2 flex justify-around items-center z-50">
    <button data-view="main-view" class="nav-btn p-2 text-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg></button>
    <button data-view="stats-view" class="nav-btn p-2 text-gray-500 dark:text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg></button>
    <button id="add-habit-fab" class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center text-white -mt-8 border-4 border-white dark:border-black shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
    <button data-view="achievements-view" class="nav-btn p-2 text-gray-500 dark:text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138z" /></svg></button>
    <button data-view="settings-view" class="nav-btn p-2 text-gray-500 dark:text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
</footer>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// UPDATED CREDENTIALS
const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

document.addEventListener('DOMContentLoaded', async () => {
    // UI Elements
    const habitsContainer = document.getElementById('habits-container');
    const dateScrollerContainer = document.getElementById('date-scroller-container');
    const addHabitView = document.getElementById('add-habit-view');
    const saveHabitBtn = document.getElementById('save-habit-btn');
    const habitNameInput = document.getElementById('habit-name-input');
    const habitTimesPerDayInput = document.getElementById('habit-times-per-day-input');
    const formTargetDays = document.getElementById('form-target-days');
    const formTimeRange = document.getElementById('form-time-range');
    const iconPreviewButton = document.getElementById('icon-preview-btn');
    const formColorGrid = document.getElementById('form-color-grid');
    const backBtn = document.getElementById('back-btn');
    const themeSelector = document.getElementById('theme-selector');

    // State
    let selectedDate = new Date();
    let habits = [];
    let history = {};

    const COLORS = [
        { main: '#3B82F6' }, { main: '#FBBF24' }, { main: '#2DD4BF' }, 
        { main: '#F87171' }, { main: '#4ADE80' }, { main: '#A78BFA' }, 
        { main: '#F472B6' }, { main: '#818CF8' }
    ];
    const ICONS = ['üìö','üèÉ','üíª','üßò','üíß','üé®','üéµ','üßπ','üí™','üéØ','üå±','üåÖ','üçé','‚úçÔ∏è','üí°'];
    const DAYS_OF_WEEK = ['S','M','T','W','T','F','S'];
    const TIME_RANGES = ['Anytime','Morning','Afternoon','Evening'];

    const toISODate = d => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().split('T')[0];

    async function loadData() {
        try {
            const { data: hData } = await supabase.from('habits').select('*').order('id');
            habits = hData || [];
            
            const { data: histData } = await supabase.from('history').select('*');
            history = {};
            (histData || []).forEach(row => {
                if (!history[row.date]) history[row.date] = {};
                history[row.date][row.habit_id] = { count: row.count, status: row.status };
            });
            renderAll();
        } catch (e) { console.error(e); }
    }

    function renderAll() {
        renderDateScroller();
        renderHabits();
    }

    function renderDateScroller() {
        dateScrollerContainer.innerHTML = '';
        const today = new Date();
        for (let i = -7; i <= 7; i++) {
            const d = new Date(); d.setDate(today.getDate() + i);
            const isSel = toISODate(d) === toISODate(selectedDate);
            const btn = document.createElement('button');
            btn.className = `flex flex-col items-center p-3 rounded-full min-w-[50px] ${isSel ? 'bg-red-500 text-white' : 'bg-gray-200 dark:bg-gray-800'}`;
            btn.innerHTML = `<span class="text-xs">${DAYS_OF_WEEK[d.getDay()]}</span><span class="font-bold">${d.getDate()}</span>`;
            btn.onclick = () => { selectedDate = d; renderAll(); };
            dateScrollerContainer.appendChild(btn);
        }
    }

    async function renderHabits() {
        const dateKey = toISODate(selectedDate);
        const dayIdx = selectedDate.getDay();
        const activeHabits = habits.filter(h => h.target_days.includes(dayIdx));
        
        habitsContainer.innerHTML = '';
        activeHabits.forEach(h => {
            const entry = (history[dateKey] || {})[h.id] || { count: 0 };
            const done = entry.count >= h.goal;
            const card = document.createElement('div');
            card.className = `p-4 rounded-xl flex items-center justify-between shadow-sm transition-all ${done ? 'bg-green-100 dark:bg-green-900/30' : 'bg-white dark:bg-gray-900'}`;
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="text-2xl">${h.icon}</span>
                    <div>
                        <p class="font-bold">${h.name}</p>
                        <p class="text-xs opacity-60">${entry.count}/${h.goal} times</p>
                    </div>
                </div>
                <button class="w-10 h-10 rounded-full flex items-center justify-center ${done ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700'}">
                    ${done ? '‚úì' : '+'}
                </button>
            `;
            card.onclick = async () => {
                if (done) return;
                const newCount = entry.count + 1;
                await supabase.from('history').upsert({ habit_id: h.id, date: dateKey, count: newCount }, { onConflict: 'habit_id,date' });
                loadData();
            };
            habitsContainer.appendChild(card);
        });
    }

    // Modal Handling
    document.getElementById('add-habit-fab').onclick = () => {
        addHabitView.classList.remove('translate-x-full');
        formTargetDays.innerHTML = DAYS_OF_WEEK.map((d,i) => `<button class="day-btn w-8 h-8 rounded-full active" data-idx="${i}">${d}</button>`).join('');
        formTimeRange.innerHTML = TIME_RANGES.map(r => `<button class="time-range-btn px-3 py-1 rounded-lg ${r==='Anytime'?'active':''}" data-val="${r}">${r}</button>`).join('');
        formColorGrid.innerHTML = COLORS.map(c => `<button class="w-6 h-6 rounded-full" style="background:${c.main}" data-color="${c.main}"></button>`).join('');
    };

    backBtn.onclick = () => addHabitView.classList.add('translate-x-full');

    saveHabitBtn.onclick = async () => {
        const days = Array.from(formTargetDays.querySelectorAll('.day-btn.active')).map(b => parseInt(b.dataset.idx));
        const tr = formTimeRange.querySelector('.time-range-btn.active').dataset.val;
        await supabase.from('habits').insert({
            name: habitNameInput.value,
            goal: parseInt(habitTimesPerDayInput.value),
            target_days: days,
            time_range: tr,
            icon: iconPreviewButton.textContent,
            color: '#EF4444'
        });
        addHabitView.classList.add('translate-x-full');
        loadData();
    };

    // Global listeners
    document.body.addEventListener('click', e => {
        if (e.target.classList.contains('day-btn')) e.target.classList.toggle('active');
        if (e.target.classList.contains('time-range-btn')) {
            formTimeRange.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
        }
    });

    themeSelector.onclick = (e) => {
        if (e.target.dataset.theme === 'light') document.documentElement.classList.remove('dark');
        else document.documentElement.classList.add('dark');
    };

    loadData();
});
</script>
</body>
</html>
