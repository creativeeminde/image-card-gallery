<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediverse</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- === ADDED SUPABASE SCRIPT === -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- ============================= -->
    <style>
        :root {
            --primary-blue: #4a90e2;
            --light-blue: #edf5ff;
            --dark-gray: #333;
            --medium-gray: #666;
            --light-gray: #ccc;
            --bg-color: #DCE3EB;
            --card-bg: rgba(255, 255, 255, 0.9);
            --glass-effect: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #333;
            --danger-red: #e74c3c;
            --danger-red-light: #fbe9e7;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            background-color: var(--bg-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 30px;
            position: relative;
            z-index: 100;
        }

        .navbar .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-gray);
            cursor: pointer;
            user-select: none;
        }

        .navbar .main-nav {
            display: flex;
            background: var(--glass-effect);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 8px;
            border: 1px solid var(--glass-border);
        }

        .navbar .main-nav button {
            background: none;
            border: none;
            padding: 8px 20px;
            border-radius: 25px;
            color: var(--medium-gray);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .navbar .main-nav button.active {
            background-color: var(--primary-blue);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar .search-profile {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .navbar .search-bar {
            position: relative;
            background: var(--glass-effect);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 8px 15px;
            border: 1px solid var(--glass-border);
        }

        .navbar .search-bar input {
            background: none;
            border: none;
            outline: none;
            color: var(--dark-gray);
            padding-left: 10px;
            width: 150px;
            font-size: 16px;
        }

        .navbar .search-bar i {
            color: var(--medium-gray);
        }

        .upload-button {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .upload-button:hover {
            background-color: #3a80d2;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* Hero Section */
        .hero-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .hero-card {
            position: relative;
            height: 300px;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            padding: 30px;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
            /* Added default background color */
            background-color: #a0b0c0;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 50%);
            z-index: 1;
        }

        /* Default Hero Card Images */
        #movie-hero-1 { background-image: url('https://images.unsplash.com/photo-1549725227-825501ce011a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80'); }
        #movie-hero-2 { background-image: url('https://images.unsplash.com/photo-1603577789960-d72b2c9b4e7a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80'); }
        #series-hero-1 { background-image: url('https://placehold.co/1000x800/4a90e2/white?text=Latest+Series'); }
        #series-hero-2 { background-image: url('https://placehold.co/1000x800/3a80d2/white?text=Top+Series'); }
        #games-hero-1 { background-image: url('https://placehold.co/1000x800/e74c3c/white?text=Latest+Game'); }
        #games-hero-2 { background-image: url('https://placehold.co/1000x800/c0392b/white?text=Top+Game'); }
        #books-hero-1 { background-image: url('https://placehold.co/1000x800/2ecc71/white?text=Latest+Book'); }
        #books-hero-2 { background-image: url('https://placehold.co/1000x800/27ae60/white?text=Top+Book'); }


        .hero-card .content {
            position: relative;
            z-index: 2;
        }

        .hero-card h2 {
            font-size: 32px;
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .hero-card p {
            font-size: 16px;
            margin-bottom: 20px;
            max-width: 80%;
        }

        .hero-card .play-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hero-card .play-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }

        /* Home Page Carousel Styles */
        .home-category {
            margin-bottom: 40px;
        }
        
        .home-category h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-gray);
        }
        
        .home-carousel {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px; /* For scrollbar spacing */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            /* --- NEW: For Dragging --- */
            cursor: grab;
            user-select: none; /* Prevent text selection */
        }

        /* --- NEW: Dragging state --- */
        .home-carousel.grabbing {
            cursor: grabbing;
        }
        
        .home-carousel::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .home-carousel .home-hero-card {
            position: relative;
            width: 300px;
            height: 200px;
            flex-shrink: 0;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
            padding: 20px;
            color: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            background-size: cover;
            background-position: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .home-carousel .home-hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 60%);
            z-index: 1;
        }

        .home-carousel .home-hero-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .home-carousel .home-hero-card .content {
            position: relative;
            z-index: 2;
        }

        .home-carousel .home-hero-card .title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .home-carousel .home-hero-card .genre {
            font-size: 14px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* --- NEW: "Show All" Card Style --- */
        .home-hero-card.show-all-card {
            background-image: none;
            background-color: var(--card-bg);
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }
        
        .home-hero-card.show-all-card i {
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .home-hero-card.show-all-card:hover {
            background-color: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        /* --- End "Show All" Card Style --- */

        
        .no-cards-msg {
            color: var(--medium-gray);
            font-style: italic;
        }


        /* Category Filters */
        .category-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: var(--glass-effect);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            border: 1px solid var(--glass-border);
        }

        .category-filters .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Added this */
            flex-grow: 1; /* Allow group to grow */
        }

        .category-filters .filter-button {
            background: none;
            border: none;
            padding: 8px 18px;
            border-radius: 25px;
            color: var(--medium-gray);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .category-filters .filter-button i {
            color: var(--medium-gray);
        }

        .category-filters .filter-button.active,
        .category-filters .filter-button:hover {
            background-color: var(--light-blue);
            color: var(--primary-blue);
        }

        .category-filters .filter-button.active i,
        .category-filters .filter-button:hover i {
            color: var(--primary-blue);
        }

        /* --- NEW STYLES for "Show All" --- */
        .category-filters .filter-button.extra-filter {
            display: none; /* Hide extra filters by default */
        }

        .category-filters .filter-group.expanded .filter-button.extra-filter {
            display: flex; /* Show them when parent is expanded */
        }

        .category-filters .filter-button.show-all-btn {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            font-weight: 600;
        }
        /* --- END NEW STYLES --- */


        .category-filters .display-options {
            display: flex;
            margin-left: 20px; /* Added margin */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .category-filters .display-options button {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--medium-gray);
            cursor: pointer;
            margin-left: 10px;
        }

        .category-filters .display-options button.active {
            color: var(--primary-blue);
        }

        /* Trending Section */
        .trending-section h3 {
            font-size: 24px;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 25px;
        }

        .movie-card {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            position: relative;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .movie-card.deleting {
            opacity: 0;
            transform: scale(0.9);
        }

        .card-icons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 4; 
        }
        
        .card-icons button {
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            color: white;
            width: 30px;
            height: 30px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0;
        }
        
        .movie-card:hover .card-icons button {
            opacity: 1;
        }

        .card-icons button:hover {
            background: var(--primary-blue);
        }
        
        .card-icons .delete-btn:hover {
            background: var(--danger-red);
        }


        .movie-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .movie-card .details {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .movie-card .details .title {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .movie-card .details .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--medium-gray);
        }

        .movie-card .details .rating {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
            color: var(--primary-blue);
        }

        .movie-card .details .rating i {
            color: gold;
            font-size: 14px;
        }
        
        .movie-card .details .genre {
            font-size: 12px;
            color: var(--medium-gray);
            font-style: italic;
        }

        /* --- Video Play Button Overlay --- */
        .movie-card, .home-hero-card {
            position: relative; /* Ensure parent is relative */
        }

        .play-btn-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px; /* Match parent card */
            opacity: 0;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 3; /* Above card image/icons */
        }

        /* Home card has a gradient, so make this one stronger */
        .home-hero-card .play-btn-overlay {
            font-size: 36px;
            background: rgba(0, 0, 0, 0.4);
        }

        .movie-card:hover .play-btn-overlay,
        .home-hero-card:hover .play-btn-overlay {
            opacity: 1;
        }

        .play-btn-overlay i {
            transform: scale(0.8);
            transition: transform 0.2s ease;
        }

        .play-btn-overlay:hover i {
            transform: scale(1);
        }


        /* Upload Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .upload-modal {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .upload-modal {
            transform: scale(1);
        }

        .upload-modal h2 {
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        .upload-form .form-group {
            margin-bottom: 15px;
        }
        
        .upload-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--medium-gray);
            font-size: 14px;
        }
        
        .upload-form input,
        .upload-form select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .upload-form input:focus,
        .upload-form select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--light-blue);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .form-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .form-actions .btn-submit {
            background-color: var(--primary-blue);
            color: white;
        }
        .form-actions .btn-submit:hover {
            background-color: #3a80d2;
        }
        
        .form-actions .btn-cancel {
            background-color: #f0f0f0;
            color: var(--medium-gray);
        }
        .form-actions .btn-cancel:hover {
            background-color: #e0e0e0;
        }

        /* Custom Confirmation Modal */
        #confirm-modal {
            z-index: 1001;
        }

        #confirm-modal .upload-modal {
            max-width: 400px;
            text-align: center;
        }
        
        #confirm-modal h3 {
            margin-top: 0;
            color: var(--dark-gray);
        }
        
        #confirm-modal p {
            color: var(--medium-gray);
            margin-bottom: 25px;
        }
        
        #confirm-modal .form-actions button {
            font-size: 14px;
        }
        
        #confirm-modal .btn-confirm-delete {
            background-color: var(--danger-red);
            color: white;
        }
        #confirm-modal .btn-confirm-delete:hover {
            background-color: #c0392b;
        }

        /* Custom Message/Alert */
        .show-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark-gray);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 500;
            z-index: 2000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .show-message.show {
            opacity: 1;
            visibility: visible;
            top: 30px;
        }
        .show-message.success {
            background-color: #2ecc71;
        }
        .show-message..error {
            background-color: var(--danger-red);
        }

    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="logo" id="logo-btn">Mediverse</div>
            <div class="main-nav">
                <button data-page="movie-page">Movie</button>
                <button data-page="series-page">Series</button>
                <button data-page="games-page">Games</button>
                <button data-page="books-page">Books</button>
            </div>
            <div class="search-profile">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search" id="search-input-bar">
                </div>
                <button class="upload-button" id="open-upload-modal">
                    <i class="fas fa-plus"></i> Upload
                </button>
            </div>
        </nav>

        <!-- HOME PAGE (default) -->
        <main id="home-page" class="page-content">
            <section class="home-category">
                <h2>Latest Movies</h2>
                <div class="home-carousel" id="home-movies">
                    <!-- JS will populate this -->
                </div>
            </section>
            <section class="home-category">
                <h2>Latest Series</h2>
                <div class="home-carousel" id="home-series">
                    <!-- JS will populate this -->
                </div>
            </section>
            <section class="home-category">
                <h2>Latest Games</h2>
                <div class="home-carousel" id="home-games">
                    <!-- JS will populate this -->
                </div>
            </section>
            <section class="home-category">
                <h2>Latest Books</h2>
                <div class="home-carousel" id="home-books">
                    <!-- JS will populate this -->
                </div>
            </section>

            <section class="trending-section" id="search-results-section" style="display: none;">
                <h3>Search Results</h3>
                <div class="movie-grid" id="search-results-grid">
                    <!-- Search results will be populated here -->
                </div>
            </section>
        </main>

        <!-- PAGE 1: MOVIES (now hidden) -->
        <main id="movie-page" class="page-content" style="display: none;">
            <section class="hero-section">
                <div class="hero-card" id="movie-hero-1">
                    <div class="content">
                        <h2>The Adventure of Blue Sword</h2>
                        <button class="play-button"><i class="fas fa-play-circle"></i> Let Play Moview</button>
                    </div>
                </div>
                <div class="hero-card" id="movie-hero-2">
                    <div class="content">
                        <h2>Recalling the journey of Dol's exciting story</h2>
                        <button class="play-button"><i class="fas fa-play-circle"></i> Let Play Moview</button>
                    </div>
                </div>
            </section>

            <section class="category-filters">
                <div class="filter-group">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
                <div class="display-options">
                    <button><i class="fas fa-bars"></i></button>
                    <button class="active"><i class="fas fa-grip-vertical"></i></button>
                </div>
            </section>

            <section class="trending-section">
                <h3>All Uploads</h3>
                <div class="movie-grid">
                    <!-- Cards will be populated from LocalStorage -->
                </div>
            </section>
        </main>

        <!-- PAGE 2: SERIES -->
        <main id="series-page" class="page-content" style="display: none;">
            <section class="hero-section">
                <div class="hero-card" id="series-hero-1">
                    <div class="content">
                        <h2>Latest Series</h2>
                        <button class="play-button"><i class="fas fa-play-circle"></i> View</button>
                    </div>
                </div>
                <div class="hero-card" id="series-hero-2">
                    <div class="content">
                        <h2>Top Series</h2>
                        <button class="play-button"><i class="fas fa-play-circle"></i> View</button>
                    </div>
                </div>
            </section>

            <section class="category-filters">
                <div class="filter-group">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
                <div class="display-options">
                    <button><i class="fas fa-bars"></i></button>
                    <button class="active"><i class="fas fa-grip-vertical"></i></button>
                </div>
            </section>
            <section class="trending-section">
                <h3>All Series</h3>
                <div class="movie-grid">
                    <!-- Cards will be populated from LocalStorage -->
                </div>
            </section>
        </main>

        <!-- PAGE 3: GAMES -->
        <main id="games-page" class="page-content" style="display: none;">
            <section class="hero-section">
                <div class="hero-card" id="games-hero-1">
                    <div class="content">
                        <h2>Latest Game</h2>
                        <button class="play-button"><i class="fas fa-play-circle"></i> Play Now</button>
                    </div>
                </div>
                <div class="hero-card" id="games-hero-2">
                    <div class="content">
                        <h2>Top Game</h2>
                        <button class="play-button"><i class="fas fa-play-circle"></i> Play Now</button>
                    </div>
                </div>
            </section>

            <section class="category-filters">
                <div class="filter-group">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
                <div class="display-options">
                    <button><i class="fas fa-bars"></i></button>
                    <button class="active"><i class="fas fa-grip-vertical"></i></button>
                </div>
            </section>
            <section class="trending-section">
                <h3>All Games</h3>
                <div class="movie-grid">
                    <!-- Cards will be populated from LocalStorage -->
                </div>
            </section>
        </main>

        <!-- PAGE 4: BOOKS -->
        <main id="books-page" class="page-content" style="display: none;">
             <section class="hero-section">
                <div class="hero-card" id="books-hero-1">
                    <div class="content">
                        <h2>Latest Book</h2>
                        <button class="play-button"><i class="fas fa-book-open"></i> Read Now</button>
                    </div>
                </div>
                <div class="hero-card" id="books-hero-2">
                    <div class="content">
                        <h2>Top Book</h2>
                        <button class="play-button"><i class="fas fa-book-open"></i> Read Now</button>
                    </div>
                </div>
            </section>

             <section class="category-filters">
                <div class="filter-group">
                    <!-- Buttons will be populated by JavaScript -->
                </div>
                <div class="display-options">
                    <button><i class="fas fa-bars"></i></button>
                    <button class="active"><i class="fas fa-grip-vertical"></i></button>
                </div>
            </section>
             <section class="trending-section">
                <h3>All Books</h3>
                <div class="movie-grid">
                    <!-- Cards will be populated from LocalStorage -->
                </div>
            </section>
        </main>
    </div>

    <!-- Upload Modal HTML -->
    <div class="modal-overlay" id="upload-modal-overlay">
        <div class="upload-modal">
            <h2 id="modal-title">Upload New Card</h2>
            <form class="upload-form" id="upload-form">
                <input type="hidden" id="upload-id">
                
                <div class="form-group">
                    <label for="uploadTitle">Title</label>
                    <input type="text" id="uploadTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="uploadCategory">Category</label>
                    <select id="uploadCategory" required>
                        <option value="">-- Select a Category --</option>
                        <option value="movie">Movie</option>
                        <option value="series">Series</option>
                        <option value="game">Game</option>
                        <option value="book">Book</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="uploadGenre">Genre</label>
                    <input type="text" id="uploadGenre" list="genre-list" required>
                    <datalist id="genre-list">
                        <!-- Options will be populated by JS -->
                    </datalist>
                </div>
                
                <div class="form-group">
                    <label for="uploadTags">Tags (comma separated, e.g. trending, new)</label>
                    <input type="text" id="uploadTags">
                </div>
                
                <div class="form-group">
                    <label for="uploadCoverUrl">Cover Image URL</label>
                    <input type="url" id="uploadCoverUrl" required>
                </div>
                
                <div class="form-group">
                    <label for="uploadVideoUrl">Video URL (Optional)</label>
                    <input type="url" id="uploadVideoUrl">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancel-upload">Cancel</button>
                    <button type="submit" class="btn-submit" id="submit-upload">Submit Card</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal HTML -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="upload-modal">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this card? This action cannot be undone.</p>
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancel-delete">Cancel</button>
                <button type="button" class="btn-confirm-delete" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Element -->
    <div class="show-message" id="custom-message"></div>


    <!-- ================================== -->
    <!-- === ALL JAVASCRIPT REWRITTEN === -->
    <!-- ================================== -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Supabase Setup ---
            const SUPABASE_URL = 'https://wxcribfgsredterukkzt.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4Y3JpYmZnc3JlZHRlcnVra3p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MjU0NTUsImV4cCI6MjA3NjUwMTQ1NX0.ZRl5Z6MAGAkwhoRmH60-AXue0AbS9HQ1SHtoHuEkbaM';
            const { createClient } = supabase;
            const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- App State ---
            let allCardsCache = []; // Local cache for all cards from Supabase

            // --- Page/Modal Elements ---
            const logoBtn = document.getElementById('logo-btn');
            const homePage = document.getElementById('home-page');
            const navButtons = document.querySelectorAll('.main-nav button');
            const pages = document.querySelectorAll('.page-content');
            const modalOverlay = document.getElementById('upload-modal-overlay');
            const modal = modalOverlay.querySelector('.upload-modal');
            const modalTitle = document.getElementById('modal-title');
            const openModalBtn = document.getElementById('open-upload-modal');
            const cancelBtn = document.getElementById('cancel-upload');
            const uploadForm = document.getElementById('upload-form');
            const submitBtn = document.getElementById('submit-upload');
            
            // --- Form Fields ---
            const cardIdInput = document.getElementById('upload-id');
            const titleInput = document.getElementById('uploadTitle');
            const categoryInput = document.getElementById('uploadCategory');
            const tagsInput = document.getElementById('uploadTags');
            const coverUrlInput = document.getElementById('uploadCoverUrl');
            const genreInput = document.getElementById('uploadGenre');
            const genreDatalist = document.getElementById('genre-list');
            const videoUrlInput = document.getElementById('uploadVideoUrl'); 

            // --- Delete Confirmation Modal Elements ---
            const confirmModalOverlay = document.getElementById('confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            let cardToDelete = null;

            // --- Message Element ---
            const messageEl = document.getElementById('custom-message');

            // --- Search Elements ---
            const searchInput = document.getElementById('search-input-bar');
            const homeCarousels = document.querySelectorAll('#home-page .home-category');
            const searchResultsSection = document.getElementById('search-results-section');
            const searchResultsGrid = document.getElementById('search-results-grid');


            // --- Drag-to-scroll for Home Carousels ---
            const carousels = document.querySelectorAll('.home-carousel');
            carousels.forEach(carousel => {
                let isDown = false;
                let startX;
                let scrollLeft;
                
                const startDrag = (e) => {
                    if(e.target.closest('.show-all-card') || e.target.closest('.play-btn-overlay')) return;
                    isDown = true;
                    carousel.classList.add('grabbing');
                    startX = (e.pageX || e.touches[0].pageX) - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                };

                const endDrag = () => {
                    isDown = false;
                    carousel.classList.remove('grabbing');
                };

                const moveDrag = (e) => {
                    if (!isDown) return;
                    e.preventDefault(); 
                    const x = (e.pageX || e.touches[0].pageX) - carousel.offsetLeft;
                    const walk = (x - startX) * 2;
                    carousel.scrollLeft = scrollLeft - walk;
                };

                carousel.addEventListener('mousedown', startDrag);
                carousel.addEventListener('mouseleave', endDrag);
                carousel.addEventListener('mouseup', endDrag);
                carousel.addEventListener('mousemove', moveDrag);
                carousel.addEventListener('touchstart', startDrag);
                carousel.addEventListener('touchend', endDrag);
                carousel.addEventListener('touchmove', moveDrag);
            });


            // --- HELPER: Get Page ID from Category ---
            function getPageIdForCategory(category) {
                if (!category) return null;
                if (category === 'movie' || category === 'series') {
                    return `${category}-page`;
                }
                return `${category}s-page`;
            }

            // --- HELPER: Get Hero ID from Category ---
            function getHeroIdForCategory(category) {
                if (!category) return null;
                if (category === 'movie' || category === 'series') {
                    return category;
                }
                return `${category}s`;
            }
            
            // --- HELPER: Get Active Page ---
            function getActivePage() {
                for (const page of pages) {
                    if (page.style.display !== 'none' && page.id !== 'home-page') {
                        return page;
                    }
                }
                return homePage; // Default to home
            }


            // --- Genre Definitions ---
            const genresByCategory = {
                movie: ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Drama', 'Fantasy', 'Horror', 'Musical', 'Mystery', 'Romance', 'Science Fiction', 'Thriller', 'War', 'Western'],
                series: ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Drama', 'Fantasy', 'Horror', 'Musical', 'Mystery', 'Romance', 'Science Fiction', 'Thriller', 'War', 'Western'],
                game: ['Action', 'Adventure', 'Role-Playing Game (RPG)', 'Shooter (First-Person / Third-Person)', 'Simulation', 'Strategy', 'Sports', 'Racing', 'Fighting', 'Puzzle', 'Platformer', 'Horror / Survival Horror', 'Sandbox / Open World', 'Battle Royale', 'MMORPG (Massively Multiplayer Online RPG)'],
                book: ['Fiction', 'Mystery', 'Thriller', 'Romance', 'Fantasy', 'Science Fiction (Sci-Fi)', 'Horror', 'Historical Fiction', 'Young Adult (YA)', 'Biography / Memoir', 'Self-Help', 'Non-Fiction', 'Adventure', 'Poetry', 'Children’s']
            };
            
            // --- Icon Definitions ---
            const genreIcons = {
                'action': 'fas fa-mask', 'adventure': 'fas fa-compass', 'animation': 'fas fa-camera-retro', 'comedy': 'fas fa-laugh', 'crime': 'fas fa-handcuffs', 'drama': 'fas fa-theater-masks', 'fantasy': 'fas fa-dragon', 'horror': 'fas fa-skull', 'musical': 'fas fa-music', 'mystery': 'fas fa-search', 'romance': 'fas fa-heart', 'science fiction': 'fas fa-rocket', 'thriller': 'fas fa-bolt', 'war': 'fas fa-fighter-jet', 'western': 'fas fa-hat-cowboy',
                'role-playing game (rpg)': 'fas fa-shield-alt', 'shooter (first-person / third-person)': 'fas fa-crosshairs', 'simulation': 'fas fa-gamepad', 'strategy': 'fas fa-chess', 'sports': 'fas fa-football-ball', 'racing': 'fas fa-flag-checkered', 'fighting': 'fas fa-fist-raised', 'puzzle': 'fas fa-puzzle-piece', 'platformer': 'fas fa-cube', 'horror / survival horror': 'fas fa-ghost', 'sandbox / open world': 'fas fa-map-marked-alt', 'battle royale': 'fas fa-parachute-box', 'mmorpg (massively multiplayer online rpg)': 'fas fa-users',
                'fiction': 'fas fa-book', 'science fiction (sci-fi)': 'fas fa-atom', 'historical fiction': 'fas fa-landmark', 'young adult (ya)': 'fas fa-child', 'biography / memoir': 'fas fa-book-open', 'self-help': 'fas fa-brain', 'non-fiction': 'fas fa-book-reader', 'poetry': 'fas fa-feather-alt', 'children’s': 'fas fa-shapes',
                'default': 'fas fa-tag'
            };

            // --- Default Hero Data ---
            const defaultHeroData = {
                movie: {
                    hero1: { title: "The Adventure of Blue Sword", button: "Let Play Moview", icon: "fa-play-circle", image: "url('https://images.unsplash.com/photo-1549725227-825501ce011a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80')" },
                    hero2: { title: "Recalling the journey of Dol's exciting story", button: "Let Play Moview", icon: "fa-play-circle", image: "url('https://images.unsplash.com/photo-1603577789960-d72b2c9b4e7a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80')" }
                },
                series: {
                    hero1: { title: "Latest Series", button: "View", icon: "fa-play-circle", image: "url('https://placehold.co/1000x800/4a90e2/white?text=Latest+Series')" },
                    hero2: { title: "Top Series", button: "View", icon: "fa-play-circle", image: "url('https://placehold.co/1000x800/3a80d2/white?text=Top+Series')" }
                },
                game: {
                    hero1: { title: "Latest Game", button: "Play Now", icon: "fa-play-circle", image: "url('https://placehold.co/1000x800/e74c3c/white?text=Latest+Game')" },
                    hero2: { title: "Top Game", button: "Play Now", icon: "fa-play-circle", image: "url('https://placehold.co/1000x800/c0392b/white?text=Top+Game')" }
                },
                book: {
                    hero1: { title: "Latest Book", button: "Read Now", icon: "fa-book-open", image: "url('https://placehold.co/1000x800/2ecc71/white?text=Latest+Book')" },
                    hero2: { title: "Top Book", button: "Read Now", icon: "fa-book-open", image: "url('https://placehold.co/1000x800/27ae60/white?text=Top+Book')" }
                }
            };


            // --- FUNCTION: Populate Filters ---
            function initializePageFilters(pageId, genres) {
                const page = document.getElementById(pageId);
                if (!page) return;
                const filterGroup = page.querySelector('.filter-group');
                if (!filterGroup) return;

                const maxVisibleGenres = 6; 

                let buttonsHTML = `
                    <button class="filter-button active" data-filter="all"><i class="fas fa-grip-horizontal"></i> All</button>
                    <button class="filter-button" data-filter="trending"><i class="fas fa-fire"></i> Trending</button>
                `;

                genres.forEach((genre, index) => {
                    const iconKey = genre.toLowerCase();
                    const icon = genreIcons[iconKey] || genreIcons.default;
                    const extraClass = index >= maxVisibleGenres ? 'extra-filter' : '';
                    buttonsHTML += `
                        <button class="filter-button ${extraClass}" data-filter="${genre.toLowerCase()}">
                            <i class="${icon}"></i> ${genre}
                        </button>
                    `;
                });

                if (genres.length > maxVisibleGenres) {
                    buttonsHTML += `
                        <button class="filter-button show-all-btn">
                            <i class="fas fa-chevron-down"></i> Show All
                        </button>
                    `;
                }
                filterGroup.innerHTML = buttonsHTML;
            }

            // --- Initialize filters for each page ---
            initializePageFilters('movie-page', genresByCategory.movie);
            initializePageFilters('series-page', genresByCategory.series);
            initializePageFilters('games-page', genresByCategory.game);
            initializePageFilters('books-page', genresByCategory.book);

            // --- Helper function to update Genre datalist ---
            function updateGenreDatalist(category, clearValue = true) {
                genreDatalist.innerHTML = '';
                if (clearValue) {
                    genreInput.value = '';
                }

                if (category && genresByCategory[category]) {
                    genresByCategory[category].forEach(genre => {
                        const option = document.createElement('option');
                        option.value = genre;
                        genreDatalist.appendChild(option);
                    });
                }
            }

            // --- Event Listener for Category Change ---
            categoryInput.addEventListener('change', () => {
                updateGenreDatalist(categoryInput.value, true);
            });


            // --- Page Navigation ---
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    pages.forEach(page => page.style.display = 'none');
                    
                    const targetPageId = button.dataset.page;
                    const targetPage = document.getElementById(targetPageId);
                    if (targetPage) {
                        targetPage.style.display = 'block';
                    }
                    
                    searchInput.value = '';
                    if (targetPageId !== 'home-page') {
                        updateHomePageSearch(); 
                    }
                });
            });

            // --- Logo Button (Home) Navigation ---
            logoBtn.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                pages.forEach(page => page.style.display = 'none');
                homePage.style.display = 'block';
                searchInput.value = '';
                updateHomePageSearch(); // Clear search results on home
            });

            // --- Custom Message Function ---
            function showMessage(message, type = 'info') {
                messageEl.textContent = message;
                messageEl.className = 'show-message';
                messageEl.classList.add(type);
                messageEl.classList.add('show');
                
                setTimeout(() => {
                    messageEl.classList.remove('show');
                }, 3000);
            }

            // --- FUNCTION: Create Card HTML ---
            function createCardHTML(card) {
                // Supabase provides `id` and `created_at`
                const rating = (Math.random() * 4 + 6).toFixed(1); // Keep random rating for fun
                const year = new Date(card.created_at).getFullYear();
                
                return `
                    <div class="movie-card" 
                         data-id="${card.id}" 
                         data-tags="${card.tags || ''}" 
                         data-genre="${(card.genre || '').toLowerCase()}"
                         data-video-url="${card.videoUrl || ''}">
                        
                        ${card.videoUrl ? '<div class="play-btn-overlay"><i class="fas fa-play"></i></div>' : ''}

                        <div class="card-icons">
                            <button class="edit-btn"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-btn"><i class="fas fa-trash"></i></button>
                        </div>
                        <img src="${card.coverUrl}" alt="${card.title}" onerror="this.src='https://placehold.co/200x250/dce3eb/333?text=Image+Failed'">
                        <div class="details">
                            <div class="title">${card.title}</div>
                            <div class="genre">${card.genre || 'N/A'}</div>
                            <div class="meta">
                                <span class="rating"><i class="fas fa-star"></i> ${rating}</span>
                                <span>${year}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- FUNCTION: Create Home Card HTML ---
            function createHomeCardHTML(card) {
                const fallbackImg = 'https://placehold.co/300x200/dce3eb/333?text=Image+Failed';
                return `
                    <div class="home-hero-card" 
                         style="background-image: url('${card.coverUrl}'), url('${fallbackImg}')"
                         data-category="${card.category}"
                         data-video-url="${card.videoUrl || ''}">

                        ${card.videoUrl ? '<div class="play-btn-overlay"><i class="fas fa-play"></i></div>' : ''}

                        <div class="content">
                            <div class="title">${card.title}</div>
                            <div class="genre">${card.genre || 'N/A'}</div>
                        </div>
                    </div>
                `;
            }

            // --- FUNCTION: Create "Show All" Card HTML ---
            function createShowAllCardHTML(category) {
                let categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                categoryName = (category === 'series') ? 'Series' : `${categoryName}s`;
                
                return `
                    <div class="home-hero-card show-all-card" data-category="${category}">
                        <i class="fas fa-arrow-right"></i>
                        <span>Show All ${categoryName}</span>
                    </div>
                `;
            }

            // --- RENDER FUNCTION: Load Cards from Cache ---
            function loadCardsFromCache() {
                document.querySelectorAll('.movie-grid').forEach(grid => grid.innerHTML = '');
                
                allCardsCache.forEach(card => {
                    const cardHTML = createCardHTML(card);
                    const gridId = getPageIdForCategory(card.category);
                    const targetGrid = document.querySelector(`#${gridId} .movie-grid`);
                    
                    if (targetGrid) {
                        // Data is sorted newest-first, so 'beforeend' renders them in that order.
                        targetGrid.insertAdjacentHTML('beforeend', cardHTML);
                    } else {
                        console.warn(`Could not find grid for category: ${card.category}`);
                    }
                });
            }

            // --- RENDER FUNCTION: Populate Home Page from Cache ---
            function populateHomePageFromCache() {
                const categories = ['movie', 'series', 'game', 'book'];

                categories.forEach(category => {
                    const carouselId = (category === 'series') ? 'home-series' : `home-${category}s`;
                    const carousel = document.getElementById(carouselId);
                    if (!carousel) {
                        console.warn(`Could not find home carousel: ${carouselId}`);
                        return;
                    }

                    // Data is pre-sorted newest-first, so just take the first 5
                    const categoryCardsToShow = allCardsCache
                        .filter(c => c.category === category)
                        .slice(0, 5);

                    if (categoryCardsToShow.length === 0) {
                        carousel.innerHTML = '<p class="no-cards-msg">No uploads in this category yet.</p>';
                    } else {
                        let html = categoryCardsToShow.map(createHomeCardHTML).join('');
                        html += createShowAllCardHTML(category);
                        carousel.innerHTML = html;
                    }
                });
            }
            
            // --- RENDER FUNCTION: Update Category Hero from Cache ---
            function updateCategoryHeroFromCache(category) {
                if (!category) return;

                const heroId = getHeroIdForCategory(category);
                if (!heroId) return;

                const heroCard1 = document.getElementById(`${heroId}-hero-1`);
                const heroCard2 = document.getElementById(`${heroId}-hero-2`);

                if (!heroCard1 || !heroCard2) {
                    console.warn(`Hero cards not found for category: ${category} (using ID: ${heroId})`);
                    return; 
                }

                const heroTitle1 = heroCard1.querySelector('.content h2');
                const heroButton1 = heroCard1.querySelector('.content .play-button');
                const heroTitle2 = heroCard2.querySelector('.content h2');
                const heroButton2 = heroCard2.querySelector('.content .play-button');

                const defaults = defaultHeroData[category];
                if (!defaults) return; 

                // Data is pre-sorted newest-first
                const categoryCards = allCardsCache.filter(card => card.category === category);

                // Update Hero Card 1 (Last Uploaded)
                if (categoryCards.length > 0) {
                    const lastCard = categoryCards[0]; // [0] is newest
                    heroTitle1.textContent = lastCard.title;
                    heroButton1.innerHTML = `<i class="fas ${defaults.hero1.icon}"></i> ${defaults.hero1.button}`;
                    
                    const img1 = new Image();
                    img1.onload = () => heroCard1.style.backgroundImage = `url('${lastCard.coverUrl}')`;
                    img1.onerror = () => heroCard1.style.backgroundImage = defaults.hero1.image;
                    img1.src = lastCard.coverUrl;
                } else {
                    heroTitle1.textContent = defaults.hero1.title;
                    heroButton1.innerHTML = `<i class="fas ${defaults.hero1.icon}"></i> ${defaults.hero1.button}`;
                    heroCard1.style.backgroundImage = defaults.hero1.image;
                }

                // Update Hero Card 2 (Second-to-Last Uploaded)
                if (categoryCards.length > 1) {
                    const secondLastCard = categoryCards[1]; // [1] is second newest
                    heroTitle2.textContent = secondLastCard.title;
                    heroButton2.innerHTML = `<i class="fas ${defaults.hero2.icon}"></i> ${defaults.hero2.button}`;
                    
                    const img2 = new Image();
                    img2.onload = () => heroCard2.style.backgroundImage = `url('${secondLastCard.coverUrl}')`;
                    img2.onerror = () => heroCard2.style.backgroundImage = defaults.hero2.image;
                    img2.src = secondLastCard.coverUrl;
                } else {
                    heroTitle2.textContent = defaults.hero2.title;
                    heroButton2.innerHTML = `<i class="fas ${defaults.hero2.icon}"></i> ${defaults.hero2.button}`;
                    heroCard2.style.backgroundImage = defaults.hero2.image;
                }
            }
            
            // --- RENDER FUNCTION: Helper to update all heroes ---
            function updateAllCategoryHeroesFromCache() {
                updateCategoryHeroFromCache('movie');
                updateCategoryHeroFromCache('series');
                updateCategoryHeroFromCache('game');
                updateCategoryHeroFromCache('book');
            }
            
            // --- DATA FUNCTION: Main Async Fetch ---
            async function fetchAndRenderAllData() {
                // Show loading state? For now, just fetch.
                const { data, error } = await db.from('cards')
                                                 .select('*')
                                                 .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error fetching data:', error);
                    showMessage('Could not load data from database.', 'error');
                    return;
                }

                allCardsCache = data; // Update cache

                // Re-render everything
                loadCardsFromCache();
                populateHomePageFromCache();
                updateAllCategoryHeroesFromCache();
            }


            // --- Upload Modal Logic ---
            function resetUploadModal() {
                uploadForm.reset();
                cardIdInput.value = '';
                modalTitle.textContent = 'Upload New Card';
                submitBtn.textContent = 'Submit Card';
                submitBtn.disabled = false;
                uploadForm.removeAttribute('data-old-category');
                updateGenreDatalist('', true);
            }
            
            function showUploadModal() {
                modalOverlay.classList.add('show');
            }
            
            function hideUploadModal() {
                modalOverlay.classList.remove('show');
                resetUploadModal(); // Reset form when hiding
            }

            openModalBtn.addEventListener('click', () => {
                resetUploadModal();
                showUploadModal();
            });
            
            cancelBtn.addEventListener('click', hideUploadModal);
            
            modalOverlay.addEventListener('click', function(event) {
                if (event.target === modalOverlay) {
                    hideUploadModal();
                }
            });

            // --- Handle Form Submission (Upload and Edit) ---
            uploadForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                
                const editingCardId = cardIdInput.value;
                
                const cardData = {
                    title: titleInput.value,
                    category: categoryInput.value,
                    genre: genreInput.value,
                    tags: tagsInput.value,
                    coverUrl: coverUrlInput.value,
                    videoUrl: videoUrlInput.value || null // Use null for empty
                };
                
                let error;

                try {
                    if (editingCardId) {
                        // --- EDITING ---
                        const { error: updateError } = await db.from('cards')
                                                              .update(cardData)
                                                              .eq('id', editingCardId);
                        error = updateError;
                    } else {
                        // --- UPLOADING NEW ---
                        // Supabase adds id and created_at automatically
                        const { error: insertError } = await db.from('cards')
                                                              .insert(cardData);
                        error = insertError;
                    }

                    if (error) throw error; // Handle error below

                    // SUCCESS: Re-fetch all data and re-render
                    await fetchAndRenderAllData(); 
                    
                    hideUploadModal();
                    showMessage(editingCardId ? 'Card updated!' : 'Card uploaded!', 'success');
                    
                } catch (err) {
                    console.error("Error submitting form:", err);
                    showMessage(err.message || 'An unknown error occurred.', 'error');
                } finally {
                    // Reset button state even on error
                    submitBtn.disabled = false;
                    if (editingCardId) {
                        submitBtn.textContent = 'Save Changes';
                    } else {
                        submitBtn.textContent = 'Submit Card';
                    }
                }
            });

            
            // --- Search Functions ---
            function checkCardMatch(cardData, term) {
                if (!term) return true; 
                const { title, genre, tags } = cardData;
                return (title && title.toLowerCase().includes(term)) ||
                       (genre && genre.toLowerCase().includes(term)) ||
                       (tags && tags.toLowerCase().includes(term));
            }

            function updateCategoryPageSearch(pageElement) {
                const searchTerm = searchInput.value.toLowerCase();
                const activeFilterBtn = pageElement.querySelector('.filter-button.active');
                const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter.toLowerCase() : 'all';
                
                const grid = pageElement.querySelector('.movie-grid');
                if (!grid) return;
                const cards = grid.querySelectorAll('.movie-card');

                cards.forEach(card => {
                    let matchesFilter = false;
                    if (activeFilter === 'all') {
                        matchesFilter = true;
                    } else if (activeFilter === 'trending') {
                        matchesFilter = card.dataset.tags.toLowerCase().includes('trending');
                    } else {
                        matchesFilter = (card.dataset.genre === activeFilter);
                    }

                    const cardData = {
                        title: card.querySelector('.title').textContent,
                        genre: card.dataset.genre,
                        tags: card.dataset.tags
                    };
                    const matchesSearch = checkCardMatch(cardData, searchTerm);

                    card.style.display = (matchesFilter && matchesSearch) ? 'block' : 'none';
                });
            }

            function updateHomePageSearch() {
                const searchTerm = searchInput.value.toLowerCase();

                if (!searchTerm) {
                    homeCarousels.forEach(c => c.style.display = 'block');
                    searchResultsSection.style.display = 'none';
                    searchResultsGrid.innerHTML = '';
                } else {
                    homeCarousels.forEach(c => c.style.display = 'none');
                    searchResultsSection.style.display = 'block';
                    
                    // Use the cache instead of DB
                    const searchResults = allCardsCache.filter(card => {
                        const cardData = { title: card.title, genre: card.genre, tags: card.tags };
                        return checkCardMatch(cardData, searchTerm);
                    });

                    if (searchResults.length > 0) {
                        searchResultsGrid.innerHTML = searchResults.map(createCardHTML).join('');
                    } else {
                        searchResultsGrid.innerHTML = '<p class="no-cards-msg">No results found for your search.</p>';
                    }
                }
            }

            // --- Search Input Event Listener ---
            searchInput.addEventListener('keyup', () => {
                const activePage = getActivePage();
                
                if (activePage.id === 'home-page') {
                    updateHomePageSearch();
                } else {
                    updateCategoryPageSearch(activePage); // Fixed typo here
                }
            });
            

            // --- Event Delegation (Edit/Delete/Filter/Home Card/Play) ---
            document.querySelector('.container').addEventListener('click', function(event) {
                const editBtn = event.target.closest('.edit-btn');
                const deleteBtn = event.target.closest('.delete-btn');
                const filterBtn = event.target.closest('.filter-button:not(.show-all-btn)');
                const homeCard = event.target.closest('.home-hero-card');
                const showAllBtn = event.target.closest('.show-all-btn');
                const playBtn = event.target.closest('.play-btn-overlay'); 

                
                // 1. Handle Video Play Click
                if (playBtn) {
                    if(playBtn.closest('.home-carousel.grabbing')) return; 

                    const card = playBtn.closest('[data-video-url]');
                    if (card) {
                        const videoUrl = card.dataset.videoUrl;
                        if (videoUrl) {
                            window.open(videoUrl, '_blank');
                        } else {
                            showMessage('No video URL found for this card.', 'error');
                        }
                    }
                } 
                
                // 2. Handle Home Card Click (only if play wasn't clicked)
                else if (homeCard) {
                    if(homeCard.closest('.home-carousel.grabbing')) return; 

                    const category = homeCard.dataset.category;
                    if (category) {
                        const pageId = getPageIdForCategory(category);
                        const targetNavButton = document.querySelector(`.main-nav button[data-page="${pageId}"]`);
                        if (targetNavButton) {
                            targetNavButton.click();
                        }
                    }
                }
                
                // 3. Handle Show All Click
                else if (showAllBtn) {
                    const filterGroup = showAllBtn.closest('.filter-group');
                    if (filterGroup) {
                        filterGroup.classList.toggle('expanded');
                        const isExpanded = filterGroup.classList.contains('expanded');
                        showAllBtn.innerHTML = isExpanded 
                            ? '<i class="fas fa-chevron-up"></i> Show Less' 
                            : '<i class="fas fa-chevron-down"></i> Show All';
                    }
                }
                
                // 4. Handle FILTER Click
                else if (filterBtn) {
                    const pageContent = filterBtn.closest('.page-content');
                    if (!pageContent) return;

                    const filterGroup = filterBtn.closest('.filter-group');
                    filterGroup.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                    filterBtn.classList.add('active');

                    const titleElement = pageContent.querySelector('.trending-section h3');
                    if (titleElement) {
                        const filterType = filterBtn.dataset.filter.toLowerCase();
                        const filterText = filterBtn.textContent.trim();
                        if (filterType === 'all') {
                            const pageName = pageContent.id.split('-')[0];
                            const capitalPageName = pageName.charAt(0).toUpperCase() + pageName.slice(1);
                            titleElement.textContent = `All ${capitalPageName}`;
                        } else if (filterType === 'trending') {
                            titleElement.textContent = 'Trending Now';
                        } else {
                            const genreName = filterText.charAt(0).toUpperCase() + filterText.slice(1);
                            titleElement.textContent = `Genre: ${genreName}`;
                        }
                    }

                    updateCategoryPageSearch(pageContent);
                }
                
                // 5. Handle EDIT Click
                else if (editBtn) {
                    const card = editBtn.closest('.movie-card');
                    const cardId = parseInt(card.dataset.id, 10);
                    const cardData = allCardsCache.find(c => c.id === cardId);
                    
                    if (cardData) {
                        modalTitle.textContent = 'Edit Card';
                        submitBtn.textContent = 'Save Changes';
                        cardIdInput.value = cardData.id;
                        titleInput.value = cardData.title;
                        categoryInput.value = cardData.category;
                        tagsInput.value = cardData.tags;
                        coverUrlInput.value = cardData.coverUrl;
                        videoUrlInput.value = cardData.videoUrl || '';
                        uploadForm.dataset.oldCategory = cardData.category; // Store old category
                        
                        updateGenreDatalist(cardData.category, false);
                        genreInput.value = cardData.genre;
                        
                        showUploadModal();
                    } else {
                        showMessage('Could not find card data to edit.', 'error');
                    }
                }
                
                // 6. Handle DELETE Click
                else if (deleteBtn) {
                    cardToDelete = deleteBtn.closest('.movie-card');
                    if (cardToDelete) {
                        confirmModalOverlay.classList.add('show');
                    }
                }
            });
            

            // --- Delete Confirmation Logic ---
            function closeConfirmModal() {
                confirmModalOverlay.classList.remove('show');
                cardToDelete = null;
            }

            cancelDeleteBtn.addEventListener('click', closeConfirmModal);
            
            confirmModalOverlay.addEventListener('click', function(event) {
                if (event.target === confirmModalOverlay) {
                    closeConfirmModal();
                }
            });

            confirmDeleteBtn.addEventListener('click', async function() {
                if (cardToDelete) {
                    const cardId = cardToDelete.dataset.id;
                    
                    // Optimistically add deleting class
                    cardToDelete.classList.add('deleting');
                    
                    try {
                        const { error } = await db.from('cards').delete().eq('id', cardId);
                        if (error) throw error;

                        // SUCCESS: Re-fetch all data to re-render everything
                        await fetchAndRenderAllData(); 
                        showMessage('Card deleted successfully.', 'success');
                        
                    } catch (err) {
                        console.error('Error during deletion:', err);
                        showMessage(err.message || 'Error deleting card.', 'error');
                        // Rollback optimistic UI change if error
                        if(cardToDelete) cardToDelete.classList.remove('deleting');
                    } finally {
                        closeConfirmModal();
                    }
                }
            });
            
            // --- INITIAL DATA LOAD ---
            fetchAndRenderAllData();

        });
    </script>
</body>
</html>

