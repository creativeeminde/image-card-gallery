<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Character Gallery</title>
  <link rel="icon" href="https://ik.imagekit.io/xfifcyvcg/P_icon.ico?updatedAt=1748049193174" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a1b26;
      background-image: radial-gradient(#3c3f58 0.5px, transparent 0.5px);
      background-size: 15px 15px;
      color: #f0f0f0;
    }
    /* Custom scrollbar for a better look in dark mode */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1a1b26;
    }
    ::-webkit-scrollbar-thumb {
      background: #4a4e69;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #5a5f80;
    }
    .popup-content, #details-view, #image-preview-view, #video-preview-view {
        animation: slide-up 0.4s ease-out;
    }
    @keyframes slide-up {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    .tag {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .tag.selected {
        background-color: #2563eb;
        color: white;
    }
    .gradient-text {
        background: linear-gradient(to right, #c77dff, #e18d9f);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    #preview-image {
        transition: transform 0.2s ease-out;
        cursor: grab;
    }
     #preview-image.is-panning {
        cursor: grabbing;
    }
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .sortable-ghost {
        opacity: 0.4;
        background-color: #4a4e69;
        border-radius: 0.375rem; /* rounded-md */
    }
    .cursor-grab {
        cursor: grab;
    }
    .cursor-grab:active {
        cursor: grabbing;
    }

    /* Styles for new video controls */
    .card-container:hover .seek-bar-container,
    .card-container:hover .speed-controls {
        opacity: 1;
    }
    .seek-bar-container {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 25px; 
        display: flex;
        align-items: center;
        cursor: pointer;
        opacity: 0; 
        transition: opacity 0.2s ease-in-out;
        background-image: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
        z-index: 5;
    }
    .seek-bar {
        position: relative;
        width: calc(100% - 20px);
        height: 5px;
        background-color: rgba(255, 255, 255, 0.5);
        margin: 0 10px;
        border-radius: 3px;
    }
    .seek-progress {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0%;
        background-color: #2563eb;
        border-radius: 3px;
    }
    .seek-handle {
        position: absolute;
        top: 50%;
        left: 0%;
        width: 14px;
        height: 14px;
        background-color: white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        box-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    .speed-controls {
      position: absolute;
      bottom: 30px; 
      left: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      background: rgba(0, 0, 0, 0.4);
      padding: 2px 8px;
      border-radius: 15px;
    }
    .speed-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      width: 22px;
      height: 22px;
      line-height: 22px;
      text-align: center;
      padding: 0;
      transition: transform 0.1s;
    }
    .speed-btn:active {
        transform: scale(0.9);
    }
    .speed-display {
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
      min-width: 28px;
      text-align: center;
      user-select: none;
    }
    
    /* Styles for resizable/draggable image */
    #details-image-transform-box:active {
        cursor: grabbing;
    }
    .resize-handle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid #333;
        border-radius: 2px;
        z-index: 10;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        pointer-events: none;
    }
    .resize-handle[data-direction="n"] { top: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
    .resize-handle[data-direction="ne"] { top: -6px; right: -6px; cursor: nesw-resize; }
    .resize-handle[data-direction="e"] { top: 50%; right: -6px; transform: translateY(-50%); cursor: ew-resize; }
    .resize-handle[data-direction="se"] { bottom: -6px; right: -6px; cursor: nwse-resize; }
    .resize-handle[data-direction="s"] { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
    .resize-handle[data-direction="sw"] { bottom: -6px; left: -6px; cursor: nesw-resize; }
    .resize-handle[data-direction="w"] { top: 50%; left: -6px; transform: translateY(-50%); cursor: ew-resize; }
    .resize-handle[data-direction="nw"] { top: -6px; left: -6px; cursor: nwse-resize; }
    
    #details-image-transform-box.is-selected {
        outline: 2px dashed rgba(255, 255, 255, 0.5);
    }
    #details-image-transform-box.is-selected .resize-handle {
        opacity: 1;
        pointer-events: auto;
    }

    /* ===== MOBILE FIXES ===== */
    @media (max-width: 767px) {
        #details-image-transform-box {
            /* Override inline styles to fix position and size to fill its container */
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
            position: relative !important; /* Changing to relative makes it fill the flex container naturally */
            cursor: default !important;
        }

        #details-image-transform-box.is-selected {
            outline: none !important;
        }

        #details-image-transform-box .resize-handle {
            display: none !important;
        }
    }
    
    /* File input custom styling */
    .file-drop-area {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 100%;
      padding: 25px;
      border: 2px dashed #4a4e69;
      border-radius: 8px;
      transition: 0.2s;
      background-color: #1a1b26;
    }
    .file-drop-area.is-active {
      background-color: #2a2d3d;
      border-color: #2563eb;
    }
    .fake-btn {
      flex-shrink: 0;
      background-color: #3c3f58;
      border: 1px solid #4a4e69;
      border-radius: 4px;
      padding: 8px 15px;
      margin-right: 10px;
      font-size: 12px;
      text-transform: uppercase;
    }
    .file-msg {
      font-size: small;
      font-weight: 300;
      line-height: 1.4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-input {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 100%;
      cursor: pointer;
      opacity: 0;
    }
  </style>
</head>
<body class="antialiased">

  <div class="container mx-auto p-4 md:p-8">
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:gap-4">
        <h1 class="text-3xl font-bold text-white tracking-tight">Character Gallery</h1>
        <span id="character-counter" class="mt-2 sm:mt-0 text-lg font-medium bg-[#2a2d3d] text-gray-200 px-3 py-1 rounded-full w-fit">
            Loading...
        </span>
    </div>

    <header class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8">
      <div class="relative w-full sm:w-auto sm:flex-grow max-w-md">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <input type="text" id="searchInput" placeholder="Search for a character..." class="w-full bg-[#2a2d3d] text-white border border-transparent rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
      </div>
      <div class="flex items-center gap-4">
        <div class="relative">
            <button id="filterButton" class="bg-[#2a2d3d] text-white rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-[#3a3d4d] transition">
                <svg class="h-5 w-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Filter
            </button>
            <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#2a2d3d] rounded-lg shadow-xl z-10 overflow-hidden max-h-60 overflow-y-auto">
                </div>
        </div>
        <div class="relative">
        
            <button id="sortButton" class="bg-[#2a2d3d] text-white rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-[#3a3d4d] transition">
                <svg class="h-5 w-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M7 12h10M10 18h4"/></svg>
                Sort By
            </button>
            <div id="sortDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#2a2d3d] rounded-lg shadow-xl z-10 overflow-hidden">
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="title_asc">Name (A-Z)</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="title_desc">Name (Z-A)</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="created_at_desc">Newest</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="created_at_asc">Oldest</a>
            </div>
        </div>
        <button id="newTagButton" class="bg-[#2a2d3d] text-white rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-[#3a3d4d] transition">
            <svg class="h-5 w-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>
            New Tag
        </button>
        <button id="addCardBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-blue-700 transition shadow-lg shadow-blue-600/20">
          <svg class="h-5 w-5 pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
          New Character
        </button>
    
      </div>
    </header>

    <main id="card-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-12">
      </main>
    <div id="loading" class="text-center py-10 hidden">Loading...</div>
    <div id="no-results" class="text-center py-10 hidden">No characters found.</div>

  </div>
  
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
      <button id="closePopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <h3 class="text-xl font-bold mb-6">Add New Character</h3>
      <form id="cardForm">
        <div class="mb-4">
          <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Character Name</label>
          <input type="text" id="title" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        </div>
     
       <div class="mb-4">
          <label for="imageUrl" class="block text-sm font-medium text-gray-300 mb-1">Image URL</label>
          <input type="text" id="imageUrl" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
            <div id="selectedTags" class="mb-2 flex flex-wrap gap-2"></div>
     
           <div class="flex gap-2">
                <input type="text" id="tagInput" placeholder="Add a new tag..." class="flex-grow bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button type="button" id="addTagBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-4 hover:bg-gray-700 transition">Add</button>
            </div>
            <div id="tagPool" class="mt-2 flex flex-wrap gap-1"></div>
    
         </div>

        <p id="errorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
        <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition shadow-lg shadow-blue-600/20">Save Character</button>
      </form>
    </div>
  </div>

  <div id="new-tag-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-sm p-6 relative">
      <button id="closeNewTagPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      <h3 class="text-xl font-bold mb-6">Create a New Tag</h3>
      <form id="newTagForm">
        <div class="mb-4">
          <label for="newTagName" class="block text-sm font-medium text-gray-300 mb-1">Tag Name</label>
          <input type="text" id="newTagName" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        </div>
        <p id="newTagErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
        <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Create Tag</button>
      </form>
    </div>
  </div>


  <div id="details-view" class="hidden fixed inset-0 bg-[#1a1b26] z-[100] p-4 md:p-8 overflow-y-auto">
      <button id="closeDetailsBtn" class="absolute top-6 right-6 text-gray-400 hover:text-white transition z-10">
          <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
             <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
      </button>
      
      <!-- New Navigation Arrows -->
      <button id="prevDetailBtn" class="fixed left-4 top-1/2 -translate-y-1/2 z-[110] text-white/50 hover:text-white transition p-3 bg-black/40 hover:bg-black/60 rounded-full backdrop-blur-sm">
        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
      </button>
      <button id="nextDetailBtn" class="fixed right-4 top-1/2 -translate-y-1/2 z-[110] text-white/50 hover:text-white transition p-3 bg-black/40 hover:bg-black/60 rounded-full backdrop-blur-sm">
        <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
      </button>

      <div class="container mx-auto grid grid-cols-1 md:grid-cols-12 gap-4 items-center h-full">
            <div id="details-image-container" class="md:col-span-7 flex items-center justify-center h-96 md:h-full relative overflow-hidden bg-black/10 rounded-lg">
                <div id="details-image-transform-box" style="position: absolute; cursor: grab;">
                    <img id="details-main-image" src="" alt="Character Image" class="w-full h-full object-contain pointer-events-none select-none">
                    <div class="resize-handle" data-direction="n"></div>
                    <div class="resize-handle" data-direction="ne"></div>
                    <div class="resize-handle" data-direction="e"></div>
                    <div class="resize-handle" data-direction="se"></div>
                    <div class="resize-handle" data-direction="s"></div>
                    <div class="resize-handle" data-direction="sw"></div>
                    <div class="resize-handle" data-direction="w"></div>
                    <div class="resize-handle" data-direction="nw"></div>
                </div>
            </div>

      
         <div class="md:col-span-5 pt-10 md:pt-20">
              <h2 class="text-gray-400 text-2xl font-bold tracking-widest">GENERAL DATA</h2>
              <h1 id="details-title" class="gradient-text text-7xl md:text-8xl lg:text-8xl font-extrabold my-2 break-words">
                  </h1>

              <h3 class="text-gray-300 text-lg font-semibold mt-8 mb-3">Tags</h3>
              <div id="details-tags" class="flex flex-wrap gap-2">
                  </div>

              <div id="details-related-images-container" class="mt-8">
                   <div class="flex items-center justify-between mb-3">
                        <h3 class="text-gray-300 text-lg font-semibold">Related Images</h3>
            
                         <div id="details-controls" class="flex gap-2">
                            <button id="addRelatedBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-blue-700 transition">
                                <svg class="h-4 w-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                Add
                            </button>
                            <button id="uploadRelatedBtn" class="bg-green-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-green-700 transition">
                                <svg class="h-4 w-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.25 13.25a.75.75 0 001.5 0V4.636l2.955 3.129a.75.75 0 001.09-1.03l-4.25-4.5a.75.75 0 00-1.09 0l-4.25 4.5a.75.75 0 101.09 1.03L9.25 4.636v8.614z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
           
                                 Upload
                            </button>
                            <button id="manageRelatedBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-gray-700 transition">
          
                               <svg class="h-4 w-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                             
                                 Manage
                            </button>
                        </div>
                   </div>
                   <div id="details-related-images" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                       </div>
              </div>

              <div id="details-related-videos-container" class="mt-8">
                   <div class="flex items-center justify-between mb-3">
                        <h3 class="text-gray-300 text-lg font-semibold">Related Videos</h3>
                        <div id="details-video-controls" class="flex gap-2">
                            <button id="addRelatedVideoBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-blue-700 transition">
                                <svg class="h-4 w-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                Add
                            </button>
                            <button id="manageRelatedVideosBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-gray-700 transition">
                                <svg class="h-4 w-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                                Manage
                            </button>
                            </div>
                   </div>
                   <div id="details-related-videos" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                   </div>
              </div>
          </div>
      </div>
  </div>
  
  <div id="related-image-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
      <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
          <button id="closeRelatedPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
              <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
          <h3 class="text-xl font-bold mb-6">Add Related Images</h3>
          <form id="relatedImagesForm">
              <div class="mb-4">
               
                  <label for="relatedImageUrls" class="block text-sm font-medium text-gray-300 mb-1">Image URLs (one per line, comma or space separated)</label>
                  <textarea id="relatedImageUrls" rows="5" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="https://example.com/image1.jpg\nhttps://example.com/image2.png"></textarea>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Tags for these images</label>
  
                               <div id="relatedSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="relatedTagPool" class="mt-2 flex flex-wrap gap-1"></div>
              </div>

              <p id="relatedErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
              <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Add Images</button>
   
           </form>
      </div>
  </div>

  <div id="edit-related-tags-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
        <button id="closeEditRelatedTagsPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      
         <h3 class="text-xl font-bold mb-4">Edit Image Tags</h3>
        <form id="editRelatedTagsForm">
            <img id="edit-related-preview-image" src="" class="w-full h-48 object-contain bg-black/20 rounded-lg mb-4">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
              <div id="editRelatedSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
             
               <div id="editRelatedTagPool" class="mt-2 flex flex-wrap gap-1 max-h-24 overflow-y-auto"></div>
            </div>
            <p id="editRelatedTagsErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
            <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Save Tags</button>
        </form>
    </div>
  </div>

  <div id="image-preview-view" class="hidden fixed inset-0 bg-black/90 z-[200] flex items-center justify-center p-4">
      <div class="relative w-full h-full flex items-center justify-center">
   
           <img id="preview-image" src="" class="max-w-full max-h-full object-contain">
        
        <button id="closePreviewBtn" class="absolute top-4 right-4 text-white/70 hover:text-white transition">
            <svg class="h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>

        <button id="prevPreviewBtn" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition bg-black/30 rounded-full p-2">
          
             <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
        </button>
        <button id="nextPreviewBtn" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition bg-black/30 rounded-full p-2">
            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
        </button>

        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-black/40 p-2 rounded-lg">
            <span id="previewCounter" class="text-white text-sm font-medium w-16 text-center"></span>
             <button id="zoomOutBtn" class="text-white/80 hover:text-white transition"><svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="zoomInBtn" class="text-white/80 hover:text-white transition"><svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="resetZoomBtn" class="text-white/80 hover:text-white transition"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.42 5.5 5.5 0 018.253-1.655l1.454-1.454a.75.75 0 011.06 1.06l-1.453 1.454a5.494 5.494 0 01-.01 2.01zm-1.85 2.152a.75.75 0 01-1.06 1.06l-1.455-1.454a5.5 5.5 0 01-8.253 1.655 5.5 5.5 0 019.201 4.42l-1.454 1.454a.75.75 0 11-1.06 1.06l1.453-1.454a5.494 5.494 0 01.01-2.01z" clip-rule="evenodd" /></svg></button>
        </div>
      </div>
  </div>

  <div id="related-video-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
      <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
          <button id="closeRelatedVideoPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
              <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
          <h3 class="text-xl font-bold mb-6">Add Related Videos</h3>
          <form id="relatedVideosForm">
              <div class="mb-4">
                  <label for="relatedVideoUrls" class="block text-sm font-medium text-gray-300 mb-1">Video URLs (one per line)</label>
                  <textarea id="relatedVideoUrls" rows="5" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="https://example.com/video.mp4"></textarea>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Tags for these videos</label>
                <div id="relatedVideoSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="relatedVideoTagPool" class="mt-2 flex flex-wrap gap-1"></div>
              </div>
              <p id="relatedVideoErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
              <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Add Videos</button>
          </form>
      </div>
  </div>
  
  <div id="edit-related-video-tags-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
        <button id="closeEditRelatedVideoTagsPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
         <h3 class="text-xl font-bold mb-4">Edit Video Tags</h3>
        <form id="editRelatedVideoTagsForm">
            <div id="edit-related-preview-video" class="w-full h-48 flex items-center justify-center bg-black/20 rounded-lg mb-4">
                </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
              <div id="editRelatedVideoSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
               <div id="editRelatedVideoTagPool" class="mt-2 flex flex-wrap gap-1 max-h-24 overflow-y-auto"></div>
            </div>
            <p id="editRelatedVideoTagsErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
            <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Save Tags</button>
        </form>
    </div>
  </div>
  <div id="video-preview-view" class="hidden fixed inset-0 bg-black/90 z-[400] flex items-center justify-center p-4">
      <div class="relative w-full max-w-4xl max-h-full">
          <div id="video-player-container" class="aspect-video bg-black">
              </div>
          <button id="closeVideoPreviewBtn" class="absolute -top-4 -right-4 md:top-2 md:right-2 text-white/70 hover:text-white transition bg-black/50 rounded-full p-1">
              <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
      </div>
  </div>

  <button id="scrollToTopBtn" class="hidden fixed bottom-8 right-8 bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700 transition-all duration-300 hover:scale-110 z-50">
    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
    </svg>
  </button>


  <script>
    const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';

    let supabaseClient;
    
    // Initialize Supabase with error handling for mobile networks
    try {
        if (!window.supabase) throw new Error("Supabase library not loaded");
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (err) {
        console.error("Supabase init error:", err);
        alert("Network Error: Could not connect to the database. Please check your internet connection.");
    }

    // Main gallery elements
    const cardGallery = document.getElementById('card-gallery');
    const searchInput = document.getElementById('searchInput');
    const loadingIndicator = document.getElementById('loading');
    const noResultsMessage = document.getElementById('no-results');
    // Popup elements
    const addCardBtn = document.getElementById('addCardBtn');
    const popup = document.getElementById('popup');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const cardForm = document.getElementById('cardForm');
    const addTagBtn = document.getElementById('addTagBtn');
    const tagInput = document.getElementById('tagInput');
    // Filter & Sort elements
    const sortButton = document.getElementById('sortButton');
    const sortDropdown = document.getElementById('sortDropdown');
    const filterButton = document.getElementById('filterButton');
    const filterDropdown = document.getElementById('filterDropdown');
    
    // New Tag elements
    const newTagButton = document.getElementById('newTagButton');
    const newTagPopup = document.getElementById('new-tag-popup');
    const closeNewTagPopupBtn = document.getElementById('closeNewTagPopupBtn');
    const newTagForm = document.getElementById('newTagForm');

    // Details View elements
    const detailsView = document.getElementById('details-view');
    const closeDetailsBtn = document.getElementById('closeDetailsBtn');
    const detailsMainImage = document.getElementById('details-main-image');
    const detailsTitle = document.getElementById('details-title');
    const detailsTags = document.getElementById('details-tags');
    const detailsRelatedImages = document.getElementById('details-related-images');
    const detailsRelatedImagesContainer = document.getElementById('details-related-images-container');
    const addRelatedBtn = document.getElementById('addRelatedBtn');
    const uploadRelatedBtn = document.getElementById('uploadRelatedBtn');
    const manageRelatedBtn = document.getElementById('manageRelatedBtn');
    const prevDetailBtn = document.getElementById('prevDetailBtn');
    const nextDetailBtn = document.getElementById('nextDetailBtn');
    
    // Image transform elements
    const detailsImageContainer = document.getElementById('details-image-container');
    const detailsImageTransformBox = document.getElementById('details-image-transform-box');

    // Add Related Popup
    const relatedImagePopup = document.getElementById('related-image-popup');
    const closeRelatedPopupBtn = document.getElementById('closeRelatedPopupBtn');
    const relatedImagesForm = document.getElementById('relatedImagesForm');
    const relatedTagPool = document.getElementById('relatedTagPool');

    // Edit Related Tags Popup
    const editRelatedTagsPopup = document.getElementById('edit-related-tags-popup');
    const closeEditRelatedTagsPopupBtn = document.getElementById('closeEditRelatedTagsPopupBtn');
    const editRelatedTagsForm = document.getElementById('editRelatedTagsForm');
    const editRelatedPreviewImage = document.getElementById('edit-related-preview-image');

    // Image Preview
    const imagePreviewView = document.getElementById('image-preview-view');
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    const previewImage = document.getElementById('preview-image');
    const prevPreviewBtn = document.getElementById('prevPreviewBtn');
    const nextPreviewBtn = document.getElementById('nextPreviewBtn');
    const previewCounter = document.getElementById('previewCounter');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');
    
    // Video Elements
    const detailsRelatedVideos = document.getElementById('details-related-videos');
    const addRelatedVideoBtn = document.getElementById('addRelatedVideoBtn');
    const manageRelatedVideosBtn = document.getElementById('manageRelatedVideosBtn');
    const relatedVideoPopup = document.getElementById('related-video-popup');
    const closeRelatedVideoPopupBtn = document.getElementById('closeRelatedVideoPopupBtn');
    const relatedVideosForm = document.getElementById('relatedVideosForm');
    const videoPreviewView = document.getElementById('video-preview-view');
    const closeVideoPreviewBtn = document.getElementById('closeVideoPreviewBtn');
    const videoPlayerContainer = document.getElementById('video-player-container');
    const editRelatedVideoTagsPopup = document.getElementById('edit-related-video-tags-popup');
    const closeEditRelatedVideoTagsPopupBtn = document.getElementById('closeEditRelatedVideoTagsPopupBtn');
    const editRelatedVideoTagsForm = document.getElementById('editRelatedVideoTagsForm');
    const editRelatedPreviewVideo = document.getElementById('edit-related-preview-video');

    // State variables
    let currentlyEditingCardId = null;
    let currentCardForDetails = null;
    let currentSort = { column: 'created_at', ascending: false }; 
    let selectedFilterTag = '';
    let allTags = new Set();
    let selectedTags = [];
    let selectedRelatedTags = [];
    let selectedRelatedVideoTags = [];
    let isManageRelatedMode = false;
    let isManageRelatedVideosMode = false;
    let filteredItemsForPreview = [];
    let currentDisplayList = [];
    // Edit Related Tags Popup State
    let currentlyEditingRelatedImage = null;
    let selectedTagsForEdit = [];
    // Edit Related Video Tags Popup State
    let currentlyEditingRelatedVideo = null;
    let selectedVideoTagsForEdit = [];
    // Preview State
    let previewImages = [];
    let currentPreviewIndex = 0;
    let currentZoom = 1;
    let lastScrollPosition = 0;
    // Panning State
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let panOffset = { x: 0, y: 0 };
    let sortable = null;

    // Image transform state
    let imageTransform = {
        isDragging: false,
        isResizing: false,
        direction: null,
        startX: 0,
        startY: 0,
        startLeft: 0,
        startTop: 0,
        startWidth: 0,
        startHeight: 0,
        containerRect: null,
    };
    
    // --- Utilities ---
    let debounceTimer;
    function debounce(func, delay) {
        return function(...args) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(this, args), delay);
        }
    }
    function customConfirm(message) { return new Promise(resolve => resolve(confirm(message))); }

    const debouncedSaveMainImageStyle = debounce(saveMainImageStyle, 1000);


    // --- Data Fetching and Display ---
    async function fetchAllTags() {
        if (!supabaseClient) return;
        try {
            const { data, error } = await supabaseClient.from('cards').select('tags, related_images_with_tags, related_videos_with_tags');
            if (error) throw error;
            
            // Keep existing tags in the set, only add new ones
            data.forEach(card => {
                if (card.tags) {
                    card.tags.split(',').forEach(tag => {
                        if(tag.trim()) allTags.add(tag.trim());
                    });
                }
             
               if(card.related_images_with_tags) {
                    card.related_images_with_tags.forEach(img => {
                        if (img.tags) {
                            img.tags.split(',').forEach(tag => {
                                if(tag.trim()) allTags.add(tag.trim());
                            });
                        }
                    });
                }
                if(card.related_videos_with_tags) {
                    card.related_videos_with_tags.forEach(video => {
                        if (video.tags) {
                            video.tags.split(',').forEach(tag => {
                                if(tag.trim()) allTags.add(tag.trim());
                            });
                        }
                    });
                }
            });
            updateTagDisplays();
        } catch (error) {
            console.error('Error fetching tags:', error);
        }
    }

    async function loadCards() {
        if (!supabaseClient) return;
        document.getElementById('character-counter').textContent = 'Loading...';
        loadingIndicator.classList.remove('hidden');
        cardGallery.innerHTML = '';
        noResultsMessage.classList.add('hidden');
        
        // Removed separate await fetchAllTags() to prevent double loading
        
        try {
            let query = supabaseClient.from('cards').select('*');
            const searchTerm = searchInput.value.trim();
            if (searchTerm) query = query.ilike('title', `%${searchTerm}%`);
            
            query = query.order(currentSort.column, { ascending: currentSort.ascending });
            const { data: cards, error } = await query;
            if (error) throw error;
            
            currentDisplayList = cards;

            let displayItems = [];
            if (selectedFilterTag === 'special:videos') {
                 cards.forEach(card => {
                    const relatedVideos = card.related_videos_with_tags || [];
                    relatedVideos.forEach(video => {
                        displayItems.push({
                            isVideo: true,
                            url: video.url,
                            tags: video.tags,
                            parentCard: card
                        });
                    });
                });
            } else if(selectedFilterTag) {
                cards.forEach(card => {
                    const mainTags = card.tags ? card.tags.split(',').map(t => t.trim()) : [];
                    if(mainTags.includes(selectedFilterTag)) {
                        displayItems.push({ ...card, isMain: true }); 
                    }

                    const relatedImages = card.related_images_with_tags || [];
                    relatedImages.forEach(img => {
                         const relatedTags = img.tags ? img.tags.split(',').map(t => t.trim()) : [];
                         if(relatedTags.includes(selectedFilterTag)) {
                            displayItems.push({
                                isRelated: true,
                                url: img.url,
                                tags: img.tags,
                                parentCard: card
                             });
                         }
                    });
                    
                    const relatedVideos = card.related_videos_with_tags || [];
                    relatedVideos.forEach(video => {
                        const videoTags = video.tags ? video.tags.split(',').map(t => t.trim()) : [];
                        if(videoTags.includes(selectedFilterTag)) {
                            displayItems.push({
                                isVideo: true,
                                url: video.url,
                                tags: video.tags,
                                parentCard: card
                            });
                        }
                    });
                });
            } else {
                displayItems = cards.map(c => ({...c, isMain: true}));
            }
            
            filteredItemsForPreview = displayItems
                .filter(item => item.isRelated || item.isMain)
                .map(item => item.isRelated ? item.url : item.main_image_url);

            displayCards(displayItems);
        } catch (error) {
            console.error("Error loading cards:", error);
            cardGallery.innerHTML = `<p class="text-red-400 col-span-full text-center">Failed to load characters. check connection.</p>`;
            displayCards([]);
        } finally {
            // CRITICAL FIX: Always hide loading, even on error
            loadingIndicator.classList.add('hidden');
        }
    }
    
    function displayCards(items) {
        document.getElementById('character-counter').textContent = `${items.length} Found`;
        cardGallery.innerHTML = '';
        if (items.length === 0) {
            noResultsMessage.classList.remove('hidden');
        } else {
            noResultsMessage.classList.add('hidden');
        }

        items.forEach((item, index) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'card-container relative group';

            if (item.isRelated) {
                const card = item.parentCard;
                const tagsHtml = item.tags ? item.tags.split(',').map(tag => `<span class="bg-purple-600 text-white text-xs font-medium px-2 py-0.5 rounded-full">${tag.trim()}</span>`).join(' ') : '';
                
                cardElement.innerHTML = `
                    <div class="bg-transparent rounded-xl shadow-lg overflow-hidden transform group-hover:scale-105 group-hover:-translate-y-1 transition-all duration-300 ease-in-out cursor-pointer">
                        <div class="w-full h-80 bg-transparent">
                            <img src="${item.url}" alt="Related to ${card.title}" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/400x400/1a1b26/ffffff?text=Image+Not+Found';">
                        </div>
                    </div>
                    
                    <h3 class="font-bold text-lg text-white truncate text-center mt-3 cursor-pointer">From: ${card.title}</h3>
                    <div class="mt-2 flex flex-wrap gap-1 justify-center">
                        ${tagsHtml}
                    </div>
                `;
            } else if (item.isVideo) {
                const card = item.parentCard;
                const tagsHtml = item.tags ? item.tags.split(',').map(tag => `<span class="bg-teal-600 text-white text-xs font-medium px-2 py-0.5 rounded-full">${tag.trim()}</span>`).join(' ') : '';

                cardElement.innerHTML = `
                    <div class="bg-black rounded-xl shadow-lg overflow-hidden transform group-hover:scale-105 group-hover:-translate-y-1 transition-all duration-300 ease-in-out cursor-pointer relative">
                         <div class="w-full h-80 bg-black relative">
                            <video class="w-full h-full object-cover" src="${item.url}" preload="metadata" loop playsinline></video>
                            
                            <div class="speed-controls">
                                <button class="speed-btn minus-btn">-</button>
                                <span class="speed-display">1x</span>
                                <button class="speed-btn plus-btn">+</button>
                            </div>

                            <div class="seek-bar-container">
                                <div class="seek-bar">
                                    <div class="seek-progress"></div>
                                    <div class="seek-handle"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg text-white truncate text-center mt-3 cursor-pointer">From: ${card.title}</h3>
                    <div class="mt-2 flex flex-wrap gap-1 justify-center">
                        ${tagsHtml}
                    </div>
                `;
                
                // Get references to elements
                const videoElem = cardElement.querySelector('video');
                const seekBarContainer = cardElement.querySelector('.seek-bar-container');
                const seekBar = cardElement.querySelector('.seek-bar');
                const seekProgress = cardElement.querySelector('.seek-progress');
                const seekHandle = cardElement.querySelector('.seek-handle');
                const speedControls = cardElement.querySelector('.speed-controls');
                const minusBtn = cardElement.querySelector('.minus-btn');
                const plusBtn = cardElement.querySelector('.plus-btn');
                const speedDisplay = cardElement.querySelector('.speed-display');

                // Hover playback with AbortError handling
                cardElement.addEventListener('mouseenter', () => {
                    const playPromise = videoElem.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            if (error.name !== 'AbortError') {
                                console.log("Video play interrupted");
                            }
                        });
                    }
                });
                cardElement.addEventListener('mouseleave', () => videoElem.pause());

                // Seek bar logic
                videoElem.addEventListener('timeupdate', () => {
                    if (videoElem.duration) {
                        const progressPercent = (videoElem.currentTime / videoElem.duration) * 100;
                        seekProgress.style.width = `${progressPercent}%`;
                        seekHandle.style.left = `${progressPercent}%`;
                    }
                });
                seekBarContainer.addEventListener('mousedown', (e) => {
                    e.stopPropagation(); 
                    const wasPlaying = !videoElem.paused;
                    videoElem.pause();
                    const seek = (event) => {
                        const rect = seekBar.getBoundingClientRect();
                        if (rect.width > 0) {
                           let offsetX = event.clientX - rect.left;
                            offsetX = Math.max(0, Math.min(offsetX, rect.width));
                            const newTime = (offsetX / rect.width) * videoElem.duration;
                            if (isFinite(newTime)) {
                                videoElem.currentTime = newTime;
                            }
                        }
                    };
                    seek(e); 
                    const onMouseMove = (moveEvent) => seek(moveEvent);
                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        if (wasPlaying) videoElem.play();
                    };
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
                seekBarContainer.addEventListener('click', (e) => e.stopPropagation());

                // Speed Control Logic
                const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
                let currentSpeedIndex = 2; // Corresponds to 1x
                const updateSpeed = () => {
                    const newSpeed = speeds[currentSpeedIndex];
                    videoElem.playbackRate = newSpeed;
                    speedDisplay.textContent = `${newSpeed}x`;
                };
                minusBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentSpeedIndex > 0) {
                        currentSpeedIndex--;
                        updateSpeed();
                    }
                });
                plusBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentSpeedIndex < speeds.length - 1) {
                        currentSpeedIndex++;
                        updateSpeed();
                    }
                });
                speedControls.addEventListener('click', (e) => e.stopPropagation());

            } else { // isMain
                const card = item;
                const tagsHtml = card.tags ? card.tags.split(',').map(tag => `<span class="bg-gray-700 text-gray-300 text-xs font-medium px-2 py-0.5 rounded-full">${tag.trim()}</span>`).join(' ') : '';
                cardElement.innerHTML = `
                    <div class="bg-transparent rounded-xl shadow-lg overflow-hidden transform group-hover:scale-105 group-hover:-translate-y-1 transition-all duration-300 ease-in-out cursor-pointer">
                         <div class="w-full h-80 bg-transparent">
                            <img src="${card.main_image_url}" alt="${card.title}" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/400x400/1a1b26/ffffff?text=Image+Not+Found';">
                         </div>
                    </div>
                    <h3 class="font-bold text-lg text-white truncate text-center mt-3 cursor-pointer">${card.title}</h3>
                    <div class="mt-2 flex flex-wrap gap-1 justify-center">
                         ${tagsHtml}
                    </div>
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="edit-btn p-1.5 bg-blue-600 rounded-full text-white hover:bg-blue-700" data-id="${card.id}">
                               <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                         <button class="delete-btn p-1.5 bg-red-600 rounded-full text-white hover:bg-red-600 ml-1" data-id="${card.id}">
                            <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
            }

            cardElement.addEventListener('click', (e) => {
                // Pause any video inside the card immediately
                const cardVideo = cardElement.querySelector('video');
                if (cardVideo) cardVideo.pause();

                if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) return;
                
                if (selectedFilterTag) {
                    if (item.isVideo) {
                        openVideoPreview(item.url);
                    } else {
                        const imageIndex = filteredItemsForPreview.indexOf(item.url);
                        if (imageIndex > -1) {
                            openImagePreview(filteredItemsForPreview, imageIndex);
                        }
                    }
               } else {
                    const cardId = item.isRelated || item.isVideo ? item.parentCard.id : item.id;
                    openDetailsView(cardId);
                }
            });
            cardGallery.appendChild(cardElement);
        });
    }
    
    // --- Image Preview Functions ---
    function openImagePreview(images, index) {
        previewImages = images;
        currentPreviewIndex = index;
        updatePreviewImage();
        imagePreviewView.classList.remove('hidden');
    }
    function closeImagePreview() {
        imagePreviewView.classList.add('hidden');
        resetZoomPreview();
    }
    function updatePreviewImage() {
        previewImage.src = previewImages[currentPreviewIndex];
        previewCounter.textContent = `${currentPreviewIndex + 1} / ${previewImages.length}`;
        prevPreviewBtn.style.display = previewImages.length > 1 ? 'block' : 'none';
        nextPreviewBtn.style.display = previewImages.length > 1 ? 'block' : 'none';
        resetZoomPreview();
    }
    function nextPreviewImage() {
        currentPreviewIndex = (currentPreviewIndex + 1) % previewImages.length;
        updatePreviewImage();
    }
    function prevPreviewImage() {
        currentPreviewIndex = (currentPreviewIndex - 1 + previewImages.length) % previewImages.length;
        updatePreviewImage();
    }
    function applyTransform() {
        previewImage.style.transform = `translate(${panOffset.x}px, ${panOffset.y}px) scale(${currentZoom})`;
    }
    function zoomInPreview() {
        currentZoom = Math.min(currentZoom + 0.2, 3);
        applyTransform();
    }
    function zoomOutPreview() {
        currentZoom = Math.max(currentZoom - 0.2, 0.5);
        if (currentZoom === 1) { // Reset pan when zooming back to normal
            panOffset = { x: 0, y: 0 };
        }
        applyTransform();
    }
    function resetZoomPreview() {
        currentZoom = 1;
        panOffset = { x: 0, y: 0 };
        isPanning = false;
        previewImage.classList.remove('is-panning');
        applyTransform();
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        loadCards();
        fetchAllTags(); // Load tags in background separately
        setupDetailsViewListeners();
    });
    searchInput.addEventListener('input', debounce(loadCards, 300));
    addCardBtn.addEventListener('click', openPopup);
    closePopupBtn.addEventListener('click', closePopup);
    popup.addEventListener('click', (e) => { if (e.target === popup) closePopup(); });
    cardForm.addEventListener('submit', saveCard);
    closeDetailsBtn.addEventListener('click', closeDetailsView);
    addRelatedBtn.addEventListener('click', openRelatedImagePopup);
    uploadRelatedBtn.addEventListener('click', openRelatedImagePopup);
    closeRelatedPopupBtn.addEventListener('click', closeRelatedImagePopup);
    relatedImagesForm.addEventListener('submit', saveRelatedImages);
    manageRelatedBtn.addEventListener('click', toggleManageRelatedMode);
    closePreviewBtn.addEventListener('click', closeImagePreview);
    nextPreviewBtn.addEventListener('click', nextPreviewImage);
    prevPreviewBtn.addEventListener('click', prevPreviewImage);
    zoomInBtn.addEventListener('click', zoomInPreview);
    zoomOutBtn.addEventListener('click', zoomOutPreview);
    resetZoomBtn.addEventListener('click', resetZoomPreview);
    // New Tag Listeners
    newTagButton.addEventListener('click', () => newTagPopup.style.display = 'flex');
    closeNewTagPopupBtn.addEventListener('click', () => newTagPopup.style.display = 'none');
    newTagPopup.addEventListener('click', (e) => { if (e.target === newTagPopup) newTagPopup.style.display = 'none'; });
    newTagForm.addEventListener('submit', handleNewTagSubmit);
    // Edit Related Tags Popup Listeners
    closeEditRelatedTagsPopupBtn.addEventListener('click', closeEditRelatedTagsPopup);
    editRelatedTagsForm.addEventListener('submit', saveRelatedImageTags);
    editRelatedTagsPopup.addEventListener('click', (e) => { if (e.target === editRelatedTagsPopup) closeEditRelatedTagsPopup(); });
    // Video Event Listeners
    addRelatedVideoBtn.addEventListener('click', openRelatedVideoPopup);
    manageRelatedVideosBtn.addEventListener('click', toggleManageRelatedVideosMode);
    closeRelatedVideoPopupBtn.addEventListener('click', closeRelatedVideoPopup);
    relatedVideosForm.addEventListener('submit', saveRelatedVideos);
    closeVideoPreviewBtn.addEventListener('click', closeVideoPreview);
    videoPreviewView.addEventListener('click', (e) => { if (e.target === videoPreviewView) closeVideoPreview(); });
    closeEditRelatedVideoTagsPopupBtn.addEventListener('click', closeEditRelatedVideoTagsPopup);
    editRelatedVideoTagsForm.addEventListener('submit', saveRelatedVideoTags);
    editRelatedVideoTagsPopup.addEventListener('click', (e) => { if (e.target === editRelatedVideoTagsPopup) closeEditRelatedVideoTagsPopup(); });
    // Details Navigation Listeners
    prevDetailBtn.addEventListener('click', () => navigateDetails(-1));
    nextDetailBtn.addEventListener('click', () => navigateDetails(1));
    document.addEventListener('keydown', (e) => {
        if (!detailsView.classList.contains('hidden')) {
            if (e.key === 'ArrowLeft') navigateDetails(-1);
            if (e.key === 'ArrowRight') navigateDetails(1);
        }
    });

    async function navigateDetails(offset) {
        if (!currentCardForDetails || currentDisplayList.length === 0) return;
        const currentIndex = currentDisplayList.findIndex(c => c.id === currentCardForDetails.id);
        if (currentIndex === -1) return;

        let newIndex = currentIndex + offset;
        // Loop navigation
        if (newIndex < 0) newIndex = currentDisplayList.length - 1;
        if (newIndex >= currentDisplayList.length) newIndex = 0;

        const nextCard = currentDisplayList[newIndex];
        await openDetailsView(nextCard.id);
    }

    // --- Panning Event Listeners ---
    previewImage.addEventListener('mousedown', startPan);
    window.addEventListener('mousemove', pan);
    window.addEventListener('mouseup', endPan);
    previewImage.addEventListener('touchstart', startPan, { passive: true });
    window.addEventListener('touchmove', pan);
    window.addEventListener('touchend', endPan);

    // --- Dropdown Toggles ---
    function setupDropdown(button, dropdown) {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllDropdowns(dropdown);
            dropdown.classList.toggle('hidden');
        });
    }
    function closeAllDropdowns(exclude) {
        [sortDropdown, filterDropdown].forEach(d => {
            if (d !== exclude) d.classList.add('hidden');
        });
    }
    document.addEventListener('click', () => closeAllDropdowns(null));
    setupDropdown(sortButton, sortDropdown);
    setupDropdown(filterButton, filterDropdown);

    // --- Sorting & Filtering ---
    sortDropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('sort-option')) {
            e.preventDefault();
            const sortValue = e.target.dataset.sort.split('_');
            currentSort.column = sortValue[0] === 'created' ? 'created_at' : 'title';
            currentSort.ascending = sortValue.pop() === 'asc';
            loadCards();
             sortDropdown.classList.add('hidden');
        }
    });
    filterDropdown.addEventListener('click', (e) => {
        if(e.target.classList.contains('filter-option')) {
            e.preventDefault();
            selectedFilterTag = e.target.dataset.tag;
            const filterButtonText = document.querySelector('#filterButton');
            if (selectedFilterTag === 'special:videos') {
                 filterButtonText.innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" /></svg> Videos Only`;
            } else if (selectedFilterTag) {
                filterButtonText.innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg> ${selectedFilterTag}`;
            } else {
                 filterButtonText.innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg> Filter`;
            }
            loadCards();
            filterDropdown.classList.add('hidden');
        }
    });
    cardGallery.addEventListener('click', async (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        if (editBtn) await editCard(editBtn.dataset.id);
        if (deleteBtn) {
            if (await customConfirm('Are you sure you want to delete this character?')) {
                await deleteCard(deleteBtn.dataset.id);
            }
           }
    });

    // --- Card Actions (Add, Edit, Delete) ---
    async function editCard(id) {
        const { data: card, error } = await supabaseClient.from('cards').select('*').eq('id', id).single();
        if (error) return console.error("Error fetching card for edit:", error);
        resetForm();
        currentlyEditingCardId = id;
        document.querySelector('#popup .popup-content h3').textContent = 'Edit Character';
        document.getElementById('title').value = card.title;
        document.getElementById('imageUrl').value = card.main_image_url;
        selectedTags = card.tags ? card.tags.split(',').map(t => t.trim()) : [];
        updateSelectedTagsDisplay();
        updateTagPoolSelection();
        openPopup();
    }

    async function deleteCard(id) {
        const { error } = await supabaseClient.from('cards').delete().eq('id', id);
        if (error) return console.error("Error deleting card:", error);
        await loadCards();
    }

    async function saveCard(e) {
      e.preventDefault();
      try {
        const title = document.getElementById('title').value.trim();
        const imageUrl = document.getElementById('imageUrl').value.trim();
        if (!title || !imageUrl) throw new Error("Character name and Image URL are required.");
        const cardData = { title, main_image_url: imageUrl, tags: selectedTags.join(', ') };
        const { error } = currentlyEditingCardId ?
            await supabaseClient.from('cards').update(cardData).eq('id', currentlyEditingCardId) : await supabaseClient.from('cards').insert([cardData]);
        if (error) throw error;
        closePopup();
        await loadCards();
      } catch (error) {
        console.error("Error saving card:", error);
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    // --- Details View ---
    async function openDetailsView(cardId) {
        lastScrollPosition = window.scrollY; // Store current scroll position

        const { data: card, error } = await supabaseClient.from('cards').select('*').eq('id', cardId).single();
        if (error || !card) return console.error("Could not fetch card details");
        currentCardForDetails = card;

        detailsImageTransformBox.classList.remove('is-selected');

        detailsMainImage.src = card.main_image_url;
        detailsTitle.textContent = card.title;
        detailsTags.innerHTML = '';
        if (card.tags) {
            card.tags.split(',').forEach(tag => {
                if(!tag.trim()) return;
                const tagEl = document.createElement('span');
                tagEl.className = 'bg-gray-700 text-gray-200 text-sm font-medium px-3 py-1 rounded-full';
                tagEl.textContent = tag.trim();
                 detailsTags.appendChild(tagEl);
            });
        }
        
        // Apply or reset main image position and size from the database
        if (card.main_image_style && typeof card.main_image_style === 'object' && card.main_image_style.width) {
            detailsImageTransformBox.style.width = card.main_image_style.width;
            detailsImageTransformBox.style.height = card.main_image_style.height;
            detailsImageTransformBox.style.top = card.main_image_style.top;
            detailsImageTransformBox.style.left = card.main_image_style.left;
        } else {
            // Default position if no style is saved in the database
            detailsImageTransformBox.style.width = '80%';
            detailsImageTransformBox.style.height = '80%';
            detailsImageTransformBox.style.top = '10%';
            detailsImageTransformBox.style.left = '10%';
        }


        renderRelatedImages();
        renderRelatedVideos();
        document.querySelector('.container').classList.add('hidden');
        detailsView.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeDetailsView() {
        detailsImageTransformBox.classList.remove('is-selected');
        document.querySelector('.container').classList.remove('hidden');
        detailsView.classList.add('hidden');
        document.body.style.overflow = 'auto';

        window.scrollTo(0, lastScrollPosition);

        isManageRelatedMode = false;
        manageRelatedBtn.classList.remove('bg-red-600');
        manageRelatedBtn.classList.add('bg-gray-600');
        
        isManageRelatedVideosMode = false;
        manageRelatedVideosBtn.classList.remove('bg-red-600');
        manageRelatedVideosBtn.classList.add('bg-gray-600');
        
        if (sortable) {
            sortable.destroy();
            sortable = null;
        }
    }

    // --- Related Images Management ---
   function renderRelatedImages() {
        const card = currentCardForDetails;
        const relatedImages = card.related_images_with_tags || [];
        
        detailsRelatedImages.innerHTML = '';
        
        if (relatedImages.length > 0) {
            manageRelatedBtn.disabled = false;
            relatedImages.forEach((img, index) => {
                const imgContainer = document.createElement('div');
                const cursorClass = isManageRelatedMode ? 'cursor-grab' : 'cursor-pointer';
                imgContainer.className = `relative group aspect-square bg-gray-800 rounded-md overflow-hidden ${cursorClass}`;
                imgContainer.innerHTML = `
                    <img src="${img.url}" alt="Related Image" class="w-full h-full object-cover group-hover:opacity-60 transition" onerror="this.onerror=null;this.src='https://placehold.co/400x400/1a1b26/ffffff?text=Image+Not+Found';">
                     ${isManageRelatedMode ? `
                    <div class="absolute top-1 right-1 flex flex-col gap-1">
                        <button class="edit-related-btn p-1 bg-blue-600/80 rounded-full text-white hover:bg-blue-600" data-url="${img.url}">
                            <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z"></path><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z"></path></svg>
                        </button>
                        <button class="delete-related-btn p-1 bg-red-600/80 rounded-full text-white hover:bg-red-600" data-url="${img.url}">
                            <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                 </button>
                    </div>
                    ` : ''}
                `;
                imgContainer.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-related-btn');
                    const editBtn = e.target.closest('.edit-related-btn');

                    if (deleteBtn) {
                        e.stopPropagation(); 
                        deleteRelatedImage(deleteBtn.dataset.url);
                    } else if (editBtn) {
                        e.stopPropagation(); 
                        openEditRelatedTagsPopup(editBtn.dataset.url);
                    } else if (!isManageRelatedMode) { 
                        const allRelated = card.related_images_with_tags.map(i => i.url);
                        openImagePreview(allRelated, index);
                    }
                });
                detailsRelatedImages.appendChild(imgContainer);
            });
        } else {
            manageRelatedBtn.disabled = true;
            detailsRelatedImages.innerHTML = `<p class="text-gray-500 text-sm md:col-span-full italic">No related images yet. Click 'Add' or 'Upload' to begin.</p>`;
        }
    }
    
    function initializeSortable() {
        if (sortable) sortable.destroy();
        sortable = new Sortable(detailsRelatedImages, {
            animation: 150,
            delay: 200,
            delayOnTouchOnly: true,
            ghostClass: 'sortable-ghost',
            onEnd: (evt) => updateRelatedImagesOrder(evt.oldIndex, evt.newIndex)
        });
    }

    async function updateRelatedImagesOrder(oldIndex, newIndex) {
        if (!currentCardForDetails || !currentCardForDetails.related_images_with_tags) return;
        let images = currentCardForDetails.related_images_with_tags;
        const [movedItem] = images.splice(oldIndex, 1);
        images.splice(newIndex, 0, movedItem);
        const updatedImageUrls = images.map(img => img.url);

        const { data, error } = await supabaseClient
            .from('cards')
            .update({ related_images_with_tags: images, related_images: updatedImageUrls })
            .eq('id', currentCardForDetails.id)
            .select().single();

        if (error) {
            console.error('Error updating image order:', error);
            renderRelatedImages(); 
            return;
        }
        currentCardForDetails = data;
    }

    function openRelatedImagePopup() {
        selectedRelatedTags = [];
        updateRelatedTagDisplays();
        relatedImagePopup.style.display = 'flex';
    }
    function closeRelatedImagePopup() {
        relatedImagePopup.style.display = 'none';
        relatedImagesForm.reset();
        selectedRelatedTags = [];
        document.getElementById('relatedErrorMessage').textContent = '';
    }
    async function saveRelatedImages(e) {
        e.preventDefault();
        const urlsText = document.getElementById('relatedImageUrls').value.trim();
        if (!urlsText) {
             document.getElementById('relatedErrorMessage').textContent = 'Please enter at least one URL.';
             return;
        }
        
        // Fix: Split by newline, comma, or space to handle multiple formats
        const urls = urlsText.split(/[\n, ]+/).map(url => url.trim()).filter(url => url);
        
        // Sync Fix: Use related_images_with_tags as the source of truth for duplicates
        const currentRelatedWithTags = currentCardForDetails.related_images_with_tags || [];
        const existingUrls = new Set(currentRelatedWithTags.map(img => img.url));
        
        const newUrls = urls.filter(url => !existingUrls.has(url));
        
        if (newUrls.length === 0) {
             document.getElementById('relatedErrorMessage').textContent = 'All entered images are already added.';
             return;
        }
        
        const tagsString = selectedRelatedTags.join(', ');
        
        // Sync Fix: Rebuild both arrays to ensure they match perfectly
        const updatedRelatedWithTags = [...currentRelatedWithTags, ...newUrls.map(url => ({ url, tags: tagsString }))];
        const updatedRelatedImages = updatedRelatedWithTags.map(img => img.url);

        const { data, error } = await supabaseClient
            .from('cards')
            .update({ related_images: updatedRelatedImages, related_images_with_tags: updatedRelatedWithTags })
            .eq('id', currentCardForDetails.id)
            .select().single();
            
        if (error) {
            document.getElementById('relatedErrorMessage').textContent = 'Error saving images.';
            return console.error('Error saving related images:', error);
        }

        currentCardForDetails = data;
        await fetchAllTags();
        renderRelatedImages();
        closeRelatedImagePopup();
    }

    function toggleManageRelatedMode() {
        if ((currentCardForDetails.related_images_with_tags || []).length === 0) return;
        isManageRelatedMode = !isManageRelatedMode;
        manageRelatedBtn.classList.toggle('bg-red-600', isManageRelatedMode);
        manageRelatedBtn.classList.toggle('bg-gray-600', !isManageRelatedMode);
        renderRelatedImages();

        if (isManageRelatedMode) initializeSortable();
        else if (sortable) {
            sortable.destroy();
            sortable = null;
        }
    }

    async function deleteRelatedImage(urlToDelete) {
        if (!await customConfirm('Are you sure you want to delete this related image?')) return;
        
        // Sync Fix: Filter both arrays correctly
        const currentRelatedWithTags = currentCardForDetails.related_images_with_tags || [];
        const updatedRelatedWithTags = currentRelatedWithTags.filter(img => img.url !== urlToDelete);
        const updatedRelatedImages = updatedRelatedWithTags.map(img => img.url);

        const { data, error } = await supabaseClient
            .from('cards')
            .update({ related_images: updatedRelatedImages, related_images_with_tags: updatedRelatedWithTags })
            .eq('id', currentCardForDetails.id)
            .select().single();
        if (error) return console.error('Error deleting image:', error);

        currentCardForDetails = data;
        renderRelatedImages();
    }

    function openEditRelatedTagsPopup(url) {
        currentlyEditingRelatedImage = currentCardForDetails.related_images_with_tags.find(img => img.url === url);
        if (!currentlyEditingRelatedImage) return;

        editRelatedPreviewImage.src = currentlyEditingRelatedImage.url;
        const currentTags = currentlyEditingRelatedImage.tags || '';
        selectedTagsForEdit = currentTags ? currentTags.split(',').map(t => t.trim()) : [];
        
        updateEditRelatedTagDisplays();
        editRelatedTagsPopup.style.display = 'flex';
    }

    function closeEditRelatedTagsPopup() {
        editRelatedTagsPopup.style.display = 'none';
        editRelatedTagsForm.reset();
        currentlyEditingRelatedImage = null;
        selectedTagsForEdit = [];
        document.getElementById('editRelatedTagsErrorMessage').textContent = '';
    }

    async function saveRelatedImageTags(e) {
        e.preventDefault();
        if (!currentlyEditingRelatedImage) return;
        const updatedTagsString = selectedTagsForEdit.join(', ');

        const updatedRelatedWithTags = currentCardForDetails.related_images_with_tags.map(img => {
            if (img.url === currentlyEditingRelatedImage.url) {
                return { ...img, tags: updatedTagsString };
            }
            return img;
        });
        const { data, error } = await supabaseClient
            .from('cards')
            .update({ related_images_with_tags: updatedRelatedWithTags })
            .eq('id', currentCardForDetails.id)
            .select().single();
        if (error) {
            document.getElementById('editRelatedTagsErrorMessage').textContent = 'Error saving tags.';
            return console.error('Error saving related image tags:', error);
        }

        currentCardForDetails = data;
        renderRelatedImages();
        closeEditRelatedTagsPopup();
    }

    // --- Related Videos Management ---
    function renderRelatedVideos() {
        const card = currentCardForDetails;
        const relatedVideos = card.related_videos_with_tags || [];
        
        detailsRelatedVideos.innerHTML = '';
        manageRelatedVideosBtn.disabled = relatedVideos.length === 0;
        
        if (relatedVideos.length > 0) {
            relatedVideos.forEach((video) => {
                const videoContainer = document.createElement('div');
                const cursorClass = isManageRelatedVideosMode ? '' : 'cursor-pointer';
                videoContainer.className = `relative group aspect-square bg-black rounded-md overflow-hidden ${cursorClass}`;
                
               videoContainer.innerHTML = `
                    <video class="w-full h-full object-cover" src="${video.url}" preload="metadata" muted loop playsinline></video>
                    ${!isManageRelatedVideosMode ? `
                    <div class="absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        <svg class="w-10 h-10 text-white/90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 10a8 8 0 1116 0 8 8 0 01-16 0zm6.39-2.908a.75.75 0 01.766.027l3.5 2.25a.75.75 0 010 1.262l-3.5 2.25A.75.75 0 018 12.25v-4.5a.75.75 0 01.39-.658z" clip-rule="evenodd" /></svg>
                    </div>
                    ` : ''}
                    ${isManageRelatedVideosMode ? `
                    <div class="absolute top-1 right-1 flex flex-col gap-1">
                        <button class="edit-related-video-btn p-1 bg-blue-600/80 rounded-full text-white hover:bg-blue-600" data-url="${video.url}">
                            <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z"></path><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z"></path></svg>
                        </button>
                        <button class="delete-related-video-btn p-1 bg-red-600/80 rounded-full text-white hover:bg-red-600" data-url="${video.url}">
                            <svg class="w-4 h-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    ` : ''}
                `;

                videoContainer.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-related-video-btn');
                    const editBtn = e.target.closest('.edit-related-video-btn');

                    if (deleteBtn) {
                        e.stopPropagation();
                        deleteRelatedVideo(deleteBtn.dataset.url);
                    } else if (editBtn) {
                        e.stopPropagation();
                        openEditRelatedVideoTagsPopup(editBtn.dataset.url);
                    } else if (!isManageRelatedVideosMode) {
                        openVideoPreview(video.url);
                    }
                });
                detailsRelatedVideos.appendChild(videoContainer);
            });
        } else {
            detailsRelatedVideos.innerHTML = `<p class="text-gray-500 text-sm md:col-span-full italic">No related videos yet. Click 'Add' to begin.</p>`;
        }
    }

    function toggleManageRelatedVideosMode() {
        if ((currentCardForDetails.related_videos_with_tags || []).length === 0) return;
        isManageRelatedVideosMode = !isManageRelatedVideosMode;
        manageRelatedVideosBtn.classList.toggle('bg-red-600', isManageRelatedVideosMode);
        manageRelatedVideosBtn.classList.toggle('bg-gray-600', !isManageRelatedVideosMode);
        renderRelatedVideos();
    }
    
    async function deleteRelatedVideo(urlToDelete) {
        if (!await customConfirm('Are you sure you want to delete this related video?')) return;
        
        const updatedRelatedVideos = currentCardForDetails.related_videos_with_tags.filter(video => video.url !== urlToDelete);
        const { data, error } = await supabaseClient
            .from('cards')
            .update({ related_videos_with_tags: updatedRelatedVideos })
            .eq('id', currentCardForDetails.id)
            .select().single();
            
        if (error) return console.error('Error deleting video:', error);
        currentCardForDetails = data;
        renderRelatedVideos();
    }
    
    function openEditRelatedVideoTagsPopup(url) {
        currentlyEditingRelatedVideo = currentCardForDetails.related_videos_with_tags.find(video => video.url === url);
        if (!currentlyEditingRelatedVideo) return;
        
        editRelatedPreviewVideo.innerHTML = `<video class="w-full h-full object-contain" src="${currentlyEditingRelatedVideo.url}" controls></video>`;
        
        const currentTags = currentlyEditingRelatedVideo.tags || '';
        selectedVideoTagsForEdit = currentTags ? currentTags.split(',').map(t => t.trim()) : [];
        
        updateEditRelatedVideoTagDisplays();
        editRelatedVideoTagsPopup.style.display = 'flex';
    }

    function closeEditRelatedVideoTagsPopup() {
        editRelatedVideoTagsPopup.style.display = 'none';
        editRelatedVideoTagsForm.reset();
        currentlyEditingRelatedVideo = null;
        selectedVideoTagsForEdit = [];
        document.getElementById('editRelatedVideoTagsErrorMessage').textContent = '';
    }

    async function saveRelatedVideoTags(e) {
        e.preventDefault();
        if (!currentlyEditingRelatedVideo) return;
        
        const updatedTagsString = selectedVideoTagsForEdit.join(', ');
        const updatedRelatedVideos = currentCardForDetails.related_videos_with_tags.map(video => {
            if (video.url === currentlyEditingRelatedVideo.url) {
                return { ...video, tags: updatedTagsString };
            }
            return video;
        });

        const { data, error } = await supabaseClient
            .from('cards')
            .update({ related_videos_with_tags: updatedRelatedVideos })
            .eq('id', currentCardForDetails.id)
            .select().single();

        if (error) {
            document.getElementById('editRelatedVideoTagsErrorMessage').textContent = 'Error saving tags.';
            return console.error('Error saving related video tags:', error);
        }

        currentCardForDetails = data;
        renderRelatedVideos();
        closeEditRelatedVideoTagsPopup();
    }

    function openRelatedVideoPopup() {
        selectedRelatedVideoTags = [];
        updateRelatedVideoTagDisplays();
        relatedVideoPopup.style.display = 'flex';
    }

    function closeRelatedVideoPopup() {
        relatedVideoPopup.style.display = 'none';
        relatedVideosForm.reset();
        selectedRelatedVideoTags = [];
    }

    async function saveRelatedVideos(e) {
        e.preventDefault();
        const urlsText = document.getElementById('relatedVideoUrls').value.trim();
        if (!urlsText) return;
        const urls = urlsText.split('\n').map(url => url.trim()).filter(url => url);
        
        const currentRelatedVideos = currentCardForDetails.related_videos_with_tags || [];
        const currentUrls = currentRelatedVideos.map(v => v.url);
        
        const newVideos = urls.filter(url => !currentUrls.includes(url));
        if (newVideos.length === 0) return closeRelatedVideoPopup();
        
        const tagsString = selectedRelatedVideoTags.join(', ');
        const updatedRelatedVideos = [...currentRelatedVideos, ...newVideos.map(url => ({ url, tags: tagsString }))];
        
        const { data, error } = await supabaseClient
            .from('cards')
            .update({ related_videos_with_tags: updatedRelatedVideos })
            .eq('id', currentCardForDetails.id)
            .select().single();
            
        if (error) {
            document.getElementById('relatedVideoErrorMessage').textContent = 'Error saving videos.';
            return console.error('Error saving related videos:', error);
        }

        currentCardForDetails = data;
        await fetchAllTags();
        renderRelatedVideos();
        closeRelatedVideoPopup();
    }

    // --- Panning Logic ---
    function getEventCoords(e) {
        return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
    }

    function startPan(e) {
        if (currentZoom <= 1) return; // Only pan if zoomed
        e.preventDefault();
        isPanning = true;
        const coords = getEventCoords(e);
        panStart.x = coords.x - panOffset.x;
        panStart.y = coords.y - panOffset.y;
        previewImage.classList.add('is-panning');
        previewImage.style.transition = 'none'; // Disable transition for smooth panning
    }

    function pan(e) {
        if (!isPanning) return;
        const coords = getEventCoords(e);
        panOffset.x = coords.x - panStart.x;
        panOffset.y = coords.y - panStart.y;
        applyTransform();
    }

    function endPan() {
        if (!isPanning) return;
        isPanning = false;
        previewImage.classList.remove('is-panning');
        previewImage.style.transition = 'transform 0.2s ease-out'; // Re-enable transition
    }

    // --- Video Preview ---
    function openVideoPreview(url) {
        videoPlayerContainer.innerHTML = ''; // Clear previous video
        const videoEl = document.createElement('video');
        videoEl.className = 'w-full h-full';
        videoEl.src = url;
        videoEl.controls = true;
        videoEl.autoplay = true;
        videoPlayerContainer.appendChild(videoEl);
        videoPreviewView.classList.remove('hidden');
    }

    function closeVideoPreview() {
        videoPlayerContainer.innerHTML = '';
        videoPreviewView.classList.add('hidden');
    }

    // --- Popup and Form Management ---
    function resetForm() {
      cardForm.reset();
      currentlyEditingCardId = null;
      selectedTags = [];
      document.querySelector('#popup .popup-content h3').textContent = 'Add New Character';
      document.getElementById('errorMessage').textContent = '';
      updateSelectedTagsDisplay();
      updateTagPoolSelection();
    }

    function openPopup() { popup.style.display = 'flex'; }
    function closePopup() { popup.style.display = 'none';
      resetForm(); 
    }
    
    // --- Tag Management ---
    function handleNewTagSubmit(e) {
        e.preventDefault();
        const errorMsg = document.getElementById('newTagErrorMessage');
        errorMsg.textContent = '';
        const newTagNameInput = document.getElementById('newTagName');
        const newTag = newTagNameInput.value.trim();

        if (!newTag) {
            errorMsg.textContent = 'Tag name cannot be empty.';
            return;
        }
        if (allTags.has(newTag)) {
            errorMsg.textContent = 'This tag already exists.';
            return;
        }

        allTags.add(newTag);
        updateTagDisplays(); // This will refresh all tag pools and filter dropdown
        newTagPopup.style.display = 'none';
        newTagNameInput.value = '';
    }

    addTagBtn.addEventListener('click', () => {
        const newTag = tagInput.value.trim();
        if (newTag && !selectedTags.includes(newTag)) {
            selectedTags.push(newTag);
            if (!allTags.has(newTag)) {
                allTags.add(newTag);
                 updateTagDisplays();
            }
            updateSelectedTagsDisplay();
            updateTagPoolSelection();
        }
        tagInput.value = '';
        tagInput.focus();
    });
    function updateTagDisplays() {
        const sortedTags = Array.from(allTags).sort();
        filterDropdown.innerHTML = `<a href="#" class="filter-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-tag="">All Characters</a>`;
        filterDropdown.innerHTML += `<a href="#" class="filter-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-tag="special:videos">Videos Only</a>`;
        sortedTags.forEach(tag => {
            filterDropdown.innerHTML += `<a href="#" class="filter-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-tag="${tag}">${tag}</a>`;
        });
        const tagPool = document.getElementById('tagPool');
        tagPool.innerHTML = '';
        sortedTags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            tagPool.appendChild(tagEl);
        });
        updateRelatedTagDisplays();
        updateEditRelatedTagDisplays();
        updateRelatedVideoTagDisplays();
        updateEditRelatedVideoTagDisplays();
    }

    function updateSelectedTagsDisplay() {
        const container = document.getElementById('selectedTags');
        container.innerHTML = '';
        selectedTags.forEach(tag => {
            container.innerHTML += `<span class="bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1">${tag}<button type="button" class="remove-tag font-bold" data-tag="${tag}">&times;</button></span>`;
        });
    }

    function updateTagPoolSelection() {
        document.querySelectorAll('#tagPool .tag').forEach(tagEl => {
            if (selectedTags.includes(tagEl.dataset.tag)) {
                tagEl.classList.add('selected');
            } else {
                tagEl.classList.remove('selected');
            }
        });
    }

    function updateRelatedTagDisplays() {
        const sortedTags = Array.from(allTags).sort();
        const relatedSelectedContainer = document.getElementById('relatedSelectedTags');
        const relatedPoolContainer = document.getElementById('relatedTagPool');
        
        relatedPoolContainer.innerHTML = '';
        sortedTags.forEach(tag => {
             const tagEl = document.createElement('span');
            tagEl.className = 'tag bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            if(selectedRelatedTags.includes(tag)) tagEl.classList.add('selected');
            relatedPoolContainer.appendChild(tagEl);
        
        });

        relatedSelectedContainer.innerHTML = '';
        selectedRelatedTags.forEach(tag => {
            relatedSelectedContainer.innerHTML += `<span class="bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1">${tag}<button type="button" class="remove-related-tag font-bold" data-tag="${tag}">&times;</button></span>`;
        });
    }

    function updateRelatedVideoTagDisplays() {
        const sortedTags = Array.from(allTags).sort();
        const selectedContainer = document.getElementById('relatedVideoSelectedTags');
        const poolContainer = document.getElementById('relatedVideoTagPool');
        
        poolContainer.innerHTML = '';
        sortedTags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            if (selectedRelatedVideoTags.includes(tag)) tagEl.classList.add('selected');
            poolContainer.appendChild(tagEl);
        });

        selectedContainer.innerHTML = '';
        selectedRelatedVideoTags.forEach(tag => {
            selectedContainer.innerHTML += `<span class="bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1">${tag}<button type="button" class="remove-related-video-tag font-bold" data-tag="${tag}">&times;</button></span>`;
        });
    }

    function updateEditRelatedTagDisplays() {
        const sortedTags = Array.from(allTags).sort();
        const selectedContainer = document.getElementById('editRelatedSelectedTags');
        const poolContainer = document.getElementById('editRelatedTagPool');
        
        poolContainer.innerHTML = '';
        sortedTags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            if (selectedTagsForEdit.includes(tag)) tagEl.classList.add('selected');
            poolContainer.appendChild(tagEl);
        
        });

        selectedContainer.innerHTML = '';
        selectedTagsForEdit.forEach(tag => {
            selectedContainer.innerHTML += `<span class="bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1">${tag}<button type="button" class="remove-edit-tag font-bold" data-tag="${tag}">&times;</button></span>`;
        });
    }
    
    function updateEditRelatedVideoTagDisplays() {
        const sortedTags = Array.from(allTags).sort();
        const selectedContainer = document.getElementById('editRelatedVideoSelectedTags');
        const poolContainer = document.getElementById('editRelatedVideoTagPool');
        
        poolContainer.innerHTML = '';
        sortedTags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            if (selectedVideoTagsForEdit.includes(tag)) tagEl.classList.add('selected');
            poolContainer.appendChild(tagEl);
        });

        selectedContainer.innerHTML = '';
        selectedVideoTagsForEdit.forEach(tag => {
            selectedContainer.innerHTML += `<span class="bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1">${tag}<button type="button" class="remove-edit-video-tag font-bold" data-tag="${tag}">&times;</button></span>`;
        });
    }

    // Event delegation for tag popups
    document.getElementById('popup').addEventListener('click', (e) => {
        if(e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            if(selectedTags.includes(tag)) selectedTags = selectedTags.filter(t => t !== tag);
            else selectedTags.push(tag);
            updateSelectedTagsDisplay();
            updateTagPoolSelection();
        }
        if(e.target.classList.contains('remove-tag')) {
            selectedTags = selectedTags.filter(t => t !== e.target.dataset.tag);
            updateSelectedTagsDisplay();
            updateTagPoolSelection();
        }
    });
    relatedImagePopup.addEventListener('click', (e) => {
        if(e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            if(selectedRelatedTags.includes(tag)) selectedRelatedTags = selectedRelatedTags.filter(t => t !== tag);
            else selectedRelatedTags.push(tag);
            updateRelatedTagDisplays();
        }
        if(e.target.classList.contains('remove-related-tag')) {
            selectedRelatedTags = selectedRelatedTags.filter(t => t !== e.target.dataset.tag);
            updateRelatedTagDisplays();
        }
    });
    editRelatedTagsPopup.addEventListener('click', (e) => {
        if (e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            if (selectedTagsForEdit.includes(tag)) selectedTagsForEdit = selectedTagsForEdit.filter(t => t !== tag);
            else selectedTagsForEdit.push(tag);
            updateEditRelatedTagDisplays();
        }
        if (e.target.classList.contains('remove-edit-tag')) {
            selectedTagsForEdit = selectedTagsForEdit.filter(t => t !== e.target.dataset.tag);
            updateEditRelatedTagDisplays();
        }
    });
    relatedVideoPopup.addEventListener('click', (e) => {
        if (e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            if (selectedRelatedVideoTags.includes(tag)) selectedRelatedVideoTags = selectedRelatedVideoTags.filter(t => t !== tag);
            else selectedRelatedVideoTags.push(tag);
            updateRelatedVideoTagDisplays();
        }
        if (e.target.classList.contains('remove-related-video-tag')) {
            selectedRelatedVideoTags = selectedRelatedVideoTags.filter(t => t !== e.target.dataset.tag);
            updateRelatedVideoTagDisplays();
        }
    });
    editRelatedVideoTagsPopup.addEventListener('click', (e) => {
        if (e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            if (selectedVideoTagsForEdit.includes(tag)) selectedVideoTagsForEdit = selectedVideoTagsForEdit.filter(t => t !== tag);
            else selectedVideoTagsForEdit.push(tag);
            updateEditRelatedVideoTagDisplays();
        }
        if (e.target.classList.contains('remove-edit-video-tag')) {
            selectedVideoTagsForEdit = selectedVideoTagsForEdit.filter(t => t !== e.target.dataset.tag);
            updateEditRelatedVideoTagDisplays();
        }
    });

    // --- Image Transform Logic ---
    function setupDetailsViewListeners() {
        detailsImageTransformBox.addEventListener('mousedown', startDrag);
        document.querySelectorAll('.resize-handle').forEach(handle => {
            handle.addEventListener('mousedown', startResize);
        });
        
        detailsImageTransformBox.addEventListener('click', (e) => {
            e.stopPropagation();
            detailsImageTransformBox.classList.add('is-selected');
        });

        detailsView.addEventListener('click', (e) => {
            if (!detailsImageTransformBox.contains(e.target)) {
                detailsImageTransformBox.classList.remove('is-selected');
            }
        });
    }

    function startDrag(e) {
        if (window.innerWidth < 768) return; // Disable drag on mobile
        // Prevent dragging if a resize handle was clicked
        if (e.target.classList.contains('resize-handle')) return;
        e.preventDefault();
        imageTransform.isDragging = true;
        imageTransform.containerRect = detailsImageContainer.getBoundingClientRect();
        imageTransform.startX = e.clientX;
        imageTransform.startY = e.clientY;
        imageTransform.startLeft = detailsImageTransformBox.offsetLeft;
        imageTransform.startTop = detailsImageTransformBox.offsetTop;
        window.addEventListener('mousemove', drag);
        window.addEventListener('mouseup', endDrag);
    }

    function drag(e) {
        if (!imageTransform.isDragging) return;
        e.preventDefault();
        const dx = e.clientX - imageTransform.startX;
        const dy = e.clientY - imageTransform.startY;
        let newLeft = imageTransform.startLeft + dx;
        let newTop = imageTransform.startTop + dy;
        
        // Constrain within the container
        newLeft = Math.max(0, Math.min(newLeft, imageTransform.containerRect.width - detailsImageTransformBox.offsetWidth));
        newTop = Math.max(0, Math.min(newTop, imageTransform.containerRect.height - detailsImageTransformBox.offsetHeight));
        
        detailsImageTransformBox.style.left = `${(newLeft / imageTransform.containerRect.width) * 100}%`;
        detailsImageTransformBox.style.top = `${(newTop / imageTransform.containerRect.height) * 100}%`;
    }

    function endDrag() {
        if (!imageTransform.isDragging) return;
        imageTransform.isDragging = false;
        window.removeEventListener('mousemove', drag);
        window.removeEventListener('mouseup', endDrag);
        debouncedSaveMainImageStyle();
    }

    function startResize(e) {
        if (window.innerWidth < 768) return; // Disable resize on mobile
        e.preventDefault();
        e.stopPropagation();
        imageTransform.isResizing = true;
        imageTransform.direction = e.target.dataset.direction;
        imageTransform.containerRect = detailsImageContainer.getBoundingClientRect();
        imageTransform.startX = e.clientX;
        imageTransform.startY = e.clientY;
        imageTransform.startLeft = detailsImageTransformBox.offsetLeft;
        imageTransform.startTop = detailsImageTransformBox.offsetTop;
        imageTransform.startWidth = detailsImageTransformBox.offsetWidth;
        imageTransform.startHeight = detailsImageTransformBox.offsetHeight;
        window.addEventListener('mousemove', resize);
        window.addEventListener('mouseup', endResize);
    }

    function resize(e) {
        if (!imageTransform.isResizing) return;
        e.preventDefault();
        const dx = e.clientX - imageTransform.startX;
        const dy = e.clientY - imageTransform.startY;
        let newWidth = imageTransform.startWidth;
        let newHeight = imageTransform.startHeight;
        let newTop = imageTransform.startTop;
        let newLeft = imageTransform.startLeft;

        if (imageTransform.direction.includes('e')) newWidth = imageTransform.startWidth + dx;
        if (imageTransform.direction.includes('w')) {
            newWidth = imageTransform.startWidth - dx;
            newLeft = imageTransform.startLeft + dx;
        }
        if (imageTransform.direction.includes('s')) newHeight = imageTransform.startHeight + dy;
        if (imageTransform.direction.includes('n')) {
            newHeight = imageTransform.startHeight - dy;
            newTop = imageTransform.startTop + dy;
        }
        
        // Prevent negative dimensions
        if (newWidth < 50) {
            newWidth = 50;
            if(imageTransform.direction.includes('w')) newLeft = detailsImageTransformBox.offsetLeft;
        }
        if (newHeight < 50) {
             newHeight = 50;
             if(imageTransform.direction.includes('n')) newTop = detailsImageTransformBox.offsetTop;
        }

        detailsImageTransformBox.style.width = `${(newWidth / imageTransform.containerRect.width) * 100}%`;
        detailsImageTransformBox.style.height = `${(newHeight / imageTransform.containerRect.height) * 100}%`;
        detailsImageTransformBox.style.top = `${(newTop / imageTransform.containerRect.height) * 100}%`;
        detailsImageTransformBox.style.left = `${(newLeft / imageTransform.containerRect.width) * 100}%`;
    }

    function endResize() {
        if (!imageTransform.isResizing) return;
        imageTransform.isResizing = false;
        window.removeEventListener('mousemove', resize);
        window.removeEventListener('mouseup', endResize);
        debouncedSaveMainImageStyle();
    }

    async function saveMainImageStyle() {
        if (!currentCardForDetails) return;
        const styleData = {
            width: detailsImageTransformBox.style.width,
            height: detailsImageTransformBox.style.height,
            top: detailsImageTransformBox.style.top,
            left: detailsImageTransformBox.style.left,
        };
        const { data, error } = await supabaseClient
            .from('cards')
            .update({ main_image_style: styleData })
            .eq('id', currentCardForDetails.id)
            .select()
            .single();

        if (error) {
            console.error("Error saving image style:", error);
            return;
        }
        currentCardForDetails.main_image_style = data.main_image_style;
    }

    // --- Scroll to Top Button Logic ---
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const checkScroll = () => {
      const isDetailsVisible = !detailsView.classList.contains('hidden');
      const currentScrollTop = isDetailsVisible ? detailsView.scrollTop : window.scrollY;
      scrollToTopBtn.classList.toggle('hidden', currentScrollTop <= 300);
    };
    const scrollToTop = () => {
      const container = detailsView.classList.contains('hidden') ? window : detailsView;
      container.scrollTo({ top: 0, behavior: 'auto' });
    };
    window.addEventListener('scroll', checkScroll);
    detailsView.addEventListener('scroll', checkScroll);
    scrollToTopBtn.addEventListener('click', scrollToTop);
    const originalOpenDetails = openDetailsView;
    openDetailsView = async (...args) => {
      await originalOpenDetails(...args);
      checkScroll();
    };
    const originalCloseDetails = closeDetailsView;
    closeDetailsView = (...args) => {
      originalCloseDetails(...args);
      checkScroll();
    };

  </script>
</body>
</html>
