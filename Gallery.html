<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Character Gallery</title>
  <link rel="icon" href="https://ik.imagekit.io/xfifcyvcg/P_icon.ico?updatedAt=1748049193174" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a1b26;
      background-image: radial-gradient(#3c3f58 0.5px, transparent 0.5px);
      background-size: 15px 15px;
      color: #f0f0f0;
    }
    /* Custom scrollbar for a better look in dark mode */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1a1b26;
    }
    ::-webkit-scrollbar-thumb {
      background: #4a4e69;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #5a5f80;
    }
    .popup-content, #details-view, #image-preview-view, #video-preview-view {
        animation: slide-up 0.4s ease-out;
    }
    @keyframes slide-up {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    .tag {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .tag.selected {
        background-color: #2563eb;
        color: white;
    }
    .gradient-text {
        background: linear-gradient(to right, #c77dff, #e18d9f);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    #preview-image {
        transition: transform 0.2s ease-out;
        cursor: grab;
    }
     #preview-image.is-panning {
        cursor: grabbing;
    }
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .sortable-ghost {
        opacity: 0.4;
        background-color: #4a4e69;
        border-radius: 0.375rem; /* rounded-md */
    }
    .cursor-grab {
        cursor: grab;
    }
    .cursor-grab:active {
        cursor: grabbing;
    }
  </style>
</head>
<body class="antialiased">

  <div class="container mx-auto p-4 md:p-8">
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:gap-4">
        <h1 class="text-3xl font-bold text-white tracking-tight">Character Gallery</h1>
        <span id="character-counter" class="mt-2 sm:mt-0 text-lg font-medium bg-[#2a2d3d] text-gray-200 px-3 py-1 rounded-full w-fit">
            Loading...
        </span>
    </div>

    <header class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8">
      <div class="relative w-full sm:w-auto sm:flex-grow max-w-md">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <input type="text" id="searchInput" placeholder="Search for a character..." class="w-full bg-[#2a2d3d] text-white border border-transparent rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
      </div>
      <div class="flex items-center gap-4">
        <div class="relative">
            <button id="filterButton" class="bg-[#2a2d3d] text-white rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-[#3a3d4d] transition">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Filter
            </button>
            <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#2a2d3d] rounded-lg shadow-xl z-10 overflow-hidden max-h-60 overflow-y-auto">
                </div>
        </div>
        <div class="relative">
        
            <button id="sortButton" class="bg-[#2a2d3d] text-white rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-[#3a3d4d] transition">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M7 12h10M10 18h4"/></svg>
                Sort By
            </button>
            <div id="sortDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#2a2d3d] rounded-lg shadow-xl z-10 overflow-hidden">
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="title_asc">Name (A-Z)</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="title_desc">Name (Z-A)</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="created_at_desc">Newest</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="created_at_asc">Oldest</a>
            </div>
        </div>
        <button id="addCardBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-blue-700 transition shadow-lg shadow-blue-600/20">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
          New Character
        </button>
    
      </div>
    </header>

    <main id="card-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-12">
      </main>
    <div id="loading" class="text-center py-10 hidden">Loading...</div>
    <div id="no-results" class="text-center py-10 hidden">No characters found.</div>

  </div>
  
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
      <button id="closePopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <h3 class="text-xl font-bold mb-6">Add New Character</h3>
      <form id="cardForm">
        <div class="mb-4">
          <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Character Name</label>
          <input type="text" id="title" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        </div>
     
       <div class="mb-4">
          <label for="imageUrl" class="block text-sm font-medium text-gray-300 mb-1">Image URL</label>
          <input type="text" id="imageUrl" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
            <div id="selectedTags" class="mb-2 flex flex-wrap gap-2"></div>
     
           <div class="flex gap-2">
                <input type="text" id="tagInput" placeholder="Add a new tag..." class="flex-grow bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button type="button" id="addTagBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-4 hover:bg-gray-700 transition">Add</button>
            </div>
            <div id="tagPool" class="mt-2 flex flex-wrap gap-1"></div>
    
         </div>

        <p id="errorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
        <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition shadow-lg shadow-blue-600/20">Save Character</button>
      </form>
    </div>
  </div>

  <div id="details-view" class="hidden fixed inset-0 bg-[#1a1b26] z-[100] p-4 md:p-8 overflow-y-auto">
      <button id="closeDetailsBtn" class="absolute top-6 right-6 text-gray-400 hover:text-white transition z-10">
          <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      
             <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
      </button>
      <div class="container mx-auto grid grid-cols-1 md:grid-cols-12 gap-4 items-center h-full">
          <div class="md:col-span-7 flex items-center justify-end h-full pt-10 md:pt-0">
              <img id="details-main-image" src="" alt="Character Image" class="max-w-full object-contain rounded-lg">
          </div>

      
         <div class="md:col-span-5 pt-10 md:pt-20">
              <h2 class="text-gray-400 text-2xl font-bold tracking-widest">GENERAL DATA</h2>
              <h1 id="details-title" class="gradient-text text-7xl md:text-8xl lg:text-8xl font-extrabold my-2 break-words">
                  </h1>

              <h3 class="text-gray-300 text-lg font-semibold mt-8 mb-3">Tags</h3>
              <div id="details-tags" class="flex flex-wrap gap-2">
                  </div>

              <div id="details-related-images-container" class="mt-8">
                   <div class="flex items-center justify-between mb-3">
                        <h3 class="text-gray-300 text-lg font-semibold">Related Images</h3>
            
                         <div id="details-controls" class="flex gap-2">
                            <button id="addRelatedBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-blue-700 transition">
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                Add
                            </button>
                            <button id="uploadRelatedBtn" class="bg-green-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-green-700 transition">
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.25 13.25a.75.75 0 001.5 0V4.636l2.955 3.129a.75.75 0 001.09-1.03l-4.25-4.5a.75.75 0 00-1.09 0l-4.25 4.5a.75.75 0 101.09 1.03L9.25 4.636v8.614z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
           
                                 Upload
                            </button>
                            <button id="manageRelatedBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-gray-700 transition">
          
                               <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                             
                                 Manage
                            </button>
                        </div>
                   </div>
                   <div id="details-related-images" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                       </div>
              </div>

              <div id="details-related-videos-container" class="mt-8">
                   <div class="flex items-center justify-between mb-3">
                        <h3 class="text-gray-300 text-lg font-semibold">Related Videos</h3>
                        <div id="details-video-controls" class="flex gap-2">
                            <button id="addRelatedVideoBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-blue-700 transition">
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                Add
                            </button>
                            <button id="manageRelatedVideosBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-gray-700 transition">
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                                Manage
                            </button>
                            </div>
                   </div>
                   <div id="details-related-videos" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                   </div>
              </div>
          </div>
      </div>
  </div>
  
  <div id="related-image-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
      <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
          <button id="closeRelatedPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
              <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
          <h3 class="text-xl font-bold mb-6">Add Related Images</h3>
          <form id="relatedImagesForm">
              <div class="mb-4">
               
                  <label for="relatedImageUrls" class="block text-sm font-medium text-gray-300 mb-1">Image URLs (one per line)</label>
                  <textarea id="relatedImageUrls" rows="5" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="https://example.com/image1.jpg\nhttps://example.com/image2.png"></textarea>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Tags for these images</label>
  
                               <div id="relatedSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="relatedTagPool" class="mt-2 flex flex-wrap gap-1"></div>
              </div>

              <p id="relatedErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
              <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Add Images</button>
   
           </form>
      </div>
  </div>

  <div id="edit-related-tags-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
        <button id="closeEditRelatedTagsPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      
         <h3 class="text-xl font-bold mb-4">Edit Image Tags</h3>
        <form id="editRelatedTagsForm">
            <img id="edit-related-preview-image" src="" class="w-full h-48 object-contain bg-black/20 rounded-lg mb-4">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
              <div id="editRelatedSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
             
               <div id="editRelatedTagPool" class="mt-2 flex flex-wrap gap-1 max-h-24 overflow-y-auto"></div>
            </div>
            <p id="editRelatedTagsErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
            <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Save Tags</button>
        </form>
    </div>
  </div>

  <div id="image-preview-view" class="hidden fixed inset-0 bg-black/90 z-[200] flex items-center justify-center p-4">
      <div class="relative w-full h-full flex items-center justify-center">
   
           <img id="preview-image" src="" class="max-w-full max-h-full object-contain">
        
        <button id="closePreviewBtn" class="absolute top-4 right-4 text-white/70 hover:text-white transition">
            <svg class="h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>

        <button id="prevPreviewBtn" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition bg-black/30 rounded-full p-2">
          
             <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
        </button>
        <button id="nextPreviewBtn" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition bg-black/30 rounded-full p-2">
            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
        </button>

        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-black/40 p-2 rounded-lg">
            <span id="previewCounter" class="text-white text-sm font-medium w-16 text-center"></span>
             <button id="zoomOutBtn" class="text-white/80 hover:text-white transition"><svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="zoomInBtn" class="text-white/80 hover:text-white transition"><svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="resetZoomBtn" class="text-white/80 hover:text-white transition"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.42 5.5 5.5 0 018.253-1.655l1.454-1.454a.75.75 0 011.06 1.06l-1.453 1.454a5.494 5.494 0 01-.01 2.01zm-1.85 2.152a.75.75 0 01-1.06 1.06l-1.455-1.454a5.5 5.5 0 01-8.253 1.655 5.5 5.5 0 019.201 4.42l-1.454 1.454a.75.75 0 11-1.06 1.06l1.453-1.454a5.494 5.494 0 01.01-2.01z" clip-rule="evenodd" /></svg></button>
        </div>
      </div>
  </div>

  <div id="related-video-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
      <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
          <button id="closeRelatedVideoPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
              <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
          <h3 class="text-xl font-bold mb-6">Add Related Videos</h3>
          <form id="relatedVideosForm">
              <div class="mb-4">
                  <label for="relatedVideoUrls" class="block text-sm font-medium text-gray-300 mb-1">Video URLs (one per line)</label>
                  <textarea id="relatedVideoUrls" rows="5" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="https://www.youtube.com/watch?v=...\nhttps://example.com/video.mp4"></textarea>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Tags for these videos</label>
                <div id="relatedVideoSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="relatedVideoTagPool" class="mt-2 flex flex-wrap gap-1"></div>
              </div>
              <p id="relatedVideoErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
              <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Add Videos</button>
          </form>
      </div>
  </div>
  
  <div id="edit-related-video-tags-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
        <button id="closeEditRelatedVideoTagsPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
         <h3 class="text-xl font-bold mb-4">Edit Video Tags</h3>
        <form id="editRelatedVideoTagsForm">
            <div id="edit-related-preview-video" class="w-full h-48 flex items-center justify-center bg-black/20 rounded-lg mb-4">
                </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
              <div id="editRelatedVideoSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
               <div id="editRelatedVideoTagPool" class="mt-2 flex flex-wrap gap-1 max-h-24 overflow-y-auto"></div>
            </div>
            <p id="editRelatedVideoTagsErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
            <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Save Tags</button>
        </form>
    </div>
  </div>
  <div id="video-preview-view" class="hidden fixed inset-0 bg-black/90 z-[400] flex items-center justify-center p-4">
      <div class="relative w-full max-w-4xl max-h-full">
          <div id="video-player-container" class="aspect-video bg-black">
              </div>
          <button id="closeVideoPreviewBtn" class="absolute -top-4 -right-4 md:top-2 md:right-2 text-white/70 hover:text-white transition bg-black/50 rounded-full p-1">
              <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
      </div>
  </div>

  <button id="scrollToTopBtn" class="hidden fixed bottom-8 right-8 bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700 transition z-50">
      <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" /></svg>
  </button>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://vqkfqjqjqjqjqjqjqjqj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxa2ZxanFqcWpxanFqcWpxanFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjg2NDM4ODUsImV4cCI6MjA0NDIxOTg4NX0.0y5y8y8y8y8y8y8y8y8y8y8y8y8y8y8y8y8y8y8y8';
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global variables
    let characters = [];
    let filteredCharacters = [];
    let currentSort = 'created_at_desc';
    let currentCharacterId = null;
    let currentRelatedImages = [];
    let currentRelatedVideos = [];
    let currentPreviewIndex = 0;
    let currentScale = 1;
    let currentTranslateX = 0;
    let currentTranslateY = 0;
    let isPanning = false;
    let startX, startY;
    let initialPinchDistance = null;
    let allTags = [];
    let selectedTags = [];
    let isManageMode = false;
    let isVideoManageMode = false;
    let isDragging = false;
    let dragImageIndex = null;
    let dragVideoIndex = null;

    // DOM elements
    const cardGallery = document.getElementById('card-gallery');
    const loadingElement = document.getElementById('loading');
    const noResultsElement = document.getElementById('no-results');
    const characterCounter = document.getElementById('character-counter');
    const searchInput = document.getElementById('searchInput');
    const filterButton = document.getElementById('filterButton');
    const filterDropdown = document.getElementById('filterDropdown');
    const sortButton = document.getElementById('sortButton');
    const sortDropdown = document.getElementById('sortDropdown');
    const addCardBtn = document.getElementById('addCardBtn');
    const popup = document.getElementById('popup');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const cardForm = document.getElementById('cardForm');
    const titleInput = document.getElementById('title');
    const imageUrlInput = document.getElementById('imageUrl');
    const errorMessage = document.getElementById('errorMessage');
    const detailsView = document.getElementById('details-view');
    const closeDetailsBtn = document.getElementById('closeDetailsBtn');
    const detailsTitle = document.getElementById('details-title');
    const detailsMainImage = document.getElementById('details-main-image');
    const detailsTags = document.getElementById('details-tags');
    const detailsRelatedImages = document.getElementById('details-related-images');
    const detailsRelatedVideos = document.getElementById('details-related-videos');
    const addRelatedBtn = document.getElementById('addRelatedBtn');
    const uploadRelatedBtn = document.getElementById('uploadRelatedBtn');
    const manageRelatedBtn = document.getElementById('manageRelatedBtn');
    const relatedImagePopup = document.getElementById('related-image-popup');
    const closeRelatedPopupBtn = document.getElementById('closeRelatedPopupBtn');
    const relatedImagesForm = document.getElementById('relatedImagesForm');
    const relatedImageUrls = document.getElementById('relatedImageUrls');
    const relatedErrorMessage = document.getElementById('relatedErrorMessage');
    const imagePreviewView = document.getElementById('image-preview-view');
    const previewImage = document.getElementById('preview-image');
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    const prevPreviewBtn = document.getElementById('prevPreviewBtn');
    const nextPreviewBtn = document.getElementById('nextPreviewBtn');
    const previewCounter = document.getElementById('previewCounter');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const tagInput = document.getElementById('tagInput');
    const addTagBtn = document.getElementById('addTagBtn');
    const selectedTagsContainer = document.getElementById('selectedTags');
    const tagPool = document.getElementById('tagPool');
    const relatedSelectedTags = document.getElementById('relatedSelectedTags');
    const relatedTagPool = document.getElementById('relatedTagPool');
    const editRelatedTagsPopup = document.getElementById('edit-related-tags-popup');
    const closeEditRelatedTagsPopupBtn = document.getElementById('closeEditRelatedTagsPopupBtn');
    const editRelatedTagsForm = document.getElementById('editRelatedTagsForm');
    const editRelatedSelectedTags = document.getElementById('editRelatedSelectedTags');
    const editRelatedTagPool = document.getElementById('editRelatedTagPool');
    const editRelatedPreviewImage = document.getElementById('edit-related-preview-image');
    const editRelatedTagsErrorMessage = document.getElementById('editRelatedTagsErrorMessage');
    const relatedVideoPopup = document.getElementById('related-video-popup');
    const closeRelatedVideoPopupBtn = document.getElementById('closeRelatedVideoPopupBtn');
    const relatedVideosForm = document.getElementById('relatedVideosForm');
    const relatedVideoUrls = document.getElementById('relatedVideoUrls');
    const relatedVideoErrorMessage = document.getElementById('relatedVideoErrorMessage');
    const relatedVideoSelectedTags = document.getElementById('relatedVideoSelectedTags');
    const relatedVideoTagPool = document.getElementById('relatedVideoTagPool');
    const addRelatedVideoBtn = document.getElementById('addRelatedVideoBtn');
    const manageRelatedVideosBtn = document.getElementById('manageRelatedVideosBtn');
    const editRelatedVideoTagsPopup = document.getElementById('edit-related-video-tags-popup');
    const closeEditRelatedVideoTagsPopupBtn = document.getElementById('closeEditRelatedVideoTagsPopupBtn');
    const editRelatedVideoTagsForm = document.getElementById('editRelatedVideoTagsForm');
    const editRelatedVideoSelectedTags = document.getElementById('editRelatedVideoSelectedTags');
    const editRelatedVideoTagPool = document.getElementById('editRelatedVideoTagPool');
    const editRelatedPreviewVideo = document.getElementById('edit-related-preview-video');
    const editRelatedVideoTagsErrorMessage = document.getElementById('editRelatedVideoTagsErrorMessage');
    const videoPreviewView = document.getElementById('video-preview-view');
    const videoPlayerContainer = document.getElementById('video-player-container');
    const closeVideoPreviewBtn = document.getElementById('closeVideoPreviewBtn');

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      fetchCharacters();
      setupEventListeners();
    });

    // Set up event listeners
    function setupEventListeners() {
      searchInput.addEventListener('input', debounce(handleSearch, 300));
      filterButton.addEventListener('click', toggleFilterDropdown);
      sortButton.addEventListener('click', toggleSortDropdown);
      addCardBtn.addEventListener('click', openPopup);
      closePopupBtn.addEventListener('click', closePopup);
      cardForm.addEventListener('submit', handleFormSubmit);
      closeDetailsBtn.addEventListener('click', closeDetailsView);
      addRelatedBtn.addEventListener('click', openRelatedImagePopup);
      uploadRelatedBtn.addEventListener('click', handleUploadRelated);
      manageRelatedBtn.addEventListener('click', toggleManageMode);
      closeRelatedPopupBtn.addEventListener('click', closeRelatedImagePopup);
      relatedImagesForm.addEventListener('submit', handleRelatedImagesSubmit);
      closePreviewBtn.addEventListener('click', closeImagePreview);
      prevPreviewBtn.addEventListener('click', showPrevImage);
      nextPreviewBtn.addEventListener('click', showNextImage);
      zoomInBtn.addEventListener('click', zoomIn);
      zoomOutBtn.addEventListener('click', zoomOut);
      resetZoomBtn.addEventListener('click', resetZoom);
      scrollToTopBtn.addEventListener('click', scrollToTop);
      window.addEventListener('scroll', toggleScrollToTopButton);
      addTagBtn.addEventListener('click', addNewTag);
      tagInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addNewTag();
        }
      });
      closeEditRelatedTagsPopupBtn.addEventListener('click', closeEditRelatedTagsPopup);
      editRelatedTagsForm.addEventListener('submit', handleEditRelatedTagsSubmit);
      addRelatedVideoBtn.addEventListener('click', openRelatedVideoPopup);
      manageRelatedVideosBtn.addEventListener('click', toggleVideoManageMode);
      closeRelatedVideoPopupBtn.addEventListener('click', closeRelatedVideoPopup);
      relatedVideosForm.addEventListener('submit', handleRelatedVideosSubmit);
      closeEditRelatedVideoTagsPopupBtn.addEventListener('click', closeEditRelatedVideoTagsPopup);
      editRelatedVideoTagsForm.addEventListener('submit', handleEditRelatedVideoTagsSubmit);
      closeVideoPreviewBtn.addEventListener('click', closeVideoPreview);

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(event) {
        if (!filterButton.contains(event.target) && !filterDropdown.contains(event.target)) {
          filterDropdown.classList.add('hidden');
        }
        if (!sortButton.contains(event.target) && !sortDropdown.contains(event.target)) {
          sortDropdown.classList.add('hidden');
        }
      });

      // Image preview panning and zooming
      previewImage.addEventListener('mousedown', startPanning);
      previewImage.addEventListener('touchstart', handleTouchStart, { passive: false });
      previewImage.addEventListener('touchmove', handleTouchMove, { passive: false });
      previewImage.addEventListener('touchend', handleTouchEnd);
      
      window.addEventListener('mousemove', doPanning);
      window.addEventListener('mouseup', stopPanning);
      
      // Keyboard navigation for image preview
      document.addEventListener('keydown', handleKeydown);
    }

    // Fetch characters from Supabase
    async function fetchCharacters() {
      try {
        loadingElement.classList.remove('hidden');
        noResultsElement.classList.add('hidden');
        
        let query = supabase
          .from('characters')
          .select('*');
          
        // Apply sorting
        if (currentSort === 'title_asc') {
          query = query.order('title', { ascending: true });
        } else if (currentSort === 'title_desc') {
          query = query.order('title', { ascending: false });
        } else if (currentSort === 'created_at_asc') {
          query = query.order('created_at', { ascending: true });
        } else {
          query = query.order('created_at', { ascending: false });
        }
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        characters = data || [];
        filteredCharacters = [...characters];
        
        // Fetch all tags
        await fetchAllTags();
        
        renderCharacters();
        updateCharacterCounter();
        
        loadingElement.classList.add('hidden');
        
        if (characters.length === 0) {
          noResultsElement.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error fetching characters:', error);
        loadingElement.classList.add('hidden');
        noResultsElement.classList.remove('hidden');
      }
    }

    // Fetch all tags from all characters
    async function fetchAllTags() {
      try {
        allTags = [];
        const characterTags = characters.map(character => character.tags || []);
        
        characterTags.forEach(tags => {
          tags.forEach(tag => {
            if (!allTags.includes(tag)) {
              allTags.push(tag);
            }
          });
        });
        
        allTags.sort();
        renderFilterDropdown();
      } catch (error) {
        console.error('Error fetching tags:', error);
      }
    }

    // Render characters in the gallery
    function renderCharacters() {
      if (filteredCharacters.length === 0) {
        cardGallery.innerHTML = '';
        noResultsElement.classList.remove('hidden');
        return;
      }
      
      noResultsElement.classList.add('hidden');
      
      cardGallery.innerHTML = filteredCharacters.map(character => `
        <div class="card group relative bg-[#2a2d3d] rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer" data-id="${character.id}">
          <div class="aspect-[3/4] relative overflow-hidden">
            <img src="${character.image_url}" alt="${character.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
              <h3 class="text-white text-xl font-bold truncate">${character.title}</h3>
            </div>
          </div>
          <div class="p-4">
            <div class="flex flex-wrap gap-1">
              ${(character.tags || []).slice(0, 3).map(tag => `
                <span class="text-xs bg-blue-900/30 text-blue-300 px-2 py-1 rounded-full">${tag}</span>
              `).join('')}
              ${(character.tags || []).length > 3 ? `<span class="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded-full">+${(character.tags || []).length - 3}</span>` : ''}
            </div>
          </div>
        </div>
      `).join('');
      
      // Add click event to each card
      document.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', function() {
          const characterId = this.getAttribute('data-id');
          openDetailsView(characterId);
        });
      });
    }

    // Update character counter
    function updateCharacterCounter() {
      const total = characters.length;
      const showing = filteredCharacters.length;
      
      if (total === showing) {
        characterCounter.textContent = `${total} Characters`;
      } else {
        characterCounter.textContent = `${showing} of ${total} Characters`;
      }
    }

    // Handle search
    function handleSearch() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      if (searchTerm === '') {
        filteredCharacters = [...characters];
      } else {
        filteredCharacters = characters.filter(character => 
          character.title.toLowerCase().includes(searchTerm) ||
          (character.tags || []).some(tag => tag.toLowerCase().includes(searchTerm))
        );
      }
      
      applyCurrentSort();
      renderCharacters();
      updateCharacterCounter();
    }

    // Toggle filter dropdown
    function toggleFilterDropdown() {
      filterDropdown.classList.toggle('hidden');
      sortDropdown.classList.add('hidden');
    }

    // Toggle sort dropdown
    function toggleSortDropdown() {
      sortDropdown.classList.toggle('hidden');
      filterDropdown.classList.add('hidden');
      
      // Set up sort options
      document.querySelectorAll('.sort-option').forEach(option => {
        option.addEventListener('click', function(e) {
          e.preventDefault();
          currentSort = this.getAttribute('data-sort');
          applyCurrentSort();
          renderCharacters();
          sortDropdown.classList.add('hidden');
        });
      });
    }

    // Apply current sort to filtered characters
    function applyCurrentSort() {
      if (currentSort === 'title_asc') {
        filteredCharacters.sort((a, b) => a.title.localeCompare(b.title));
      } else if (currentSort === 'title_desc') {
        filteredCharacters.sort((a, b) => b.title.localeCompare(a.title));
      } else if (currentSort === 'created_at_asc') {
        filteredCharacters.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      } else {
        filteredCharacters.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }
    }

    // Render filter dropdown with tags
    function renderFilterDropdown() {
      filterDropdown.innerHTML = '';
      
      if (allTags.length === 0) {
        filterDropdown.innerHTML = '<div class="px-4 py-2 text-sm text-gray-400">No tags available</div>';
        return;
      }
      
      allTags.forEach(tag => {
        const isSelected = selectedTags.includes(tag);
        const tagElement = document.createElement('div');
        tagElement.className = `tag px-4 py-2 text-sm ${isSelected ? 'selected text-white' : 'text-gray-300 hover:bg-blue-600 hover:text-white'}`;
        tagElement.textContent = tag;
        tagElement.addEventListener('click', () => toggleTagFilter(tag));
        filterDropdown.appendChild(tagElement);
      });
      
      // Add clear filters option
      if (selectedTags.length > 0) {
        const clearElement = document.createElement('div');
        clearElement.className = 'px-4 py-2 text-sm text-red-400 hover:bg-red-600 hover:text-white border-t border-gray-600 mt-2';
        clearElement.textContent = 'Clear Filters';
        clearElement.addEventListener('click', clearTagFilters);
        filterDropdown.appendChild(clearElement);
      }
    }

    // Toggle tag filter
    function toggleTagFilter(tag) {
      if (selectedTags.includes(tag)) {
        selectedTags = selectedTags.filter(t => t !== tag);
      } else {
        selectedTags.push(tag);
      }
      
      applyTagFilters();
      renderFilterDropdown();
    }

    // Apply tag filters
    function applyTagFilters() {
      if (selectedTags.length === 0) {
        filteredCharacters = [...characters];
      } else {
        filteredCharacters = characters.filter(character => 
          selectedTags.every(tag => (character.tags || []).includes(tag))
        );
      }
      
      applyCurrentSort();
      renderCharacters();
      updateCharacterCounter();
    }

    // Clear all tag filters
    function clearTagFilters() {
      selectedTags = [];
      applyTagFilters();
      renderFilterDropdown();
    }

    // Open add character popup
    function openPopup() {
      popup.style.display = 'flex';
      renderTagPool(tagPool, [], true);
      selectedTagsContainer.innerHTML = '';
    }

    // Close add character popup
    function closePopup() {
      popup.style.display = 'none';
      cardForm.reset();
      errorMessage.textContent = '';
      selectedTags = [];
    }

    // Handle form submission for new character
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const title = titleInput.value.trim();
      const imageUrl = imageUrlInput.value.trim();
      
      if (!title) {
        errorMessage.textContent = 'Please enter a character name';
        return;
      }
      
      if (!imageUrl) {
        errorMessage.textContent = 'Please enter an image URL';
        return;
      }
      
      try {
        errorMessage.textContent = 'Saving...';
        
        const { data, error } = await supabase
          .from('characters')
          .insert([
            {
              title: title,
              image_url: imageUrl,
              tags: selectedTags
            }
          ])
          .select();
        
        if (error) throw error;
        
        closePopup();
        fetchCharacters();
      } catch (error) {
        console.error('Error creating character:', error);
        errorMessage.textContent = 'Error creating character. Please try again.';
      }
    }

    // Open character details view
    async function openDetailsView(characterId) {
      try {
        const { data, error } = await supabase
          .from('characters')
          .select('*')
          .eq('id', characterId)
          .single();
        
        if (error) throw error;
        
        currentCharacterId = characterId;
        detailsTitle.textContent = data.title;
        detailsMainImage.src = data.image_url;
        detailsMainImage.alt = data.title;
        
        // Render tags
        detailsTags.innerHTML = '';
        if (data.tags && data.tags.length > 0) {
          data.tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag bg-blue-900/30 text-blue-300 px-3 py-1 rounded-full text-sm';
            tagElement.textContent = tag;
            detailsTags.appendChild(tagElement);
          });
        } else {
          detailsTags.innerHTML = '<span class="text-gray-500">No tags</span>';
        }
        
        // Fetch related images
        await fetchRelatedImages(characterId);
        
        // Fetch related videos
        await fetchRelatedVideos(characterId);
        
        // Show details view
        detailsView.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      } catch (error) {
        console.error('Error fetching character details:', error);
      }
    }

    // Close character details view
    function closeDetailsView() {
      detailsView.classList.add('hidden');
      document.body.style.overflow = 'auto';
      currentCharacterId = null;
      currentRelatedImages = [];
      currentRelatedVideos = [];
      isManageMode = false;
      isVideoManageMode = false;
      updateManageButtonState();
    }

    // Fetch related images for a character
    async function fetchRelatedImages(characterId) {
      try {
        const { data, error } = await supabase
          .from('related_images')
          .select('*')
          .eq('character_id', characterId)
          .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        currentRelatedImages = data || [];
        renderRelatedImages();
      } catch (error) {
        console.error('Error fetching related images:', error);
        currentRelatedImages = [];
      }
    }

    // Fetch related videos for a character
    async function fetchRelatedVideos(characterId) {
      try {
        const { data, error } = await supabase
          .from('related_videos')
          .select('*')
          .eq('character_id', characterId)
          .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        currentRelatedVideos = data || [];
        renderRelatedVideos();
      } catch (error) {
        console.error('Error fetching related videos:', error);
        currentRelatedVideos = [];
      }
    }

    // Render related images
    function renderRelatedImages() {
      detailsRelatedImages.innerHTML = '';
      
      if (currentRelatedImages.length === 0) {
        detailsRelatedImages.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No related images</div>';
        return;
      }
      
      currentRelatedImages.forEach((image, index) => {
        const imageElement = document.createElement('div');
        imageElement.className = `relative aspect-square rounded-lg overflow-hidden cursor-pointer ${isManageMode ? 'cursor-grab' : ''}`;
        imageElement.setAttribute('data-id', image.id);
        imageElement.setAttribute('data-index', index);
        
        imageElement.innerHTML = `
          <img src="${image.image_url}" alt="Related image" class="w-full h-full object-cover">
          ${isManageMode ? `
            <div class="absolute inset-0 bg-black/50 flex items-center justify-center gap-2 opacity-0 hover:opacity-100 transition-opacity">
              <button class="edit-image-btn bg-blue-600 text-white p-1.5 rounded-full hover:bg-blue-700 transition">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
              </button>
              <button class="delete-image-btn bg-red-600 text-white p-1.5 rounded-full hover:bg-red-700 transition">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          ` : ''}
        `;
        
        detailsRelatedImages.appendChild(imageElement);
        
        // Add click event for preview (only when not in manage mode)
        if (!isManageMode) {
          imageElement.addEventListener('click', () => {
            openImagePreview(index);
          });
        }
        
        // Add event listeners for edit and delete buttons (only in manage mode)
        if (isManageMode) {
          const editBtn = imageElement.querySelector('.edit-image-btn');
          const deleteBtn = imageElement.querySelector('.delete-image-btn');
          
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditRelatedTagsPopup(image);
          });
          
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteRelatedImage(image.id);
          });
        }
      });
      
      // Initialize Sortable for drag and drop reordering (only in manage mode)
      if (isManageMode) {
        initImageSortable();
      }
    }

    // Render related videos
    function renderRelatedVideos() {
      detailsRelatedVideos.innerHTML = '';
      
      if (currentRelatedVideos.length === 0) {
        detailsRelatedVideos.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No related videos</div>';
        return;
      }
      
      currentRelatedVideos.forEach((video, index) => {
        const videoElement = document.createElement('div');
        videoElement.className = `relative aspect-video rounded-lg overflow-hidden cursor-pointer ${isVideoManageMode ? 'cursor-grab' : ''}`;
        videoElement.setAttribute('data-id', video.id);
        videoElement.setAttribute('data-index', index);
        
        // Generate thumbnail for video
        const thumbnailUrl = generateVideoThumbnail(video.video_url);
        
        videoElement.innerHTML = `
          <img src="${thumbnailUrl}" alt="Video thumbnail" class="w-full h-full object-cover">
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="bg-black/50 rounded-full p-2">
              <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </div>
          </div>
          ${isVideoManageMode ? `
            <div class="absolute inset-0 bg-black/50 flex items-center justify-center gap-2 opacity-0 hover:opacity-100 transition-opacity">
              <button class="edit-video-btn bg-blue-600 text-white p-1.5 rounded-full hover:bg-blue-700 transition">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
              </button>
              <button class="delete-video-btn bg-red-600 text-white p-1.5 rounded-full hover:bg-red-700 transition">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          ` : ''}
        `;
        
        detailsRelatedVideos.appendChild(videoElement);
        
        // Add click event for video preview (only when not in manage mode)
        if (!isVideoManageMode) {
          videoElement.addEventListener('click', () => {
            openVideoPreview(video.video_url);
          });
        }
        
        // Add event listeners for edit and delete buttons (only in manage mode)
        if (isVideoManageMode) {
          const editBtn = videoElement.querySelector('.edit-video-btn');
          const deleteBtn = videoElement.querySelector('.delete-video-btn');
          
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openEditRelatedVideoTagsPopup(video);
          });
          
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteRelatedVideo(video.id);
          });
        }
      });
      
      // Initialize Sortable for drag and drop reordering (only in manage mode)
      if (isVideoManageMode) {
        initVideoSortable();
      }
    }

    // Generate video thumbnail
    function generateVideoThumbnail(videoUrl) {
      // For YouTube videos
      if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        let videoId = '';
        
        if (videoUrl.includes('youtube.com')) {
          const urlParams = new URLSearchParams(new URL(videoUrl).search);
          videoId = urlParams.get('v');
        } else if (videoUrl.includes('youtu.be')) {
          videoId = videoUrl.split('/').pop().split('?')[0];
        }
        
        if (videoId) {
          return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        }
      }
      
      // For other video URLs, we'll use a generic video thumbnail
      // In a real application, you might want to generate a thumbnail from the video
      return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjExMiIgdmlld0JveD0iMCAwIDIwMCAxMTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTEyIiBmaWxsPSIjMkEyRDNkIi8+CjxwYXRoIGQ9Ik04MCA1NkM4MCA1NC44OTU0IDgwLjg5NTQgNTQgODIgNTRIMTExQzExMi4xMDUgNTQgMTEzIDU0Ljg5NTQgMTEzIDU2Vjc4QzExMyA3OS4xMDQ2IDExMi4xMDUgODAgMTExIDgwSDgyQzgwLjg5NTQgODAgODAgNzkuMTA0NiA4MCA3OFY1NloiIGZpbGw9IiM0YTZlZmYiLz4KPC9zdmc+';
    }

    // Open related image popup
    function openRelatedImagePopup() {
      relatedImagePopup.style.display = 'flex';
      relatedImageUrls.value = '';
      relatedErrorMessage.textContent = '';
      renderTagPool(relatedTagPool, [], true);
      relatedSelectedTags.innerHTML = '';
    }

    // Close related image popup
    function closeRelatedImagePopup() {
      relatedImagePopup.style.display = 'none';
      relatedImagesForm.reset();
      relatedErrorMessage.textContent = '';
    }

    // Handle related images form submission
    async function handleRelatedImagesSubmit(e) {
      e.preventDefault();
      
      const imageUrlsText = relatedImageUrls.value.trim();
      
      if (!imageUrlsText) {
        relatedErrorMessage.textContent = 'Please enter at least one image URL';
        return;
      }
      
      const imageUrls = imageUrlsText.split('\n').filter(url => url.trim() !== '');
      
      if (imageUrls.length === 0) {
        relatedErrorMessage.textContent = 'Please enter at least one valid image URL';
        return;
      }
      
      try {
        relatedErrorMessage.textContent = 'Adding images...';
        
        // Get the current maximum sort_order for this character
        const { data: existingImages, error: existingError } = await supabase
          .from('related_images')
          .select('sort_order')
          .eq('character_id', currentCharacterId)
          .order('sort_order', { ascending: false })
          .limit(1);
        
        if (existingError) throw existingError;
        
        let nextSortOrder = 0;
        if (existingImages && existingImages.length > 0) {
          nextSortOrder = existingImages[0].sort_order + 1;
        }
        
        // Prepare the images to insert
        const imagesToInsert = imageUrls.map((url, index) => ({
          character_id: currentCharacterId,
          image_url: url.trim(),
          tags: [],
          sort_order: nextSortOrder + index
        }));
        
        const { error } = await supabase
          .from('related_images')
          .insert(imagesToInsert);
        
        if (error) throw error;
        
        closeRelatedImagePopup();
        fetchRelatedImages(currentCharacterId);
      } catch (error) {
        console.error('Error adding related images:', error);
        relatedErrorMessage.textContent = 'Error adding images. Please try again.';
      }
    }

    // Handle upload related images (placeholder)
    function handleUploadRelated() {
      alert('Upload functionality would be implemented here. This is a placeholder.');
    }

    // Toggle manage mode for images
    function toggleManageMode() {
      isManageMode = !isManageMode;
      updateManageButtonState();
      renderRelatedImages();
    }

    // Toggle manage mode for videos
    function toggleVideoManageMode() {
      isVideoManageMode = !isVideoManageMode;
      updateManageButtonState();
      renderRelatedVideos();
    }

    // Update manage button state
    function updateManageButtonState() {
      if (isManageMode) {
        manageRelatedBtn.classList.remove('bg-gray-600');
        manageRelatedBtn.classList.add('bg-blue-600');
        manageRelatedBtn.innerHTML = `
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>
          Done
        `;
      } else {
        manageRelatedBtn.classList.remove('bg-blue-600');
        manageRelatedBtn.classList.add('bg-gray-600');
        manageRelatedBtn.innerHTML = `
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
          Manage
        `;
      }
      
      if (isVideoManageMode) {
        manageRelatedVideosBtn.classList.remove('bg-gray-600');
        manageRelatedVideosBtn.classList.add('bg-blue-600');
        manageRelatedVideosBtn.innerHTML = `
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>
          Done
        `;
      } else {
        manageRelatedVideosBtn.classList.remove('bg-blue-600');
        manageRelatedVideosBtn.classList.add('bg-gray-600');
        manageRelatedVideosBtn.innerHTML = `
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
          Manage
        `;
      }
    }

    // Initialize Sortable for image reordering
    function initImageSortable() {
      if (!isManageMode) return;
      
      new Sortable(detailsRelatedImages, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: async function(evt) {
          const fromIndex = evt.oldIndex;
          const toIndex = evt.newIndex;
          
          if (fromIndex === toIndex) return;
          
          // Update the sort_order for all affected images
          const updatedImages = [...currentRelatedImages];
          const [movedImage] = updatedImages.splice(fromIndex, 1);
          updatedImages.splice(toIndex, 0, movedImage);
          
          // Update sort_order for all images
          const updatePromises = updatedImages.map((image, index) => {
            return supabase
              .from('related_images')
              .update({ sort_order: index })
              .eq('id', image.id);
          });
          
          try {
            await Promise.all(updatePromises);
            await fetchRelatedImages(currentCharacterId);
          } catch (error) {
            console.error('Error reordering images:', error);
          }
        }
      });
    }

    // Initialize Sortable for video reordering
    function initVideoSortable() {
      if (!isVideoManageMode) return;
      
      new Sortable(detailsRelatedVideos, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: async function(evt) {
          const fromIndex = evt.oldIndex;
          const toIndex = evt.newIndex;
          
          if (fromIndex === toIndex) return;
          
          // Update the sort_order for all affected videos
          const updatedVideos = [...currentRelatedVideos];
          const [movedVideo] = updatedVideos.splice(fromIndex, 1);
          updatedVideos.splice(toIndex, 0, movedVideo);
          
          // Update sort_order for all videos
          const updatePromises = updatedVideos.map((video, index) => {
            return supabase
              .from('related_videos')
              .update({ sort_order: index })
              .eq('id', video.id);
          });
          
          try {
            await Promise.all(updatePromises);
            await fetchRelatedVideos(currentCharacterId);
          } catch (error) {
            console.error('Error reordering videos:', error);
          }
        }
      });
    }

    // Delete related image
    async function deleteRelatedImage(imageId) {
      if (!confirm('Are you sure you want to delete this image?')) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('related_images')
          .delete()
          .eq('id', imageId);
        
        if (error) throw error;
        
        fetchRelatedImages(currentCharacterId);
      } catch (error) {
        console.error('Error deleting related image:', error);
        alert('Error deleting image. Please try again.');
      }
    }

    // Delete related video
    async function deleteRelatedVideo(videoId) {
      if (!confirm('Are you sure you want to delete this video?')) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('related_videos')
          .delete()
          .eq('id', videoId);
        
        if (error) throw error;
        
        fetchRelatedVideos(currentCharacterId);
      } catch (error) {
        console.error('Error deleting related video:', error);
        alert('Error deleting video. Please try again.');
      }
    }

    // Open edit related tags popup
    function openEditRelatedTagsPopup(image) {
      editRelatedTagsPopup.style.display = 'flex';
      editRelatedPreviewImage.src = image.image_url;
      editRelatedPreviewImage.alt = 'Image to edit';
      renderTagPool(editRelatedTagPool, image.tags || [], false);
      editRelatedSelectedTags.innerHTML = '';
      
      // Store the current image being edited
      editRelatedTagsPopup.setAttribute('data-image-id', image.id);
      
      // Render selected tags
      if (image.tags && image.tags.length > 0) {
        image.tags.forEach(tag => {
          addTagToSelected(tag, editRelatedSelectedTags, editRelatedTagPool, false);
        });
      }
    }

    // Close edit related tags popup
    function closeEditRelatedTagsPopup() {
      editRelatedTagsPopup.style.display = 'none';
      editRelatedTagsForm.reset();
      editRelatedTagsErrorMessage.textContent = '';
    }

    // Handle edit related tags form submission
    async function handleEditRelatedTagsSubmit(e) {
      e.preventDefault();
      
      const imageId = editRelatedTagsPopup.getAttribute('data-image-id');
      const selectedTags = Array.from(editRelatedSelectedTags.querySelectorAll('.tag'))
        .map(tag => tag.getAttribute('data-tag'));
      
      try {
        editRelatedTagsErrorMessage.textContent = 'Saving...';
        
        const { error } = await supabase
          .from('related_images')
          .update({ tags: selectedTags })
          .eq('id', imageId);
        
        if (error) throw error;
        
        closeEditRelatedTagsPopup();
        fetchRelatedImages(currentCharacterId);
      } catch (error) {
        console.error('Error updating image tags:', error);
        editRelatedTagsErrorMessage.textContent = 'Error updating tags. Please try again.';
      }
    }

    // Open related video popup
    function openRelatedVideoPopup() {
      relatedVideoPopup.style.display = 'flex';
      relatedVideoUrls.value = '';
      relatedVideoErrorMessage.textContent = '';
      renderTagPool(relatedVideoTagPool, [], true);
      relatedVideoSelectedTags.innerHTML = '';
    }

    // Close related video popup
    function closeRelatedVideoPopup() {
      relatedVideoPopup.style.display = 'none';
      relatedVideosForm.reset();
      relatedVideoErrorMessage.textContent = '';
    }

    // Handle related videos form submission
    async function handleRelatedVideosSubmit(e) {
      e.preventDefault();
      
      const videoUrlsText = relatedVideoUrls.value.trim();
      
      if (!videoUrlsText) {
        relatedVideoErrorMessage.textContent = 'Please enter at least one video URL';
        return;
      }
      
      const videoUrls = videoUrlsText.split('\n').filter(url => url.trim() !== '');
      
      if (videoUrls.length === 0) {
        relatedVideoErrorMessage.textContent = 'Please enter at least one valid video URL';
        return;
      }
      
      try {
        relatedVideoErrorMessage.textContent = 'Adding videos...';
        
        // Get the current maximum sort_order for this character
        const { data: existingVideos, error: existingError } = await supabase
          .from('related_videos')
          .select('sort_order')
          .eq('character_id', currentCharacterId)
          .order('sort_order', { ascending: false })
          .limit(1);
        
        if (existingError) throw existingError;
        
        let nextSortOrder = 0;
        if (existingVideos && existingVideos.length > 0) {
          nextSortOrder = existingVideos[0].sort_order + 1;
        }
        
        // Prepare the videos to insert
        const videosToInsert = videoUrls.map((url, index) => ({
          character_id: currentCharacterId,
          video_url: url.trim(),
          tags: [],
          sort_order: nextSortOrder + index
        }));
        
        const { error } = await supabase
          .from('related_videos')
          .insert(videosToInsert);
        
        if (error) throw error;
        
        closeRelatedVideoPopup();
        fetchRelatedVideos(currentCharacterId);
      } catch (error) {
        console.error('Error adding related videos:', error);
        relatedVideoErrorMessage.textContent = 'Error adding videos. Please try again.';
      }
    }

    // Open edit related video tags popup
    function openEditRelatedVideoTagsPopup(video) {
      editRelatedVideoTagsPopup.style.display = 'flex';
      
      // Create video thumbnail preview
      const thumbnailUrl = generateVideoThumbnail(video.video_url);
      editRelatedPreviewVideo.innerHTML = `
        <img src="${thumbnailUrl}" alt="Video thumbnail" class="w-full h-full object-cover">
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="bg-black/50 rounded-full p-2">
            <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
          </div>
        </div>
      `;
      
      renderTagPool(editRelatedVideoTagPool, video.tags || [], false);
      editRelatedVideoSelectedTags.innerHTML = '';
      
      // Store the current video being edited
      editRelatedVideoTagsPopup.setAttribute('data-video-id', video.id);
      
      // Render selected tags
      if (video.tags && video.tags.length > 0) {
        video.tags.forEach(tag => {
          addTagToSelected(tag, editRelatedVideoSelectedTags, editRelatedVideoTagPool, false);
        });
      }
    }

    // Close edit related video tags popup
    function closeEditRelatedVideoTagsPopup() {
      editRelatedVideoTagsPopup.style.display = 'none';
      editRelatedVideoTagsForm.reset();
      editRelatedVideoTagsErrorMessage.textContent = '';
    }

    // Handle edit related video tags form submission
    async function handleEditRelatedVideoTagsSubmit(e) {
      e.preventDefault();
      
      const videoId = editRelatedVideoTagsPopup.getAttribute('data-video-id');
      const selectedTags = Array.from(editRelatedVideoSelectedTags.querySelectorAll('.tag'))
        .map(tag => tag.getAttribute('data-tag'));
      
      try {
        editRelatedVideoTagsErrorMessage.textContent = 'Saving...';
        
        const { error } = await supabase
          .from('related_videos')
          .update({ tags: selectedTags })
          .eq('id', videoId);
        
        if (error) throw error;
        
        closeEditRelatedVideoTagsPopup();
        fetchRelatedVideos(currentCharacterId);
      } catch (error) {
        console.error('Error updating video tags:', error);
        editRelatedVideoTagsErrorMessage.textContent = 'Error updating tags. Please try again.';
      }
    }

    // Open image preview
    function openImagePreview(index) {
      currentPreviewIndex = index;
      currentScale = 1;
      currentTranslateX = 0;
      currentTranslateY = 0;
      updatePreviewImage();
      imagePreviewView.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Close image preview
    function closeImagePreview() {
      imagePreviewView.classList.add('hidden');
      document.body.style.overflow = 'auto';
      resetZoom();
    }

    // Update preview image
    function updatePreviewImage() {
      if (currentRelatedImages.length === 0) return;
      
      const image = currentRelatedImages[currentPreviewIndex];
      previewImage.src = image.image_url;
      previewImage.alt = 'Preview image';
      previewCounter.textContent = `${currentPreviewIndex + 1} / ${currentRelatedImages.length}`;
      
      // Reset transform
      previewImage.style.transform = `scale(1) translate(0px, 0px)`;
      previewImage.classList.remove('is-panning');
    }

    // Show previous image in preview
    function showPrevImage() {
      if (currentPreviewIndex > 0) {
        currentPreviewIndex--;
        updatePreviewImage();
      }
    }

    // Show next image in preview
    function showNextImage() {
      if (currentPreviewIndex < currentRelatedImages.length - 1) {
        currentPreviewIndex++;
        updatePreviewImage();
      }
    }

    // Zoom in
    function zoomIn() {
      currentScale += 0.25;
      updateImageTransform();
    }

    // Zoom out
    function zoomOut() {
      if (currentScale > 0.5) {
        currentScale -= 0.25;
        updateImageTransform();
      }
    }

    // Reset zoom
    function resetZoom() {
      currentScale = 1;
      currentTranslateX = 0;
      currentTranslateY = 0;
      updateImageTransform();
    }

    // Update image transform
    function updateImageTransform() {
      previewImage.style.transform = `scale(${currentScale}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
    }

    // Start panning
    function startPanning(e) {
      if (currentScale <= 1) return;
      
      isPanning = true;
      startX = e.clientX - currentTranslateX;
      startY = e.clientY - currentTranslateY;
      previewImage.classList.add('is-panning');
    }

    // Do panning
    function doPanning(e) {
      if (!isPanning) return;
      
      currentTranslateX = e.clientX - startX;
      currentTranslateY = e.clientY - startY;
      updateImageTransform();
    }

    // Stop panning
    function stopPanning() {
      isPanning = false;
      previewImage.classList.remove('is-panning');
    }

    // Handle touch events for mobile
    function handleTouchStart(e) {
      if (e.touches.length === 1) {
        // Single touch - panning
        if (currentScale <= 1) return;
        
        isPanning = true;
        startX = e.touches[0].clientX - currentTranslateX;
        startY = e.touches[0].clientY - currentTranslateY;
        previewImage.classList.add('is-panning');
      } else if (e.touches.length === 2) {
        // Multi-touch - pinch to zoom
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        initialPinchDistance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
      }
    }

    function handleTouchMove(e) {
      if (e.touches.length === 1 && isPanning) {
        // Single touch - panning
        currentTranslateX = e.touches[0].clientX - startX;
        currentTranslateY = e.touches[0].clientY - startY;
        updateImageTransform();
      } else if (e.touches.length === 2 && initialPinchDistance !== null) {
        // Multi-touch - pinch to zoom
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
        
        const scaleChange = currentDistance / initialPinchDistance;
        currentScale = Math.max(0.5, Math.min(3, currentScale * scaleChange));
        
        initialPinchDistance = currentDistance;
        updateImageTransform();
      }
    }

    function handleTouchEnd(e) {
      if (e.touches.length === 0) {
        isPanning = false;
        initialPinchDistance = null;
        previewImage.classList.remove('is-panning');
      }
    }

    // Open video preview
    function openVideoPreview(videoUrl) {
      videoPlayerContainer.innerHTML = '';
      
      // Create video element based on URL type
      if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
        // YouTube video
        let videoId = '';
        
        if (videoUrl.includes('youtube.com')) {
          const urlParams = new URLSearchParams(new URL(videoUrl).search);
          videoId = urlParams.get('v');
        } else if (videoUrl.includes('youtu.be')) {
          videoId = videoUrl.split('/').pop().split('?')[0];
        }
        
        if (videoId) {
          const iframe = document.createElement('iframe');
          iframe.src = `https://www.youtube.com/embed/${videoId}`;
          iframe.allowFullscreen = true;
          iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          videoPlayerContainer.appendChild(iframe);
        }
      } else {
        // Direct video URL
        const video = document.createElement('video');
        video.src = videoUrl;
        video.controls = true;
        video.autoplay = true;
        video.style.width = '100%';
        video.style.height = '100%';
        videoPlayerContainer.appendChild(video);
      }
      
      videoPreviewView.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    // Close video preview
    function closeVideoPreview() {
      videoPreviewView.classList.add('hidden');
      document.body.style.overflow = 'auto';
      
      // Stop any playing video
      const video = videoPlayerContainer.querySelector('video');
      if (video) {
        video.pause();
      }
      
      const iframe = videoPlayerContainer.querySelector('iframe');
      if (iframe) {
        iframe.src = '';
      }
    }

    // Handle keyboard navigation
    function handleKeydown(e) {
      // Only handle keys when preview is open
      if (imagePreviewView.classList.contains('hidden') && 
          videoPreviewView.classList.contains('hidden')) {
        return;
      }
      
      switch(e.key) {
        case 'Escape':
          if (!imagePreviewView.classList.contains('hidden')) {
            closeImagePreview();
          } else if (!videoPreviewView.classList.contains('hidden')) {
            closeVideoPreview();
          }
          break;
        case 'ArrowLeft':
          if (!imagePreviewView.classList.contains('hidden')) {
            showPrevImage();
          }
          break;
        case 'ArrowRight':
          if (!imagePreviewView.classList.contains('hidden')) {
            showNextImage();
          }
          break;
        case '+':
        case '=':
          if (!imagePreviewView.classList.contains('hidden')) {
            e.preventDefault();
            zoomIn();
          }
          break;
        case '-':
          if (!imagePreviewView.classList.contains('hidden')) {
            e.preventDefault();
            zoomOut();
          }
          break;
        case '0':
          if (!imagePreviewView.classList.contains('hidden')) {
            resetZoom();
          }
          break;
      }
    }

    // Toggle scroll to top button
    function toggleScrollToTopButton() {
      if (window.pageYOffset > 300) {
        scrollToTopBtn.classList.remove('hidden');
      } else {
        scrollToTopBtn.classList.add('hidden');
      }
    }

    // Scroll to top
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // Add new tag
    function addNewTag() {
      const tagText = tagInput.value.trim();
      
      if (!tagText) return;
      
      if (!allTags.includes(tagText)) {
        allTags.push(tagText);
        allTags.sort();
      }
      
      if (!selectedTags.includes(tagText)) {
        selectedTags.push(tagText);
        renderSelectedTags(selectedTagsContainer, selectedTags, true);
      }
      
      tagInput.value = '';
      renderTagPool(tagPool, selectedTags, true);
    }

    // Render tag pool
    function renderTagPool(container, selectedTags, isMainForm) {
      container.innerHTML = '';
      
      allTags.forEach(tag => {
        if (selectedTags.includes(tag)) return;
        
        const tagElement = document.createElement('span');
        tagElement.className = 'tag bg-gray-700 text-gray-300 px-2 py-1 rounded-full text-xs cursor-pointer hover:bg-gray-600 transition';
        tagElement.textContent = tag;
        tagElement.setAttribute('data-tag', tag);
        
        tagElement.addEventListener('click', () => {
          if (isMainForm) {
            if (!selectedTags.includes(tag)) {
              selectedTags.push(tag);
              renderSelectedTags(selectedTagsContainer, selectedTags, true);
            }
          } else {
            // For related images/videos forms, we need to determine which selected tags container to use
            let targetSelectedTagsContainer;
            
            if (container === relatedTagPool) {
              targetSelectedTagsContainer = relatedSelectedTags;
            } else if (container === editRelatedTagPool) {
              targetSelectedTagsContainer = editRelatedSelectedTags;
            } else if (container === relatedVideoTagPool) {
              targetSelectedTagsContainer = relatedVideoSelectedTags;
            } else if (container === editRelatedVideoTagPool) {
              targetSelectedTagsContainer = editRelatedVideoSelectedTags;
            }
            
            if (targetSelectedTagsContainer) {
              addTagToSelected(tag, targetSelectedTagsContainer, container, false);
            }
          }
          
          renderTagPool(container, selectedTags, isMainForm);
        });
        
        container.appendChild(tagElement);
      });
    }

    // Render selected tags
    function renderSelectedTags(container, tags, isMainForm) {
      container.innerHTML = '';
      
      tags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag bg-blue-600 text-white px-2 py-1 rounded-full text-xs flex items-center gap-1';
        tagElement.innerHTML = `
          ${tag}
          <button type="button" class="remove-tag text-white hover:text-gray-200 transition" data-tag="${tag}">
            <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
          </button>
        `;
        
        container.appendChild(tagElement);
        
        // Add event listener to remove button
        const removeBtn = tagElement.querySelector('.remove-tag');
        removeBtn.addEventListener('click', () => {
          if (isMainForm) {
            selectedTags = selectedTags.filter(t => t !== tag);
            renderSelectedTags(container, selectedTags, isMainForm);
            renderTagPool(tagPool, selectedTags, true);
          } else {
            // For related images/videos forms, we need to determine which tag pool to update
            let targetTagPool;
            
            if (container === relatedSelectedTags) {
              targetTagPool = relatedTagPool;
            } else if (container === editRelatedSelectedTags) {
              targetTagPool = editRelatedTagPool;
            } else if (container === relatedVideoSelectedTags) {
              targetTagPool = relatedVideoTagPool;
            } else if (container === editRelatedVideoSelectedTags) {
              targetTagPool = editRelatedVideoTagPool;
            }
            
            if (targetTagPool) {
              removeTagFromSelected(tag, container, targetTagPool, false);
            }
          }
        });
      });
    }

    // Add tag to selected (for non-main forms)
    function addTagToSelected(tag, selectedContainer, tagPool, isMainForm) {
      const selectedTags = Array.from(selectedContainer.querySelectorAll('.tag'))
        .map(tagEl => tagEl.getAttribute('data-tag'));
      
      if (!selectedTags.includes(tag)) {
        selectedTags.push(tag);
        renderSelectedTags(selectedContainer, selectedTags, isMainForm);
        renderTagPool(tagPool, selectedTags, isMainForm);
      }
    }

    // Remove tag from selected (for non-main forms)
    function removeTagFromSelected(tag, selectedContainer, tagPool, isMainForm) {
      const selectedTags = Array.from(selectedContainer.querySelectorAll('.tag'))
        .map(tagEl => tagEl.getAttribute('data-tag'))
        .filter(t => t !== tag);
      
      renderSelectedTags(selectedContainer, selectedTags, isMainForm);
      renderTagPool(tagPool, selectedTags, isMainForm);
    }

    // Utility function for debouncing
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>
