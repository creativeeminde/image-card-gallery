<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Character Gallery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #1a1b26;
      background-image: radial-gradient(#3c3f58 0.5px, transparent 0.5px);
      background-size: 15px 15px;
      color: #f0f0f0;
    }
    /* Custom scrollbar for a better look in dark mode */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1a1b26;
    }
    ::-webkit-scrollbar-thumb {
      background: #4a4e69;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #5a5f80;
    }
    .popup-content, #details-view, #image-preview-view {
        animation: slide-up 0.4s ease-out;
    }
    @keyframes slide-up {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    .tag {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .tag.selected {
        background-color: #2563eb;
        color: white;
    }
    .gradient-text {
        background: linear-gradient(to right, #c77dff, #e18d9f);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    /* Ensure the preview image can be transformed for zooming */
    #preview-image {
        transition: transform 0.2s ease-out;
    }
  </style>
</head>
<body class="antialiased">

  <div class="container mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8">
      <div class="relative w-full sm:w-auto sm:flex-grow max-w-md">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <input type="text" id="searchInput" placeholder="Search for a character..." class="w-full bg-[#2a2d3d] text-white border border-transparent rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
      </div>
      <div class="flex items-center gap-4">
        <div class="relative">
            <button id="filterButton" class="bg-[#2a2d3d] text-white rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-[#3a3d4d] transition">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                Filter
            </button>
            <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#2a2d3d] rounded-lg shadow-xl z-10 overflow-hidden max-h-60 overflow-y-auto">
                <!-- Tag filters will be injected here -->
            </div>
        </div>
        <div class="relative">
            <button id="sortButton" class="bg-[#2a2d3d] text-white rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-[#3a3d4d] transition">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M7 12h10M10 18h4"/></svg>
                Sort By
            </button>
            <div id="sortDropdown" class="hidden absolute right-0 mt-2 w-48 bg-[#2a2d3d] rounded-lg shadow-xl z-10 overflow-hidden">
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="title_asc">Name (A-Z)</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="title_desc">Name (Z-A)</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="created_at_desc">Newest</a>
                <a href="#" class="sort-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-sort="created_at_asc">Oldest</a>
            </div>
        </div>
        <button id="addCardBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-4 py-2 flex items-center gap-2 hover:bg-blue-700 transition shadow-lg shadow-blue-600/20">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
          New Character
        </button>
      </div>
    </header>

    <!-- Card Gallery -->
    <main id="card-gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-x-6 gap-y-16">
      <!-- Cards will be injected here -->
    </main>
    <div id="loading" class="text-center py-10 hidden">Loading...</div>
    <div id="no-results" class="text-center py-10 hidden">No characters found.</div>

  </div>
  
  <!-- Add/Edit Card Popup -->
  <div id="popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
    <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
      <button id="closePopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <h3 class="text-xl font-bold mb-6">Add New Character</h3>
      <form id="cardForm">
        <div class="mb-4">
          <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Character Name</label>
          <input type="text" id="title" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        </div>
        <div class="mb-4">
          <label for="imageUrl" class="block text-sm font-medium text-gray-300 mb-1">Image URL</label>
          <input type="text" id="imageUrl" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
        </div>
        <!-- Tag Section -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-1">Tags</label>
            <div id="selectedTags" class="mb-2 flex flex-wrap gap-2"></div>
            <div class="flex gap-2">
                <input type="text" id="tagInput" placeholder="Add a new tag..." class="flex-grow bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button type="button" id="addTagBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-4 hover:bg-gray-700 transition">Add</button>
            </div>
            <div id="tagPool" class="mt-2 flex flex-wrap gap-1"></div>
        </div>

        <p id="errorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
        <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition shadow-lg shadow-blue-600/20">Save Character</button>
      </form>
    </div>
  </div>

  <!-- Character Details View (Initially Hidden) -->
  <div id="details-view" class="hidden fixed inset-0 bg-[#1a1b26] z-[100] p-4 md:p-8 overflow-y-auto">
      <button id="closeDetailsBtn" class="absolute top-6 right-6 text-gray-400 hover:text-white transition z-10">
          <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
      </button>
      <div class="container mx-auto grid grid-cols-1 md:grid-cols-5 gap-8 items-start h-full">
          <!-- Left Column: Main Image -->
          <div class="md:col-span-4 flex items-center justify-center h-full pt-10 md:pt-0">
              <img id="details-main-image" src="" alt="Character Image" class="max-w-full max-h-[85vh] object-contain rounded-lg">
          </div>

          <!-- Right Column: Details -->
          <div class="md:col-span-1 pt-10 md:pt-20">
              <h2 class="text-gray-400 text-2xl font-bold tracking-widest">GENERAL DATA</h2>
              <h1 id="details-title" class="gradient-text text-7xl md:text-8xl lg:text-9xl font-extrabold my-2 break-words">
                  <!-- Character Name -->
              </h1>

              <h3 class="text-gray-300 text-lg font-semibold mt-8 mb-3">Tags</h3>
              <div id="details-tags" class="flex flex-wrap gap-2">
                  <!-- Tags will be injected here -->
              </div>

              <div id="details-related-images-container" class="mt-8">
                   <div class="flex items-center justify-between mb-3">
                        <h3 class="text-gray-300 text-lg font-semibold">Related Images</h3>
                        <div class="flex gap-2">
                            <button id="addRelatedBtn" class="bg-blue-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-blue-700 transition">
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                Add
                            </button>
                            <button id="manageRelatedBtn" class="bg-gray-600 text-white font-semibold rounded-lg px-3 py-1 text-sm flex items-center gap-1 hover:bg-gray-700 transition">
                                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                                Manage
                            </button>
                        </div>
                   </div>
                   <div id="details-related-images" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                       <!-- Related images will be injected here -->
                   </div>
              </div>
          </div>
      </div>
  </div>
  
  <!-- Add Related Images Popup -->
  <div id="related-image-popup" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[300]" style="display: none;">
      <div class="popup-content bg-[#2a2d3d] rounded-xl shadow-2xl w-full max-w-md p-6 relative">
          <button id="closeRelatedPopupBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
              <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
          <h3 class="text-xl font-bold mb-6">Add Related Images</h3>
          <form id="relatedImagesForm">
              <div class="mb-4">
                  <label for="relatedImageUrls" class="block text-sm font-medium text-gray-300 mb-1">Image URLs (one per line)</label>
                  <textarea id="relatedImageUrls" rows="5" class="w-full bg-[#1a1b26] text-white border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="https://example.com/image1.jpg\nhttps://example.com/image2.png"></textarea>
              </div>
              <!-- Tag Section for Related Images -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Tags for these images</label>
                <div id="relatedSelectedTags" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="relatedTagPool" class="mt-2 flex flex-wrap gap-1"></div>
              </div>

              <p id="relatedErrorMessage" class="text-red-400 text-sm mb-4 h-5"></p>
              <button type="submit" class="w-full bg-blue-600 text-white font-semibold rounded-lg p-2.5 hover:bg-blue-700 transition">Add Images</button>
          </form>
      </div>
  </div>

  <!-- Image Preview Modal -->
  <div id="image-preview-view" class="hidden fixed inset-0 bg-black/90 z-[200] flex items-center justify-center p-4">
      <div class="relative w-full h-full flex items-center justify-center">
        <!-- Main Image -->
        <img id="preview-image" src="" class="max-w-full max-h-full object-contain">
        
        <!-- Close Button -->
        <button id="closePreviewBtn" class="absolute top-4 right-4 text-white/70 hover:text-white transition">
            <svg class="h-10 w-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>

        <!-- Navigation Buttons -->
        <button id="prevPreviewBtn" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition bg-black/30 rounded-full p-2">
            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
        </button>
        <button id="nextPreviewBtn" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white transition bg-black/30 rounded-full p-2">
            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
        </button>

        <!-- Controls -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center gap-2 bg-black/40 p-2 rounded-lg">
             <span id="previewCounter" class="text-white text-sm font-medium w-16 text-center"></span>
             <button id="zoomOutBtn" class="text-white/80 hover:text-white transition"><svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="zoomInBtn" class="text-white/80 hover:text-white transition"><svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
             <button id="resetZoomBtn" class="text-white/80 hover:text-white transition"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.42 5.5 5.5 0 018.253-1.655l1.454-1.454a.75.75 0 011.06 1.06l-1.453 1.454a5.494 5.494 0 01-.01 2.01zm-1.85 2.152a.75.75 0 01-1.06 1.06l-1.455-1.454a5.5 5.5 0 01-8.253 1.655 5.5 5.5 0 019.201 4.42l-1.454 1.454a.75.75 0 11-1.06 1.06l1.453-1.454a5.494 5.494 0 01.01-2.01z" clip-rule="evenodd" /></svg></button>
        </div>
      </div>
  </div>


  <script>
    const SUPABASE_URL = 'https://fwzffqwjprjuwidkrckb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3emZmcXdqcHJqdXdpZGtyY2tiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwMTMwNzMsImV4cCI6MjA2MzU4OTA3M30.p3b_pshzTN-G3QTKE91b5TGBZJwSRZTEOClXN5JEl6I';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Main gallery elements
    const cardGallery = document.getElementById('card-gallery');
    const searchInput = document.getElementById('searchInput');
    const loadingIndicator = document.getElementById('loading');
    const noResultsMessage = document.getElementById('no-results');
    
    // Popup elements
    const addCardBtn = document.getElementById('addCardBtn');
    const popup = document.getElementById('popup');
    const closePopupBtn = document.getElementById('closePopupBtn');
    const cardForm = document.getElementById('cardForm');
    const addTagBtn = document.getElementById('addTagBtn');
    const tagInput = document.getElementById('tagInput');
    
    // Filter & Sort elements
    const sortButton = document.getElementById('sortButton');
    const sortDropdown = document.getElementById('sortDropdown');
    const filterButton = document.getElementById('filterButton');
    const filterDropdown = document.getElementById('filterDropdown');
    
    // Details View elements
    const detailsView = document.getElementById('details-view');
    const closeDetailsBtn = document.getElementById('closeDetailsBtn');
    const detailsMainImage = document.getElementById('details-main-image');
    const detailsTitle = document.getElementById('details-title');
    const detailsTags = document.getElementById('details-tags');
    const detailsRelatedImages = document.getElementById('details-related-images');
    const detailsRelatedImagesContainer = document.getElementById('details-related-images-container');
    const addRelatedBtn = document.getElementById('addRelatedBtn');
    const manageRelatedBtn = document.getElementById('manageRelatedBtn');

    // Add Related Popup
    const relatedImagePopup = document.getElementById('related-image-popup');
    const closeRelatedPopupBtn = document.getElementById('closeRelatedPopupBtn');
    const relatedImagesForm = document.getElementById('relatedImagesForm');
    const relatedTagPool = document.getElementById('relatedTagPool');

    // Image Preview
    const imagePreviewView = document.getElementById('image-preview-view');
    const closePreviewBtn = document.getElementById('closePreviewBtn');
    const previewImage = document.getElementById('preview-image');
    const prevPreviewBtn = document.getElementById('prevPreviewBtn');
    const nextPreviewBtn = document.getElementById('nextPreviewBtn');
    const previewCounter = document.getElementById('previewCounter');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');


    // State variables
    let currentlyEditingCardId = null;
    let currentCardForDetails = null;
    let currentSort = { column: 'created_at', ascending: false }; 
    let selectedFilterTag = '';
    let allTags = new Set();
    let selectedTags = [];
    let selectedRelatedTags = [];
    let isManageRelatedMode = false;
    let filteredItemsForPreview = [];

    // Preview State
    let previewImages = [];
    let currentPreviewIndex = 0;
    let currentZoom = 1;


    // --- Data Fetching and Display ---
    async function fetchAllTags() {
        const { data, error } = await supabase.from('cards').select('tags, related_images_with_tags');
        if (error) return console.error('Error fetching tags:', error);
        
        allTags.clear();
        data.forEach(card => {
            if (card.tags) {
                card.tags.split(',').forEach(tag => {
                    if(tag.trim()) allTags.add(tag.trim());
                });
            }
            if(card.related_images_with_tags) {
                card.related_images_with_tags.forEach(img => {
                    if (img.tags) {
                        img.tags.split(',').forEach(tag => {
                            if(tag.trim()) allTags.add(tag.trim());
                        });
                    }
                });
            }
        });
        updateTagDisplays();
    }

    async function loadCards() {
        loadingIndicator.classList.remove('hidden');
        cardGallery.innerHTML = '';
        noResultsMessage.classList.add('hidden');
        await fetchAllTags();
        try {
            let query = supabase.from('cards').select('*');
            const searchTerm = searchInput.value.trim();
            if (searchTerm) query = query.ilike('title', `%${searchTerm}%`);
            
            query = query.order(currentSort.column, { ascending: currentSort.ascending });

            const { data: cards, error } = await query;
            if (error) throw error;
            
            let displayItems = [];
            if(selectedFilterTag) {
                cards.forEach(card => {
                    const mainTags = card.tags ? card.tags.split(',').map(t => t.trim()) : [];
                    if(mainTags.includes(selectedFilterTag)) {
                        displayItems.push({ ...card, isMain: true }); 
                    }

                    const related = card.related_images_with_tags || [];
                    related.forEach(img => {
                         const relatedTags = img.tags ? img.tags.split(',').map(t => t.trim()) : [];
                         if(relatedTags.includes(selectedFilterTag)) {
                            displayItems.push({
                                isRelated: true,
                                url: img.url,
                                tags: img.tags,
                                parentCard: card
                            });
                         }
                    });
                });
            } else {
                displayItems = cards.map(c => ({...c, isMain: true}));
            }
            
            filteredItemsForPreview = displayItems.map(item => item.isRelated ? item.url : item.main_image_url);
            displayCards(displayItems);
        } catch (error) {
            console.error("Error loading cards:", error);
            cardGallery.innerHTML = `<p class="text-red-400 col-span-full text-center">Failed to load characters.</p>`;
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }
    
    function displayCards(items) {
        cardGallery.innerHTML = '';
        if (items.length === 0) {
            noResultsMessage.classList.remove('hidden');
            return;
        }
        items.forEach((item, index) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'card-container relative group cursor-pointer';

            if (item.isRelated) {
                const card = item.parentCard;
                const tagsHtml = item.tags ? item.tags.split(',').map(tag => `<span class="bg-purple-700 text-purple-200 text-xs font-medium px-2 py-0.5 rounded-full">${tag.trim()}</span>`).join(' ') : '';
                
                cardElement.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden transform group-hover:scale-105 group-hover:-translate-y-1 transition-all duration-300 ease-in-out">
                        <img src="${item.url}" alt="Related to ${card.title}" class="w-full h-48 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/400x400/1a1b26/ffffff?text=Image+Not+Found';">
                    </div>
                    <div class="absolute -top-3 left-3 bg-[#3a3d4d] text-white text-sm font-semibold px-3 py-1 rounded-full shadow-md border-2 border-[#1a1b26]">
                        From: ${card.title}
                    </div>
                    <div class="absolute -bottom-10 w-full p-2 flex flex-wrap gap-1 justify-center">
                        ${tagsHtml}
                    </div>
                `;
            } else { // isMain
                const card = item;
                const tagsHtml = card.tags ? card.tags.split(',').map(tag => `<span class="bg-gray-700 text-gray-300 text-xs font-medium px-2 py-0.5 rounded-full">${tag.trim()}</span>`).join(' ') : '';
                cardElement.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden transform group-hover:scale-105 group-hover:-translate-y-1 transition-all duration-300 ease-in-out">
                        <img src="${card.main_image_url}" alt="${card.title}" class="w-full h-48 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/400x400/1a1b26/ffffff?text=Image+Not+Found';">
                    </div>
                    <div class="absolute -top-3 left-3 bg-[#3a3d4d] text-white text-sm font-semibold px-3 py-1 rounded-full shadow-md border-2 border-[#1a1b26]">
                        ${card.title}
                    </div>
                    <div class="absolute -bottom-10 w-full p-2 flex flex-wrap gap-1 justify-center">
                        ${tagsHtml}
                    </div>
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="edit-btn p-1.5 bg-blue-600 rounded-full text-white hover:bg-blue-700" data-id="${card.id}">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button class="delete-btn p-1.5 bg-red-600 rounded-full text-white hover:bg-red-700 ml-1" data-id="${card.id}">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
            }

            cardElement.addEventListener('click', (e) => {
                if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) return;
                
                if (selectedFilterTag) {
                    openImagePreview(filteredItemsForPreview, index);
                } else {
                    const cardId = item.isRelated ? item.parentCard.id : item.id;
                    openDetailsView(cardId);
                }
            });
            cardGallery.appendChild(cardElement);
        });
    }


    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', loadCards);
    searchInput.addEventListener('input', () => debounce(loadCards, 300));
    addCardBtn.addEventListener('click', openPopup);
    closePopupBtn.addEventListener('click', closePopup);
    popup.addEventListener('click', (e) => { if (e.target === popup) closePopup(); });
    cardForm.addEventListener('submit', saveCard);
    closeDetailsBtn.addEventListener('click', closeDetailsView);
    addRelatedBtn.addEventListener('click', openRelatedImagePopup);
    closeRelatedPopupBtn.addEventListener('click', closeRelatedImagePopup);
    relatedImagesForm.addEventListener('submit', saveRelatedImages);
    manageRelatedBtn.addEventListener('click', toggleManageRelatedMode);
    closePreviewBtn.addEventListener('click', closeImagePreview);
    nextPreviewBtn.addEventListener('click', nextPreviewImage);
    prevPreviewBtn.addEventListener('click', prevPreviewImage);
    zoomInBtn.addEventListener('click', zoomInPreview);
    zoomOutBtn.addEventListener('click', zoomOutPreview);
    resetZoomBtn.addEventListener('click', resetZoomPreview);


    // --- Dropdown Toggles ---
    function setupDropdown(button, dropdown) {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllDropdowns(dropdown);
            dropdown.classList.toggle('hidden');
        });
    }
    function closeAllDropdowns(exclude) {
        [sortDropdown, filterDropdown].forEach(d => {
            if (d !== exclude) d.classList.add('hidden');
        });
    }
    document.addEventListener('click', () => closeAllDropdowns(null));
    setupDropdown(sortButton, sortDropdown);
    setupDropdown(filterButton, filterDropdown);
    
    // --- Sorting & Filtering ---
    sortDropdown.addEventListener('click', (e) => {
        if (e.target.classList.contains('sort-option')) {
            e.preventDefault();
            const sortValue = e.target.dataset.sort.split('_');
            currentSort.column = sortValue[0] === 'created' ? 'created_at' : 'title';
            currentSort.ascending = sortValue.pop() === 'asc';
            loadCards();
            sortDropdown.classList.add('hidden');
        }
    });

    filterDropdown.addEventListener('click', (e) => {
        if(e.target.classList.contains('filter-option')) {
            e.preventDefault();
            selectedFilterTag = e.target.dataset.tag;
            const filterButtonText = document.querySelector('#filterButton');
            if (selectedFilterTag) {
                filterButtonText.innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg> ${selectedFilterTag}`;
            } else {
                 filterButtonText.innerHTML = `<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg> Filter`;
            }
            loadCards();
            filterDropdown.classList.add('hidden');
        }
    });

    cardGallery.addEventListener('click', async (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        if (editBtn) await editCard(editBtn.dataset.id);
        if (deleteBtn) {
            if (await customConfirm('Are you sure you want to delete this character?')) {
                await deleteCard(deleteBtn.dataset.id);
            }
        }
    });

    // --- Card Actions (Add, Edit, Delete) ---
    async function editCard(id) {
        const { data: card, error } = await supabase.from('cards').select('*').eq('id', id).single();
        if (error) return console.error("Error fetching card for edit:", error);
        resetForm();
        currentlyEditingCardId = id;
        document.querySelector('.popup-content h3').textContent = 'Edit Character';
        document.getElementById('title').value = card.title;
        document.getElementById('imageUrl').value = card.main_image_url;
        selectedTags = card.tags ? card.tags.split(',').map(t => t.trim()) : [];
        updateSelectedTagsDisplay();
        updateTagPoolSelection();
        openPopup();
    }

    async function deleteCard(id) {
        const { error } = await supabase.from('cards').delete().eq('id', id);
        if (error) return console.error("Error deleting card:", error);
        await loadCards();
    }

    async function saveCard(e) {
      e.preventDefault();
      try {
        const title = document.getElementById('title').value.trim();
        const imageUrl = document.getElementById('imageUrl').value.trim();
        if (!title || !imageUrl) throw new Error("Character name and Image URL are required.");
        const cardData = { title, main_image_url: imageUrl, tags: selectedTags.join(', ') };
        const { error } = currentlyEditingCardId ? await supabase.from('cards').update(cardData).eq('id', currentlyEditingCardId) : await supabase.from('cards').insert([cardData]);
        if (error) throw error;
        closePopup();
        await loadCards();
      } catch (error) {
        console.error("Error saving card:", error);
        document.getElementById('errorMessage').textContent = error.message;
      }
    }

    // --- Details View ---
    async function openDetailsView(cardId) {
        const { data: card, error } = await supabase.from('cards').select('*').eq('id', cardId).single();
        if (error || !card) return console.error("Could not fetch card details");
        currentCardForDetails = card;

        detailsMainImage.src = card.main_image_url;
        detailsTitle.textContent = card.title;
        detailsTags.innerHTML = '';
        if (card.tags) {
            card.tags.split(',').forEach(tag => {
                if(!tag.trim()) return;
                const tagEl = document.createElement('span');
                tagEl.className = 'bg-gray-700 text-gray-200 text-sm font-medium px-3 py-1 rounded-full';
                tagEl.textContent = tag.trim();
                detailsTags.appendChild(tagEl);
            });
        }
        renderRelatedImages();
        document.querySelector('.container').classList.add('hidden');
        detailsView.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function renderRelatedImages() {
        const card = currentCardForDetails;
        detailsRelatedImages.innerHTML = '';
        const relatedImages = card.related_images_with_tags || (card.related_images ? card.related_images.map(url => ({url})) : []);

        if(relatedImages.length > 0) {
            detailsRelatedImagesContainer.classList.remove('hidden');
            relatedImages.forEach((img, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.className = "relative group aspect-square bg-gray-800 rounded-md overflow-hidden cursor-pointer";
                imgContainer.innerHTML = `
                    <img src="${img.url}" alt="Related Image" class="w-full h-full object-cover group-hover:opacity-60 transition">
                    ${isManageRelatedMode ? `
                    <button class="delete-related-btn absolute top-1 right-1 p-1 bg-red-600/80 rounded-full text-white hover:bg-red-600" data-url="${img.url}">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    ` : ''}
                `;
                imgContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-related-btn')) {
                        deleteRelatedImage(img.url);
                    } else {
                        const allRelated = card.related_images_with_tags.map(i => i.url);
                        openImagePreview(allRelated, index);
                    }
                });
                detailsRelatedImages.appendChild(imgContainer);
            });
        } else {
             detailsRelatedImagesContainer.classList.add('hidden');
        }
    }
    
    function closeDetailsView() {
        document.querySelector('.container').classList.remove('hidden');
        detailsView.classList.add('hidden');
        document.body.style.overflow = 'auto';
        isManageRelatedMode = false;
        manageRelatedBtn.classList.remove('bg-red-600');
        manageRelatedBtn.classList.add('bg-gray-600');
    }

    // --- Related Images Management ---
    function openRelatedImagePopup() {
        selectedRelatedTags = [];
        updateRelatedTagDisplays();
        relatedImagePopup.style.display = 'flex';
    }
    function closeRelatedImagePopup() {
        relatedImagePopup.style.display = 'none';
        relatedImagesForm.reset();
        selectedRelatedTags = [];
    }
    async function saveRelatedImages(e) {
        e.preventDefault();
        const urlsText = document.getElementById('relatedImageUrls').value.trim();
        if (!urlsText) return;
        const urls = urlsText.split('\n').map(url => url.trim()).filter(url => url);
        
        const currentRelatedImages = currentCardForDetails.related_images || [];
        const currentRelatedWithTags = currentCardForDetails.related_images_with_tags || [];
        
        const newUrls = urls.filter(url => !currentRelatedImages.includes(url));
        if (newUrls.length === 0) return closeRelatedImagePopup();

        const tagsString = selectedRelatedTags.join(', ');
        
        const updatedRelatedImages = [...currentRelatedImages, ...newUrls];
        const updatedRelatedWithTags = [...currentRelatedWithTags, ...newUrls.map(url => ({ url, tags: tagsString }))];

        const { data, error } = await supabase
            .from('cards')
            .update({ related_images: updatedRelatedImages, related_images_with_tags: updatedRelatedWithTags })
            .eq('id', currentCardForDetails.id)
            .select()
            .single();

        if (error) {
            document.getElementById('relatedErrorMessage').textContent = 'Error saving images.';
            return console.error(error);
        }

        currentCardForDetails = data;
        await fetchAllTags(); // Refresh all tags in case new ones were added implicitly
        renderRelatedImages();
        closeRelatedImagePopup();
    }

    function toggleManageRelatedMode() {
        isManageRelatedMode = !isManageRelatedMode;
        manageRelatedBtn.classList.toggle('bg-red-600', isManageRelatedMode);
        manageRelatedBtn.classList.toggle('bg-gray-600', !isManageRelatedMode);
        renderRelatedImages();
    }

    async function deleteRelatedImage(urlToDelete) {
        if (!await customConfirm('Are you sure you want to delete this related image?')) return;

        const updatedRelatedImages = currentCardForDetails.related_images.filter(url => url !== urlToDelete);
        const updatedRelatedWithTags = currentCardForDetails.related_images_with_tags.filter(img => img.url !== urlToDelete);

        const { data, error } = await supabase
            .from('cards')
            .update({ related_images: updatedRelatedImages, related_images_with_tags: updatedRelatedWithTags })
            .eq('id', currentCardForDetails.id)
            .select()
            .single();

        if (error) return console.error('Error deleting image:', error);

        currentCardForDetails = data;
        renderRelatedImages();
    }

    // --- Image Preview ---
    function openImagePreview(images, index) {
        previewImages = images;
        currentPreviewIndex = index;
        updatePreviewImage();
        imagePreviewView.classList.remove('hidden');
    }
    function closeImagePreview() {
        imagePreviewView.classList.add('hidden');
        resetZoomPreview();
    }
    function updatePreviewImage() {
        previewImage.src = previewImages[currentPreviewIndex];
        previewCounter.textContent = `${currentPreviewIndex + 1} / ${previewImages.length}`;
        prevPreviewBtn.style.display = previewImages.length > 1 ? 'block' : 'none';
        nextPreviewBtn.style.display = previewImages.length > 1 ? 'block' : 'none';
        resetZoomPreview();
    }
    function nextPreviewImage() {
        currentPreviewIndex = (currentPreviewIndex + 1) % previewImages.length;
        updatePreviewImage();
    }
    function prevPreviewImage() {
        currentPreviewIndex = (currentPreviewIndex - 1 + previewImages.length) % previewImages.length;
        updatePreviewImage();
    }
    function zoomInPreview() {
        currentZoom = Math.min(currentZoom + 0.2, 3); // Max zoom 3x
        previewImage.style.transform = `scale(${currentZoom})`;
    }
    function zoomOutPreview() {
        currentZoom = Math.max(currentZoom - 0.2, 0.5); // Min zoom 0.5x
        previewImage.style.transform = `scale(${currentZoom})`;
    }
    function resetZoomPreview() {
        currentZoom = 1;
        previewImage.style.transform = 'scale(1)';
    }

    // --- Popup and Form Management ---
    function resetForm() {
      cardForm.reset();
      currentlyEditingCardId = null;
      selectedTags = [];
      document.querySelector('.popup-content h3').textContent = 'Add New Character';
      document.getElementById('errorMessage').textContent = '';
      updateSelectedTagsDisplay();
      updateTagPoolSelection();
    }

    function openPopup() { popup.style.display = 'flex'; }
    function closePopup() { popup.style.display = 'none'; resetForm(); }
    
    // --- Tag Management ---
    addTagBtn.addEventListener('click', () => {
        const newTag = tagInput.value.trim();
        if (newTag && !selectedTags.includes(newTag)) {
            selectedTags.push(newTag);
            if (!allTags.has(newTag)) {
                allTags.add(newTag);
                updateTagDisplays();
            }
            updateSelectedTagsDisplay();
            updateTagPoolSelection();
        }
        tagInput.value = '';
        tagInput.focus();
    });

    function updateTagDisplays() {
        const sortedTags = Array.from(allTags).sort();
        // Main filter
        filterDropdown.innerHTML = `<a href="#" class="filter-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-tag="">All Characters</a>`;
        sortedTags.forEach(tag => {
            filterDropdown.innerHTML += `<a href="#" class="filter-option block px-4 py-2 text-sm text-gray-300 hover:bg-blue-600 hover:text-white" data-tag="${tag}">${tag}</a>`;
        });
        // Main card tag pool
        const tagPool = document.getElementById('tagPool');
        tagPool.innerHTML = '';
        sortedTags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            tagPool.appendChild(tagEl);
        });
        // Related images tag pool
        updateRelatedTagDisplays();
    }

    function updateSelectedTagsDisplay() {
        const container = document.getElementById('selectedTags');
        container.innerHTML = '';
        selectedTags.forEach(tag => {
            container.innerHTML += `<span class="bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1">${tag}<button type="button" class="remove-tag font-bold" data-tag="${tag}">&times;</button></span>`;
        });
    }

    function updateTagPoolSelection() {
        document.querySelectorAll('#tagPool .tag').forEach(tagEl => {
            if (selectedTags.includes(tagEl.dataset.tag)) {
                tagEl.classList.add('selected');
            } else {
                tagEl.classList.remove('selected');
            }
        });
    }

    function updateRelatedTagDisplays() {
        const sortedTags = Array.from(allTags).sort();
        const relatedSelectedContainer = document.getElementById('relatedSelectedTags');
        const relatedPoolContainer = document.getElementById('relatedTagPool');
        
        relatedPoolContainer.innerHTML = '';
        sortedTags.forEach(tag => {
             const tagEl = document.createElement('span');
            tagEl.className = 'tag bg-gray-600 text-gray-200 text-xs font-medium px-2 py-1 rounded-full';
            tagEl.textContent = tag;
            tagEl.dataset.tag = tag;
            if(selectedRelatedTags.includes(tag)) tagEl.classList.add('selected');
            relatedPoolContainer.appendChild(tagEl);
        });

        relatedSelectedContainer.innerHTML = '';
        selectedRelatedTags.forEach(tag => {
            relatedSelectedContainer.innerHTML += `<span class="bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center gap-1">${tag}<button type="button" class="remove-related-tag font-bold" data-tag="${tag}">&times;</button></span>`;
        });
    }
    
    document.getElementById('popup').addEventListener('click', (e) => {
        if(e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            if(selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
            } else {
                selectedTags.push(tag);
            }
            updateSelectedTagsDisplay();
            updateTagPoolSelection();
        }
        if(e.target.classList.contains('remove-tag')) {
            const tag = e.target.dataset.tag;
            selectedTags = selectedTags.filter(t => t !== tag);
            updateSelectedTagsDisplay();
            updateTagPoolSelection();
        }
    });

    relatedImagePopup.addEventListener('click', (e) => {
        if(e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            if(selectedRelatedTags.includes(tag)) {
                selectedRelatedTags = selectedRelatedTags.filter(t => t !== tag);
            } else {
                selectedRelatedTags.push(tag);
            }
            updateRelatedTagDisplays();
        }
        if(e.target.classList.contains('remove-related-tag')) {
            const tag = e.target.dataset.tag;
            selectedRelatedTags = selectedRelatedTags.filter(t => t !== tag);
            updateRelatedTagDisplays();
        }
    });

    // --- Utilities ---
    let debounceTimer;
    function debounce(func, delay) { clearTimeout(debounceTimer); debounceTimer = setTimeout(func, delay); }
    function customConfirm(message) { return new Promise(resolve => resolve(confirm(message))); }

  </script>
</body>
</html>

